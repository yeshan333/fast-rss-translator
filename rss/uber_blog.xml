<?xml version="1.0" encoding="UTF-8"?><rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Uber Engineering Blog</title>
    <link>http://rsshub.rssforever.com/uber/blog</link>
    <description>The technology behind Uber Engineering - Powered by RSSHub</description>
    <managingEditor>contact@rsshub.app (RSSHub)</managingEditor>
    <item>
      <title>【Transforming Executive Travel: Delegate Booking with Uber】改变高管旅行：通过 Uber 进行代表预订</title>
      <link>https://www.uber.com/blog/executive-travel/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;b27400c4-033d-479b-8343-f721dfb6a373&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;89dee566-0235-4f75-9899-b95adc486649&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the competitive world of corporate travel, efficiency and precision are paramount. At Uber, we’ve recognized a specific need within this sector: senior executives and their assistants require a streamlined and reliable booking experience. To address this, we developed the Delegate Booking tool, a significant enhancement to our platform designed to empower executive assistants (EAs) to manage travel with ease and precision.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bdce132a-1f3b-4f19-a1f2-74ce82231597&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4f39f205-3ed5-4ba2-8d2d-9f6f982fd4a2&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-why-we-developed-delegate-booking&#34;&gt;Why We Developed Delegate Booking&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cf5ca665-348a-43b8-bc47-3e558630475c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Recognizing the unique challenges faced by EAs tasked with arranging travel for their executives, we saw a significant opportunity to enhance their experience. Traditionally, EAs relied on multiple third-party services to meet the sophisticated demands of executive travel, striving to provide high-quality, seamless journeys. With the introduction of our Delegate Booking tool, we have elevated Uber’s offerings to align with the premium standards expected in executive travel, enhancing control over trip modifications and communications for a superior service experience.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;c1f9cc66-4834-41f7-adda-a275b3b3547d&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-key-considerations&#34;&gt;Key Considerations:&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f03d4af2-6cac-42e1-a472-581127608355&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;User Experience Continuity:&lt;/strong&gt; Maintaining the same quality of experience for the executive as if they had booked the ride themselves.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Control and Visibility for EAs:&lt;/strong&gt; Providing EAs with the ability to fully manage the ride, including the flexibility to modify or cancel trips and communicate directly with both the executive and the driver.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4eeac287-6e02-4d3b-9a3a-9de4d311bd10&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c349ca5a-7fe7-465c-a64e-94948ee1e968&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-the-engineering-challenge&#34;&gt;The Engineering Challenge&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;58c685ca-fbb1-4aa1-9074-2a1059dda1d9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our main focus was to evolve the existing architecture to accommodate the participant model in the trip booking process, aimed at enhancing flexibility and inclusivity. The objective was to develop a seamless integration that allows executive assistants to manage bookings effortlessly, while maintaining the high-quality experience for executives. This advancement necessitated a strategic transformation in how our platform manages user roles and permissions, reinforcing our commitment to a more adaptable and user-friendly service.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4cd05f6e-409e-45bf-b624-b06c5b6e7fff&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Service Expansion:&lt;/strong&gt; We expanded our service layers to accommodate multiple user profiles interacting with the same trip.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Notification System:&lt;/strong&gt; We extended our notification system to send relevant updates to both the executive and the EA throughout the journey.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Billing and Auditing:&lt;/strong&gt; We integrated our billing engine with the new model so that financial transactions are accurate and reflect the delegated booking accurately.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;04e1c30c-28f8-4ef9-bcab-062cc0958908&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ee2a2d83-a4ab-491a-bdca-0ca05b5c0e63&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architecture-overhaul&#34;&gt;Architecture Overhaul&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;73407d17-f148-4bde-9382-3ca71aee0ea2&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeZOLNXNIy22CWLdesUzT3GBT7XLlzkgY4CUAuCBz_kof8yA-4_ydShJB8hlj3B_Py0VViO40jTSWNeNx34AgcMnCtmb-7xjZWQvkE_kuLASRaawDK_tD8LZj-6sJMjZWRLnF3-d4_HnGEuxuyG2IW-qQo?key=DuSIbdUxytqjw1jh-r69qg&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Flow diagram demonstrates high level architecture flow of the delegate booking system.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0598de3d-0b4f-4f0e-afd9-36e0be5e4afc&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c6fcf013-bdb8-4bde-8656-75e237cc8447&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our platform was originally designed with a simple and user-centric model: the person booking the ride is intimately involved in all stages of the journey. To introduce Delegate Booking, a feature that enhances flexibility and inclusivity, we embraced the challenge of innovating across our ecosystem. This expansive upgrade spanned over 30 services and 5 different platforms, integrating a diverse array of technologies from backend systems like GO, Java®, and Node, to frontend applications such as Fusion, iOS®, and Android®. This holistic transformation not only broadens our service capabilities but also enriches the user experience.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b82adcb0-eba2-424a-9b9e-fdcc443c9ca6&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;15953ed2-3933-4071-bc65-907942153c93&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-how-delegate-booking-works&#34;&gt;How Delegate Booking Works&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5eacda76-9fbc-45c1-9d44-506a91a08212&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The Delegate Booking tool integrates deeply with our existing infrastructure:&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;98156b0e-1b17-475b-b175-bc641e1dda2a&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeALh8hTbUZpQw-bf44ErjTB6f_egaKY45HEJWOSXQ5SkvDSCY3JUB6waQJjB6tJkD9rmggKoqt3Jy8vpocQPkH8O4NxNIZEcr0xR-lcMdGRwv-zHQGqQdkYPB3QR569cpmd_qgdP-ihipjttNjUHPXbQGn?key=DuSIbdUxytqjw1jh-r69qg&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: Flow diagram following the Executive onboarding their EA using Uber rider app.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;69228b67-11cc-4ecd-bcc1-fe15859f94d4&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;hash&amp;quot;:&amp;quot;e815ac96-6508-4fa5-928b-164c8d245bc7&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;User Interface:&lt;/strong&gt; Executives assign a delegate (the EA) from within their Uber rider app by entering the EA’s business email and specifying permissions.&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3d619fa0-6915-4161-8872-fd5512475cc7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;&lt;/strong&gt;Figure 3: Flow diagram following the request for a ride from an EA for their executive.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;start&amp;quot;:2,&amp;quot;hash&amp;quot;:&amp;quot;71a97212-c5e2-45f6-b427-fa328b476b9f&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34; start=&#34;2&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Booking and Management:&lt;/strong&gt; EAs access their delegated profile through their version of the Uber rider app, where they can book rides, select preferences, and manage trip details in real time.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Backend Integration:&lt;/strong&gt; Our backend systems support these operations by ensuring that all data flows are secure and that every action taken by an EA on behalf of an executive is logged and auditable.&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cd588d27-6501-4b26-b8df-e6789336f80f&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;512eaadb-552b-4e0b-b88a-94aa9f05b86d&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-impact-and-future-directions&#34;&gt;Impact and Future Directions&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c3e914b3-81a3-4cc2-9e0d-504923194281&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The introduction of Delegate Booking has not only improved our service offering, but has also opened up new avenues for feature expansion. We are now exploring how these changes can benefit other user groups, such as office managers or team coordinators, who may also require similar functionalities.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c08b4f12-e110-429d-8ecc-4c39cc2203db&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This feature introduces a delightful unlock of a segment where trips can be conveniently booked by another party while the payment is gracefully managed by the rider. This offers both flexibility and ease, enriching the user experience.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f62b2f4a-4ccd-4a4d-a89a-0f0f9ddf47c2&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;104ed716-f22c-4dc3-aed5-30f796f3f1a7&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-next-steps&#34;&gt;Next Steps&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;f002f771-0bd2-4138-b76b-796e8f76db4a&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-reuse-of-design&#34;&gt;Reuse of Design:&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5a5672e2-0b55-408c-8699-0d110f417aab&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Utilizing the existing design framework for new feature unlocks&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Adapting the technology to support scenarios involving multiple trip participants&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Aim to enhance the seamless trip experience on the rider app&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;1a0898c5-e275-4c6e-8c2d-362321d5385f&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-integration-into-uber-s-vision-and-goals&#34;&gt;Integration into Uber’s Vision and Goals:&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c3dda00d-a177-4603-8cc3-3674f3c44be8&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Ensuring the success of Uber Platinum through a robust delegated business solution&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Expanding up-market with tailored business offerings such as Biz Comfort and Platinum&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Targeting a user base that demands high-quality, executive-grade booking experiences&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d47a2416-d276-4648-8550-f5f0871077f1&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;50e66936-b406-4fc5-8a49-31c9547d8673&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;09573c19-7a67-4a8a-8c3c-fdf15eadcf06&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The introduction of delegate booking by Uber marks a significant advancement in our service offerings, particularly for executive travel. This feature responds to the evolving needs of our clientele. By empowering executive assistants to efficiently manage travel arrangements through the Uber platform, we strive to&amp;nbsp; simplify logistics while enhancing user satisfaction and loyalty.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5ebf37cd-6e68-4dca-baec-bf6950826d66&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This innovation is not just about adding a new feature—it’s about transforming how business is done. It underscores our commitment to continuous improvement and customer-centric solutions. We will continue to refine this technology, exploring new use cases and expanding its capabilities to meet the demands of a dynamic corporate world.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;313f9d91-7b8b-4f45-b3f0-4370e48bf2b9&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a10a23a4-bf40-4062-a0b9-ad96265d776d&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;Acknowledgments&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;243f82cf-7588-49c2-b185-e6027303b0a4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;I would like to extend my heartfelt thanks to &lt;a href=&#34;https://www.linkedin.com/in/saravab/&#34;&gt;Sarav&lt;/a&gt;&lt;a href=&#34;https://www.linkedin.com/in/saravab/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;a&lt;/a&gt;&lt;a href=&#34;https://www.linkedin.com/in/saravab/&#34;&gt;nan Balasubramanian&lt;/a&gt;, &lt;a href=&#34;https://www.linkedin.com/in/anshukumar/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Anshu Kumar&lt;/a&gt;,&lt;a href=&#34;https://www.linkedin.com/in/alex-cao-4ab915306?trk=contact-info&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Ning Cao&lt;/a&gt; &amp;amp;&amp;nbsp; &lt;a href=&#34;https://www.linkedin.com/in/khannaisha17/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Isha Khanna&lt;/a&gt; for their invaluable contributions to this blog. Their dedicated efforts in reviewing the content and providing insightful feedback were instrumental in shaping the final version.&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;b27400c4-033d-479b-8343-f721dfb6a373&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;89dee566-0235-4f75-9899-b95adc486649&#34;,&#34;dropCap&#34;:false}&#34;&gt;在竞争中在商务旅行的世界里，效率和精确度至关重要。在优步，我们已经认识到该行业的特殊需求：高级管理人员及其助理需要简化且可靠的预订体验。为了解决这个问题，我们开发了代表预订工具，这是对我们平台的重大增强，旨在使行政助理 (EA) 能够轻松、精确地管理差旅。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bdce132a-1f3b-4f19-a1f2-74ce82231597&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4f39f205-3ed5-4ba2-8d2d-9f6f982fd4a2&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-why-we-development-delegate-booking&#34;&gt;为什么我们开发代表预订&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cf5ca665-348a-43b8-bc47-3e558630475c&#34;,&#34;dropCap&#34;:false}&#34;&gt;识别唯一性面对负责为高管安排差旅的 EA 所面临的挑战，我们看到了增强他们体验的重要机会。传统上，EA 依靠多种第三方服务来满足高管差旅的复杂需求，努力提供高质量、无缝的旅程。随着我们的代表预订工具的推出，我们提升了 Uber 的服务水平，使其符合高管旅行预期的优质标准，增强了对行程修改和沟通的控制，以提供卓越的服务体验。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;c1f9cc66-4834-41f7-adda-a275b3b3547d&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-key-considerations&#34;&gt;主要注意事项：&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f03d4af2-6cac-42e1-a472-581127608355&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;用户体验连续性&lt;/strong&gt;：为管理人员保持相同的体验质量他们自己预订了行程。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;EA 的控制和可见性&lt;/strong&gt;：为 EA 提供全面管理行程，包括灵活修改或取消行程以及直接与管理人员和司机沟通。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;核心/分隔符&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4eeac287-6e02-4d3b-9a3a-9de4d311bd10&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c349ca5a-7fe7-465c-a64e-94948ee1e968&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-the-engineering-challenge&#34;&gt;工程挑战&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;58c​​685ca-fbb1-4aa1-9074-2a1059dda1d9&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的主要焦点的目标是改进现有架构，以适应旅行预订流程中的参与者模型，旨在增强灵活性和包容性。目标是开发无缝集成，使行政助理能够轻松管理预订，同时保持高管的高质量体验。这一进步需要我们的平台管理用户角色和权限的方式进行战略转型，从而加强我们对提供更具适应性和用户友好性服务的承诺。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4cd05f6e-409e-45bf-b624-b06c5b6e7fff&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;服务扩展&lt;/strong&gt;：我们扩展了服务层，以适应多个用户配置文件的交互同一次旅行。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;通知系统&lt;/strong&gt;：我们扩展了通知系统，将相关更新发送到执行官和 EA 贯穿整个过程。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;计费和审核&lt;/strong&gt;：我们将计费引擎与新模型集成，以便财务交易准确并准确反映委托预订。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;04e1c30c-28f8-4ef9-bcab-062cc0958908&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ee2a2d83-a4ab-491a-bdca-0ca05b5c0e63&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architecture-overhaul&#34;&gt;架构大修&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;73407d17-f148-4bde-9382-3ca71aee0ea2&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeZOLNXNIy22CWLdesUzT3GBT7XLlzkgY4CUAuCBz_kof8yA-4_ydShJB8hlj3B_Py0VViO40jTSWNeNx34AgcMnCtmb-7xjZ WQvkE_kuLASRaawDK_tD8LZj-6sJMjZWRLnF3-d4_HnGEuxuyG2IW-qQo?key=DuSIbdUxytqjw1jh -r69qg&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：流程图展示了代表预订系统的高级架构流程。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0598de3d-0b4f-4f0e-afd9-36e0be5e4afc&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c6fcf013-bdb8-4bde-8656-75e237cc8447&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的平台是最初设计时采用了一个简单且以用户为中心的模型：预订乘车的人密切参与旅程的所有阶段。为了推出代表预订这一增强灵活性和包容性的功能，我们接受了整个生态系统创新的挑战。此次大规模升级涵盖 30 多种服务和 5 个不同平台，集成了从 GO、Java® 和 Node 等后端系统到 Fusion、iOS® 和 Android® 等前端应用程序的各种技术。这种整体转型不仅拓宽了我们的服务能力，也丰富了用户体验。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b82adcb0-eba2-424a-9b9e-fdcc443c9ca6&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;15953ed2-3933-4071-bc65-907942153c93&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-how-delegate-booking-works&#34;&gt;代表预订如何运作&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5eacda76-9fbc-45c1-9d44-506a91a08212&#34;,&#34;dropCap&#34;:false}&#34;&gt;代表预订工具与我们现有的基础设施深度集成：&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;98156b0e-1b17-475b-b175-bc641e1dda2a&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeALh8hTbUZpQw-bf44ErjTB6f_egaKY45HEJWOSXQ5SkvDSCY3JUB6waQJjB6tJkD9rmggKoqt3Jy8vpocQPkH8O4NxNIZE cr0xR-lcMdGRwv-zHQGqQdkYPB3QR569cpmd_qgdP-ihipjttNjUHPXbQGn?key=DuSIbdUxytqjw1jh-r69qg &#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：执行人员使用 Uber 乘客应用程序加入其 EA 后的流程图。&lt;/figcaption&gt;&lt;/figure&gt;&lt; /div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;69228b67-11cc-4ecd-bcc1-fe15859f94d4&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;hash&#34;:&#34;e815ac96-6508-4fa5-928b-164c8d245bc7&#34;,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;核心/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;用户界面&lt;/strong&gt;：管理人员通过输入 EA 的业务电子邮件并指定权限，从其 Uber 乘客应用程序中分配代理人（EA）。&lt; /里&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3d619fa0-6915-4161-8872-fd5512475cc7&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt; &lt;/strong&gt;图 3：EA 为其主管提出乘车请求后的流程图。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;start&#34;:2,&#34;hash&#34;:&#34;71a97212-c5e2-45f6-b427-fa328b476b9f&#34; ,&#34;values&#34;:&#34;&#34;}&#34; class=&#34;wp-block-list&#34; start=&#34;2&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;预订和管理&lt;/strong&gt;：EA 通过其 Uber 版本访问其委托资料乘客应用程序，他们可以在其中预订行程、选择偏好并实时管理行程详细信息。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;后端集成：&lt;/strong&gt;我们的后端系统通过确保所有数据流来支持这些操作是安全的，并且 EA 代表高管采取的每项行动都会被记录并可审计。&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cd588d27-6501-4b26-b8df-e6789336f80f&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;512eaadb-552b-4e0b-b88a-94aa9f05b86d&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-impact-and-future-directions&#34;&gt;影响和未来方向&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c3e914b3-81a3-4cc2-9e0d-504923194281&#34;,&#34;dropCap&#34;:false}&#34;&gt;引入代表预订不仅改进了我们的服务，还开辟了功能扩展的新途径。我们现在正在探索这些变化如何使其他用户群体受益，例如办公室经理或团队协调员，他们可能也需要类似的功能。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c08b4f12-e110-429d-8ecc-4c39cc2203db&#34;,&#34;dropCap&#34;:false}&#34;&gt;此功能介绍令人愉快地解锁了一个细分市场，其中另一方可以方便地预订行程，而付款则由乘客优雅地管理。这提供了灵活性和易用性，丰富了用户体验。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f62b2f4a-4ccd-4a4d-a89a-0f0f9ddf47c2&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;104ed716-f22c-4dc3-aed5-30f796f3f1a7&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-next-steps&#34;&gt;下一步附：&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;f002f771-0bd2-4138-b76b-796e8f76db4a&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-reuse-of-design&#34;&gt;设计重用：&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5a5672e2-0b55-408c-8699-0d110f417aab&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;利用现有设计框架解锁新功能&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;调整技术以支持涉及多个行程参与者的场景&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;旨在增强乘客应用上的无缝出行体验&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;1a0898c5-e275-4c6e-8c2d-362321d5385f&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-integration-into-uber-s-vision-and-goals&#34;&gt;融入 Uber 的愿景和目标：&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c3dda00d-a177-4603-8cc3-3674f3c44be8&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;通过强大的委托业务解决方案确保 Uber Platinum 取得成功&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;通过 Biz Comfort 和 Platinum 等定制业务产品拓展高端市场&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;瞄准需要高品质、行政级预订体验的用户群&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d47a2416-d276-4648-8550-f5f0871077f1&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;50e66936-b406-4fc5-8a49-31c9547d8673&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;09573c19-7a67-4a8a-8c3c-fdf15eadcf06&#34;,&#34;dropCap&#34;:false}&#34;&gt;引入优步的代表预订标志着我们服务的重大进步，特别是在商务旅行方面。此功能响应了我们客户不断变化的需求。通过让行政助理能够通过优步平台高效管理出行安排，我们努力简化物流，同时提高用户满意度和忠诚度。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5ebf37cd-6e68-4dca-baec-bf6950826d66&#34;,&#34;dropCap&#34;:false}&#34;&gt;这项创新是不仅仅是添加新功能，而是改变业务开展方式。它强调了我们对持续改进和以客户为中心的解决方案的承诺。我们将继续完善这项技术，探索新的用例并扩展其功能，以满足动态企业世界的需求。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;313f9d91-7b8b-4f45-b3f0-4370e48bf2b9&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a10a23a4-bf40-4062-a0b9-ad96265d776d&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;243f82cf-7588-49c2-b185-e6027303b0a4&#34;,&#34;dropCap&#34;:false}&#34;&gt;我想要向 &lt;a href=&#34;https://www.linkedin.com/in/saravab/&#34;&gt;Sarav&lt;/a&gt;&lt;a href=&#34;https://www.linkedin.com/in/saravab/&#34;&gt;Sarav 致以衷心的感谢/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;a&lt;/a&gt;&lt;a href=&#34;https://www.linkedin.com/in/saravab/&#34;&gt;nan Balasubramanian&lt;/a&gt;，&lt;a href =&#34;https://www.linkedin.com/in/anshukumar/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;安舒·库马尔&lt;/a&gt;，&lt;a href=&#34;https://www.linkedin.com /in/alex-cao-4ab915306?trk=contact-info&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;宁曹&lt;/a&gt; &amp;  &lt;a href=&#34;https://www.linkedin.com/in /khannaisha17/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Isha Khanna&lt;/a&gt; 感谢他们对此博客做出的宝贵贡献。他们在审查内容和提供富有洞察力的反馈方面所做的不懈努力对于最终版本的形成发挥了重要作用。&lt;/p&gt;</description>
      <pubDate>Thu, 12 Sep 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【How to Measure Design System at Scale】如何大规模测量设计系统</title>
      <link>https://www.uber.com/blog/design-system-at-scale/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;1bbfd30a-c5f4-4a2c-9079-08dda007a726&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;40c024e9-461d-490a-a802-9a2b9e1e1958&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The Uber Rider app launches features simultaneously on a global scale, changing details across hundreds of screens using thousands of feature flags. It is no longer possible for any designers, engineers, quality assurance, or product managers to fully visualize every single user flow. Uber needs an observability system of similar scale for measuring design quality to prevent subpar user experience, especially when it comes to adopting the existing UI libraries and accessibility best practices packaged under the Uber’s Design System, Base. Without such an observability system–let’s call it Design System Observability–it could be too late when Uber learned through complaints and public media about the end users who would suffer confusing onboarding rides, inconsistent layouts, and frustrating voiceovers/talkbacks sessions.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;49d10ef1-9be8-4790-9c58-d2cd2d9ae0f8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Design System Observability consists of two main components: an eye and an ear.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;493b3ad1-547a-445e-9e4e-3520390f4f93&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5fca9790-a155-4c93-b0a3-a9e3618e8b00&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-the-designer-eye-challenge&#34;&gt;The designer-eye challenge&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d57d0a35-22d2-4eed-8e32-09c9b182b651&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;It is often hard to tell by the naked eye the differences between the design specs handoffs and the final implementation in the actual apps.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2741c28a-3e02-47b0-8f86-c1bee61492e8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;a648c103-7f0b-437c-ab87-7c531e833e51&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeL3qxGyZ4RdQc-XcJ0NfNfS8DRedxiUrS7i5_yn6WekNpXxzS9vLebu5DGKhJc-BuvPNLaz3dLiVuAcNnhlebwmmA83g8PYbTT_O3R5miKOloLQ0249aeMd9hm0X2qc6jb3u1dEU3ECEFSlrYtmdBIH138?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Designer-eye challenge. Without the marking, very few could tell the “Confirm your pickup spot” sheet and the back button implementations (left) were not up to Base design hand-off (right).&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;117f1000-9871-450a-8346-c5c01ecd2e6e&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;215a40a2-231e-4648-93bb-a8bcf907e883&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXc6eOA9mbHFilS2-kDKs4CAPlzF8_EX6pzSwf0q6mt9MHal3elFV5l3wZfys_1WYQtCwa3cYb5Ze0tuxkD0asORVH4jA5U_9dkXW0cl_d1QyM00p8mqQmbGz3-3Iy_FLsorMa8ywNzIkaMBALYEgflQr0U?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: All Base UI library components were marked as green while one-off custom components were marked as red. This helped both designers and non-designers see what can be made with Base.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a74be4f8-e3a8-4b79-b19c-b608763351fc&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d1f32c48-0e7a-4280-88c5-719df13410c9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;At Uber, we strive to reuse components if they have already been built. Hence, it has become critical for us to measure this very important metric consistently like any other important engineering quality metric such as test coverage, downtime, latency, etc. Base is Uber’s design system with shared components across Design and Code. This provides a consistent user experience, with a reduced learning curve, accessibility, etc., coming for free.&amp;nbsp; Based on internal research, benefits of using Base components include 3X faster development, 4X fewer visual parity issues, 50% less code, than using custom components.&amp;nbsp; Moreover, future changes like theme and typography updates only take a few lines of code changes then rollout in matters of weeks, not months. Thus, it is important to visualize and measure Base adoption.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7a5d98bb-49bb-44c0-a8f6-1b63975c8920&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2f1c54fd-0db8-4a40-8a3d-14f51db803c4&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-deterministics-counter-the-eye-for-everyone&#34;&gt;Deterministics Counter – the eye for everyone&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;67022da3-df65-422c-b8cb-58e2b9bc34e8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;90f194d3-e033-4a1e-a9ae-d78c9ac106e4&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdCLmLnF2JBlHH_-b_C4_pDlzoj1W19mkH_L-T6es1rLuJOmcm1bpYXyzVi25TaeCC8N5ULoPdUGRpxauZbmAPa8BkR0-FLZShCt3U0MaBSrP960NAWM3JDBNWCz_ngrQWrdA3yNaV4_bftJZYkM72JGO8?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: Deterministic counter to rewards usage of Base components and discourage usage of one-off custom components in a consistent manner. Non-Base implies a layout&lt;strong&gt; looks-like-Base-but-not&lt;/strong&gt;-Base.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0975f648-bea8-40dc-aa52-9e3958039ad5&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;71746240-78b5-4d68-96c1-d6dcde51be68&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Users turn on Base Counter, see different elements on the screen getting highlighted, and understand what can be improved. This is a first-of-it-kind deterministic measurement with visual highlights for design system adoption. Instead of a small group of experts who understand design quality, now thousands of people from different functions can measure and start work items to improve their own screens, making quality at scale possible.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7f3f861c-9d2d-43f8-8da6-19017cc969f7&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;55f040cb-1a3a-4687-9612-1d26fd6ba886&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfw5FOGQNEF_eTQQjPng6wUgN1toNsOXtL6u3lRwfnI4cnvJ8TGlh9qQKcCIMIwxJGuPT4nzM_6wsVgZhRaYyfl5-IhZ4hJhwbsBh47LjqBqCgL-2_-zouDwGyq5KDeYiLadmRDLdnlk4qMQ76n8igdWvYF?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: The counting algorithm traverses view trees looking for known component classes.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c4127c18-83a1-4ec9-bb76-d1cf8c92f37e&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8fbc4092-13f1-41c2-b68c-2633e355626e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;There are three major steps in the Base Counter tooling: Trigger, Counting Algorithm, and Decorator.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;27877de6-f321-4303-b026-ab4a1565fc13&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Trigger for counting: We use an internal framework to capture the screen-level navigation, and trigger the start of the Base Counter. Periodic screen updates automatically trigger the base counting and help us in quantifying the Base stats for a screen without additional manual intervention. Using screen change as a trigger ensures that we are running the Base Counter only when it’s required.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;52414012-1889-4c7f-bd0c-adc4360d5829&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Counting algorithm: Once the tool receives a trigger it starts counting the Base stats for the screen. We first need to figure out which screen is currently being shown to the user. Starting from the application window, we find the topmost view controller that is being shown to the user. Once we get the top view controller, we start the postorder view DFS (depth-first search) traversal, starting at the root view of the top view controller.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;196c402a-6565-4169-8687-fa78b6b9d844&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Decorators were built to provide support for visualizations to developers, and to also have extensible architecture, which can support future cases when they arise. Coloring of view nodes after identification is done by using the coloring node decorator. All decorators implement the decorator protocol.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0f15accb-9ce3-4178-bde9-f215b8381e17&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;9e841c2c-ae42-4c07-99c4-422cb3cdbc5e&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd65u9UA4aUx224Lkri_fVV-9ZoxAND9c4udFQ-TTc7a1zpRlGvE5kHUuXSwTN-OND0GPDEfVqshs8gtTeVUqfjJ5dUxhgFVLFjpi2CHFI4f86Q03HKnj3VxbXIbL0dJwdsv5nvGSkkshn5h7j3nOKQrU8?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: Visitor implementations are used in order to perform the DFS post order traversal.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ebde1f52-7965-41dc-b9f1-ae8927e2f35b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;cef855c1-6162-4de2-bd2c-4d0c59fce6fe&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXf8O3iWGPdtZlcQJJqvaadzem1TuopHQl3STdzzQFIO-K51HJoWUjGq3sWLs7yVe6ab5rkBkW50BwVX2obwfUHeeLozsWhxdCaM7ytCROX54mJCP3aKdsUbFbuunnAzlzrAwR7F-IhixRQvyfGMFwAt63HL?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 6: The same deterministics counters were used across designers and engineering’s workflows. Everyone having the same goal of 100% is the key for quality at scale.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0f458bf3-49df-4b1a-a152-b862b0bc05dc&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;afb313b2-d085-48a7-b3f0-355ac5181766&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-the-have-you-heard-questions&#34;&gt;The have-you-heard questions&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a5eee0d6-77a7-45b7-8be3-46a8535f96f7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our teammates often ask each other questions like: “Have you heard about that new home screen launch for the India market?” or “When did that Uber shortcuts experience launch?”&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fcb5b01e-d319-463d-98ee-94a6a5e17743&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In apps like Uber, it’s common to have a wide variety of user experiences coexisting, due to its massive user base spread across different regions. The feature teams are also very scattered across Uber offices around the world, and work independently. Each feature team conducts A/B experiments to determine the design that offers the best user engagement. Additionally, legal requirements may necessitate displaying certain screens in specific regions of the world. This makes it challenging to objectively tag a screen with a single Base stats metric at scale, as changes in its UI composition results in different Base stats for the screen.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cf9907b1-022b-48e1-abcf-f949f7ab5269&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We experimented with various aggregation techniques and ultimately decided to use the mode of all the baseline metrics as the single metric for tagging a screen. The mode automatically captures what the majority of users are actually viewing on your screen.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2dba1e37-8c3c-4fb3-af74-2280679e72c6&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bc568ad2-3020-49d9-8f34-f6b2c2deb93d&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-daily-automated-analysis-the-ear-to-stay-on-top-of-launches&#34;&gt;Daily Automated Analysis – the ear to stay on top of launches&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;28385019-f299-4e66-989d-3bdd2290b827&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;With the Base Counter tooling we have the tool required to calculate the score, but we still have to manually go count this on each screen. We need a pipeline to measure thousands of different screens.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;91e9bc8c-04b4-486a-8430-464b5cc10d93&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We deployed two complementary approaches to automation. The first approach gathers the broad statistics through analytics events triggered by default for all internal testers. Another approach using testing frameworks to take screenshots and run in-depth analysis including which components were used as well as known custom components we want to track.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7dfb6a03-a8fc-4644-a0ec-854c4073565c&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;04ad8918-1b92-405f-9abf-79cd885387c7&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdX1M28ZwFPnYeiMYWj1S7U9PVQz5VywU9F_rl2yHawu9sN1tnoH2ZajgUIdy95ZkcEPl_lANvlrSdVdLV2OGnmdykI9xjJ3zMUmTPUtGCOO0xwk2wUzM4Mr0TeDeiriypfB0EoxpjRdGD59fqq5iRMZ5Mi?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 7: Broad statistics were aggregated across all users, providing us with crowdsourced data that reflected real-world usage.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;595a2b59-caaa-4083-b589-0fce16984928&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;a9d5982f-654a-4c2f-a651-9b477598fb0e&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdKPpgKoXCpo7M_VKatHVMVveCWUu5AfudfdQLW93XH_LOXjtLCkaSP69azrJUfbrhGOmEGrnL0Bk2wfdLetQjsoR5HY1CoiJaQ0q9x3PEoI3LEvhhNjZWj4mevibTYuJoYf_K5J-ziGkp2oMesqGjrI8s?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 8: Existing E2E test suites were utilized to take regular screenshots and calculate detailed design metrics&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;db9c0dc9-645b-4f60-ac17-6e608cea234b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;01b6455e-1689-43ad-96fa-ba491065b137&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;With each screen having a defined quality score, we can track it on daily CD builds. Any violations would result in an automated Jira ticket assigned to the respective screen-owning Design and Engineering managers. Combining this automated process with a human Feature Review Readiness process where stakeholders verify the scores, we will ensure that &lt;strong&gt;future developments do not degrade and only improve design quality.&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a1358661-b081-4231-9504-7e78408454ac&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;51e475b8-8dbf-4648-a3ff-d65274298f1a&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-real-world-examples&#34;&gt;Real-world examples&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e8578000-0135-4beb-8264-a3669e632519&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The new eye and ear have helped every product team of Uber Rider drive towards the same goal.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b51cf021-5eaa-4784-b96b-ada731b9ba1a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;922d454f-a38f-46e7-8792-87f93f1bfe97&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd0hhhqBPZipIXgy0yQhJu8ymY1M1DsUOR7FCbpzjy_Vkl5bBbIsLB3IVGcLcmdb4dXYReimcXV91Pl5e-UQZyQezS9mVgJ6mxlfqqXCuYeX3EgSrRMS44vPoNQKGfHhLJhiXrPmG0HsUqeOcqaMLwmj0uA?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 9: Real impacts where many engineer teams improved Uber screens in seamless coordination thanks to Design System Observability (measured in June 2024, Rider iOS app).&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;09dcb249-c4a2-402a-9ca2-af1b44f7fef3&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;5ad2797e-a62d-4112-9f18-30c780da9509&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXex8WJYFlzCswieg89VpxSAeQ6wmHchXHM9cajUWQko-Gtjb3dshS6A64pVr-IqrPvN83ethSl5C1JXTIzv27LuqCIRt63kBE1QXpWYurwfBbDOiu2rN6l1WHa9bgFmBAd42mIVOD7bhV-e2M5k-VXn_ZU?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 10: When hearing about an accidental design degradation due to an infrastructure migration in early 2024, our engineer teams jumped in to fix it quickly.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8876cdc1-0958-4cc8-a4da-d155e3ba9008&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;5340daa7-c26c-4a22-ad3e-f52f324ac7c9&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b6c7d762-c2df-44b1-ad02-64704695771d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We believe Design System Observability is a must-have for any technology organization that needs both velocity and quality. Here are our learnings:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;hash&amp;quot;:&amp;quot;6a851675-e21a-4995-b035-edf83892f173&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;While all teams expressed enthusiasm for applying a Design System, most have competing priorities. &lt;strong&gt;Hence, it is important to have a shared and trackable OKR.&lt;/strong&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;There’s a lack of shared understanding about what a Design System truly encompasses. Some believe that simply using a text style or a color style is enough, while others attempt to recreate a component’s appearance without leveraging the existing code. &lt;strong&gt;Defining a Design System metrics meant to define an organization’s design quality expectations.&lt;/strong&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Always assume people have good intentions and degradation is caused by the lack of guardrails. &lt;strong&gt;The earlier an issue is caught in the product development pipeline, the fewer days it takes to fix it&lt;/strong&gt;.&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9fd7887e-e466-495a-a867-3d84e94d87c4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;At the end of the day, all Uber teams want to improve user experience, but often get lost in finding design resources or reaching out to other teams. These metrics were excellent conversation starters for both the Design and Engineering teams to improve their checkpoint and handoff experiences.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4a19d319-1f1d-4089-aaba-cd2cdd250adb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our biggest win has been elevating design metrics to be as important as engineering and business metrics. It was a journey of steady progress, starting with building awareness around Base, our design system. We hosted Base Race challenges to encourage adoption, and eventually secured executive buy-in for adoption push. Trust was built through countless hours of manual audits with domain experts. We addressed pushbacks, refined our methodology, and aligned more managers. Today, what once took hours of manual work each month is now an automated system accessible to everyone, highlighting the impact of our design system journey.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9a506791-e872-4ec0-ae5d-09df36edad58&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;5f67ce36-7698-452c-a571-435ca78b7eec&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXefjemrgY8I6CrwkLCvlMhMLlNiUYswBRG8GdMJdLvYMNcWqWiU6YIbkTBualhR4pejGLdYTnxYnldbg7RblX113O0ZioaFDVSdcKbYS-NzhaWlE1FLk37Qq67cEmC80Z-yTPRTaX018OitHGtXVzoH0JM?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 11: Design System metric is now a trackable business-impact metric&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;636b413c-700f-457a-a5ec-d9e1f799ce73&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;efaeabaf-0112-4202-b969-1863148d1663&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Above was our work with the Rider Android and iOS apps, we will apply the approach to the broader Uber product portfolios. In the future, as Uber constantly evolves different technology stacks within Android, iOS, and Web, the Design System Observability will be an effective system to stop reinventing UI components, launching accessible features, and rolling out high-quality design to thousands of screens quickly. We also have many partners in the company from content designers to researchers who are interested in building on top of our system to deliver best practices at scale. More metrics to come.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3fa19de8-bce5-4ec3-8771-90345318ab8a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e000362e-2d80-400a-af80-22924e3aeefc&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;Acknowledgments&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;d15be2d3-1845-4ee6-915b-33556770ab1e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Special thank you to Mohit Gupta, Reshma Naik, Anukalp Katyal, Arun Babu A S P,&amp;nbsp; Lucia Pineda, and other colleagues for your technical contributions to the Design System Observability infrastructure.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;36cee99a-8ad4-4884-8763-00cff8240e0c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Last but not least, this project can’t happen without the love and attention to details of our Design System team at base.uber.com and the support of the Uber Design organization.&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;1bbfd30a-c5f4-4a2c-9079-08dda007a726&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;40c024e9-461d-490a-a802-9a2b9e1e1958&#34;,&#34;dropCap&#34;:false}&#34;&gt;优步乘客应用程序在全球范围内同时启动功能，使用数千个功能标志在数百个屏幕上更改详细信息。任何设计师、工程师、质量保证或产品经理不再可能完全可视化每个用户流程。 Uber 需要一个类似规模的可观测系统来衡量设计质量，以防止用户体验不佳，特别是在采用 Uber 设计系统 Base 下打包的现有 UI 库和可访问性最佳实践时。如果没有这样的可观察性系统（我们称之为设计系统可观察性），当 Uber 通过投诉和公共媒体了解最终用户将遭受令人困惑的入职行程、不一致的布局和令人沮丧的画外音/对讲会话时，可能就太晚了。&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;49d10ef1-9be8-4790-9c58-d2cd2d9ae0f8&#34;,&#34;dropCap&#34;:false}&#34;&gt;设计系统可观察性由两个主要部分组成：眼睛和耳朵。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;493b3ad1-547a-445e-9e4e-3520390f4f93&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5fca9790-a155-4c93-b0a3-a9e3618e8b00&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-the-designer-eye-challenge&#34;&gt;设计师眼睛挑战&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d57d0a35-22d2-4eed-8e32-09c9b182b651&#34;,&#34;dropCap&#34;:false}&#34;&gt;通常是肉眼很难看出设计规范交接与实际应用中的最终实现之间的差异。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2741c28a-3e02-47b0-8f86-c1bee61492e8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;a648c103-7f0b-437c-ab87-7c531e833e51&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeL3qxGyZ4RdQc-XcJ0NfNfS8DRedxiUrS7i5_yn6WekNpXxzS9vLebu5DGKhJc-BuvPNLaz3dLiVuAcNnhlebwmmA83 g8PYbTT_O3R5miKOloLQ0249aeMd9hm0X2qc6jb3u1dEU3ECEFSlrYtmdBIH138?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34;referrerpolicy =&#34;no-referrer&#34;&gt;&lt;figcaption 类=&#34;wp-element-caption&#34;&gt;图 1：设计师眼中的挑战。如果没有标记，很少有人能看出“确认您的上车地点”表和后退按钮实现（左）不符合 Base 设计交接（右）的要求。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;117f1000-9871-450a-8346-c5c01ecd2e6e&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;215a40a2-231e-4648-93bb-a8bcf907e883&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXc6eOA9mbHFilS2-kDKs4CAPlzF8_EX6pzSwf0q6mt9MHal3elFV5l3wZfys_1WYQtCwa3cYb5Ze0tuxkD0asORVH4jA 5U_9dkXW0cl_d1QyM00p8mqQmbGz3-3Iy_FLsorMa8ywNzIkaMBALYEgflQr0U?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; 推荐策略=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：所有基本 UI 库组件都标记为绿色，而一次性自定义组件则标记为红色。这有助于设计师和非设计师了解可以用 Base 制作什么。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a74be4f8-e3a8-4b79-b19c-b608763351fc&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d1f32c48-0e7a-4280-88c5-719df13410c9&#34;,&#34;dropCap&#34;:false}&#34;&gt;在 Uber，如果组件已经构建，我们会努力重用它们。因此，对我们来说，像测试覆盖率、停机时间、延迟等任何其他重要的工程质量指标一样，一致地衡量这个非常重要的指标变得至关重要。Base 是 Uber 的设计系统，在设计和代码中具有共享组件。这提供了一致的用户体验，并减少了学习曲线、可访问性等，而且是免费的。  根据内部研究，与使用自定义组件相比，使用基础组件的好处包括开发速度提高 3 倍、视觉奇偶校验问题减少 4 倍、代码减少 50%。  此外，主题和排版更新等未来的变化只需要几行代码更改，然后在几周而不是几个月内推出。因此，可视化和衡量 Base 采用情况非常重要。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7a5d98bb-49bb-44c0-a8f6-1b63975c8920&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2f1c54fd-0db8-4a40-8a3d-14f51db803c4&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-deterministics-counter-the-eye-for-everyone&#34;&gt;确定性计数器 – 每个人的眼睛&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;67022da3-df65-422c-b8cb-58e2b9bc34e8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha -通道不透明度&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;90f194d3-e033-4a1e-a9ae-d78c9ac106e4&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdCLmLnF2JBlHH_-b_C4_pDlzoj1W19mkH_L-T6es1rLuJOmcm1bpYXyzVi25TaeCC8N5ULoPdUGRpxauZbmAPa8BkR0-FLZ ShCt3U0MaBSrP960NAWM3JDBNWCz_ngrQWrdA3yNaV4_bftJZYkM72JGO8?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：奖励使用基本组件并阻止以一致的方式使用一次性自定义组件的确定性计数器。 Non-Base 意味着布局&lt;strong&gt;看起来像-Base-但不是&lt;/strong&gt;-Base。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0975f648-bea8-40dc-aa52-9e3958039ad5&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;71746240-78b5-4d68-96c1-d6dcde51be68&#34;,&#34;dropCap&#34;:false}&#34;&gt;用户开启基本计数器，查看屏幕上突出显示的不同元素，并了解可以改进的地方。这是首个确定性测量，具有设计系统采用的视觉亮点。现在，来自不同职能部门的数千名人员可以衡量并启动工作项目来改进自己的屏幕，从而使大规模质量成为可能，而不是一小群了解设计质量的专家。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7f3f861c-9d2d-43f8-8da6-19017cc969f7&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;55f040cb-1a3a-4687-9612-1d26fd6ba886&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfw5FOGQNEF_eTQQjPng6wUgN1toNsOXtL6u3lRwfnI4cnvJ8TGlh9qQKcCIMIwxJGuPT4nzM_6wsVgZhRaYyfl5-IhZ4 hJhwbsBh47LjqBqCgL-2_-zouDwGyq5KDeYiLadmRDLdnlk4qMQ76n8igdWvYF?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 4：计数算法遍历视图树查找已知组件类。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c4127c18-83a1-4ec9-bb76-d1cf8c92f37e&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p 数据-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8fbc4092-13f1-41c2-b68c-2633e355626e&#34;,&#34;dropCap&#34;:false}&#34;&gt;Base Counter主要分为三个步骤工具：触发器、计数算法和装饰器。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;27877de6-f321-4303-b026-ab4a1565fc13&#34;,&#34;dropCap&#34;:false}&#34;&gt;计数触发器：我们使用内部框架来捕获屏幕级导航，并触发基本计数器的启动。定期屏幕更新会自动触发基本计数，并帮助我们量化屏幕的基本统计数据，而无需额外的手动干预。使用屏幕更改作为触发器可确保我们仅在需要时运行基本计数器。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;52414012-1889-4c7f-bd0c-adc4360d5829&#34;,&#34;dropCap&#34;:false}&#34;&gt;计数算法：一旦该工具收到触发器，它就会开始计算屏幕的基本统计数据。我们首先需要弄清楚当前正在向用户显示哪个屏幕。从应用程序窗口开始，我们找到向用户显示的最顶层视图控制器。一旦我们获得顶视图控制器，我们就开始后序视图 DFS（深度优先搜索）遍历，从顶视图控制器的根视图开始。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;196c402a-6565-4169-8687-fa78b6b9d844&#34;,&#34;dropCap&#34;:false}&#34;&gt;构建了装饰器为开发人员提供可视化支持，并且还具有可扩展的架构，可以在未来出现的情况下支持它们。识别后视图节点的着色是使用着色节点装饰器完成的。所有装饰器都实现装饰器协议。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0f15accb-9ce3-4178-bde9-f215b8381e17&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;9e841c2c-ae42-4c07-99c4-422cb3cdbc5e&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd65u9UA4aUx224Lkri_fVV-9ZoxAND9c4udFQ-TTc7a1zpRlGvE5kHUuXSwTN-OND0GPDEfVqshs8gtTeVUqfjJ5dUx hgFVLFjpi2CHFI4f86Q03HKnj3VxbXIbL0dJwdsv5nvGSkkshn5h7j3nOKQrU8?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：使用访问者实现来执行 DFS 后序遍历。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ebde1f52-7965-41dc-b9f1-ae8927e2f35b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator has-alpha-channel-op”能力&gt;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;cef855c1-6162-4de2-bd2c-4d0c59fce6fe&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXf8O3iWGPdtZlcQJJqvaadzem1TuopHQl3STdzzQFIO-K51HJoWUjGq3sWLs7yVe6ab5rkBkW50BwVX2obwfUHeeLozsWhx dCaM7ytCROX54mJCP3aKdsUbFbuunnAzlzrAwR7F-IhixRQvyfGMFwAt63HL?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34; 推荐策略=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 6：设计人员和工程人员的工作流程中使用了相同的确定性计数器。每个人都有 100% 的相同目标，这是大规模质量的关键。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0f458bf3-49df-4b1a-a152-b862b0bc05dc&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;afb313b2-d085-48a7-b3f0-355ac5181766&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-the-have-you-heard-questions&#34;&gt;你听说过的问题&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a5eee0d6-77a7-45b7-8be3-46a8535f96f7&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的队友经常互相询问以下问题：“您听说过针对印度市场推出的新主屏幕吗？”或“Uber 快捷方式什么时候推出？” &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fcb5b01e-d319-463d-98ee-94a6a5e17743&#34;,&#34;dropCap&#34;:false}&#34;&gt;在以下应用中Uber，由于其庞大的用户群分布在不同地区，因此多种用户体验并存是很常见的。功能团队也非常分散在世界各地的 Uber 办事处，并且独立工作。每个功能团队都会进行 A/B 实验，以确定提供最佳用户参与度的设计。此外，法律要求可能需要在世界特定地区显示某些屏幕。这使得使用单个基本统计数据指标客观地大规模标记屏幕变得具有挑战性，因为其 UI 组成的变化会导致屏幕的基本统计数据不同。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cf9907b1-022b-48e1-abcf-f949f7ab5269&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们尝试了各种聚合技术，最终决定使用所有基线指标的模式作为标记屏幕的单一指标。该模式会自动捕获大多数用户在屏幕上实际查看的内容。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2dba1e37-8c3c-4fb3-af74-2280679e72c6&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp”-块分隔符具有 alpha 通道不透明度&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bc568ad2-3020-49d9-8f34-f6b2c2deb93d&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-daily-automated-analysis-the-ear-to-stay-on-top-of-launches&#34;&gt;每日自动分析 – 随时掌握发布动态的耳朵&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;28385019-f299-4e66-989d-3bdd2290b827&#34;,&#34;dropCap&#34;:false}&#34;&gt;与底座计数器工具我们有计算分数所需的工具，但我们仍然必须在每个屏幕上手动进行计数。我们需要一个管道来测量数千个不同的屏幕。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;91e9bc8c-04b4-486a-8430-464b5cc10d93&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们部署了两个自动化的补充方法。第一种方法通过默认为所有内部测试人员触发的分析事件收集广泛的统计数据。另一种方法是使用测试框架来截取屏幕截图并运行深入分析，包括使用了哪些组件以及我们想要跟踪的已知自定义组件。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7dfb6a03-a8fc-4644-a0ec-854c4073565c&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;04ad8918-1b92-405f-9abf-79cd885387c7&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdX1M28ZwFPnYeiMYWj1S7U9PVQz5VywU9F_rl2yHawu9sN1tnoH2ZajgUIdy95Zk cEPl_lanvlrSdVdLV2OGnmdykI9xjJ3zMUmTPUtGCOO0xwk2wUzM4Mr0TeDeiriypfB0EoxpjRdGD59fqq5iRMZ5Mi?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 7：汇总了所有用户的广泛统计数据，为我们提供了反映实际使用情况的众包数据。&lt;/figcaption &gt;&lt;/图&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;595a2b59-caaa-4083-b589-0fce16984928&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;a9d5982f-654a-4c2f-a651-9b477598fb0e&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src =“https://lh7-rt.googleusercontent.com/docsz/AD_4nXdKPpgKoXCpo7M_VKatHVMVveCWUu5AfudfdQLW93XH_LOXjtLCkaSP69azrJUfb rhGOmEGrnL0Bk2wfdLetQjsoR5HY1CoiJaQ0q9x3PEoI3LEvhhNjZWj4mevibTYuJoYf_K5J-ziGkp2oMesqGjrI8s?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 8：存在使用 E2E 测试套件定期进行屏幕截图并计算详细的设计指标&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;db9c0dc9-645b-4f60-ac17-6e608cea234b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;01b6455e-1689-43ad-96fa-ba491065b137&#34;,&#34;dropCap&#34;:false}&#34;&gt;每个屏幕有了定义的质量分数，我们可以在每日 CD 构建中跟踪它。任何违规行为都会导致自动将 Jira 票证分配给各自拥有屏幕的设计和工程经理。将此自动化流程与利益相关者验证分数的人工功能审查准备流程相结合，我们将确保&lt;strong&gt;未来的开发不会降低而只会提高设计质量。&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a1358661-b081-4231-9504-7e78408454ac&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;51e475b8-8dbf-4648-a3ff-d65274298f1a&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-real-world-examples&#34;&gt;真实世界示例&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e8578000-0135-4beb-8264-a3669e632519&#34;,&#34;dropCap&#34;:false}&#34;&gt;新眼睛和 Ear 帮助 Uber Rider 的每个产品团队朝着同一个目标前进。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b51cf021-5eaa-4784-b96b-ada731b9ba1a&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;922d454f-a38f-46e7-8792-87f93f1bfe97&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd0hhhqBPZipIXgy0yQhJu8ymY1M1DsUOR7FCbpzjy_Vkl5bBbIsLB3IVGcLcmdb4dXYReimcXV91Pl5e-UQZyQezS9mVgJ6 mxlfqqXCuYeX3EgSrRMS44vPoNQKGfHhLJhiXrPmG0HsUqeOcqaMLwmj0uA?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34;referrerpolicy=&#34; no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 9：由于设计系统可观察性（2024 年 6 月测量，Rider iOS 应用程序），许多工程师团队无缝协调地改进了 Uber 屏幕，产生了实际影响。&lt;/图标题&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;09dcb249-c4a2-402a-9ca2-af1b44f7fef3&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&amp;quot;,&#34;hash&#34;:&#34;5ad2797e-a62d-4112-9f18-30c780da9509&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt .googleusercontent.com/docsz/AD_4nXex8WJYFlzCswieg89VpxSAeQ6wmHchXHM9cajUWQko-Gtjb3dshS6A64pVr-IqrPvN83ethSl5C1JXTIzv27LuqCIRt63kBE1QXpWYurwfBbDOiu2rN6l1WHa9bgF mBAd42mIVOD7bhV-e2M5k-VXn_ZU?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 10：听到时关于 2024 年初基础设施迁移导致的意外设计退化，我们的工程师团队迅速介入修复。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8876cdc1-0958-4cc8-a4da-d155e3ba9008&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;5340daa7-c26c-4a22-ad3e-f52f324ac7c9&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b6c7d762-c2df-44b1-ad02-64704695771d&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们相信设计系统可观察性是任何需要速度和质量的技术组织的必备条件。以下是我们的经验教训：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;hash&#34;:&#34;6a851675-e21a-4995-b035-edf83892f173&#34;,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;虽然所有团队都表达了应用设计系统的热情，但大多数团队都有相互竞争的优先事项。 &lt;strong&gt;因此，拥有一个共享且可追踪的 OKR 非常重要。&lt;/strong&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;对于设计系统真正包含的内容缺乏共识。有些人认为简单地使用文本样式或颜色样式就足够了，而另一些人则尝试在不利用现有代码的情况下重新创建组件的外观。 &lt;strong&gt;定义设计系统指标旨在定义组织的设计质量期望。&lt;/strong&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;始终假设人们的意图是好的，而退化是由于缺乏护栏造成的。 &lt;strong&gt;在产品开发流程中越早发现问题，解决问题所需的天数就越少&lt;/strong&gt;。&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9fd7887e-e466-495a-a867-3d84e94d87c4&#34;,&#34;dropCap&#34;:false}&#34;&gt;最后如今，所有 Uber 团队都希望改善用户体验，但常常在寻找设计资源或联系其他团队时迷失方向。这些指标对于设计和工程团队来说都是很好的对话起点，可以改善他们的检查点和切换体验。&lt;/p&gt;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4a19d319-1f1d-4089-aaba-cd2cdd250adb&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们最大的胜利一直在提升设计指标与工程和业务指标一样重要。这是一个稳步进步的旅程，首先是围绕我们的设计系统 Base 建立意识。我们举办了基础竞赛挑战赛以鼓励采用，并最终获得了高管的支持以推动采用。信任是通过与领域专家进行无数个小时的手动审核而建立的。我们解决了阻力，完善了我们的方法，并协调了更多的管理人员。如今，曾经每月需要花费数小时手动工作的系统现在已成为每个人都可以使用的自动化系统，凸显了我们设计系统之旅的影响。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9a506791-e872-4ec0-ae5d-09df36edad58&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;5f67ce36-7698-452c-a571-435ca78b7eec&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXefjemrgY8I6CrwkLCvlMhMLlNiUYswBRG8GdMJdLvYMNcWqWiU6YIbkTBualhR4pejGLdYTnxYnldbg7RblX113O0ZioaFDVS dcKbYS-NzhaWlE1FLk37Qq67cEmC80Z-yTPRTaX018OitHGtXVzoH0JM?key=7feEAiFy2WYWGVjQFc7yPQ&#34; alt=&#34;&#34;referrerpolicy =&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 11：设计系统指标现在是可跟踪的业务影响指标&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;636b413c-700f-457a-a5ec-d9e1f799ce73&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;efaeabaf-0112-4202-b969-1863148d1663&#34;,&#34;dropCap&#34;:false}&#34;&gt;以上是我们的通过与 Rider Android 和 iOS 应用程序合作，我们将把该方法应用到更广泛的 Uber 产品组合中。未来，随着 Uber 在 Android、iOS 和 Web 中不断发展不同的技术堆栈，设计系统可观察性将成为一个有效的系统，以停止重新发明 UI 组件、推出可访问的功能以及快速将高质量设计推广到数千个屏幕。我们公司还有许多合作伙伴，从内容设计师到研究人员，他们有兴趣在我们的系统之上构建以大规模提供最佳实践。更多指标即将推出。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3fa19de8-bce5-4ec3-8771-90345318ab8a&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e000362e-2d80-400a-af80-22924e3aeefc&#34;,&#34;level&#34;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;d15be2d3-1845-4ee6-915b-33556770ab1e&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;特别感谢 Mohit Gupta、Reshma Naik、Anukalp Katyal、Arun Babu A SP、Lucia Pineda 和其他同事对设计系统可观测性基础设施的技术贡献。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;36cee99a-8ad4-4884-8763-00cff8240e0c&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;最后但并非最不重要的一点是，如果没有 base.uber.com 设计系统团队对细节的热爱和关注以及来自Uber 设计组织。&lt;/p&gt;</description>
      <pubDate>Tue, 24 Sep 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【Preon: Presto Query Analysis for Intelligent and Efficient Analytics】Preon：用于智能高效分析的 Presto 查询分析</title>
      <link>https://www.uber.com/blog/preon/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;bd450234-c86f-4e6f-b773-8427ffd60fe8&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;66363a5e-b873-4dbc-bd75-c1e14743f43b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Presto&lt;sup&gt;™&lt;/sup&gt; is an open source SQL query engine used on a large scale at Uber. Uber has around 20+ Presto clusters comprising over 12,000 hosts. We have about 7,000 weekly users and run about half a million queries per day. Presto has various use cases at Uber like ad hoc interactive analytics, ETL and batch workloads, dashboarding, data quality checks, report generation, experimentation, and data-driven services. Due to the scale of the system, there are various opportunities to make&amp;nbsp; it more efficient. However, these opportunities need intelligence regarding the queries being processed by the system.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2c7041ea-bb35-461e-89b3-398712c78fc8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cc06ed60-e777-487c-a9f2-0e4303c9163e&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-motivation-background-behind-project&#34;&gt;Motivation/Background Behind Project&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4254560c-9953-49fb-afa0-55312937048a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Presto is a query engine and provides an SQL interface for running queries, but there are many cases where we need to be able to analyze queries in order to get specific actionable insights. Some examples are:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ca8e6ab2-c196-4ae8-8906-67b76809af08&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;To be able to analyze predicates used to query tables&lt;/strong&gt; – This can be used to reformat (sort, bucket, partition) the tables on those columns leading to less data being read from the backend during query execution and faster and more efficient queries.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;To be able to ascertain the tables/columns being read/written in the query&lt;/strong&gt; – This can be used to route queries to specific clusters based on availability of those tables in specific regions of the Uber data lake or to do permissions checks.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;To determine the type of a query –&lt;/strong&gt; For example, DDL/DML to route ETL queries to certain clusters.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;To ascertain what is the most recent modification time of any of the datasets being queried –&lt;/strong&gt; This can be used to ascertain if results from a previous run of the query are still valid and can be reused instead of rerunning the query.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;To fingerprint queries&lt;/strong&gt; – There are many use cases where we need to know if a query is the same or similar to a previous query. The fingerprint has to be immune to whitespaces and comments in the query and thus just a string hash does not work very well. Finding similar queries (e.g., queries with only the literal values changed are even more difficult.)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;To validate queries&lt;/strong&gt; – It is important to fail queries with syntax errors early, at the time of submission itself rather than the query having to get through the queue and fail when it starts running.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5381540a-abc2-44dd-b1b1-8c0773a4d195&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;All these analyses need to be able to parse the query structurally. Before we created Preon, all query analysis was done in the context of executing the query in a Presto cluster and on completion the analysis results were published to a Presto Query Events topic along with other stats related to the query execution. Also, logging any arbitrary information was difficult since the information had to be generated in the course of executing the query (i.e., either in the analysis/planning/optimization or execution phase and carried forward to the point of query completion). Also, the analysis code had to be carried as a private patch in the main Uber Presto repo, which could become problematic when upgrading Presto.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b2d3aefc-ff9c-4c13-a798-36476ef27a15&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Query Execution and Query Analysis are two different services with very different form factors, as summarized below:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/table&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;91d0850d-c45f-4362-9b6f-46281b135fb0&amp;quot;,&amp;quot;hasFixedLayout&amp;quot;:true,&amp;quot;head&amp;quot;:[],&amp;quot;body&amp;quot;:[],&amp;quot;foot&amp;quot;:[]}&#34; class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;Query Analysis&lt;/td&gt;&lt;td&gt;Query Execution&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Needs to only parse/analyze/optimize query&lt;/td&gt;&lt;td&gt;Needs to parse/analyze/plan/execute query&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Needs to only be a standard microservice&lt;/td&gt;&lt;td&gt;Runs in distributed clusters on bare metal (for performance), multiple clusters per DC&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Any information can be logged at any time&lt;/td&gt;&lt;td&gt;Logging is limited to query completion; any information to be logged has to be brought to that point&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Standard CI/CD for microservices; changes can be deployed fast&lt;/td&gt;&lt;td&gt;Making changes is slow; needs to be deployed after land on every cluster separately&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Each type of analysis can be a separate endpoint&lt;/td&gt;&lt;td&gt;Only a single query execution endpoint&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;An analysis can return a result, log the result to a DB, or return a transformed query&lt;/td&gt;&lt;td&gt;The only output is the query execution results&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;An analysis can involve multiple queries (e.g., to find common structures between them)&lt;/td&gt;&lt;td&gt;Each query is run independently&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Analysis can be done offline (e.g., by tailing a Kafka topic on query completions)&lt;/td&gt;&lt;td&gt;Online by definition&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;We can do the analysis using the Presto modules as libraries&lt;/td&gt;&lt;td&gt;Would involve making changes in the core engine code&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Service can be scaled automatically horizontally by the Uber auto-scaler based on traffic&lt;/td&gt;&lt;td&gt;Static configuration&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Does not need powerful machines&lt;/td&gt;&lt;td&gt;Presto coordinators need powerful hosts&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;26b7b3c6-8556-402c-95b0-d6f9fdadc04f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8c3db597-494e-4e4b-bcac-90f7826b2ebd&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8257d41f-eb1f-4c4a-88cb-a47fa933b414&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architecture&#34;&gt;Architecture&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2828b7bc-4c9a-42a7-a668-4af59489c735&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The requirements for the query analysis service were:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;hash&amp;quot;:&amp;quot;c9162000-c285-4487-8079-a5b5ac796f95&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;It should be able to run in a microservice form factor in the Uber Stateless Microservices platform (UP).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;The service should have a minimal CPU/memory footprint.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;The service should have 100% coverage for all Presto query shapes at Uber (including in-house UDFs).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;The service should have 100% coverage for the entire Uber Data Lake (i.e., support for all Presto connectors and catalogs).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;The analysis should be done based on the current state of the Uber Data Lake by talking to the production catalogs.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;The analyzed query should be similar to the query that would be in production (i.e., with all the transformations and optimizations that would happen during query execution).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Ability to parse non-Presto query shapes was not a requirement.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Fast development times (i.e., any new analysis should not require a change in the Presto modules, but could be done in the microservice itself).&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e84d7e0d-cf4e-4855-b40e-60dd0b7cdc1e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The query parsing could have been done using an Apache Calcite&lt;sup&gt; ™&lt;/sup&gt; parser. This would have had the advantage of being able to parse non-Presto query shapes, too. However, it had the following drawbacks:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;hash&amp;quot;:&amp;quot;f8388119-bd75-45cf-b643-a219d21c19f6&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Apache Calcite might not be able to parse all Presto query shapes.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;We not only need to be able to parse the query, but analyze and even optimize the query using the Presto production optimization rules.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;We wanted to be able to share code (e.g., query fingerprinting logic) between the Production Presto and Preon as needed.&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fd22bc68-bb09-42af-bb1b-cdeacb1caf33&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;295c9374-a11a-4f80-b331-8e26ec571b4b&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-service-design&#34;&gt;Service Design&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b3f8ff74-ccac-46c7-a6c8-5efe2c8a18f1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The service was designed in the shape of a microservice that creates a mini Presto server with various REST interfaces added to enable different analyses. Since the Presto server would not need to talk to any workers, all HTTP clients and task communication machinery was removed from the server.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096434,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;bb88323e-9c76-45c5-82b8-2a3c739f060e&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;387&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure1-17273059861351-1024x387.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096434&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure1-17273059861351.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure1-17273059861351.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure1-17273059861351.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1406,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure1-17273059861351.png 1406w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Preon as a microservice&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a8c501ed-041a-4309-abf9-bba93b7e588e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;77602bf6-d93d-4183-8c5c-18a5e647fa6a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The Preon service uses Presto modules from the Uber Presto repo in order to do the analysis. We have had to make minimal changes to the Presto modules for them to be used by Preon. In addition, we also had to create a presto-preon module in Presto to give us the bindings to instantiate this mini Presto Server.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;649be9b5-d9e6-4f43-98cf-c4b4df59c423&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Preon provides internal APIs to:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c68a3b01-9f2c-406d-8da2-7a7d62bd2d51&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Create query statement i.e. just parse the Query&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Analyze query i.e. resolve table and columns against the production data lake&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Create a Plan for a Query with full Planning Optimizers&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Create a Plan for a Query with a given list of Optimizers&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;656a78f5-ebdd-49ba-9331-eb20c3599321&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In general the analyzers then implement the analysis as a visitor on the in memory parsed/analyzed/optimized query. Various analysis endpoints have been created in Preon using these internal APIs. Some example analysis are:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9d8a3e46-4cad-44d5-9f2d-614af2536f77&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Predicate Analysis: This endpoint takes a query and returns the predicate columns that are used to filter data from a table and their predicate values. A query such as “select * from some_table where uuid = 20” would return a predicate of &amp;lt;table:some_table, column: uuid, value: 20&amp;gt;. Only single value and range value predicates are returned.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b5336b99-145a-4f98-94e9-689115ea9289&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;LastUpdate: This endpoint takes a query and returns the last modification time of any of the datasets read in the query. It does this by creating a query plan (the same plan that would be created by production Presto) and for each leaf tablescan node, gets the last modification time as registered in HMS. Optionally the endpoint can look further into the modification time of files in Uber Data lake as well.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;67efa249-937e-4fad-974b-4cb1beac3db4&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Materialized view: The endpoint ascertains whether a given query is candidate for improvement using a materialized view. To meet this criteria, the query should have been aggregated by one partition column throughout the query. Then the query can be potentially sped up by materializing the computation for a partition only once.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;15fa67f7-fe84-462a-b207-7d603f2b417e&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Structural validation of a query e.g. syntax errors&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fc543375-b0eb-48bc-9314-f1e498b7ba96&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Getting the list of tables/columns read/updated by the given query.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;52afa3f2-7535-4af8-8b53-3422a31c1a33&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b53c993b-1cdb-469e-af23-5085a399c56a&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-development-and-deployment-challenges&#34;&gt;Development and Deployment Challenges&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;69e2fa78-b887-464e-b61a-5cf9ac9cab81&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Since Preon is a micro service hosted in the Uber UP infrastructure, it enjoys many of the benefits of the ecosystem such as:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;74bfb4d5-6c0a-44c0-bc8a-7e31e789481c&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Automatic horizontal&amp;nbsp; auto scaling of the # of Preon instances based on utilization&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Load balancing of the requests between the instances&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Ability to vertically scale the instances&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Automated logging, monitoring and alerting in case of service failure, CPU utilization and latency spikes&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Different environments for different classes of traffic e.g. staging, critical, non-critical&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Standard CI/CD&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Infrastructure support to scaffold new API calls&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;75cf7244-ab54-42cc-887b-7aa03dd4dd0f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In addition, the latency and reliability of each endpoint in Preon is monitored separately through additional metrics. Though Preon provides reliability SLA at par with production Presto clusters, yet the endpoints are integrated into the callers in a fail open manner so that the query flow still continues even if an endpoint call fails or times out.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b0cd619a-e394-47c7-b022-4aa903d24298&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Though Preon provides many benefits as mentioned above, it also creates the additional responsibility of keeping the Presto used in Preon in sync with the Uber Presto. The Uber Presto code sits in a separate repository to make it easier to upgrade from open source. Preon code meanwhile sits in the main Uber java repository to make better use of developer tools.&amp;nbsp; So, we have to make sure that the Preon uses the latest artifacts from the Uber Presto repo. Using a new artifact sometimes requires changes in analysis code as well. Not using the latest artifacts can cause analysis to fail.&amp;nbsp; For example, if any new SQL functions or UDFs have been added in the Uber Presto, then the query validation (using Preon) would fail if the query is using those new functions/UDFs unless the Presto modules used by Preon are also upgraded. Towards this end, we have created a rotation to upgrade Preon Presto on a regular cadence.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a05d8824-ccb1-4742-8ade-9dc51fdb677f&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;763aa2e7-a20d-4265-8794-384449ee8896&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-use-cases-at-uber&#34;&gt;Use Cases at Uber&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fe552e73-4855-4f73-a4de-7ea4e9a4a766&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;There are many production use cases at Uber that require Preon to get insights about queries. Two major use cases of Preon are Query result caching and Data layout formatting.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;a2d4ec8d-d001-4cb9-8dc8-8ae812a1be0c&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-query-result-caching&#34;&gt;Query Result Caching&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;15a00c71-31d6-43c5-8d58-d54f0a0388b9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Preon provides an API (LastUpdate) for the Upstream callers to check the validity of the previous runs of the query. There are two upstream callers at Uber that use this functionality in order to reduce redundant query traffic. In the case of the first caller, the hash of every executed query is stored in Redis with a TTL of 24 hrs. When a new query is submitted and its hash is present in redis, then Preon is consulted to see if the most recent modification time of any of the datasets in the query is prior to its last execution time. If yes, then the previous results are returned to the caller. Since the underlying data has not changed, it is safe to return the previous results. Additionally, sometimes just matching the query hash is not sufficient. For example when a query is reading data over a moving window e.g. last 7 days, then while the query would look similar to a previous one, but the data being read may not be exactly the same and hence we have to exclude such queries from this feature.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;34b7540c-da8d-4479-ae67-ae6773294d89&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&amp;nbsp;This feature has been running for over 2 years at Uber and we have seen around 5 – 7% of queries getting deduplicated due to this feature. Given that Presto at Uber runs about 500k queries per day, this is a significant reduction in # of queries.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096436,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;c90f493c-f93c-4e21-9c3d-544ec1456c53&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;243&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure2-17273060195956-1024x243.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096436&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1334,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 1334w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: Number of queries deduplicated by count and by percentage&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;41233185-95c8-42ed-92bc-4556bcdb78f2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;512a107d-5dbf-403e-b8ea-bfa6f51a2778&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-data-layout-formatting&#34;&gt;Data Layout Formatting&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a94ede9a-d107-4660-b16f-3333ec2d65d1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Every Presto query executed at Uber is post processed through the Preon Predicate Analysis endpoint. The post processing is done&amp;nbsp; by tailing the Presto Query Events topic and making a call to Preon and logging the results in another kafka topic.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096439,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;5ac9acb1-67b1-4f6a-9bea-0a8f4c4f774f&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;425&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure3-3-17273060601434-1024x425.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096439&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1384,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 1384w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: Table Format Recommender system&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2a7691c6-b623-4a6e-b421-886ec9a04934&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2a7e0112-316f-46d1-9128-b99ed7a02519&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Then an offline analysis is done periodically to examine what columns are often used as predicates to query the top tables. Based on the values used for the predicates and the cardinality of those columns, a recommendation is generated about which column the data in the table should be sorted on and expected read savings by sorting the data. The read savings are realized because of predicate pushdown in Presto where Presto can skip reading sections of files or entire files because the min/max statistics in the file footer does not match the value that is being used for filtering the data. We have seen significant reduction in the amount of data read from just a couple of tables after sorting them based on the recommendation.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096442,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;bbb4b436-c023-4c72-a0d2-720050fc632b&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-full&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;750&#34; height=&#34;256&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure4-17273061334001.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096442&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=750,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure4-17273061334001.png 750w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure4-17273061334001.png 300w&#34; sizes=&#34;(max-width: 750px) 100vw, 750px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: Weekly Data read savings from the Data Layout Reformatting.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;034fb341-e382-4996-a018-6d3cdb553540&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;35e298a0-61bd-4381-b891-4dec7fdde438&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the first case, the weekly data read from the table reduced from 4PB per week to about 2PB per week and in the second case the reduction was from 40PB per week to about 20PB per week.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e07a0c8c-1ef5-460d-9368-744a308faf91&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Bucketing is another option to consider but it might require backfill of data which can be costly. Also, since changing the table layout would also need compute resources, the benefit from the query savings need to be weighed against the cost of reformatting and thus this might only make sense for the heavily read tables.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;98e91f82-71de-4db8-8cec-28688c4a7a55&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Some other use cases that currently use Preon are:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d8e0503a-65b1-440f-8eb6-6f8787ecd809&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Query validation i.e. checking queries for structural issues before Query is accepted.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Permission check i.e. rejecting query early if the user does not have permissions on the tables/columns.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Routing queries to &lt;a href=&#34;https://www.uber.com/blog/modernizing-ubers-data-infrastructure-with-gcp/?uclick_id=1d3e4386-1f42-4d4f-92d9-3816206f3720&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Cloud clusters&lt;/a&gt; based on the presence of tables in the Cloud.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8806e51b-883d-42d5-ba59-d6260bc7c4f3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Preon currently gets invoked multiple times in the lifetime of a Presto query execution at Uber.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096445,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;f1aa9df0-dc73-4b9a-a07e-8a92dd1a2872&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-full&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;842&#34; height=&#34;495&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096445&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=842,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png 842w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png 768w&#34; sizes=&#34;(max-width: 842px) 100vw, 842px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: Preon calls in Query Processing Workflow at Uber&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;18e9d271-4866-4159-8c74-3fd77d7313fa&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6eda09e4-fef1-43d4-92e2-ad78c1e0af03&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;a0729a16-cd7e-4968-8cf4-ae5761ca6db6&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-next-steps&#34;&gt;Next Steps&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b7fc32a9-1957-4b71-88fe-74b4c01db304&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We also plan to use Preon for cost based routing and automatically enabling certain optimizations such as CTE materialization when the query analysis shows significant cost benefit from it. Another potential use case is just in time scheduling of ETL workloads based on when the input partitions become available. This will need insights regarding what partitions are being read by a query.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;648f0a52-76d0-4b37-8bf4-5cf338e274cd&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;bf7d3536-5027-4cc4-8be1-065daf6e8a74&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fc2c553c-27fa-41e6-bfa8-5561949b5b2a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We believe that query analysis should be promoted as a first class citizen and query engines should provide custom pluggable analysis facilities. While there has been some progress regarding query rewrite capabilities within the engine, however as we have shown above in many cases, insights are needed regarding a query before its execution. We hope to see developments regarding standalone query analysis in the open source community and be able to contribute to it.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;b0800bb7-954d-4462-a43a-41ad0bf613e7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Presto is a registered trademark of LF Projects, LLC in the United States and/or other countries. No endorsement by The LF Projects, LLC is implied by the use of this mark. Kafka and Apache Calcite is a trademark of Apache Software Foundation in the United States and/or other countries.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;8b25d545-5534-42c0-9660-a575b4a636f7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Cover Photo Attribution: &amp;nbsp;“&lt;a href=&#34;https://www.flickr.com/photos/188454520@N02/49917389986&#34;&gt;Torx Bits Metal Iron Tool Edited 2020&lt;/a&gt;” by &lt;a href=&#34;https://www.flickr.com/photos/188454520@N02&#34;&gt;chimpwithcan&lt;/a&gt; is licensed under &lt;a href=&#34;https://creativecommons.org/licenses/by/2.0/?ref=openverse&#34;&gt;CC BY 2.0&lt;/a&gt;.&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;bd450234-c86f-4e6f-b773-8427ffd60fe8&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;66363a5e-b873-4dbc-bd75-c1e14743f43b&#34;,&#34;dropCap&#34;:false}&#34;&gt;Presto&lt;sup &gt;™&lt;/sup&gt; 是 Uber 大规模使用的开源 SQL 查询引擎。 Uber 拥有大约 20 多个 Presto 集群，包含 12,000 多个主机。我们每周约有 7,000 名用户，每天运行约 50 万个查询。 Presto 在 Uber 拥有各种用例，例如临时交互式分析、ETL 和批量工作负载、仪表板、数据质量检查、报告生成、实验和数据驱动服务。由于系统规模庞大，有多种机会可以提高其效率。然而，这些机会需要有关系统正在处理的查询的智能。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2c7041ea-bb35-461e-89b3-398712c78fc8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cc06ed60-e777-487c-a9f2-0e4303c9163e&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-motivation-background-behind-project&#34;&gt;项目背后的动机/背景&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4254560c-9953-49fb-afa0-55312937048a&#34;,&#34;dropCap&#34;:false}&#34;&gt;Presto 是一个查询引擎并提供用于运行查询的 SQL 接口，但在很多情况下，我们需要能够分析查询以获得具体的可操作的见解。一些例子是：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ca8e6ab2-c196-4ae8-8906-67b76809af08&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;能够分析用于查询表的谓词&lt;/strong&gt; – 这可以使用重新格式化（排序、存储桶、分区）这些列上的表，从而减少查询执行期间从后端读取的数据，并实现更快、更高效的查询。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;能够确定查询中正在读取/写入的表/列&lt;/strong &gt; – 这可用于根据 Uber 数据湖特定区域中这些表的可用性将查询路由到特定集群，或进行权限检查。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;确定查询的类型 -&lt;/strong&gt; 例如，DDL/DML将 ETL 查询路由到某些集群。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;确定最近的修改是什么正在查询的任何数据集的时间 - &lt;/strong&gt;这可用于确定先前运行查询的结果是否仍然有效并且可以重复使用而不是重新运行查询。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;指纹查询&lt;/strong&gt; – 在很多用例中，我们需要知道是否查询与先前的查询相同或相似。指纹必须不受查询中的空格和注释的影响，因此仅使用字符串哈希并不能很好地工作。查找类似的查询（例如，仅更改文字值的查询更加困难。）&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;验证查询&lt;/strong&gt; – 尽早使出现语法错误的查询失败非常重要，在提交本身时，而不是查询必须通过队列并在开始运行时失败。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5381540a-abc2-44dd-b1b1-8c0773a4d195&#34;,&#34;dropCap&#34;:false}&#34;&gt;所有这些分析需要能够从结构上解析查询。在我们创建 Preon 之前，所有查询分析都是在 Presto 集群中执行查询的上下文中完成的，完成后，分析结果与与查询执行相关的其他统计信息一起发布到 Presto 查询事件主题。此外，记录任意信息也很困难，因为信​​息必须在执行查询的过程中生成（即，在分析/规划/优化或执行阶段并继续到查询完成点）。此外，分析代码必须作为 Uber Presto 主存储库中的私有补丁进行携带，这在升级 Presto 时可能会出现问题。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b2d3aefc-ff9c-4c13-a798-36476ef27a15&#34;,&#34;dropCap&#34;:false}&#34;&gt;查询执行和查询分析是两种不同的服务，具有截然不同的形式因素，总结如下：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/table&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;91d0850d-c45f-4362-9b6f-46281b135fb0&#34;,&#34;hasFixedLayout&#34;:true,&#34;head&#34;:[ ],&#34;body&#34;:[],&#34;foot&#34;:[]}&#34; class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;查询分析&lt;/td&gt;&lt;td&gt;查询执行&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;仅需要解析/分析/优化查询&lt;/td&gt;&lt;td&gt;需要解析/分析/计划/执行查询&lt; /td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;只需成为标准微服务&lt;/td&gt;&lt;td&gt;在裸机上的分布式集群中运行（为了性能），每个 DC 多个集群&lt;/td&gt;&lt;/tr &gt;&lt;tr&gt;&lt;td&gt;可以随时记录任何信息&lt;/td&gt;&lt;td&gt;记录仅限于查询完成；任何要记录的信息都必须到达该点&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;微服务的标准 CI/CD；可以快速部署更改&lt;/td&gt;&lt;td&gt;进行更改很慢；需要在电动汽车着陆后部署单独的每个集群&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;每种类型的分析都可以是一个单独的端点&lt;/td&gt;&lt;td&gt;只有一个查询执行端点&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt; &lt;td&gt;分析可以返回结果、将结果记录到数据库或返回转换后的查询&lt;/td&gt;&lt;td&gt;唯一的输出是查询执行结果&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td &gt;分析可以涉及多个查询（例如，找到它们之间的共同结构）&lt;/td&gt;&lt;td&gt;每个查询独立运行&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;分析可以离线完成（例如， ，通过跟踪有关查询完成的 Kafka 主题）&lt;/td&gt;&lt;td&gt;根据定义在线&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;我们可以使用 Presto 模块作为库进行分析&lt;/td&gt;&lt; td&gt;将涉及对核心引擎代码进行更改&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Uber 自动缩放器可以根据流量自动水平缩放服务&lt;/td&gt;&lt;td&gt;静态配置&lt; /td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;不需要强大的机器&lt;/td&gt;&lt;td&gt;Presto协调员需要强大的主机&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;26b7b3c6-8556-402c-95b0-d6f9fdadc04f&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8c3db597-494e-4e4b-bcac-90f7826b2ebd&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8257d41f-eb1f-4c4a-88cb-a47fa933b414&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architecture&#34;&gt;架构&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2828b7bc-4c9a-42a7-a668-4af59489c735&#34;,&#34;dropCap&#34;:false}&#34;&gt;以下要求查询分析服务是：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;hash&#34;:&#34;c9162000-c285-4487-8079-a5b5ac796f95&#34;,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;它应该能够在 Uber 无状态微服务平台 (UP) 中以微服务形式运行。&lt; /里&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;该服务应具有最小的 CPU/内存占用量。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;服务应 100% 覆盖 Uber 的所有 Presto 查询形状（包括内部 UDF）。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;服务应 100% 覆盖整个 Uber 数据湖（即支持所有 Presto 连接器和目录）。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;应根据 Uber 数据湖的当前状态，通过与生产目录对话来完成分析。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;分析的查询应与生产中的查询类似（即，包含所有转换和优化查询执行期间会发生的变化）。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;不要求能够解析非 Presto 查询形状。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;快速开发时间（即，任何新分析都不需要更改 Presto 模块，但可以在微服务本身中完成）。&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e84d7e0d-cf4e-4855-b40e-60dd0b7cdc1e&#34;,&#34;dropCap&#34;:false}&#34;&gt;查询解析可以使用 Apache Calcite&lt;sup&gt; ™&lt;/sup&gt; 解析器来完成。这也有能够解析非 Presto 查询形状的优点。然而，它有以下缺点：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;hash&#34;:&#34;f8388119-bd75-45cf-b643-a219d21c19f6&#34;,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Apache Calcite 可能无法解析所有 Presto 查询形状。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;我们不仅需要能够解析查询，还需要使用 Presto 分析甚至优化查询生产优化规则。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;我们希望能够在 Production Presto 和 Preon 之间共享代码（例如，查询指纹逻辑），如下所示需要。&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fd22bc68-bb09-42af-bb1b-cdeacb1caf33&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;295c9374-a11a-4f80-b331-8e26ec571b4b&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-service-design&#34;&gt;服务设计&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b3f8ff74-ccac-46c7-a6c8-5efe2c8a18f1&#34;,&#34;dropCap&#34;:false}&#34;&gt;该服务是以微服务的形式设计，创建一个迷你 Presto 服务器，并添加各种 REST 接口以实现不同的分析。由于 Presto 服务器不需要与任何工作人员通信，因此所有 HTTP 客户端和任务通信机制都从服务器中删除。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096434,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“bb88323e-9c76-45c5-82b8-2a3c739f060e”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“387”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/09/figure1-17273059861351-1024x387.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096434&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09 /figure1-17273059861351.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/ 09/figure1-17273059861351.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024 /09/figure1-17273059861351.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1406，quality=80，onerror=redirect，format=auto/wp-content/uploads/ 2024/09/figure1-17273059861351.png 1406w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：Preon 作为微服务&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a8c501ed-041a-4309-abf9-bba93b7e588e&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;77602bf6-d93d-4183-8c5c-18a5e647fa6a&#34;,&#34;dropCap&#34;:false}&#34;&gt;Preon 服务使用 Uber Presto 存储库中的 Presto 模块进行分析。我们必须对 Presto 模块进行最小的更改才能让 Preon 使用它们。此外，我们还必须在 Presto 中创建一个 presto-preon 模块，以便为我们提供实例化这个迷你 Presto 服务器的绑定。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;649be9b5-d9e6-4f43-98cf-c4b4df59c423&#34;,&#34;dropCap&#34;:false}&#34;&gt;Preon 提供内部API 用于：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c68a3b01-9f2c-406d-8da2-7a7d62bd2d51&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;创建查询语句，即仅解析查询&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;分析查询，即根据生产数据湖解析表和列&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;使用完整的规划优化器创建查询计划&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;使用给定的优化器列表为查询创建计划&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;656a78f5-ebdd-49ba-9331-eb20c3599321&#34;,&#34;dropCap&#34;:false}&#34;&gt;一般来说然后分析器作为内存中解析/分析/优化查询的访问者实施分析。使用这些内部 API 在 Preon 中创建了各种分析端点。一些示例分析如下：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9d8a3e46-4cad-44d5-9f2d-614af2536f77&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;谓词分析：此端点接受查询并返回用于过滤表中数据的谓词列及其谓词值。诸如“select * from some_table where uuid = 20”之类的查询将返回谓词 &lt;table:some_table, column: uuid, value: 20&gt;。仅返回单值和范围值谓词。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b5336b99-145a-4f98-94e9-689115ea9289&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;LastUpdate：此端点接受查询并返回查询中读取的任何数据集的最后修改时间。它通过创建一个查询计划（与生产 Presto 创建的计划相同）并为每个叶表扫描节点获取 HMS 中注册的最后修改时间来实现此目的。 （可选）端点还可以进一步查看 Uber 数据湖中文件的修改时间。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;67efa249-937e-4fad-974b-4cb1beac3db4&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;物化视图：端点使用物化视图确定给定查询是否适合改进。为了满足这一条件，查询应该在整个查询中由一个分区列聚合。然后，通过仅实现分区的计算一次，可以潜在地加快查询速度。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;15fa67f7-fe84-462a-b207-7d603f2b417e&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;查询的结构验证，例如语法错误&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fc543375-b0eb-48bc-9314-f1e498b7ba96&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;获取给定查询读取/更新的表/列的列表。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;52afa3f2-7535-4af8-8b53-3422a31c1a33&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b53c993b-1cdb-469e-af23-5085a399c56a&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-development-and-deployment-challenges&#34;&gt;开发和部署挑战&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;69e2fa78-b887-464e-b61a-5cf9ac9cab81&#34;,&#34;dropCap&#34;:false}&#34;&gt;因为 Preon 是托管在 Uber UP 基础设施中的微服务，它享有生态系统的任何好处，例如：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;74bfb4d5-6c0a-44c0-bc8a-7e31e789481c&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;根据利用率自动水平缩放 Preon 实例数量&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;实例之间的请求负载均衡&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;能够垂直缩放实例&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;在出现服务故障、CPU 利用率和延迟峰值时自动记录、监控和发出警报&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;不同流量类别的不同环境，例如分期、关键、非关键&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;标准 CI/CD&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;为新 API 调用提供基础设施支持&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;75cf7244-ab54-42cc-887b-7aa03dd4dd0f&#34;,&#34;dropCap&#34;:false}&#34;&gt;此外， Preon 中每个端点的延迟和可靠性通过附加指标单独监控。尽管 Preon 提供与生产 Presto 集群同等的可靠性 SLA，但端点以故障开放方式集成到调用方中，因此即使端点调用失败或超时，查询流仍会继续。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b0cd619a-e394-47c7-b022-4aa903d24298&#34;,&#34;dropCap&#34;:false}&#34;&gt;虽然 Preon 提供如上所述，它具有许多优点，但它还产生了额外的责任，即保持 Preon 中使用的 Presto 与 Uber Presto 同步。 Uber Presto 代码位于单独的存储库中，以便更轻松地从开源升级。同时，Preon 代码位于 Uber java 主存储库中，以便更好地利用开发人员工具。  因此，我们必须确保 Preon 使用 Uber Presto 存储库中的最新工件。使用新工件有时还需要更改分析代码。不使用最新的工件可能会导致分析失败。  例如，如果 Uber Presto 中添加了任何新的 SQL 函数或 UDF，则查询验证（使用 Preon）将失败（如果查询使用这些新函数/UDF），除非 Preon 使用的 Presto 模块也已升级。为此，我们创建了轮换机制，定期升级 Preon Presto。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a05d8824-ccb1-4742-8ade-9dc51fdb677f&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;763aa2e7-a20d-4265-8794-384449ee8896&#34;,&#34;level&#34;:2}&#34; class=&#34;wp- block-heading&#34; id=&#34;h-use-cases-at-uber&#34;&gt;Uber 的用例&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fe552e73-4855-4f73-a4de-7ea4e9a4a766&#34;,&#34;dropCap&#34;:false}&#34;&gt;有很多Uber 的生产用例需要 Preon 来获取有关查询的见解。 Preon 的两个主要用例是查询结果缓存和数据布局格式化。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;a2d4ec8d-d001-4cb9-8dc8-8ae812a1be0c&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-query-result-caching&#34;&gt;查询结果缓存&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;15a00c71-31d6-43c5-8d58-d54f0a0388b9&#34;,&#34;dropCap&#34;:false}&#34;&gt;Preon 提供API（LastUpdate）供上游调用者检查先前运行的查询的有效性。 Uber 有两个上游调用者使用此功能来减少冗余查询流量。对于第一个调用者，每个执行查询的哈希值都存储在 Redis 中，TTL 为 24 小时。当提交新查询并且其哈希值存在于 Redis 中时，会查询 Preon 以查看查询中任何数据集的最新修改时间是否早于其上次执行时间。如果是，则将之前的结果返回给调用者。由于底层数据没有改变，所以返回之前的结果是安全的。此外，有时仅匹配查询哈希是不够的。例如，当查询通过移动窗口读取数据时，例如最近 7 天，那么虽然查询看起来与之前的查询类似，但读取的数据可能不完全相同，因此我们必须从该功能中排除此类查询。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;34b7540c-da8d-4479-ae67-ae6773294d89&#34;,&#34;dropCap&#34;:false}&#34;&gt; 此功能具有该功能在 Uber 运行了 2 年多，我们发现大约 5-7% 的查询由于此功能而得到了重复数据删除。鉴于 Uber 的 Presto 每天运行约 50 万个查询，查询数量显着减少。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096436,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“c90f493c-f93c-4e21-9c3d-544ec1456c53”，“alt”：“”}“class =“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“243”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/09/figure2-17273060195956-1024x243.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096436&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 1024w，https://blog.uber-cdn.com/cdn -cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 300w，https://blog.uber-cdn.com/ cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 768w，https://blog.uber-cdn.com /cdn-cgi/image/width=1334，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure2-17273060195956.png 1334w“尺寸=”（最大宽度：1024px） 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：按计数和百分比进行重复数据删除的查询数&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;41233185-95c8-42ed-92bc-4556bcdb78f2&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;512a107d-5dbf-403e-b8ea-bfa6f51a2778&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-data-layout-formatting&#34;&gt;数据布局格式&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a94ede9a-d107-4660-b16f-3333ec2d65d1&#34;,&#34;dropCap&#34;:false}&#34;&gt;每个 Presto 查询在 Uber 执行的操作是通过 Preon 谓词分析端点进行后处理的。后处理是通过跟踪 Presto 查询事件主题并调用 Preon 并将结果记录在另一个 kafka 主题中来完成的。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096439,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“5ac9acb1-67b1-4f6a-9bea-0a8f4c4f774f”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”height =“425”src =“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror =重定向，format = auto/wp-content/uploads /2024/09/figure3-3-17273060601434-1024x425.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096439&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图片/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 300w，https://blog.uber-cdn.com/cdn -cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure3-3-17273060601434.png 768w，https://blog.uber-cdn。 com/cdn-cgi/image/width=1384，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/09/figure3-3-17273060601434.png 1384w“尺寸=”（最大宽度: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：表格格式推荐系统&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p数​​据-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2a7691c6-b623-4a6e-b421-886ec9a04934&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2a7e0112-316f-46d1-9128-b99ed7a02519&#34;,&#34;dropCap&#34;:false}&#34;&gt;然后离线定期进行分析，以检查哪些列经常用作谓词来查询顶级表。根据用于谓词的值和这些列的基数，生成有关表中数据应按哪一列进行排序的建议，以及通过对数据进行排序预计节省的读取量。读取节省的实现是由于 Presto 中的谓词下推，其中 Presto 可以跳过文件或整个文件的读取部分，因为文件页脚中的最小/最大统计信息与用于过滤数据的值不匹配。根据建议对几个表进行排序后，我们发现从其中读取的数据量显着减少。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096442,&#34;sizeSlug&#34;:&#34;full&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“bbb4b436-c023-4c72-a0d2-720050fc632b”，“alt”：“”}“类=“aligncenter size-full”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “750”高度=“256”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/09/figure4-17273061334001.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096442&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=750,quality =80，onerror=重定向，format=auto/wp-content/uploads/2024/09/figure4-17273061334001.png 750w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，质量= 80，onerror =重定向，格式=自动/可湿性粉剂内容/上传/2024/09/figure4-17273061334001.png 300w“尺寸=”（最大宽度：750px）100vw，750px“referrerpolicy=”无引荐” &gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 4：通过数据布局重新格式化每周数据读取节省。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;034fb341-e382-4996-a018-6d3cdb553540&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;35e298a0-61bd-4381-b891-4dec7fdde438&#34;,&#34;dropCap&#34;:false}&#34;&gt;在第一个在第一种情况下，从表中读取的每周数据从每周 4PB 减少到每周约 2PB，在第二种情况下，从每周 40PB 减少到每周约 20PB。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e07a0c8c-1ef5-460d-9368-744a308faf91&#34;,&#34;dropCap&#34;:false}&#34;&gt;分桶是另一种方法可以考虑的选项，但可能需要回填数据，这可能成本高昂。此外，由于更改表布局也需要计算资源，因此查询的好处需要权衡节省的成本和重新格式化的成本，因此这可能只对大量读取的表有意义。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;98e91f82-71de-4db8-8cec-28688c4a7a55&#34;,&#34;dropCap&#34;:false}&#34;&gt;一些其他用途目前使用Preon的案例有：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d8e0503a-65b1-440f-8eb6-6f8787ecd809&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;查询验证，即在接受查询之前检查查询是否存在结构问题。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;权限检查，即如果用户没有表/列的权限，则提前拒绝查询。&lt;/li &gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;将查询路由到 &lt;a href=&#34;https://www.uber.com/blog/modernizing- ubers-data-infrastruct-with-gcp/?uclick_id=1d3e4386-1f42-4d4f-92d9-3816206f3720&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;云集群&lt;/a&gt;基于云中表的存在.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8806e51b-883d-42d5-ba59-d6260bc7c4f3&#34;,&#34;dropCap&#34;:false}&#34;&gt;Preon 目前获取在 Uber 的 Presto 查询执行的生命周期中被调用多次。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096445,&#34;sizeSlug&#34;:&#34;full&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“f1aa9df0-dc73-4b9a-a07e-8a92dd1a2872”，“alt”：“”}“class =“aligncenter size-full”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “842”height =“495”src =“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror =重定向，format = auto/wp-content/uploads /2024/09/figure5-17273061772075.png&#34; alt=&#34;&#34; class=&#34;wp-image-1096445&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=842,quality =80，onerror=重定向，format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png 842w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，质量=80，onerror=重定向，format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768 ,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure5-17273061772075.png 768w&#34; 尺寸=&#34;(最大宽度: 842px) 100vw, 842px&#34;referrerpolicy=&#34;no-referrer &#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：Uber 查询处理工作流程中的 Preon 调用&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;18e9d271-4866-4159-8c74-3fd77d7313fa&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6eda09e4-fef1-43d4-92e2-ad78c1e0af03&#34;,&#34;不透明度&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;a0729a16-cd7e-4968-8cf4-ae5761ca6db6&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-next-steps&#34;&gt;后续步骤&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b7fc32a9-1957-4b71-88fe-74b4c01db304&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们还计划使用 Preon 进行基于成本的路由，并在查询分析显示显着的成本效益时自动启用某些优化，例如 CTE 实现。另一个潜在的用例是根据输入分区何时可用来及时调度 ETL 工作负载。这需要了解查询正在读取哪些分区。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;648f0a52-76d0-4b37-8bf4-5cf338e274cd&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;bf7d3536-5027-4cc4-8be1-065daf6e8a74&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fc2c553c-27fa-41e6-bfa8-5561949b5b2a&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们相信查询分析应该被提升为一等公民，查询引擎应该提供自定义的可插入分析工具。虽然引擎内的查询重写功能已经取得了一些进展，但是正如我们在上面的许多情况下所示，需要在查询执行之前对其进行深入了解。我们希望看到开源社区中独立查询分析的发展并能够为其做出贡献。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;b0800bb7-954d-4462-a43a-41ad0bf613e7&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;Presto 是 LF Projects, LLC 在美国和/或其他国家/地区的注册商标。使用此标志并不暗示 The LF Projects, LLC 的认可。 Kafka 和 Apache Calcite 是 Apache Software Foundation 在美国和/或其他国家/地区的商标。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;8b25d545-5534-42c0-9660-a575b4a636f7&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;封面照片出处：“&lt;a href=&#34;https://www.flickr.com/photos/188454520@N02/49917389986&#34;&gt;Torx Bits 金属铁工具2020 年编辑&lt;/a&gt;”由 &lt;a href=&#34;https://www.flickr.com/photos/188454520@N02&#34;&gt;chimpwithcan&lt;/a&gt; 获得 &lt;a href=&#34;https://creativecommons.org 许可/licenses/by/2.0/?ref=openverse&#34;&gt;CC BY 2.0&lt;/a&gt;。&lt;/p&gt;</description>
      <pubDate>Thu, 26 Sep 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【DataMesh: How Uber laid the foundations for the data lake cloud migration】DataMesh：Uber 如何为数据湖云迁移奠定基础</title>
      <link>https://www.uber.com/blog/datamesh/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;401572ae-639f-4c19-86ef-84e3b9b4801d&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fdb502df-ebe1-4382-b2ee-6e3f4d876d28&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Uber’s batch data platform is used by over 10,000 active internal users, ranging from data scientists, city operations, and business analysts to engineers. It hosts around 1.5 exabytes of Apache Hadoop&lt;sup&gt;Ⓡ&lt;/sup&gt; Distributed File System (HDFS) storage across two on-prem regions, serving over 500,000 Presto queries and over 370,000 Apache Spark&lt;sup&gt;TM&lt;/sup&gt; apps daily.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9877877f-e962-4011-b044-e2b97e39b060&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As discussed in our previous post, &lt;a href=&#34;https://www.uber.com/blog/modernizing-ubers-data-infrastructure-with-gcp/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;Modernizing Uber’s Batch Data Infrastructure with Google Cloud Platform&lt;/em&gt;&lt;/a&gt;, Uber is migrating the batch data platform to the cloud (GCP). Our strategy is to utilize the cloud’s object storage (GCS) for the data lake while transitioning the rest of our data infrastructure to cloud-based Infrastructure as a Service (IaaS).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;be53613f-6b03-46fb-9014-fc913e06674b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the previous blog, &lt;a href=&#34;https://www.uber.com/blog/securing-hadoop-on-gcp/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;Enabling Security for Hadoop Data Lake on Google Cloud Storage&lt;/em&gt;&lt;/a&gt;, we explored the security considerations of the migration and strategies for bridging the gap between HDFS and GCS security models.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9e79bc47-c3e2-4039-9f28-7243e9a50be1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In this blog, we delve into the details of how Uber laid the foundations for the batch data cloud migration by incorporating key &lt;a href=&#34;https://martinfowler.com/articles/data-mesh-principles.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;data mesh principles&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;92712175-8328-4243-97b2-d1439b35c1e6&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;aed21c53-8df6-4a15-837e-f5d12f118c50&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-motivation&#34;&gt;Motivation&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cd9d6d1d-8444-40c8-92b4-714a9408786b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Cloud providers have &lt;a href=&#34;https://cloud.google.com/storage/quotas&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;various limits&lt;/a&gt; on storage and IAM policies that pose challenges while migrating batch data to the cloud. Our major considerations while planning the cloud migration were:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cd73ebbd-d932-4995-8ec6-c55a0430d483&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Optimal Data Mapping:&lt;/strong&gt; Map HDFS files and directories to storage buckets in a Goldilocks manner–not map too much data to too few buckets, thus running into per-project or per-bucket quotas, and not spread the data out to too many buckets to run into the overhead of maintaining too many buckets.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;dbf88336-b8ae-40e3-81c4-7f913e724c78&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Access Control:&lt;/strong&gt; Place access controls at the appropriate level in the storage hierarchy without running into hard limits from the cloud providers, while also not overly elevating privileges for existing users.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2516611e-caa8-4c34-a461-5d7a0afc28fe&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Additionally,&amp;nbsp; we also saw the cloud migration as an opportunity to make improvements to our data lake:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;922befb6-bd92-4968-b9eb-ac8a9c6a0dd4&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Security group consolidation:&lt;/strong&gt; Address the issue of proliferation of security groups with overlaps and consolidate users into fewer groups such that per-user access stays the same.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;63dbb565-c670-4055-bed6-4594229eca03&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Decentralized data ownership:&lt;/strong&gt; Cleanly map Hive DBs and tables belonging to an organization into a bucket belonging to that org, thus leveraging cloud primitives to formalize &lt;a href=&#34;https://martinfowler.com/articles/data-mesh-principles.html#PrinciplesSummaryAndTheHighLevelLogicalArchitecture&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;data mesh principles&lt;/a&gt; of data ownership and easier cost attribution.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7016f88d-4a1b-4f50-a5e2-a8b1de356fe3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Today, the “Data team” acts as an intermediary admin and manages access controls for ingested raw datasets. Say someone requests access to a raw table: the Data Ingestion L1 team first asks approval from the owner of this raw table, then grants access to the requestor once approved.&amp;nbsp; With decentralized ownership, this intermediary role can be avoided and the owner can take charge of data access, just like model tables.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f4382787-f1a8-486d-a2ce-600750cb6865&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Data governance:&lt;/strong&gt; Take this opportunity to further improve data governance by mapping data based on its intended usage and lifetime. For example, place well-modeled datasets meant for broad consumption into a bucket with appropriate access control, while placing raw datasets into a bucket which can have reduced access. Place less-business-critical data into separate buckets with appropriate TTL, restricted access, and object lifecycle management policies.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;10188db3-16b8-445c-9c44-4debc444918d&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Automated environment setup:&lt;/strong&gt; We also wanted to automate setting up our infrastructure, starting with the cloud assets. This enables us to set up and tear down environments easily, thus helping with testing, staging, and production. Additionally this facilitates quickly bootstrapping new data analytics use cases and bringing up the stack in multiple regions for DR.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f0dd306d-2a59-4156-b096-9c93350601f6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The cloud migration presented an unique opportunity to address this by incorporating ideas from &lt;a href=&#34;https://martinfowler.com/articles/data-mesh-principles.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;data mesh principles&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6cfa4eef-f7ed-4700-81a4-f4edc280cc4a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2b6909b6-4a8d-44bc-9a52-b25b8cad4ca6&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-data-mesh-and-corresponding-cloud-concepts&#34;&gt;Data Mesh and Corresponding Cloud Concepts&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ab90d8c3-057c-4fef-8a69-74837da568af&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We introduced generic concepts modeled around the data mesh principles, to abstract the cloud constructs and easily adapt it to any chosen cloud provider.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9f27482c-ce9f-466a-ae8e-e44a97388b37&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Domain:&lt;/strong&gt; A hierarchical unit of organizing all the resources in an organization or team. In data mesh terms, domains can be both at the organization level or at a sub-organization/team level.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Domain Resources:&lt;/strong&gt; Cloud providers have resource containers, which are a unit of access control, resource grouping, and cost accounting.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Data Collection: &lt;/strong&gt;A logical container for data (DB/tables/files) belonging to the same category (e.g., raw data, tables for internal consumption or modeled tables for external broad access). This may be captured as labels in the corresponding cloud resources.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Domain Storage:&lt;/strong&gt; The storage buckets which are a unit of access control,&amp;nbsp; cost accounting, geographic location, storage class (hot, warm, cold), data lifecycle policies (TTL, legal holds, etc.), and data replication (to either standby store or archival store).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Data Product:&lt;/strong&gt; A curated, discoverable, and usable representation of data, which includes the Hive tables, BI dashboards, workflow pipelines, etc.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9f07e8ae-12a9-43eb-805b-94df0ebd8ec7&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1095631,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;42c56277-70fc-47af-9512-2b3ac034509d&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;703&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993-1024x703.png&#34; alt=&#34;&#34; class=&#34;wp-image-1095631&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1384,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993.png 1384w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Fig 1: Abstractions modeled around DataMesh and its mapping to cloud provider concepts.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b96336da-8bec-48f3-988f-022c5b6250e3&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;53b6652c-3fae-4b06-b7cb-62ba51afddea&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The below figure depicts how the data can be organized to align with the organizational hierarchy via the above constructs modeled around the data mesh principles.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;64766914-1b79-4946-b72b-473b0900ab56&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;9d4a06f9-02d6-44a1-8deb-f9dd043d7170&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcNBYoG3NmdpcxKHRFq6A3grJbF0RgAiN0vilpWcLZ2tLz6seG2VX_QkqMD-6uUjXk5MtxWVUkIMBifoSOnsPGOLbapb0Mide_9h7SW718cy9DYn_-vCHg6kJwslcbADyNVPiiO_iLHnnGahrRc5cRjfb4?key=Z4nUnZcVVVjMulk9CZK0Pg&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Fig 2: A logical view of the DataMesh components and the hierarchy.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a746dd40-7970-4c52-a5db-ca18290436ef&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;52ad0365-c483-4726-ae3d-bbef7ff32bc6&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-datamesh-service&#34;&gt;DataMesh Service&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a87abc1b-6366-428c-b9e7-616cdc229ab2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We built “DataMesh,” a cloud resources management service that organizes data resources in an organization-centric hierarchical manner. The service allows administration of changes to these resources in a safe and compliant manner, and periodically reconciles the state in the cloud with the desired goal state.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ff3ffcaf-869b-40a1-b39e-b331e25bbf46&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;By abstracting away the complexities of managing the underlying infrastructure, the DataMesh service empowers the organizations to take charge and maximize the value of their data, and easily share the data with other teams via well-known interface points.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;91ff8c97-8d56-4afb-ae2e-5e03c160f823&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0df9ec79-97ad-4321-b79e-d766b17be45d&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architecture&#34;&gt;Architecture&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e6045b96-89f4-4c2b-969f-b34fabf7ccef&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The DataMesh service forms the foundation of Batch DataLake’s cloud control plane. It bootstraps the cloud resources like GCP projects and storage buckets for each organization (domain), sets up bucket IAM and OLM policies, collects the cloud metrics, and pushes them into Uber’s internal framework for monitoring and alerting.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e90b49aa-c64b-4da8-acf6-3c04b13f0cf4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The DataMesh service pulls the organization hierarchy (teams and sub-teams) from Uber’s central ownership repository (uOwn), determines the table ownership, and maps the data to the corresponding organization’s cloud resources. The service also extracts table metadata from &lt;a href=&#34;https://www.uber.com/blog/databook/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;uMetadata&lt;/a&gt; (an internal repository of the schema, lineage, and business criticality of data) to label the cloud resources (like buckets) with relevant information.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7600d21d-fe52-49c7-8380-0bb46bb3e3c2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;All of this management is automated via reconciliation workflows, which are triggered either by events or time-based schedules. The reconciliation logic ensures that the data is mapped based on its ownership to the right cloud resources and the appropriate security, governance, and lifecycle policies are applied to the cloud resources.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;55ee19f9-6b49-49d5-b8da-e54039152aaf&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1095520,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;44cb95f0-8958-422c-996c-d8a96c4dbddb&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-image size-full&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;768&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1095520&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg 768w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Fig 3: The DataMesh service powering the cloud control plane.&lt;/figcaption&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e546fb3a-3635-4b6b-8c63-a82dcecf0405&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;651b1f71-f3c6-4e77-83c4-9fa125e20c81&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-dashboard-ui&#34;&gt;Dashboard/UI&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4c71503e-5312-46da-95cb-555e21762822&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The DataMesh dashboard/UI provides domain administrators with a comprehensive view of their domain’s underlying cloud infrastructure like buckets, quotas, metrics, etc., and their data products (currently focused on Hive databases and tables). While initially designed for domain administrators, we plan to expand the dashboard to include features that are relevant to users to discover data and for the domain admins to manage the infra in a self-service manner.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fb30a199-0caa-4ee9-8d4a-ecf91af88f04&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ae18ee53-a7f8-4797-bb6e-98880485a65c&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-simplifying-the-migration-and-future-proofing-the-system&#34;&gt;Simplifying the migration and future-proofing the system&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;07769ea8-88a0-44e3-bae8-27c2ff7a6738&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One of our migration goals was to make the migration less painful for our users. There are over 100,000 &lt;a href=&#34;https://www.uber.com/blog/managing-data-workflows-at-scale/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;user workflows&lt;/a&gt; and millions of lines of user code in the Uber’s Batch Data platform.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;03e5e51c-589f-4590-8f18-329c38b9a7be&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Many of the workflows and the underlying Spark applications have hard-coded HDFS paths in the code and configs. Asking users to update their code would have slowed down the overall migration process. Instead, we built an automated path translation logic to map the on-prem paths to cloud-based paths.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;46795360-4c83-4683-b70b-67668e4809d8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The DataMesh service captures the on-prem path to bucket path mapping as a part of the migration in a “Path Translation Service” (PTS). The PTS is looked up at runtime by the storage clients to automatically rewrite the on-prem paths to its corresponding cloud destination. Watch out for a future blog post detailing how we handled the hard-coded paths that we encountered in our jobs and pipelines as many companies accumulate these over time!&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2b8f5808-56c9-4b80-b5fa-7b19e625cf1e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To future-proof the system and make it cloud-agnostic, one of our principles was to NOT leak the bucket paths in the user code or pipelines going forward. The data may need to be moved across buckets due to various reasons (e.g., ownership changes, compliance requirements, changing data access patterns, new cloud provider features, etc.).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c0f0b6f9-41f7-4d88-9cfc-b221a7af4e12&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We created a new “logical file system” to abstract the bucket paths, and have consistent naming across cloud providers.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;064baadb-cc8c-4c1c-838c-6e836c874ea3&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e0bab1f4-4416-440d-814e-4373e0501d0c&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-challenges&#34;&gt;Challenges&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;20204da1-1e87-453a-b890-6fd9ddeca8f2&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-ownership-changes&#34;&gt;Ownership changes&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;36fea77d-1ff3-45c5-aa57-f709dbbeb80f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The DataMesh service organizes both cloud resources and data assets based on their ownership. For newly created assets (tables), if the ownership is not explicitly provided at creation time, the service uses various heuristics like the bucket location of the data, the organization of the asset creator, etc., to determine the ownership.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;70dfe27c-0d04-4d63-9378-af3ea1ac2a7b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;However the ownership of the assets can change due to users explicitly re-assigning the asset’s ownership or team reorgs, necessitating remapping the assets or moving the data to the target org’s cloud resources.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;035ee838-d00d-4cbc-aa01-fd5d8be057b7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We have implemented an automated process that continuously monitors ownership changes and performs remapping in the background.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;64f1c04a-3fb5-4b1e-98f6-d182eb8da339&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To minimize the data movement, the service re-labels the assets and/or moves GCP projects to the parent folder of target org whenever possible. For cross-bucket transfers, we leverage the GCP &lt;a href=&#34;https://cloud.google.com/storage-transfer/docs/cloud-storage-to-cloud-storage&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Storage Transfer Service&lt;/a&gt;, which optimizes for metadata-only copies when source and destination storage classes match.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;55f06d65-aa0c-4cc9-b66a-8a73164f5924&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-cloud-provider-limits-and-quotas&#34;&gt;Cloud provider limits and quotas&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0d895fca-b2ed-48e9-b8a0-288ec53d67f3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;GCS imposes various limits and quotas. Our service considers these constraints while mapping the data into the GCP Projects and buckets for optimal distribution.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ae6f3e1b-4ecb-4b2e-a163-399f1d3dcce7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For example, to avoid hitting GCS &lt;a href=&#34;https://cloud.google.com/storage/docs/request-rate#auto-scaling&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;read/write IOPS throttling&lt;/a&gt;, heavily-used tables (identified through metrics) are placed in separate buckets. This not only improves performance, but also provides readily available GCS metrics for those tables in the GCS dashboard for easier troubleshooting.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;b223434e-3ca9-4976-9bd3-22e96651da68&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-resource-usage-attribution-and-cost-control&#34;&gt;Resource usage attribution and cost control&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;111ccb0d-5fd4-4375-b5a4-176ae92a35f7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;On-premises, we leverage HDFS directory quotas and custom monitoring to manage the data usage. However, GCS lacks native mechanisms for setting object storage quotas. To bridge the gap, we built a system for organization admins to monitor usage (cost, bytes, operations, egress, etc.) at the org, bucket, and table levels, and optionally set storage quotas. This ensures storage costs align with organizational targets. The system continuously monitors GCS resource usage and takes action like sending notifications and blocking access when limits are exceeded.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c7eb96d2-8a80-4a7f-b6a4-019e1f8fd146&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-next-steps&#34;&gt;Next steps&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6efe3fc3-af06-4bf3-add4-5ff697282159&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We want to continue to build up on the principles of datamesh and empower data owners and users by creating a&amp;nbsp; “data domains” platform where:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7bfe124f-1484-412d-b192-c270a49be83c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Data is self-governed:&lt;/strong&gt; Users logically organize data, metadata and related artifacts (code/pipeline, notebooks, etc.) into domains that align with the ownership boundaries.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;abfe4dee-814b-41ab-a907-7f714d3002a0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Infrastructure management is simplified:&lt;/strong&gt; Enable capability to manage the cloud infrastructure for data processing in a self-serve manner. Automatically optimize the infrastructure to drive efficiency and cost savings.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;67ca08fa-8066-4b8b-8291-51c39b2355cb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Data Governance becomes intuitive:&lt;/strong&gt; Leverage capabilities available in different Uber services and &lt;a href=&#34;https://www.uber.com/blog/metadata-insights-databook/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;tools like Databook&lt;/a&gt;, build the missing features and integrate it into a single pane of glass view for managing all aspects of data in the cloud.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;a97dfafd-a34b-4805-ad03-e84b08d82b9b&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;dd65c097-5a5d-4a13-8594-e7661dfaedc1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Uber’s cloud migration of its exabyte-scale batch data platform involves multiple teams, and challenges stemming from a legacy on-premises stack.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c0ddc95b-4ae2-4289-bf80-f38f372fdbce&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;By building the DataMesh service, we were able to deliver the following key wins:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1ebf68a8-8f76-49dd-8e71-5af6cf7c1f3f&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Simplified Cloud Resource Management: &lt;/strong&gt;Abstracted away the complexities of cloud infrastructure, automating resource provisioning, configuration, and management.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Optimized Data Placement:&lt;/strong&gt; Optimally mapped data to buckets, navigating various GCS quota limits and ensuring performance parity with HDFS.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Ownership:&lt;/strong&gt; Organized data based on ownership, streamlining cost attribution, simplifying quota management, and fostering decentralized data ownership.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;49ddc6a2-640f-407a-a460-85141e3c4cae&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;By embracing Data Mesh principles, we not only aim to streamline the migration, but also establish a foundation for a more agile, secure, and cost-effective data ecosystem.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a673c51a-2b3b-43b7-af20-1a7e0b32ea2c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We hope that by sharing our experiences and learnings, we can inspire and guide other organizations embarking on similar cloud migrations. We’re excited to continue innovating in this space, and look forward to sharing more insights, execution progress and the lessons learned in the future blog posts.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b3c28bb6-58c2-4ccb-99a3-45b89fecde70&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f2d985a6-c8c8-4268-bce6-d9a5e6edfd7a&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34;&gt;Acknowledgments&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e0f7bbeb-6879-4afd-ad4c-369b699d6b76&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We are really grateful for the invaluable contributions of the DataMesh team members Charles Huang, Bugra Cavdar, and Yue Peng. Their dedication has been instrumental in the success of this initiative. We would also like to thank Mithun “Matt” Mathew for his insightful review and feedback for this blog.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;a6c2b7d0-c13b-448a-8c72-065a111376ee&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Apache&lt;sup&gt;®&lt;/sup&gt;, Apache Hadoop&lt;sup&gt;Ⓡ&lt;/sup&gt;, Apache Parquet™, Apache Hudi™, Apache Spark™, Apache Hadoop YARN™ are registered trademarks or trademarks of the &lt;/em&gt;&lt;a href=&#34;http://www.apache.org/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;Apache Software Foundation&lt;/em&gt;&lt;/a&gt;&lt;em&gt; in the United States and/or other countries. No endorsement by The Apache Software Foundation is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;43e7c70b-cfc6-4070-8f28-c5e53f30116f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Oracle, Java, MySQL, and NetSuite are registered trademarks of Oracle and/or its affiliates. Other names may be trademarks of their respective owners.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;51ee3b72-968e-45eb-8586-532a820f21a3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;The Grafana Labs Marks are trademarks of Grafana Labs, and are used with Grafana Labs’ permission. We are not affiliated with, endorsed or sponsored by Grafana Labs or its affiliates.Cover Photo Attribution: “&lt;/em&gt;&lt;a href=&#34;https://www.flickr.com/photos/100359919@N08/48083867888&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;Biosphere Environmental Museum&lt;/em&gt;&lt;/a&gt;&lt;em&gt;” by &lt;/em&gt;&lt;a href=&#34;https://www.flickr.com/photos/100359919@N08&#34;&gt;&lt;em&gt;vmokry&lt;/em&gt;&lt;/a&gt;&lt;em&gt; is licensed under &lt;/em&gt;&lt;a href=&#34;https://creativecommons.org/publicdomain/zero/1.0/?ref=openverse&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;CC0 1.0&lt;/em&gt;&lt;/a&gt;&lt;em&gt;.&lt;/em&gt;&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;401572ae-639f-4c19-86ef-84e3b9b4801d&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fdb502df-ebe1-4382-b2ee-6e3f4d876d28&#34;,&#34;dropCap&#34;:false}&#34;&gt;Uber 批量数据该平台有超过 10,000 名活跃的内部用户使用，其中包括数据科学家、城市运营、业务分析师和工程师。它在两个本地区域托管约 1.5 艾字节的 Apache Hadoop&lt;sup&gt;Ⓡ&lt;/sup&gt; 分布式文件系统 (HDFS) 存储，每天为超过 500,000 个 Presto 查询和超过 370,000 个 Apache Spark&lt;sup&gt;TM&lt;/sup&gt; 应用程序提供服务.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9877877f-e962-4011-b044-e2b97e39b060&#34;,&#34;dropCap&#34;:false}&#34;&gt;如中所述我们之前的帖子，&lt;a href=&#34;https://www.uber.com/blog/modernizing-ubers-data-infrastruct-with-gcp/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;现代化Uber 的批量数据基础设施与 Google Cloud Platform&lt;/em&gt;&lt;/a&gt;，Uber 正在将批量数据平台迁移到云端（GCP）。我们的策略是利用云的对象存储 (GCS) 作为数据湖，同时将其余数据基础设施过渡到基于云的基础设施即服务 (IaaS)。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;be53613f-6b03-46fb-9014-fc913e06674b&#34;,&#34;dropCap&#34;:false}&#34;&gt;在前面博客，&lt;a href=&#34;https://www.uber.com/blog/securing-hadoop-on-gcp/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;为 Hadoop Data Lake 启用安全性Google Cloud Storage&lt;/em&gt;&lt;/a&gt;，我们探讨了迁移的安全注意事项以及弥合 HDFS 和 GCS 安全模型之间差距的策略。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9e79bc47-c3e2-4039-9f28-7243e9a50be1&#34;,&#34;dropCap&#34;:false}&#34;&gt;在此博客中，我们深入研究了 Uber 如何通过合并关键 &lt;a href=&#34;https://martinfowler.com/articles/data-mesh-principles.html&#34; target=&#34;_blank&#34; rel 为批量数据云迁移奠定基础的细节=&#34;noreferrer noopener&#34;&gt;数据网格原理&lt;/a&gt;。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;92712175-8328-4243-97b2-d1439b35c1e6&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;aed21c53-8df6-4a15-837e-f5d12f118c50&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-motivation&#34;&gt;动机&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cd9d6d1d-8444-40c8-92b4-714a9408786b&#34;,&#34;dropCap&#34;:false}&#34;&gt;云提供商有&lt;a href=&#34;https://cloud.google.com/storage/quotas&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;va存储和 IAM 策略的严重限制给批量数据迁移到云端带来了挑战。我们在规划云迁移时的主要考虑因素是：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cd73ebbd-d932-4995-8ec6-c55a0430d483&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;最佳数据映射：&lt;/strong&gt;将 HDFS 文件和目录映射到 Goldilocks 中的存储桶方式 - 不要将太多数据映射到太少的存储桶，从而导致每个项目或每个存储桶的配额，也不要将数据分散到太多的存储桶，以免产生维护太多存储桶的开销。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;dbf88336-b8ae-40e3-81c4-7f913e724c78&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;访问控制：&lt;/strong&gt;将访问控制置于存储层次结构中的适当级别，无需遇到云提供商的硬性限制，同时也不会过度提升现有用户的权限。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2516611e-caa8-4c34-a461-5d7a0afc28fe&#34;,&#34;dropCap&#34;:false}&#34;&gt;此外，我们还认为云迁移是改进我们的数据湖的机会：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;922befb6-bd92-4968-b9eb-ac8a9c6a0dd4&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;安全组整合&lt;/strong&gt;：解决存在重叠和安全组激增的问题将用户合并到更少的组中，以便每个用户的访问权限保持不变。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;63dbb565-c670-4055-bed6-4594229eca03&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;去中心化数据所有权&lt;/strong&gt;：将属于组织的 Hive 数据库和表清晰地映射到属于该组织的存储桶，从而利用云原语来形式化 &lt;a href=&#34;https://martinfowler.com/articles/data-mesh-principles.html#PrinciplesSummaryAndTheHighLevelLogicalArchitecture&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;数据所有权的数据网格原则&lt;/a&gt;和更简单的成本归因。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7016f88d-4a1b-4f50-a5e2-a8b1de356fe3&#34;,&#34;dropCap&#34;:false}&#34;&gt;今天， “数据团队”充当中间管理员，管理摄取的原始数据集的访问控制。假设有人请求访问原始数据表：数据摄取 L1 团队首先请求该原始表所有者的批准，然后在获得批准后向请求者授予访问权限。  通过分散所有权，可以避免这种中间角色，所有者可以负责数据访问，就像模型表一样。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f4382787-f1a8-486d-a2ce-600750cb6865&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;数据治理&lt;/strong&gt;：借此机会，通过基于数据的映射来进一步改进数据治理关于其预期用途和使用寿命。例如，将用于广泛使用的建模良好的数据集放入具有适当访问控制的存储桶中，同时将原始数据集放入可减少访问的存储桶中。将业务不太关键的数据放入具有适当 TTL、限制访问和对象生命周期管理策略的单独存储桶中。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;10188db3-16b8-445c-9c44-4debc444918d&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;自动化环境设置&lt;/strong&gt;：我们还希望自动设置我们的基础设施，从与云资产。这使我们能够轻松地设置和拆除环境，从而有助于测试、登台和生产。此外，这有助于快速引导新的数据分析用例，并在多个区域中建立堆栈以进行灾难恢复。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f0dd306d-2a59-4156-b096-9c93350601f6&#34;,&#34;dropCap&#34;:false}&#34;&gt;云迁移通过结合&lt;a href=&#34;https://martinfowler.com/articles/data-mesh-principles.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;数据网格原则&lt;的想法来解决这个问题提供了一个独特的机会/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6cfa4eef-f7ed-4700-81a4-f4edc280cc4a&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2b6909b6-4a8d-44bc-9a52-b25b8cad4ca6&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-data-mesh-and-corresponding-cloud-concepts&#34;&gt;数据网格和相应的云概念&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ab90d8c3-057c-4fef-8a69-74837da568af&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们引入了泛型围绕数据网格原则建模的概念，以抽象云结构并轻松使其适应任何选定的云提供商。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9f27482c-ce9f-466a-ae8e-e44a97388b37&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34;&#34;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;域：&lt;/strong&gt;组织组织或团队中所有资源的分层单元。用数据网格术语来说，域可以是组织级别的，也可以是子组织/团队级别的。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;域资源&lt;/strong&gt;：云提供商拥有资源容器，这是一个访问单元控制、资源分组和成本核算。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;数据收集：&lt;/strong&gt;数据的逻辑容器（数据库/表/文件）属于同一类别（例如，原始数据、供内部使用的表或供外部广泛访问的建模表）。这可以被捕获为相应云资源中的标签。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;域存储&lt;/strong&gt;：作为访问控制单位的存储桶、成本会计、地理位置、存储类别（热、温、冷）、数据生命周期策略（TTL、合法保留等）以及数据复制（到备用存储或归档存储）。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;数据产品&lt;/strong&gt;：精心策划、可发现且可用的数据表示形式，包括 Hive 表、BI 仪表板、工作流程管道等。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9f07e8ae-12a9-43eb-805b-94df0ebd8ec7&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1095631,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“42c56277-70fc-47af-9512-2b3ac034509d”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“703”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993-1024x703.png&#34; alt=&#34;&#34; class=&#34;wp-image-1095631&#34; srcset=&#34;https://blog.uber-cdn .com/cdn-cgi/image/width=1024，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993 .png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/screenshot- 2024-09-10-at-12.37.33-17259646958993.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto /wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=第1384章，质量=80，onerror=重定向，表格at=auto/wp-content/uploads/2024/09/screenshot-2024-09-10-at-12.37.33-17259646958993.png 1384w“尺寸=”（最大宽度：1024px）100vw，1024px“referrerpolicy=” no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：围绕 DataMesh 建模的抽象及其与云提供商概念的映射。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b96336da-8bec-48f3-988f-022c5b6250e3&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;53b6652c-3fae-4b06-b7cb-62ba51afddea&#34;,&#34;dropCap&#34;:false}&#34;&gt;下图描述了如何通过围绕数据网格原则建模的上述构造来组织数据以与组织层次结构保持一致。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;64766914-1b79-4946-b72b-473b0900ab56&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;9d4a06f9-02d6-44a1-8deb-f9dd043d7170&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXcNBYoG3NmdpcxKHRFq6A3grJbF0RgAiN0vilpWcLZ2tLz6seG2VX_QkqMD-6uUjXk5MtxWVUkIMBifoSONsPGOLbapb0Mide_9h7SW718cy9DYn_-vCHg6kJwslcbADyNVPiiO_i LHnnGahrRc5cRjfb4?key=Z4nUnZcVVVjMulk9CZK0Pg&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图2：DataMesh 组件和层次结构的逻辑视图。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a746dd40-7970-4c52-a5db-ca18290436ef&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;52ad0365-c483-4726-ae3d-bbef7ff32bc6&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-datamesh-service&#34;&gt;DataMesh 服务&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a87abc1b-6366-428c-b9e7-616cdc229ab2&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们构建了“ DataMesh，一种云资源管理服务，以组织为中心的分层方式组织数据资源。该服务允许以安全且合规的方式管理对这些资源的更改，并定期使云中的状态与所需的目标状态保持一致。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ff3ffcaf-869b-40a1-b39e-b331e25bbf46&#34;,&#34;dropCap&#34;:false}&#34;&gt;通过抽象管理的复杂性作为底层基础设施，DataMesh 服务使组织能够掌控并最大化其数据价值，并通过众所周知的接口点轻松与其他团队共享数据。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;91ff8c97-8d56-4afb-ae2e-5e03c160f823&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0df9ec79-97ad-4321-b79e-d766b17be45d&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architecture&#34;&gt;架构&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e6045b96-89f4-4c2b-969f-b34fabf7ccef&#34;,&#34;dropCap&#34;:false}&#34;&gt;DataMesh 服务构成 Batch DataLake 云控制平面的基础。它为每个组织（域）引导 GCP 项目和存储桶等云资源，设置存储桶 IAM 和 OLM 策略，收集云指标，并将其推送到 Uber 的内部框架中进行监控和警报。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e90b49aa-c64b-4da8-acf6-3c04b13f0cf4&#34;,&#34;dropCap&#34;:false}&#34;&gt;DataMesh 服务从 Uber 的中央所有权存储库 (uOwn) 中提取组织层次结构（团队和子团队），确定表所有权，并将数据映射到相应组织的云资源。该服务还从 &lt;a href=&#34;https://www.uber.com/blog/databook/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;uMetadata&lt;/a&gt;（数据中心的内部存储库）中提取表元数据。数据的架构、沿袭和业务关键性），用相关信息标记云资源（如存储桶）。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7600d21d-fe52-49c7-8380-0bb46bb3e3c2&#34;,&#34;dropCap&#34;:false}&#34;&gt;所有这些管理通过对帐工作流程实现自动化，该工作流程由事件或基于时间的计划触发。协调逻辑确保数据根据其所有权映射到正确的云资源，并将适当的安全、治理和生命周期策略应用于云资源。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;55ee19f9-6b49-49d5-b8da-e54039152aaf&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1095520,&#34;sizeSlug&#34;:&#34;full&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34; 44cb95f0-8958-422c-996c-d8a96c4dbddb&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;wp-block-image size-full&#34;&gt;&lt;img 加载=&#34;lazy&#34; 解码=&#34;async&#34; 宽度=&#34;1024&#34; 高度=&#34;768&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1095520&#34; srcset=&#34;https://blog.uber-cdn.com/cdn- cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg 1024w，https://blog.uber-cdn .com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg 300w，https:// blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/draft-datamesh-blog-17258996155985.jpeg 768w &#34;size=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：为云控制平面提供支持的 DataMesh 服务。&lt;/figcaption &gt;&lt;/图&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e546fb3a-363​​5-4b6b-8c63-a82dcecf0405&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;651b1f71-f3c6-4e77-83c4-9fa125e20c81&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-dashboard-ui&#34;&gt;仪表板/UI&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4c71503e-5312-46da-95cb-555e21762822&#34;,&#34;dropCap&#34;:false}&#34;&gt;DataMesh 仪表板/UI 为域管理员提供了其域的底层云基础设施（如存储桶、配额、指标等）及其数据产品（当前专注于 Hive 数据库和表）的全面视图。虽然最初是为域管理员设计的，但我们计划扩展仪表板以包含与用户发现数据以及域管理员以自助服务方式管理基础设施相关的功能。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fb30a199-0caa-4ee9-8d4a-ecf91af88f04&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ae18ee53-a7f8-4797-bb6e-98880485a65c&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-simplifying-the-migration-and-future-proofing-the-system&#34;&gt;简化迁移并确保系统面向未来&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;07769ea8-88a0-44e3-bae8-27c2ff7a6738&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的其中一个迁移目标是减少用户的迁移痛苦。有超过 100,000 个&lt;a href=&#34;https://www.uber.com/blog/managing-data-workflows-at-scale/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;用户工作流程&lt;/a&gt;以及 Uber 批量数据平台中的数百万行用户代码。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;03e5e51c-589f-4590-8f18-329c38b9a7be&#34;,&#34;dropCap&#34;:false}&#34;&gt;许多工作流程和底层 Spark 应用程序在代码和配置中具有硬编码的 HDFS 路径。要求用户更新代码会减慢整个迁移过程。相反，我们构建了一个自动路径转换逻辑，将本地路径映射到基于云的路径。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;46795360-4c83-4683-b70b-67668e4809d8&#34;,&#34;dropCap&#34;:false}&#34;&gt;DataMesh 服务捕获本地路径到存储桶路径映射，作为“路径转换服务”(PTS) 中迁移的一部分。存储客户端在运行时查找 PTS，以自动重写到其相应云目标的本地路径。请留意未来的博客文章，详细介绍我们如何处理在工作和管道中遇到的硬编码路径，因为许多公司随着时间的推移积累了这些路径！&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2b8f5808-56c9-4b80-b5fa-7b19e625cf1e&#34;,&#34;dropCap&#34;:false}&#34;&gt;到未来-为了证明系统并使其与云无关，我们的原则之一是不要泄漏用户代码或管道中的存储桶路径。由于各种原因（例如，所有权变更、合规性要求、不断变化的数据访问模式、新的云提供商功能等），数据可能需要跨存储桶移动。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c0f0b6f9-41f7-4d88-9cfc-b221a7af4e12&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们创建了一个新的“逻辑文件系统”用于抽象存储桶路径，并在云提供商之间具有一致的命名。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;064baadb-cc8c-4c1c-838c-6e836c874ea3&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e0bab1f4-4416-440d-814e-4373e0501d0c&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-challenges&#34;&gt;挑战&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;20204da1-1e87-453a-b890-6fd9ddeca8f2&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-ownership-changes&#34;&gt;所有权变更&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;36fea77d-1ff3-45c5-aa57-f709dbbeb80f&#34;,&#34;dropCap&#34;:false}&#34;&gt;DataMesh 服务根据所有权组织云资源和数据资产。对于新创建的资产（表），如果在创建时未明确提供所有权，则服务会使用各种启发式方法（例如数据的存储桶位置、资产创建者的组织等）来确定所有权。&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;70dfe27c-0d04-4d63-9378-af3ea1ac2a7b&#34;,&#34;dropCap&#34;:false}&#34;&gt;但是由于用户明确地重新分配资产的所有权或团队重组，因此需要重新映射资产或将数据移动到目标组织的云资源，资产的所有权可能会发生变化。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;035ee838-d00d-4cbc-aa01-fd5d8be057b7&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们已经实施一个自动化过程，持续监控所有权变更并在后台执行重新映射。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;64f1c04a-3fb5-4b1e-98f6-d182eb8da339&#34;,&#34;dropCap&#34;:false}&#34;&gt;要最小化数据移动时，该服务会尽可能重新标记资产和/或将 GCP 项目移动到目标组织的父文件夹。对于跨存储桶传输，我们利用 GCP &lt;a href=&#34;https://cloud.google.com/storage-transfer/docs/cloud-storage-to-cloud-storage&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;存储传输服务&lt;/a&gt;，当源和目标存储类匹配时，它会针对仅元数据副本进行优化。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;55f06d65-aa0c-4cc9-b66a-8a73164f5924&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-cloud-provider-limits-and-quotas&#34;&gt;云提供商限制和配额&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0d895fca-b2ed-48e9-b8a0-288ec53d67f3&#34;,&#34;dropCap&#34;:false}&#34;&gt;GCS 强加了各种限制和配额。我们的服务在将数据映射到 GCP 项目和存储桶中以实现最佳分配时会考虑这些限制。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ae6f3e1b-4ecb-4b2e-a163-399f1d3dcce7&#34;,&#34;dropCap&#34;:false}&#34;&gt;例如，避免达到 GCS &lt;a href=&#34;https://cloud.google.com/storage/docs/request-rate#auto-scaling&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;读/写 IOPS 限制&lt;/ a&gt;，频繁使用的表（通过指标识别）被放置在单独的桶中。这不仅提高了性能，还为 GCS 仪表板中的这些表提供了现成的 GCS 指标，以便更轻松地进行故障排除。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;b223434e-3ca9-4976-9bd3-22e96651da68&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-resource-usage-attribution-and-cost-control&#34;&gt;资源使用归因和成本控制&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;111ccb0d-5fd4-4375-b5a4-176ae92a35f7&#34;,&#34;dropCap&#34;:false}&#34;&gt;本地，我们利用 HDFS 目录配额和自定义监控来管理数据使用。然而，GCS 缺乏设置对象存储配额的本机机制。为了弥补这一差距，我们为组织管理员构建了一个系统，用于监控组织、存储桶和表级别的使用情况（成本、字节、操作、出口等），并可选择设置存储愤怒配额。这可确保存储成本与组织目标保持一致。系统持续监控GCS资源使用情况，并在超出限制时采取发送通知、阻止访问等措施。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c7eb96d2-8a80-4a7f-b6a4-019e1f8fd146&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-next-steps&#34;&gt;后续步骤&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6efe3fc3-af06-4bf3-add4-5ff697282159&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们想要继续建立数据网格原则，并通过创建“数据域”平台来增强数据所有者和用户的能力，其中：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7bfe124f-1484-412d-b192-c270a49be83c&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;数据是自我管理的：&lt;/strong&gt;用户按照逻辑将数据、元数据和相关工件（代码/管道、笔记本等）组织到与所有权边界一致的域中。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;abfe4dee-814b-41ab-a907-7f714d3002a0&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;基础设施管理得到简化：&lt;/strong&gt;能够以自助方式管理用于数据处理的云基础设施。自动优化基础设施以提高效率并节省成本。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;67ca08fa-8066-4b8b-8291-51c39b2355cb&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;数据治理变得直观：&lt;/strong&gt;利用不同 Uber 服务和&lt;a href=&#34;https://www.uber.com/blog/metadata-insights-databook/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer 中提供的功能noopener&#34;&gt;像 Databook 这样的工具&lt;/a&gt;，构建缺失的功能并将其集成到单一管理平台视图中，以管理云中数据的各个方面。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;a97dfafd-a34b-4805-ad03-e84b08d82b9b&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;dd65c097-5a5d-4a13-8594-e7661dfaedc1&#34;,&#34;dropCap&#34;:false}&#34;&gt;Uber 的云迁移其 EB 级批量数据平台涉及多个团队，并且面临来自遗留本地堆栈的挑战。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c0ddc95b-4ae2-4289-bf80-f38f372fdbce&#34;,&#34;dropCap&#34;:false}&#34;&gt;通过构建通过 DataMesh 服务，我们取得了以下关键成果：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1ebf68a8-8f76-49dd-8e71-5af6cf7c1f3f&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;简化云资源管理：&lt;/strong&gt;消除云基础设施的复杂性，实现资源调配、配置和管理的自动化。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;优化数据放置&lt;/strong&gt;：将数据优化映射到存储桶，应对各种 GCS 配额限制并确保与 HDFS 的性能相当。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;所有权：&lt;/strong&gt;根据所有权组织数据，简化成本归属，简化配额管理，并促进去中心化的数据所有权。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;49ddc6a2-640f-407a-a460-85141e3c4cae&#34;,&#34;dropCap&#34;:false}&#34;&gt;拥抱数据网格原则，我们不仅旨在简化迁移，还为更加敏捷、安全和经济高效的数据生态系统奠定基础。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a673c51a-2b3b-43b7-af20-1a7e0b32ea2c&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们希望通过分享我们的经验和学习，我们可以激励和指导其他组织开展类似的云迁移。我们很高兴能够在这一领域继续创新，并期待在未来的博客文章中分享更多见解、执行进度和经验教训。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b3c28bb6-58c2-4ccb-99a3-45b89fecde70&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f2d985a6-c8c8-4268-bce6-d9a5e6edfd7a&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e0f7bbeb-6879-4afd-ad4c-369b699d6b76&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们真的感谢 DataMesh 团队成员 Charles Huang、Bugra Cavdar 和 Yue Peng 的宝贵贡献。他们的奉献精神对这一举措的成功发挥了重要作用。我们还要感谢 Mithun “Matt” Mathew 对此博客的富有洞察力的评论和反馈。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;a6c2b7d0-c13b-448a-8c72-065a111376ee&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Apache&lt;sup&gt;®&lt;/sup&gt;、Apache Hadoop&lt;sup&gt;Ⓡ&lt;/sup&gt;、Apache Parquet™、Apache Hudi™、Apache Spark ™、Apache Hadoop YARN™ 是 Apache Software 的注册商标或商标&lt;/em&gt;&lt;a href=&#34;http://www.apache.org/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;美国和/或其他国家的基金会&lt;/em&gt;&lt;/a&gt;&lt;em&gt;。使用这些标记并不暗示 Apache 软件基金会的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p 数据-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;43e7c70b-cfc6-4070-8f28-c5e53f30116f&#34;,&#34;dropCap&#34;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Oracle、Java、MySQL 和 NetSuite 是 Oracle 和/或其附属公司的注册商标。其他名称可能是其各自所有者的商标。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;51ee3b72-968e-45eb-8586-532a820f21a3&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Grafana Labs 标记是 Grafana Labs 的商标，经 Grafana Labs 许可使用。我们不隶属于 Grafana Labs 或其附属机构，也不受其认可或赞助。封面照片归属：“&lt;/em&gt;&lt;a href=&#34;https://www.flickr.com/photos/100359919@N08/48083867888&#34; target= “_blank” rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;生物圈环境博物馆&lt;/em&gt;&lt;/a&gt;&lt;em&gt;”作者：&lt;/em&gt;&lt;a href=&#34;https://www.flickr.com/photos/ 100359919@N08&#34;&gt;&lt;em&gt;vmokry&lt;/em&gt;&lt;/a&gt;&lt;em&gt; 已获得许可&lt;/em&gt;&lt;a href=&#34;https://creativecommons.org/publicdomain/zero/1.0/?ref=openverse &#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;em&gt;CC0 1.0&lt;/em&gt;&lt;/a&gt;&lt;em&gt;。&lt;/em&gt;&lt;/p&gt;</description>
      <pubDate>Tue, 10 Sep 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【Streamlining Financial Precision: Uber’s Advanced Settlement Accounting System】简化财务精准度：Uber 的高级结算会计系统</title>
      <link>https://www.uber.com/blog/ubers-advanced-settlement-accounting-system/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;1801f856-06d7-4d1e-b983-5c0e34944441&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d28e00ac-0240-44d8-bd8d-0f7441623771&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the realm of fintech, settlements, refunds, and chargebacks related to PSPs (payment service providers) are crucial transactions that involve the transfer of funds between different financial entities to complete a payment process. PSPs act as intermediaries between merchants and consumers, facilitating the smooth and secure transfer of funds. Settlements in this context refer to the end-of-day process where funds collected from consumers are disbursed to merchants, minus any fees or charges&lt;strong&gt;.&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4b613f6a-b4a6-43c8-896e-18ee740601af&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Settlement accounting is a critical financial process that involves reconciling and recording all transactions related to settlements, refunds, and other financial activities conducted through PSPs. At Uber, settlement accounting is indispensable due to the sheer volume of transactions and the need for precise financial tracking.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098207,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;98096e93-b824-4c92-af22-468fab18e202&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;555&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-1-17297140298650-1024x555.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098207&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Summary of card payment processing and the key players in the market.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8d5cd00f-8537-4acf-b571-6ad5f217245b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We process about 1.2 billion settlements each month, handling around $130 billion in cash in transit annually from over 50 different PSPs. This process ensures that ‌funds received from various payment methods are accurately accounted for and matched with the corresponding bank statements. Settlement accounting at Uber involves offsetting receivables booked during revenue accounting, verifying the cash deposited in the bank, and analyzing contracts with PSPs to determine fees, taxes, and other charges associated with transactions.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;48f19f93-df8a-4d4f-822b-457c25df29f0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This blog describes Uber’s advanced settlement accounting system. Settlement accounting is crucial for ensuring financial accuracy, preventing fraud, and maintaining regulatory compliance. By automating reconciliation and offering near-real-time reporting, it boosts operational efficiency and supports strategic business decisions. Additionally, it helps manage transaction costs by analyzing PSP fees and taxes. Reliable settlement accounting fosters customer trust through accurate processing and timely resolution of payment issues.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b1730c08-4e9d-47af-abab-3c1bdde1ed18&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2ad61c98-7341-4fac-8ca2-4ae6b93f88da&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-motivation&#34;&gt;Motivation&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;78f806f0-9dda-4c0a-81d1-45ab56a9cd38&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;PSP files include various events from payment service providers, each initiated by different parties and crucial for maintaining accurate financial operations. We built the settlement accounting system to manage these events.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;2fc0868d-a293-492a-ac65-9d3a34260f39&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-uber-initiated-events&#34;&gt;&lt;strong&gt;Uber-Initiated Events&lt;/strong&gt;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a04b5ef0-e7fe-4406-8eca-89838535154b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;When considering the payment ecosystem, Uber-initiated events are actions initiated directly by Uber. They include:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;40ffc0fa-1d14-4162-b666-1aae618cdd2d&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Collections:&lt;/strong&gt; Uber initiates the collection of funds from riders for services rendered.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Refunds:&lt;/strong&gt; When a rider is owed money back, Uber initiates the refund process. This could be due to ride cancellations, service issues, or other reasons that warrant returning funds to the rider.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;012d12c3-1fc1-4c5b-ba15-c3a0ecdb4b60&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-rider-initiated-events&#34;&gt;&lt;br&gt;&lt;strong&gt;Rider-Initiated Events&lt;/strong&gt;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;eb657940-a4ba-4677-b0a0-9f6e4850a063&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Rider-initiated events are triggered by riders, typically in response to issues or disputes. These include:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c8cc5949-2582-45a0-bb0f-730690789d3f&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Chargebacks:&lt;/strong&gt; Riders can dispute transactions, leading to a chargeback. This process involves reversing a transaction after a rider questions its legitimacy, often resulting in funds being withdrawn from Uber’s account and returned to the rider.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;42fb3550-4e62-4b1e-8a4a-7c84aaad6544&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-psp-initiated-events&#34;&gt;&lt;br&gt;&lt;strong&gt;PSP-Initiated Events&lt;/strong&gt;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9f392df5-7980-4e5b-bf4b-e0b197d5f2b7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;PSP-initiated events are managed by the PSP. These include several critical financial processes:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ceee52b8-0632-4673-88be-e36b511d3901&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Trip Fees:&lt;/strong&gt; These are fees directly related to the trips taken by riders, such as a gateway fee, card network fee, etc.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Non-Trip Fees:&lt;/strong&gt; These are fees that are applied on an aggregated level rather than per trip, such as a gateway fee or card network fee.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Taxes:&lt;/strong&gt; PSPs often handle the collection and remittance of applicable taxes on transactions, per tax regulations.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Payment Verification:&lt;/strong&gt; This involves verifying the authenticity and validity of payments. PSPs perform checks to prevent fraud, ensure that payment details are correct, and that funds are available.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4fb659a4-bb1a-4ce4-960a-0bf593b62ef3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Each of these events plays a vital role in the comprehensive financial management system, ensuring that transactions are processed accurately, disputes are handled properly, and regulatory compliance is maintained. Understanding and managing these events effectively is essential for maintaining financial integrity and operational efficiency in the payment processing ecosystem.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4c6d2080-a59c-4dd6-9dcc-da1bb84dedd5&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e9947bc4-e53c-4618-8fcc-1c6c6442a2a5&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-challenges-with-the-psp-files&#34;&gt;Challenges with the PSP files&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d44489e2-2461-4c5f-86ba-62c4bf266f75&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Efficient financial transaction management is critical in today’s digital landscape. Payment service providers facilitate these transactions, but reconciling PSP settlement files can be challenging. Here are the common challenges with PSP settlement files:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e2af04b3-ff0b-4ee3-b248-3a66adbdd8c9&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Complexity:&lt;/strong&gt; Each PSP has its own file format, and there are diverse file delivery mechanisms available.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Duplicates:&lt;/strong&gt; Duplicates occur when the same transaction or entry is recorded more than once in the settlement files. This leads to discrepancies in financial records and causes issues in reconciliation. For instance, a transaction for a payment of $100 might be recorded twice, resulting in an inflated total of $200 instead of the actual $100.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Missing or Wrong ‌References:&lt;/strong&gt; This challenge involves the absence of necessary reference information or the inclusion of incorrect references in the settlement files, making it difficult to match transactions accurately. A transaction record might lack a unique transaction ID or have an incorrect ID that doesn’t match the records in the payment platform, leading to reconciliation issues.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Format Issues:&lt;/strong&gt; These occur when the data in the settlement files don’t conform to the expected format, leading to difficulties in processing and reconciliation. For example, a settlement file might include dates in DD/MM/YYYY format instead of the expected MM/DD/YYYY format, or contain extra columns that aren’t anticipated by the processing system.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Balancing Equation Isn’t Satisfied: &lt;/strong&gt;The balancing equation &lt;em&gt;Settlements – Deductions = Payout&lt;/em&gt;&lt;strong&gt; &lt;/strong&gt;ensures that the total settlements minus deductions should equal the payout amount. Any discrepancies indicate potential errors in the settlement data. For example, if the settlements amount to $10,000 and deductions are $2,000, the payout should be $8,000. If the file shows a payout of $7,500, there’s a discrepancy that needs investigation.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Large One-Off Transactions Monitoring:&lt;/strong&gt; When a PSP conducts a large one-off transaction, it requires special monitoring to ensure it behaves as expected and doesn’t cause disruptions. For example, a PSP might conduct a one-off transaction withholding $10 million USD. Systems must monitor this transaction closely to ensure it’s processed correctly and reflects accurately in all financial records.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;24185785-9fb5-4637-b66b-6ab93e5d81aa&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;042bb279-3a9b-4765-9a3a-27e587175551&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architecture&#34;&gt;Architecture&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2f029662-28f5-46d4-bc36-d4bed0c7fe1b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The settlement accounting system manages challenges with PSP files and streamlines financial precision. Settlement accounting at Uber has 3 primary components: the Feed Ingestion Service, the Feed Processor Service, and the Reconciliation &amp;amp; Accounting Service. Each service has specific contractual responsibilities that are crucial for understanding their roles in the overall settlement process.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098209,&amp;quot;width&amp;quot;:&amp;quot;802px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;2cf7b2f1-c3cf-4a82-9466-e32365e18f44&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;309&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639-1024x309.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098209&#34; style=&#34;width:802px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: Parts of the Settlement Accounting infrastructure.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;271b7874-c0f5-42d4-b2de-9fb7a47f5322&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4630a1b6-0d11-4c40-a3eb-d8e18fc53c00&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The File Ingestion Service is integral to managing settlement files obtained from third-party PSPs. Its primary function includes fetching these files from third-party sources and transferring them to a designated file storage location. This approach ensures that we avoid excessive retries or reprocessing requests from ‌third-party sources by storing the files internally.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;a38fcd16-cab7-4543-a646-2cb6901920c0&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-feed-ingestion-service&#34;&gt;&lt;br&gt;Feed Ingestion Service&amp;nbsp;&lt;/h3&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098212,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;44a29c2a-e362-4a5f-9230-ecf216a8d297&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;812&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610-1024x812.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098212&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: The functioning of the file ingestion service, including downloading, parsing, and normalizing.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f98eecf3-70ee-4bb1-b9f3-fc36f92a6c65&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d0971fac-9043-487d-a283-dc4ed214ef72&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Downloading files from PSPs involves accessing settlement files published by PSPs through various data sources, such as SFTP, APIs, or blob stores. The File Ingestion Service retrieves these files directly from the source and uploads them to a designated blob store. This store serves as a centralized repository from which the files can be accessed for subsequent reading and processing.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c3136627-cb64-4ff8-a6ac-d76fb389c721&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Parsing presents a significant challenge due to the lack of standardized formats among settlement files from different PSPs. This necessitates dynamic parsing tailored to each format and PSP. The File Ingestion Service relies heavily on configuration for parsing the files sent by the PSP. For every PSP onboarding into the system, parser rules are written to parse the files for processing. Before applying parsing rules, we stage the file data into necessary tokens for further processing. This is called tokenization of data. Tokenizing involves splitting using delimiters and tagging the data to configured tokens.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;eae27851-4064-46e4-a52b-f863b04115e7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Since PSPs send data in their unique format, it complicates the process of data processing. To address this challenge, the File Ingestion Service performs a crucial function known as normalization. During parsing, the service converts the varied data formats received from PSPs into a standardized, consumable format. This normalization process ensures that the data is structured consistently, facilitating easier and more efficient processing downstream.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3b466219-0aeb-487b-8314-5029766107d4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To effectively process the PSP feed, essential fields like amount, currency, and transaction date are identified as critical. These key business data elements are extracted and structured into a standardized, normalized format known as PSPEvent. This standardized format ensures consistency and clarity of the extracted information. Later, the PSPEvent is transmitted to the feed-processing component for further stages of processing and analysis.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098214,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;4d009874-8211-4bf0-b66f-0fbe3f72b935&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;486&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/rules-17297147319977-1024x486.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098214&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/rules-17297147319977.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/rules-17297147319977.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/rules-17297147319977.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1500,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/rules-17297147319977.png 1500w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: Sample normalization for a PSPEvent.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;54447c35-7d55-4f53-90f1-8f77d9ffd0be&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;2d3a5c07-5d52-490b-b070-a6f1350e3a50&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-feed-processor-service&#34;&gt;&lt;br&gt;Feed Processor Service&amp;nbsp;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;80ebb41f-7de5-4ef1-86f1-a5a066604d0a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As summarized previously, the Feed Parser divides the incoming PSP file data into distinct buckets called splits. This targeted segmentation ensures that each payment event is processed in a contextually relevant manner, setting the foundation for a more efficient and precise reconciliation process.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098217,&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;0545ac55-542c-4be4-b198-4c9f868190a4&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-full is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;2394&#34; height=&#34;1584&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1098217&#34; style=&#34;width:700px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2394,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg 2394w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm-17297151251181.jpeg 2048w&#34; sizes=&#34;(max-width: 2394px) 100vw, 2394px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: The functioning of the batching and aggregating of the normalized events.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;11d8a3d0-09aa-4d3b-9f98-4f8208afc210&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c6c07030-bdf5-48ef-9d9a-346f6f6e39c0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Following the parsing phase, the Feed Processor steps in to handle each of these buckets in parallel. This parallel processing approach significantly accelerates the handling of large volumes of PSP events, reducing overall processing time and enhancing throughput. For each PSP event within a split, the Feed Processor calls the Reconciliation Service. This service meticulously matches these PSP events with Uber’s Payment Platform records, ensuring that every transaction is accurately reconciled.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a4096ec0-fc67-4b80-ac77-182f538c9999&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;However, not all reconciliation attempts are successful. For events where reconciliation fails, the system marks them as unhealthy and submits them to the DLQ (Dead Letter Queue). The DLQ acts as a safety net, ensuring that these events are retried and resolved at a later time. This mechanism maintains the integrity and accuracy of our payment processing pipeline by ensuring no event is lost or forgotten.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a3b70a01-7181-4b9e-8951-8882272e6c38&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Once the financial events are enriched, they’re sent back to the Feed Processor. After completing the processing of a split, these enriched financial events are forwarded to our accounting engine. At this stage, the financial events are meticulously processed, and the corresponding accounting transactions are persistently stored in our data repository. This ensures that every financial event is accurately accounted for, maintaining the fidelity of Uber’s financial records.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;7f5e5564-d4e9-48e6-933d-3e87e853d094&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-reconciliation-amp-accounting-service&#34;&gt;&lt;br&gt;Reconciliation &amp;amp; Accounting Service&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;71ec042c-2efb-4a80-8e4e-991d1d11c9a2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;According to the &lt;a href=&#34;https://www.withum.com/resources/2022-acfe-report-to-the-nations-fraud-trends-and-key-takeaways/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Association of the Certified Fraud Examiners&lt;/a&gt;, businesses typically lose around 5% of their annual revenue to fraud, much of which stems from discrepancies in financial records.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;55820ed7-f53e-4578-8328-0e0028a967eb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Payment reconciliation, in essence, is the process of cross-referencing and verifying financial transactions between the payment service providers and the bank records. The primary goal is to ensure that all transactions are accounted for accurately and that the settlements by the payment service providers match the expected revenue.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;797a34a5-7a2c-473b-9739-2a3191525d19&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Besides protecting against fraud, effective payment reconciliation enables data-driven decision-making, features the trends among various payment service providers, and manages compliance with legal and financial regulations.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;11b8223b-83e4-4f2f-adfc-1de3e28ff83c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The Reconciliation Service plays a crucial role in reconciling PSPEvents with records on the Uber Payment Platform, ensuring that Uber receives payment for every trip where PSPs were involved in processing transactions. The reconciliation process hinges on matching precise records from both the PSP and Uber Payment Platform, facilitated by a deterministic field called &lt;em&gt;transactionReference&lt;/em&gt; shared between them. This acts as a unique reference, established and stored during the payment transaction process between Uber and the PSP. Uber retains these references to validate incoming data from the PSP during reconciliation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;42bd3ea2-54f3-4efe-b09a-2011ba1e0f09&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098219,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;a9e8c9a0-f704-4d2a-b6d3-b1ba17bade0c&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;974&#34; height=&#34;1024&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089-974x1024.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1098219&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=974,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 974w, https://blog.uber-cdn.com/cdn-cgi/image/width=285,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 285w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1461,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 1461w, https://blog.uber-cdn.com/cdn-cgi/image/width=1632,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 1632w&#34; sizes=&#34;(max-width: 974px) 100vw, 974px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 6: The reconciliation and accounting architecture for the PSP events.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;42bd3ea2-54f3-4efe-b09a-2011ba1e0f09&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bf8b9c19-9ecc-403c-89dc-5fd8245d87d0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Reconciliation operations aren’t immediate upon trip completion but can occur with a delay due to the PSP sending data to Uber on a scheduled basis—typically daily or weekly, about T+7 days after the transaction. Given Uber processes around 1 billion trips per month via PSPs, the system must accommodate high scalability and robust storage capabilities.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d814020e-61c7-4622-b76a-cff09e2839e3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To streamline operations and segregate responsibilities between trip ingestion and PSPEvent processing, we designed the system with a dedicated Trip Ingestion Service. Trip information is ingested into the system via an Apache Kafka&lt;sup&gt;®&lt;/sup&gt; consumer triggered on an event basis, immediately upon trip completion. The Kafka consumer hydrates the cache with essential details such as trip ID and the &lt;em&gt;transactionReference&lt;/em&gt;, enabling swift retrieval and correlation when processing PSPEvents.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;243e1731-aed9-426f-a6dc-619c286e78c4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;When reconciliation is successful, the events undergo an enrichment process. They’re supplemented with data from 15 different upstream sources, transforming them into comprehensive financial events. These financial events are self-sufficient data models, containing all the information necessary for precise and accurate accounting.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c0a9fd4d-71b1-4057-a277-6762284ba3ca&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;These financial events are sent to the accounting service to generate the financial accounting transactions.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b3c213e7-e361-4b8f-8986-1174650c4763&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Upon creation of a financial event, it’s promptly routed to the accounting engine, where meticulously configured accounting rules come into play. Each event type is associated with specific accounting rules that guide the evaluation process. These financial events carry all necessary parameters to facilitate the application of relevant accounting rules.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;92a24c3d-04f2-4e9c-a4e4-b1b32fca9704&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Every financial event has pre-configured rulesets designed to calculate various segments of the accounting treatment. These events are tagged with attributes such as location, line of business, account type, etc. The account types are broadly categorized into assets, liabilities, and profit and loss. Each of these categories is further subdivided into revenue, contra-revenue, receivables, and payables and expenses.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f5524533-ae41-4f0f-b9c7-bb5bbf318fca&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;After ‌accounting rules are evaluated for a given event, a transaction model is generated based on the outcomes. This model represents the accounting treatment applied to the event. The transaction model undergoes a series of validations to ensure accuracy and compliance with accounting standards. Once validated, the transaction is saved in the data store and then published to a Kafka topic for downstream systems to consume.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;607ccc00-6ca1-4e7f-b5a3-1e648320e60a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The validated transactions are aggregated into a ledger, which provides a comprehensive view of all financial activities. This ledger is essential for financial reporting, audit trails, and strategic decision-making.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d41bc132-3f05-4d65-a1f0-8ebca8cdd9f8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;d0279e52-e7fc-4433-ad9b-ed1edc9108aa&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;300d14ed-d5f7-4d92-8d92-5d647f81fea9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our comprehensive settlement accounting system at Uber is designed to efficiently handle the immense volume of transactions processed each month. By using a structured approach that includes parsing, processing, reconciliation, enrichment, and accounting, we ensure that each financial event is accurately captured and recorded.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;062b88af-8ec0-4b95-9269-0e06bb8896dd&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This robust system not only accelerates processing time but also enhances the accuracy and integrity of our financial operations. Automated reconciliation and real-time reporting improve operational efficiency, support strategic business decisions, and maintain regulatory compliance. Additionally, it helps in managing transaction costs, preventing fraud, and fostering customer trust through precise and timely resolution of payment issues.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;dbd560d5-73b2-4dc6-b86e-a15319458955&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Ultimately, this settlement accounting framework underscores Uber’s commitment to operational excellence and reliability, ensuring that our financial processes are secure.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;77267101-94c4-4706-bb0a-d07e537f27df&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Apache&lt;sup&gt;®&lt;/sup&gt;, Apache Kafka&lt;sup&gt;®&lt;/sup&gt;, Kafka&lt;sup&gt;®&lt;/sup&gt;, Apache Cassandra&lt;sup&gt;®&lt;/sup&gt;, Cassandra&lt;sup&gt;®&lt;/sup&gt;, Apache Spark&lt;sup&gt; ™&lt;/sup&gt;, Spark&lt;sup&gt; ™&lt;/sup&gt;, Apache Hive&lt;sup&gt; ™&lt;/sup&gt;, and Hive&lt;sup&gt; ™&lt;/sup&gt; are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries. No endorsement by The Apache Software Foundation is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;1801f856-06d7-4d1e-b983-5c0e34944441&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d28e00ac-0240-44d8-bd8d-0f7441623771&#34;,&#34;dropCap&#34;:false}&#34;&gt;在领域中在金融科技领域，与 PSP（支付服务提供商）相关的结算、退款和退款是至关重要的交易，涉及不同金融实体之间的资金转移以完成支付流程。 PSP 充当商家和消费者之间的中介，促进资金的顺利、安全转移。本文中的结算是指日终流程，即从消费者处收取的资金在扣除任何费用或收费后支付给商家&lt;strong&gt;。&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4b613f6a-b4a6-43c8-896e-18ee740601af&#34;,&#34;dropCap&#34;:false}&#34;&gt;结算记账为一个关键的财务流程，涉及核对和记录与通过 PSP 进行的结算、退款和其他财务活动相关的所有交易。在 Uber，由于交易量巨大且需要精确的财务跟踪，结算会计是必不可少的。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098207,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“98096e93-b824-4c92-af22-468fab18e202”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“555”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/image-1-17297140298650-1024x555.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098207&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图片/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 300w，https://blog.uber-cdn.com/cdn -cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 768w，https://blog.uber-cdn。 com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 1536w，https://blog.uber -cdn.com/cdn-cgi/image/width=2048，质量=80，onerror=重定向，format=auto/wp-content/uploads/2024/10/image-1-17297140298650.png 2048w“尺寸=”（ max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：卡支付处理和市场主要参与者的摘要。&lt;/figcaption&gt; &lt;/图&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;核心/段落ph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8d5cd00f-8537-4acf-b571-6ad5f217245b&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们每月处理约 12 亿笔结算，处理约 1300 亿美元现金每年从 50 多个不同的 PSP 中转移，该流程可确保从各种支付方式收到的资金得到准确核算并与相应的银行对账单相匹配。分析与 PSP 的合同以确定与交易相关的费用、税金和其他费用。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;48f19f93-df8a-4d4f-822b-457c25df29f0&#34;,&#34;dropCap&#34;:false}&#34;&gt;此博客介绍了Uber先进的结算会计系统。结算会计对于确保财务准确性、防止欺诈和保持监管合规性至关重要。通过自动对账和提供近乎实时的报告，它提高了运营效率并支持战略业务决策。此外，它还通过分析 PSP 费用和税收来帮助管理交易成本。可靠的结算会计通过准确处理和及时解决付款问题来培养客户信任。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b1730c08-4e9d-47af-abab-3c1bdde1ed18&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2ad61c98-7341-4fac-8ca2-4ae6b93f88da&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-motivation&#34;&gt;动机&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;78f806f0-9dda-4c0a-81d1-45ab56a9cd38&#34;,&#34;dropCap&#34;:false}&#34;&gt;PSP 文件包括支付服务提供商发起的各种事件，每个事件均由不同方发起，对于维持准确的金融运营至关重要。我们建立了结算会计系统来管理这些事件。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;2fc0868d-a293-492a-ac65-9d3a34260f39&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-uber-initerated-events&#34;&gt;&lt;strong&gt;Uber 发起的事件&lt;/strong&gt;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a04b5ef0-e7fe-4406-8eca-89838535154b&#34;,&#34;dropCap&#34;:false}&#34;&gt;当考虑支付生态系统中，Uber 发起的事件是 Uber 直接发起的行动。它们包括：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;40ffc0fa-1d14-4162-b666-1aae618cdd2d&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;催收&lt;/strong&gt;：Uber 发起催收n 的资金来自乘客提供的服务。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;退款&lt;/strong&gt;：当乘客欠款时，Uber 会启动退款流程。这可能是由于行程取消、服务问题或其他需要向乘客退还资金的原因造成的。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;012d12c3-1fc1-4c5b-ba15-c3a0ecdb4b60&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-rider-initerated-events&#34;&gt;&lt;br&gt;&lt;strong&gt;骑手发起的事件&lt;/strong&gt;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;eb657940-a4ba-4677-b0a0-9f6e4850a063&#34;,&#34;dropCap&#34;:false}&#34;&gt;骑手发起事件由乘客触发，通常是为了响应问题或争议。其中包括：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c8cc5949-2582-45a0-bb0f-730690789d3f&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;退款&lt;/strong&gt;：乘客可以对交易提出异议，从而导致退款。此过程涉及在乘客质疑其合法性后撤销交易，通常会导致资金从 Uber 账户中提取并退还给乘客。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;42fb3550-4e62-4b1e-8a4a-7c84aaad6544&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-psp-initied-events&#34;&gt;&lt;br&gt;&lt;strong&gt;PSP 发起的事件&lt;/strong&gt;&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9f392df5-7980-4e5b-bf4b-e0b197d5f2b7&#34;,&#34;dropCap&#34;:false}&#34;&gt;PSP 启动事件由 PSP 管理。其中包括几个关键的财务流程：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ceee52b8-0632-4673-88be-e36b511d3901&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;行程费用&lt;/strong&gt;：这些费用与乘客的行程直接相关，例如网关费、卡网络费等。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;非行程费用&lt;/strong&gt;：这些费用是按汇总级别收取的费用而不是每次旅行，例如网关费用或卡网络费用。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;税费&lt;/strong&gt;：PSP 通常负责收取和汇出交易中适用的税费，根据税收法规。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;付款验证&lt;/strong&gt;：这涉及验证付款的真实性和有效性。 PSP 进行检查以防止欺诈，确保付款详细信息正确且资金可用。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p数​​据-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4fb659a4-bb1a-4ce4-960a-0bf593b62ef3&#34;,&#34;dropCap&#34;:false}&#34;&gt;每个事件都会发挥作用全面财务管理体系中发挥着至关重要的作用，确保交易准确处理、纠纷妥善处理、监管合规。有效地理解和管理这些事件对于维持支付处理生态系统的财务完整性和运营效率至关重要。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4c6d2080-a59c-4dd6-9dcc-da1bb84dedd5&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e9947bc4-e53c-4618-8fcc-1c6c6442a2a5&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-challenges-with-the-psp-files&#34;&gt;PSP 文件的挑战&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d44489e2-2461-4c5f-86ba-62c4bf266f75&#34;,&#34;dropCap&#34;:false}&#34;&gt;高效的金融交易管理在当今的数字环境中至关重要。支付服务提供商为这些交易提供便利，但协调 PSP 结算文件可能具有挑战性。以下是 PSP 结算文件的常见挑战：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e2af04b3-ff0b-4ee3-b248-3a66adbdd8c9&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;复杂性：&lt;/strong&gt;每个 PSP 都有自己的文件格式，并且有不同的文件可用的交付机制。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;重复：&lt;/strong&gt;当同一事务或条目被记录多次时，就会出现重复在结算档案中。这会导致财务记录出现差异并导致对账问题。例如，支付 100 美元的交易可能会被记录两次，导致总额夸大 200 美元，而不是实际的 100 美元。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;参考文献缺失或错误&lt;/strong&gt;：此挑战涉及缺乏必要的参考信息或结算文件中包含错误的参考信息，导致难以准确匹配交易。交易记录可能缺少唯一的交易 ID，或者 ID 不正确，与支付平台中的记录不匹配，从而导致对账问题。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;格式问题&lt;/strong&gt;：当结算文件中的数据不正确时，就会出现这些问题不符合预期格式，导致处理和核对困难。例如，和解文件可能包括 da测试采用 DD/MM/YYYY 格式，而不是预期的 MM/DD/YYYY 格式，或者包含处理系统未预期的额外列。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;不满足平衡方程：&lt;/strong&gt;平衡方程&lt;em&gt;定居点 –扣除额 = 付款&lt;/em&gt;&lt;strong&gt; &lt;/strong&gt;确保结算总额减去扣除额应等于付款金额。任何差异都表明结算数据中存在潜在错误。例如，如果和解金额为 10,000 美元，扣除金额为 2,000 美元，则赔付金额应为 8,000 美元。如果文件显示支付金额为 7,500 美元，则存在需要调查的差异。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;大型一次性交易监控：&lt;/strong&gt;当 PSP 进行大型一次性交易时关闭交易时，需要特殊监控以确保其按预期运行并且不会造成中断。例如，PSP 可能会进行一笔一次性交易，扣留 1000 万美元。系统必须密切监控这笔交易，以确保其得到正确处理并准确反映在所有财务记录中。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;24185785-9fb5-4637-b66b-6ab93e5d81aa&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;042bb279-3a9b-4765-9a3a-27e587175551&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architecture&#34;&gt;架构&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2f029662-28f5-46d4-bc36-d4bed0c7fe1b&#34;,&#34;dropCap&#34;:false}&#34;&gt;结算记账系统管理 PSP 文件的挑战并简化财务精度。 Uber 的结算会计有 3 个主要组件：Feed Ingestion Service、Feed Processor Service 以及 Reconciliation &amp; Accounting Service。每项服务都有特定的合同责任，这对于理解它们在整个结算流程中的角色至关重要。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098209,&#34;width&#34;:&#34;802px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;sizeSlug&#34;:&#34;大&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;2cf7b2f1-c3cf-4a82-9466-e32365e18f44&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img 加载=“惰性”解码=“异步”宽度=“1024”高度=“309”src=“https://blog.uber-cdn.com/cdn-cgi/image/width= 2160，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/architecture-17297141812639-1024x309.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098209&#34; style=&#34;width: 802px;高度：自动” srcset =“https://blog.uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=重定向，format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror =重定向，format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80， onerror=redirect，format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80 ，onerror=重定向，format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=2048，quality= 80,onerror=redirect,format=auto/wp-content/uploads/2024/10/architecture-17297141812639.png 2048w&#34; 尺寸=&#34;(最大宽度: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt; Figcaption class=&#34;wp-element-caption&#34;&gt;图 2：结算会计基础设施的一部分。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;271b7874-c0f5-42d4-b2de-9fb7a47f5322&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4630a1b6-0d11-4c40-a3eb-d8e18fc53c00&#34;,&#34;dropCap&#34;:false}&#34;&gt;文件摄取该服务是管理从第三方 PSP 获得的结算文件不可或缺的一部分。其主要功能包括从第三方来源获取这些文件并将其传输到指定的文件存储位置。这种方法可确保我们通过在内部存储文件来避免过度重试或重新处理来自第三方来源的请求。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;a38fcd16-cab7-4543-a646-2cb6901920c0&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-feed-ingestion-service&#34;&gt;&lt;br&gt;Feed 摄取服务&lt;/h3&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098212,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“44a29c2a-e362-4a5f-9230-ecf216a8d297”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“812”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/feed-ingestion-17297145987610-1024x812.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098212&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图片/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 300w，https://blog.uber-cdn.com/cdn -cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 768w，https://blog.uber-cdn。 com/cdn-cgi/image/width=1536，质量=80,onerror=重定向,format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/feed-ingestion-17297145987610。 png 2048w”尺寸=“（最大宽度：1024px）100vw，1024px” referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：文件摄取服务的功能，包括下载、解析和规范化。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div &gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f98eecf3-70ee-4bb1-b9f3-fc36f92a6c65&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d0971fac-9043-487d-a283-dc4ed214ef72&#34;,&#34;dropCap&#34;:false}&#34;&gt;从以下位置下载文件PSP 涉及通过各种数据源（例如 SFTP、API 或 Blob 存储）访问 PSP 发布的结算文件。文件摄取服务直接从源检索这些文件并将它们上传到指定的 blob 存储。该存储充当集中存储库，可以从中访问文件以进行后续读取和处理。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c3136627-cb64-4ff8-a6ac-d76fb389c721&#34;,&#34;dropCap&#34;:false}&#34;&gt;解析呈现由于不同 PSP 的结算文件缺乏标准化格式，这是一项重大挑战。这就需要针对每种格式和 PSP 进行动态解析。文件摄取服务在很大程度上依赖于解析 PSP 发送的文件的配置。对于每个 PSP 加入系统，都会编写解析器规则来解析文件以进行处理。在应用解析规则之前，我们将文件数据暂存为必要的标记以进行进一步处理。这称为数据标记化。标记化涉及使用分隔符进行分割并将数据标记为配置的标记。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;eae27851-4064-46e4-a52b-f863b04115e7&#34;,&#34;dropCap&#34;:false}&#34;&gt;自 PSP 发送以来数据以其独特的格式存在，这使得数据处理过程变得复杂。为了应对这一挑战，文件摄取服务执行一项称为标准化的关键功能。在解析过程中，该服务将从 PSP 接收到的各种数据格式转换为标准化的、可使用的格式。这种规范化过程可确保数据结构一致，从而促进下游处理更轻松、更高效。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3b466219-0aeb-487b-8314-5029766107d4&#34;,&#34;dropCap&#34;:false}&#34;&gt;有效处理在 PSP feed 中，金额、货币和交易日期等基本字段被认为是关键字段。这些关键业务数据元素被提取并构建为标准化、规范化的格式，称为 PSPEvent。这个标准dized 格式确保提取信息的一致性和清晰度。随后，PSPEvent 被传输到馈送处理组件以进行进一步的处理和分析。 &lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098214,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“4d009874-8211-4bf0-b66f-0fbe3f72b935”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“486”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/rules-17297147319977-1024x486.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098214&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024 ，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/rules-17297147319977.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width= 300，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/rules-17297147319977.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width =768，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/rules-17297147319977.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/宽度=1500，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/rules-17297147319977.png 1500w“尺寸=”（最大宽度：1024px）100vw，1024px“referrerpolicy=” no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 4：PSPEvent 标准化示例。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;54447c35-7d55-4f53-90f1-8f77d9ffd0be&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;2d3a5c07-5d52-490b-b070-a6f1350e3a50&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-feed-processor-service&#34;&gt;&lt;br&gt;Feed 处理器服务&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;80ebb41f-7de5-4ef1-86f1-a5a066604d0a&#34;,&#34;dropCap&#34;:false}&#34;&gt;如前所述，Feed Parser 将传入的 PSP 文件数据划分为不同的桶（称为 split）。这种有针对性的细分可确保以上下文相关的方式处理每个支付事件，从而为更高效、更精确的对账流程奠定基础。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098217,&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;sizeSlug&#34;:&#34; full&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;0545ac55-542c-4be4-b198-4c9f868190a4&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-full is-resized&#34;&gt;&lt;img 加载=“惰性”解码=“异步”宽度=“2394”高度=“1584”src=“https://blog.uber-cdn.com/cdn-cgi/image”/宽度=2160，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm​​-17297151251181.jpeg&#34; alt=&#34;&#34; 类= “wp-image-1098217”样式=“宽度：700px;高度：自动”srcset =“https://blog.uber-cdn.com/cdn-cgi/image/width=2394，质量= 80，onerror =重定向，format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm​​-17297151251181.jpeg 2394w，https://blog.uber-cdn.com/cdn-cgi/image /width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm​​-17297151251181.jpeg 300w，https://blog .uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25 pm-17297151251181.jpeg 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10 /image-10-23-24-at-1.25pm​​-17297151251181.jpeg 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，格式=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm​​-17297151251181.jpeg 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width =2048，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/image-10-23-24-at-1.25pm​​-17297151251181.jpeg 2048w“尺寸=”（最大宽度: 2394px) 100vw, 2394px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：标准化事件的批处理和聚合功能。&lt;/figcaption&gt;&lt;/figure&gt; &lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;11d8a3d0-09aa-4d3b-9f98-4f8208afc210&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c6c07030-bdf5-48ef-9d9a-346f6f6e39c0&#34;,&#34;dropCap&#34;:false}&#34;&gt;下面进行解析阶段，Feed Processor 介入并行处理每个桶。这种并行处理方法显着加快了大量 PSP 事件的处理速度，减少了总体处理时间并提高了吞吐量。对于拆分中的每个 PSP 事件，源处理器会调用协调服务。该服务将这些 PSP 事件与 Uber 支付平台记录进行精心匹配，确保每笔交易都得到准确核对。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a4096ec0-fc67-4b80-ac77-182f538c9999&#34;,&#34;dropCap&#34;:false}&#34;&gt;但是，不所有和解尝试都是成功的。对于协调失败的事件，系统将其标记为不健康，并将其提交到DLQ（死信队列）。 DLQ 充当安全网，确保稍后重试并解决这些事件。该机制通过确保没有事件丢失或遗忘来维护我们支付处理管道的完整性和准确性。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a3b70a01-7181-4b9e-8951-8882272e6c38&#34;,&#34;dropCap&#34;:false}&#34;&gt;一旦财务活动已结束饥饿后，它们会被送回饲料处理器。完成分割处理后，这些丰富的财务事件将被转发到我们的会计引擎。在此阶段，财务事件经过精心处理，相应的会计交易将持久存储在我们的数据存储库中。这可确保准确记录每项财务事件，从而保持 Uber 财务记录的保真度。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;7f5e5564-d4e9-48e6-933d-3e87e853d094&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-reconciliation-amp-accounting-service&#34;&gt;&lt;br&gt;对账与会计服务&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;71ec042c-2efb-4a80-8e4e-991d1d11c9a2&#34;,&#34;dropCap&#34;:false}&#34;&gt;根据&lt;a href=&#34;https://www.withum.com/resources/2022-acfe-report-to-the-nations-fraud-trends-and-key-takeaways/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener &#34;&gt;根据注册欺诈审查员协会&lt;/a&gt;的调查，企业通常会因欺诈而损失约 5% 的年收入，其中大部分源于财务记录的差异。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;55820ed7-f53e-4578-8328-0e0028a967eb&#34;,&#34;dropCap&#34;:false}&#34;&gt;付款对账，本质上，是支付服务提供商和银行记录之间交叉引用和验证金融交易的过程。主要目标是确保所有交易均得到准确核算，并确保支付服务提供商的结算与预期收入相符。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;797a34a5-7a2c-473b-9739-2a3191525d19&#34;,&#34;dropCap&#34;:false}&#34;&gt;除了防止欺诈，有效的支付对账可以实现数据驱动的决策，展示不同支付服务提供商之间的趋势，并管理法律和金融法规的合规性。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;11b8223b-83e4-4f2f-adfc-1de3e28ff83c&#34;,&#34;dropCap&#34;:false}&#34;&gt;调节服务在协调 PSPEvents 与 Uber 支付平台上的记录方面发挥着至关重要的作用，确保 Uber 收到 PSP 参与处理交易的每次行程的付款。协调过程取决于匹配来自 PSP 和 Uber 支付平台的精确记录，并通过它们之间共享的名为 &lt;em&gt;transactionReference&lt;/em&gt; 的确定性字段来促进。这是在 Uber 和 PSP 之间的支付交易过程中建立和存储的唯一参考。 Uber 保留这些引用，以便在协调期间验证来自 PSP 的传入数据。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;42bd3ea2-54f3-4efe-b09a-2011ba1e0f09&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098219,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“a9e8c9a0-f704-4d2a-b6d3-b1ba17bade0c”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “974”高度=“1024”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/image-10-23-24-at-1.27pm-17297152992089-974x1024.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1098219&#34; srcset=&#34;https://blog.uber-cdn. com/cdn-cgi/image/width=974，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 974w，https://blog.uber-cdn.com/cdn-cgi/image/width=285，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/image-10- 23-24-at-1.27pm-17297152992089.jpeg 285w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-内容/上传/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1461，quality= 80，onerror=重定向，format=auto/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 1461w，https://blog.uber-cdn.com/ cdn-cgi/图像/宽度=1632，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/image-10-23-24-at-1.27pm-17297152992089.jpeg 1632w&#34; size=&#34;(max-width: 974px) 100vw, 974px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 6：PSP 事件的对账和会计架构。&lt;/figcaption &gt;&lt;/图&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;42bd3ea2-54f3-4efe-b09a-2011ba1e0f09&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bf8b9c19-9ecc-403c-89dc-5fd8245d87d0&#34;,&#34;dropCap&#34;:false}&#34;&gt;调节操作是行程完成后不会立即发生，但可能会延迟发生，因为 PSP 按计划向 Uber 发送数据（通常是每天或每周，大约在交易后 T+7 天）。鉴于 Uber 每月通过 PSP 处理约 10 亿次出行，该系统必须具备高可扩展性和强大的存储功能。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d814020e-61c7-4622-b76a-cff09e2839e3&#34;,&#34;dropCap&#34;:false}&#34;&gt;简化操作为了分离行程摄取和 PSPEvent 处理之间的职责，我们设计了具有专用行程摄取服务的系统。行程信息通过 Apache Kafka&lt;sup&gt;®&lt;/sup&gt; 消费者摄取到系统中，该消费者在行程完成后立即基于事件触发。 Kafka 消费者使用必要的详细信息（例如行程 ID 和 transactionReference）来填充缓存，enab处理 PSPEvents 时能够快速检索和关联。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;243e1731-aed9-426f-a6dc-619c286e78c4&#34;,&#34;dropCap&#34;:false}&#34;&gt;何时进行调节成功后，活动将经历丰富的过程。它们补充了来自 15 个不同上游来源的数据，将其转化为综合金融事件。这些财务事件是自给自足的数据模型，包含精确和准确会计所需的所有信息。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c0a9fd4d-71b1-4057-a277-6762284ba3ca&#34;,&#34;dropCap&#34;:false}&#34;&gt;这些金融事件发送到会计服务以生成财务会计交易。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b3c213e7-e361-4b8f-8986-1174650c4763&#34;,&#34;dropCap&#34;:false}&#34;&gt;创建后当发生财务事件时，它会立即路由到会计引擎，在那里精心配置的会计规则将发挥作用。每种事件类型都与指导评估过程的特定会计规则相关联。这些财务事件带有所有必要的参数，以促进相关会计规则的应用。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;92a24c3d-04f2-4e9c-a4e4-b1b32fca9704&#34;,&#34;dropCap&#34;:false}&#34;&gt;每个金融事件具有预先配置的规则集，旨在计算会计处理的各个部分。这些事件被标记为位置、业务范围、账户类型等属性。账户类型大致分为资产、负债和损益。每个类别又进一步细分为收入、对应收入、应收账款、应付账款和费用。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f5524533-ae41-4f0f-b9c7-bb5bbf318fca&#34;,&#34;dropCap&#34;:false}&#34;&gt;会计规则之后对给定事件进行评估，根据结果生成交易模型。该模型代表了应用于事件的会计处理。交易模型经过一系列验证，以确保准确性并符合会计准则。验证后，交易将保存在数据存储中，然后发布到 Kafka 主题以供下游系统使用。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;607ccc00-6ca1-4e7f-b5a3-1e648320e60a&#34;,&#34;dropCap&#34;:false}&#34;&gt;已验证的交易汇总到一个分类账中，提供所有金融活动的全面视图。该分类账对于财务报告、审计跟踪和战略决策至关重要。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d41bc132-3f05-4d65-a1f0-8ebca8cdd9f8&#34;,&amp;quot;opacity&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;d0279e52-e7fc-4433-ad9b-ed1edc9108aa&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;300d14ed-d5f7-4d92-8d92-5d647f81fea9&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的全面结算Uber 的会计系统旨在有效地处理每月处理的大量交易。通过使用包括解析、处理、对账、充实和会计在内的结构化方法，我们确保准确捕获和记录每个财务事件。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;062b88af-8ec0-4b95-9269-0e06bb8896dd&#34;,&#34;dropCap&#34;:false}&#34;&gt;这个强大的系统不仅加快了处理时间，还提高了我们财务运营的准确性和完整性。自动对账和实时报告可提高运营效率、支持战略业务决策并保持法规遵从性。此外，它还有助于管理交易成本、防止欺诈，并通过准确及时地解决支付问题来培养客户信任。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;dbd560d5-73b2-4dc6-b86e-a15319458955&#34;,&#34;dropCap&#34;:false}&#34;&gt;最终，这个结算会计框架强调了 Uber 对卓越运营和可靠性的承诺，确保我们的财务流程安全。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;哈希&#34;:&#34;77267101-94c4-4706-bb0a-d07e537f27df&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Apache&lt;sup&gt;®&lt;/sup&gt;、Apache Kafka&lt;sup&gt;®&lt;/sup&gt;、Kafka&lt;sup&gt;®&lt;/sup&gt;、 Apache Cassandra&lt;sup&gt;®&lt;/sup&gt;、Cassandra&lt;sup&gt;®&lt;/sup&gt;、Apache Spark&lt;sup&gt;™&lt;/sup&gt;、Spark&lt;sup&gt;™&lt;/sup&gt;、Apache Hive&lt;sup&gt;™&lt;/ support&gt; 和 Hive&lt;sup&gt;™&lt;/sup&gt; 是 Apache Software Foundation 在美国和/或其他国家/地区的注册商标或商标。使用这些标记并不暗示 Apache 软件基金会的认可。&lt;/em&gt;&lt;/p&gt;</description>
      <pubDate>Thu, 24 Oct 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【Open Source and In-House: How Uber Optimizes LLM Training】开源和内部：Uber 如何优化 LLM 培训</title>
      <link>https://www.uber.com/blog/open-source-and-in-house-how-uber-optimizes-llm-training/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;2a1bfc33-e3e2-438f-ae6e-3769f3795e56&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0b5d692f-13a5-447f-bcc4-de8dc6bdb7f9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Generative AI powered by LLMs (Large Language Models) has a wide range of applications at Uber, like Uber Eats recommendations and search, customer support chatbots, code development, and SQL query generation.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2bac8375-db6b-4ae6-8d93-a2aae00fd471&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To support these applications, Uber leverages open-source models like Meta&lt;sup&gt;®&lt;/sup&gt; Llama 2 and Mistral AI Mixtral&lt;sup&gt;®&lt;/sup&gt;, and closed-source models from OpenAI, Google, and other third-party providers. As a leading company in mobility and delivery, Uber also has considerable domain-specific knowledge that can improve LLM performance for these applications. ‌One way Uber incorporates this domain-specific knowledge is through RAG (Retrieval Augmented Generation).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7e841d89-1252-4bc2-b78f-b3a1630cf7fc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Uber also explores ways to adapt LLMs to Uber’s knowledge base through continuous pre-training and instruction fine-tuning. For example, for Uber Eats, we found that a model finetuned on Uber’s knowledge of items, dishes, and restaurants could improve the accuracy of item tagging, search queries, and user preference understanding compared to open-source model results. Even further, these finetuned models can achieve similar performance to GPT-4 models while allowing for much more traffic at Uber’s scale.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1946080a-21ea-4227-8723-e6eb98d414d6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;AI community support and open-source libraries like &lt;a href=&#34;https://huggingface.co/docs/transformers/index&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;transformers&lt;/a&gt;, Microsoft DeepSpeed&lt;sup&gt;®&lt;/sup&gt;, and &lt;a href=&#34;https://pytorch.org/blog/introducing-pytorch-fully-sharded-data-parallel-api/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;PyTorch FSDP&lt;/a&gt; empower Uber to rapidly build infrastructure to efficiently train and evaluate LLMs. Emerging open-source initiatives like&lt;a href=&#34;https://github.com/facebookresearch/llama-recipes&#34;&gt; &lt;/a&gt;Meta&lt;sup&gt;®&lt;/sup&gt; Llama 3 &lt;a href=&#34;https://github.com/facebookresearch/llama-recipes&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;llama-recipes&lt;/a&gt;, Microsoft &lt;a href=&#34;https://github.com/microsoft/LoRA&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;LoRA&lt;/a&gt;&lt;sup&gt;®&lt;/sup&gt;, &lt;a href=&#34;https://github.com/artidoro/qlora&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;QLoRA&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt;, and Hugging Face &lt;a href=&#34;https://github.com/huggingface/peft&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;PEFT&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; simplify the fine-tuning lifecycle for LLMs and reduce engineering efforts. Tools like &lt;a href=&#34;https://github.com/ray-project/ray&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Ray&lt;/a&gt;&lt;sup&gt;®&lt;/sup&gt; and &lt;a href=&#34;https://github.com/vllm-project/vllm&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;vLLM&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; maximize the throughput of large-scale pre-training, fine-tuning, offline batch prediction, and online serving capabilities for open-source LLMs.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d374805e-07fa-44fa-a4a7-020598b58abc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The novel in-house LLM training approach described in this blog ensures Uber’s flexibility and speed in prototyping and developing Generative AI-driven services. We use SOTA (state-of-the-art) open-source models for faster, cheaper, and more secure and scalable experimentation. Optimized in-house LLM training helps Uber maintain cutting-edge technology innovations and passes on the benefits to people who use the Uber app.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a0029706-3a73-4cc2-a568-7c36b37caf0b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f86bcfc9-0737-45be-9e65-5a7d07a833d5&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-infrastructure-stack&#34;&gt;Infrastructure Stack&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;abe7dc70-d3c6-4977-bf70-07599b182907&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;A critical component of LLM training at Uber is the thoroughly tested infrastructure stack that enables rapid experimentation.&amp;nbsp;&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;ba22d7dd-5289-43c0-b348-01d8f8ddcc6b&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-layer-0-hardware&#34;&gt;Layer 0: Hardware&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7a540b97-614a-4d27-95b2-aa5e4853fc23&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Uber’s in-house LLM workflows are scheduled on 2 kinds of computing instances: (1) NVIDIA&lt;sup&gt;®&lt;/sup&gt; A100 GPU instances in Uber’s on-prem clusters and (2) NVIDIA H100 GPU instances on Google Cloud. Each Uber on-prem A100 host is equipped with 4 A100 GPUs, 600 GB memory, and 3 TB SSD.&amp;nbsp; On Google Cloud, each host is a 3-highgpu-8g machine type, with 8 H100 GPUs, 1872GB CPU memory, and 6TB SSD. These machines are managed as part of the &lt;a href=&#34;https://www.uber.com/en-MX/blog/crane-ubers-next-gen-infrastructure-stack/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Crane&lt;/a&gt; infrastructure stack.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;e69d694b-39e3-4650-824d-947f2ba180b7&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-layer-1-orchestration&#34;&gt;Layer 1: Orchestration&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3a32a183-2b47-42a7-902f-3dc9c2fde9dc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Computing resources are managed by Kubernetes&lt;sup&gt;®&lt;/sup&gt; and Ray. Kubernetes is used to schedule training workloads and manage hardware requirements. Ray, along with the KubeRay operator, is used for distributing the workload to the workers.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;d742a5e0-215c-4584-a99d-2cd2f2ec42d9&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-layer-2-federation&#34;&gt;Layer 2: Federation&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;353d646a-5615-4d50-b4bc-b0ffaffc27dd&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The end-to-end flow of resource management is depicted in Figure 1 below. Our multiple Kubernetes clusters are managed by a federation layer, which schedules workloads based on resource availability. Training jobs are modeled as a Job with multiple Tasks. The JobSpec defines the goal state of the Job and includes information like the instance SKUs, clusters, compute/storage resources, and post-Docker-launch commands to set up tokens and environment variables.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097951,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;dff8f22e-4f52-4cf6-ab64-b2c4eaecab2c&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;799&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604-1024x799.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097951&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1471,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 1471w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Resource scheduling for LLM workflows.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;75c9c747-bc39-426c-85aa-e0c39e60e5b8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5dc9360d-b887-467d-9b4d-a21813c32596&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;97a27885-ee5a-402d-b7d8-36ad09297d0c&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-training-stack&#34;&gt;Training Stack&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9600c43d-0531-437a-82b9-3968d02c9cf4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We fully embraced open source when building our LLM training stack. Specifically, we integrated PyTorch, Ray, Hugging Face, DeepSpeed, and NCLL to enable training LLMs with the Michelangelo platform.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;13622ae7-6133-4412-9f2b-11fef3eac11a&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;PyTorch is our chosen deep learning framework because most SOTA open-source LLMs and techniques are implemented in PyTorch.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Ray Train provides a thin API to perform distributed training using PyTorch on Ray clusters.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Hugging Face Transformers provide APIs and tools to download and train SOTA transformer-based models.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;DeepSpeed is a deep learning optimization software suite that enables unprecedented scale and speed for deep learning training and inference.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;08d5f9d1-cc0e-4979-80ea-011ebf35983f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As shown in Figure 2 below, Ray is at the top of the LLM training stack for coordinating tasks. NCCL is at the bottom level for GPU communication.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097891,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;1f4b6be8-b85d-4ea3-94c7-48ec2964ce74&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;535&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig2-17291323864935-1024x535.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097891&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig2-17291323864935.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig2-17291323864935.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig2-17291323864935.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig2-17291323864935.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1680,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/fig2-17291323864935.png 1680w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: Uber LLM training software stack.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;292322d2-b608-44f1-93bb-8a794cb0ae6e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9ce7e044-4e63-414e-91bb-787b66baa245&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1388b477-2ada-46d4-8926-b47d9e2cc6c9&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-distributed-training-pipeline&#34;&gt;Distributed Training Pipeline&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;93674e70-08af-454f-8eff-046a9cd96cdd&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To support our in-house implementation, we built an LLM distributed training pipeline that includes host communication, data preparation, distributed model training, and model checkpoint management. Here is how it works:&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;hash&amp;quot;:&amp;quot;901cb5da-a158-4522-a928-e1b50df61ef7&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Multi-host and multi-GPU communication&lt;/strong&gt;. To start, a TorchTrainer in Ray Train creates multiple workers in the form of Ray Actors, handles in-bound communication (used by Ray Object Store), and initializes a PyTorch distributed process group (used by Deepspeed) on GPUs across all hosts.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Data preparation&lt;/strong&gt;. The LLM training framework supports remote data sources on Uber HDFS, Uber Terrablob, and Hugging Face public datasets.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Model training&lt;/strong&gt;. Tokenization converts input text into integers that will be fed into the models. For distributed training, each GPU worker initializes a Hugging Face Transformers Trainer object using the DeepSpeed ZeRO stage 1/2/3 options.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Saving results.&lt;/strong&gt; Metrics associated with the training experiment are saved on the Uber Comet server. The main training process on the Ray head node pushes training model weights and associated configuration files to Terrablob storage.&amp;nbsp;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;aceba0d7-957c-43bf-beef-30c6b1b9db41&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdT3F2A2DQU9CZxNSsCKbIAIB7ZfHvNFKT2W7E2DRlpzCxmyD0NIwbwy0CfOCs2dnPJdQyHLuH5Ia7Dt5QSgICSuNmz9igsWp_TabDWQ8XCJs1GWbMBRohsvSv9qg-J19oJyuLqixlDKAlRZrfZyhzu3l_3?key=F9WnaYLpB5WvGJfBHoMLXQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: Uber LLM distributed training pipeline.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;63ddda68-46ce-42ab-a705-5330656936de&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;79024f68-5234-4376-958a-00799f61c598&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ddd7ea80-3f24-40ac-b5d0-c51ccdf19df5&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-training-results&#34;&gt;Training Results&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5e250810-041e-4b72-b1f2-503d255d34fa&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our exploration involved demonstrating that the in-house Michelangelo platform has the capability and scalability to train any open-source LLM with throughput optimization.&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;a3b35586-204b-4320-b82b-69c884b942be&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-training-on-state-of-the-art-llms&#34;&gt;Training on State-Of-The-Art LLMs&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;770ae998-1513-4b07-9ddd-21064b7f0d0e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We found that the Michelangelo platform can support the largest open-source LLMs while training under different settings, including full-parameter fine tuning and parameter-efficient fine tuning with LoRA and QLoRA.&amp;nbsp;&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097895,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;60b1c16e-2cee-4f9d-9961-44f6bb418189&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;505&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-17291324832411-1024x505.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097895&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-17291324832411.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-17291324832411.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-17291324832411.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1467,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-17291324832411.png 1467w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: Training loss of Llama 2 models with and without (Q)LoRA.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f8c07128-ce1d-418f-969b-2993735ab8ae&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;62e2ae55-2adb-47db-88d6-6aac1a579201&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 4 (above) shows the training loss curve for Llama 2 13B and Llama 2 70B with and without LoRA. We found that, even if LoRA and QLoRA use far fewer GPUs and train much faster with fewer GPUs, the loss decreases much less than the full parameter training. Therefore, it’s important to improve the throughput/Model Flops Utilization (MFU) for full parameter fine-tuning of LLMs.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;2794d532-813b-4ec7-8267-c36c5bfac293&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-throughput-mfu-optimization&#34;&gt;&lt;br&gt;Throughput/MFU Optimization&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;027c8334-2a64-4831-af4a-324f5abd02f0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Scaling the transformer architecture is heavily bottlenecked by the model’s self-attention mechanism, which has quadratic time and memory complexity. To achieve better training throughput, we’ve explored several industry recommended efforts to optimize GPU memory usage: CPU offload and flash attention.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a34ef321-de14-4067-af33-e2eb15596493&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The first training throughput optimization we explored was using DeepSpeed ZeRO-stage-3 CPU Optimizer Offload, which led to at least 34% GPU memory reduction with the same batch size when training Llama 2 70B. This allowed us to increase the batch size by 3-4 times but still keep the same forward and backward speed, so the training throughput increased by 2-3 times.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;758b796c-630f-443a-9953-7f554395bfe6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The second training throughput optimization explored was following Hugging Face’s suggestion to use flash attention. Flash attention is an attention algorithm used to reduce quadratic complexity and scale transformer-based models more efficiently, enabling faster training. With flash attention, we could save 50% of GPU memory with the same batch size. If we maximized the usage of GPU memory, then we could double the batch size while keeping compatible forward and backward speed.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;89be987d-e630-44c7-b748-e23a605041bc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To study training efficiency, we used Hardware Model Flops Utilization (&lt;a href=&#34;https://arxiv.org/pdf/2204.02311.pdf&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;MFU&lt;/a&gt;). MFU is the ratio of the observed throughput to the theoretical maximum throughput if the benchmarked hardware setup was operating at peak FLOPS with no memory or communication overhead.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;95c4ddbb-d746-4625-84fb-001e68a2d445&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In our benchmark, we used &lt;a href=&#34;https://deepspeed.readthedocs.io/en/latest/flops-profiler.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Deepspeed Flops Profiler&lt;/a&gt; to obtain the expected FLOPS number. FLOPS per GPU was calculated as: forward and backward FLOPS per GPU/iteration latency. Then we divided it by the device’s peak theoretical performance and obtained our final MFU metric. ‌In all our experiments, we maximized the batch size under different optimization settings so that GPU memory was fully utilized. We did this with the training arguments, setting &lt;em&gt;gradient_accumulation_steps = 1&lt;/em&gt; so that &lt;em&gt;macro_batch_size = micro_batch_size x num_gpus x 1&lt;/em&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3eb1c35d-1aa8-4459-9bcb-c207671f538f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Here’s what we found:&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0824a484-47fe-415d-990c-59086f7e64a6&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Throughput&lt;/strong&gt;: Both flash attention and CPU offload saved GPU memory, enabling us to increase batch size 2 to 7 times during Llama 2 70B training with maximum GPU memory usage (70GB-80GB) on 32 GPUs (8 hosts on A100, 4 hosts on H100). This led to significant throughput increases.&amp;nbsp;&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;MFU&lt;/strong&gt;: MFU on H100 was lower than on A100, and GPU utilization wasn’t full with maximum GPU memory usage. This might indicate that for Llama 2 70B training, we have memory-bound GPU instead of compute-bound. That’s also why CPU offload could help the most to improve MFU, as plotted in Figure 5 below.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Compute or Memory Bound&lt;/strong&gt;: The story is slightly different for Llama 2 7B on 4 A100/H100 on a single host, where we may have compute-bound GPU instead of memory-bound GPU.&amp;nbsp; We saw that the MFU of training Llama 2 7B was higher than training Llama 2 70B, and CPU offload was not helpful to improve MFU. Flash attention could help the most, as shown in Figure 6 below.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Network: &lt;/strong&gt;In our experiment, the network usage was around 10GB/second on H100 and 3GB/second on A100 for Llama 2 70B model training. This is small compared to the infra theoretical value, indicating that the network is yet to be a bottleneck compared to GPU compute and memory.&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097898,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;f6539680-e550-403c-8250-280ec77192ac&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;634&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-17291325919540-1024x634.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097898&#34; title=&#34;Chart&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-17291325919540.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-17291325919540.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-17291325919540.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1234,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-17291325919540.png 1234w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: Model Flops Utilization of training Llama 2 70B.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a4b411e3-c488-4737-a15d-7fc23eeb3e67&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097899,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;bca783a9-96e7-4c90-9dd0-6dd950e0cbb9&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;635&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-17291326224707-1024x635.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097899&#34; title=&#34;Chart&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1328,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 1328w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 6: Model Flops Utilization of training Llama 2 7B.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f1e75079-9ed3-40d4-9930-c00265e9045c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;5558af28-a0c8-493d-8ca2-1de822e467e0&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-llm-scorer&#34;&gt;LLM Scorer&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a73b63d3-6d45-465b-b421-b79fbf01737f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To evaluate the raw or finetuned models, we also implemented an offline LLM scorer to predict on large datasets. We used Ray to create a cluster on Kubernetes with multiple instances and each instance with multiple GPUs. This way, we could distribute the data and score in parallel. On each instance, we used inference servers such as &lt;a href=&#34;https://github.com/vllm-project/vllm&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;vLLM&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4a617aea-dbba-4d40-95ba-8c8c612e6cac&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In our implementation, we used Ray jobs as the operational foundation. Each Ray job allocates a specified number of CPU and GPU resources, downloads models, and partitions datasets by rank. The Ray `ActorPool` aggregates the outputs from different Ray Actors. Figure 7 below shows the implementation of this LLM scorer.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;e9d41adb-1d33-48a2-988b-33d8c40de5fb&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcptqsUis4TPQFJP9-OfxrU60nUal734joeKAohIc3jWOMuOU30fC58yufglGf4nzT3KI8VggrcxoASoFb8aSmOQKMXOk5ccrXsIhpQAr_-Pomo-INJ-MUMOMIYkgqKv9u2Q7Dwg3laKTYJ750mU3w45i8?key=F9WnaYLpB5WvGJfBHoMLXQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 7: Distributed LLM scorer with Ray and vLLM.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;72b43d00-c050-41c9-867a-fc38576e1944&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;59341eaf-c14b-41c0-a3e4-35d84e603f04&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 8 below summarizes the performance of batch prediction for Mixtral 8x7b models using 2 A100 and H100 GPUs, where the input token size is 4K and the maximum output tokens are 700. We observed that output tokens per second increased linearly for batch sizes up to 64 on both GPU types. Notably, the H100 achieved a throughput 3 times higher than the A100. This benchmark helps teams make production decisions and plan resource requirements.&amp;nbsp;&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;5dc1b9ad-6441-4171-8b85-d233257a4bf8&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfpULj9Ck6J4EpGtKKPx8e4f_q925QVj3CisQlmWVKLzr1NiTnTpsSSxOj_NfaZZ8eQWuxxBRM0Grb280IbiDTkdRqaK5RSg3moI346umhtDDnHFqVOhPflkhI0Bk0pIbI272dXCbLHt0zw0iKOafuN-l4?key=F9WnaYLpB5WvGJfBHoMLXQ&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 8: Throughput for Mixtral-8x7b on 2 x A100/H100.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1dcee380-7696-48be-ad2b-c7ac66edcf82&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d8826856-01f0-4d2b-9b39-9b0ab9436a37&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;95cf00c9-778f-4b51-b272-fc8090e9c008&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6fff4811-1c1f-4a4b-b352-069d8588e134&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As more and larger open-source models get published, like Llama 3 450B, we’ll improve our LLM training infrastructure to support fine-tuning them. Using these finetuned models will help us improve things like Uber Eats recommendations and search.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c1055457-0d60-4315-8a6a-9846867752e7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Thinking about the broader industry, our journey exploring in-house LLM training has brought us these insights:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;ordered&amp;quot;:true,&amp;quot;hash&amp;quot;:&amp;quot;caf84a04-8f32-464e-a823-e06addcf93ee&amp;quot;,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Embracing open source is the key &lt;/strong&gt;&lt;strong&gt;to catching up with generative AI trends.&lt;/strong&gt; In a short time, we’ve seen and benefitted from the fast-growing open-source community Hugging Face and the rapid adoption of DeepSpeed. Open-source model structures like Falcon, Llama, and Mixtral are published one-after-another every few months. With open-source solutions, we can train SOTA LLMs and achieve the industry standard MFU to maximize GPU usage.&amp;nbsp;&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Having long-time-tested and extensible cluster management is critical to catching the latest trends quickly.&lt;/strong&gt; Our well-established Ray and Kubernetes stack makes it easy to integrate new open-source solutions into our production environment.&amp;nbsp;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;79492b52-80a3-484e-96db-eaea716fb532&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;34b325a2-53fb-47e7-9c70-956bb37ea040&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e1c7934a-3ba0-4400-8d03-91333882acb2&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgements&#34;&gt;Acknowledgements&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d61854a1-4a5c-4936-870c-08fc26b173a6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This major step for GenAI at Uber couldn’t have happened without the many teams at Uber who contributed to it: Michelangelo, Applied AI, Dev Platform, and Platform Core Service.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;0cc3578a-4276-48eb-b5bb-dda18aac1570&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Apache&lt;sup&gt;®&lt;/sup&gt;, Apache Kafka, Kafka, Apache Spark, Spark, and the star logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries. No endorsement by The Apache Software Foundation is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;1f17d0fc-b135-4a11-81f0-461744185c12&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Deepspeed&lt;sup&gt;®&lt;/sup&gt; and its logo, LoRA&lt;/em&gt;&lt;sup&gt;®&lt;/sup&gt;&lt;em&gt; and its logo&lt;/em&gt; &lt;em&gt;are registered trademarks of Microsoft&lt;sup&gt;®&lt;/sup&gt; in the United States and other countries. No endorsement by Microsoft is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;7553dd58-1d4a-407e-bd4d-8d5ed7be3771&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Kubernetes&lt;sup&gt;®&lt;/sup&gt; and its logo are registered trademarks of The Linux Foundation&lt;sup&gt;®&lt;/sup&gt; in the United States and other countries. No endorsement by The Linux Foundation is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;d91b4603-ef84-4b0e-bd0a-c31aedef4532&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Llama 2&lt;sup&gt;®&lt;/sup&gt;, Llama 3&lt;sup&gt;®&lt;/sup&gt; and their logos are registered trademarks of Meta&lt;sup&gt;®&lt;/sup&gt; in the United States and other countries. No endorsement by Meta is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;b8b3f2bb-79ed-43e0-ae31-3f70e2215105&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Mixtral&lt;sup&gt;®&lt;/sup&gt; and its logo are registered trademarks of Mistral AI&lt;sup&gt;®&lt;/sup&gt; in the United States and other countries. No endorsement by Mistral AI is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;fc01d91d-1ad5-4ff6-b213-31414422427d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;NVIDIA&lt;sup&gt;® &lt;/sup&gt;and the NVIDIA logo are trademarks and/or registered trademarks of NVIDIA Corporation in the U.S. and other countries. No endorsement by NVIDIA is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;c3799488-dfdf-4488-9a62-da6179757c3d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;PyTorch, the PyTorch logo and any related marks are trademarks of The Linux Foundation.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;53d78373-5c6a-4d62-9fd1-83994303c000&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Transformers&lt;sup&gt;®&lt;/sup&gt; and its logo are registered trademarks of Hugging Face&lt;sup&gt;®&lt;/sup&gt; in the United States and other countries. No endorsement by Hugging Face is implied by the use of these marks.&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;33545b90-edf8-4266-a93c-c0c04c917f2e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1b3dfcd7-24d6-409c-a60c-028e45f2e6be&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;308d94a8-c895-41fb-acd9-12964ced97c6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;2a1bfc33-e3e2-438f-ae6e-3769f3795e56&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0b5d692f-13a5-447f-bcc4-de8dc6bdb7f9&#34;,&#34;dropCap&#34;:false}&#34;&gt;由生成式 AI 驱动LLM（大型语言模型）在 Uber 拥有广泛的应用，例如 Uber Eats 优食推荐和搜索、客户支持聊天机器人、代码开发和 SQL 查询生成。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2bac8375-db6b-4ae6-8d93-a2aae00fd471&#34;,&#34;dropCap&#34;:false}&#34;&gt;支持这些在应用程序中，Uber 利用 Meta&lt;sup&gt;®&lt;/sup&gt; Llama 2 和 Mistral AI Mixtral&lt;sup&gt;®&lt;/sup&gt; 等开源模型，以及来自 OpenAI、Google 和其他第三方提供商的闭源模型。作为移动和交付领域的领先公司，Uber 还拥有大量特定领域的知识，可以提高这些应用程序的 LLM 性能。 ‌Uber 整合这种特定领域知识的一种方式是通过 RAG（检索增强生成）。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7e841d89-1252-4bc2-b78f-b3a1630cf7fc&#34;,&#34;dropCap&#34;:false}&#34;&gt;Uber 还探索通过持续的预训练和指令微调，使法学硕士适应 Uber 的知识库。例如，对于 Uber Eats 优食，我们发现与开源模型结果相比，根据 Uber 对商品、菜肴和餐厅的了解进行微调的模型可以提高商品标记、搜索查询和用户偏好理解的准确性。更进一步，这些经过微调的模型可以实现与 GPT-4 模型类似的性能，同时允许 Uber 规模的流量大幅增加。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1946080a-21ea-4227-8723-e6eb98d414d6&#34;,&#34;dropCap&#34;:false}&#34;&gt;AI 社区支持以及开源库，例如 &lt;a href=&#34;https://huggingface.co/docs/transformers/index&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;transformers&lt;/a&gt;、Microsoft DeepSpeed&lt;sup&gt;®&lt; /sup&gt; 和 &lt;a href=&#34;https://pytorch.org/blog/introducing-pytorch-filled-sharded-data-parallel-api/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;PyTorch FSDP&lt; /a&gt; 使 Uber 能够快速构建基础设施，以有效地培训和评估法学硕士。新兴的开源计划，例如&lt;a href=&#34;https://github.com/facebookresearch/llama-recipes&#34;&gt;&lt;/a&gt;Meta&lt;sup&gt;®&lt;/sup&gt; Llama 3 &lt;a href=&#34;https:// github.com/facebookresearch/llama-recipes&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;llama-recipes&lt;/a&gt;，微软 &lt;a href=&#34;https://github.com/microsoft/LoRA&#34; target= &#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;LoRA&lt;/a&gt;&lt;sup&gt;®&lt;/sup&gt;，&lt;a href=&#34;https://github.com/artidoro/qlora&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;QLoRA&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; 和 Hugging Face &lt;a href=&#34;https://github.com/huggingface/peft&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;PEFT&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; 简化了法学硕士的微调生命周期并减少了工程工作量。&lt;a 等工具href=&#34;https://github.com/ray-project/ray&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Ray&lt;/a&gt;&lt;sup&gt;®&lt;/sup&gt; 和 &lt;a href=&#34;https://github.com/vllm-project/vllm&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;vLLM&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; 最大化大规模预编译的吞吐量-开源LLM的训练、微调、离线批量预测和在线服务能力。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d374805e-07fa-44fa-a4a7-020598b58abc&#34;,&#34;dropCap&#34;:false}&#34;&gt;小说本博客中描述的内部法学硕士培训方法确保了 Uber 在原型设计和开发生成式人工智能驱动服务方面的灵活性和速度。我们使用 SOTA（最先进的）开源模型来进行更快、更便宜、更安全和可扩展的实验。优化的内部法学硕士培训有助于 Uber 保持尖端技术创新，并将好处传递给 Uber 应用的用户。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a0029706-3a73-4cc2-a568-7c36b37caf0b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f86bcfc9-0737-45be-9e65-5a7d07a833d5&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-infrastruct-stack&#34;&gt;基础设施堆栈&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;abe7dc70-d3c6-4977-bf70-07599b182907&#34;,&#34;dropCap&#34;:false}&#34;&gt;关键组件Uber 的 LLM 培训的核心是经过彻底测试的基础架构堆栈，可实现快速实验。  &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;ba22d7dd-5289-43c0-b348-01d8f8ddcc6b&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-layer-0-hardware&#34;&gt;第 0 层：硬件&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7a540b97-614a-4d27-95b2-aa5e4853fc23&#34;,&#34;dropCap&#34;:false}&#34;&gt;Uber 的 in- house LLM 工作流程安排在 2 种计算实例上：(1) NVIDIA&lt;sup&gt;®&lt;/sup&gt; A100 GPU 实例Uber 的本地集群和 Google Cloud 上的 (2) 个 NVIDIA H100 GPU 实例。每台 Uber On-Prem A100 主机均配备 4 个 A100 GPU、600 GB 内存和 3 TB SSD。  在 Google Cloud 上，每台主机都是 3-highgpu-8g 机器类型，具有 8 个 H100 GPU、1872GB CPU 内存和 6TB SSD。这些机器作为 &lt;a href=&#34;https://www.uber.com/en-MX/blog/crane-ubers-next-gen-infrastruct-stack/&#34; target=&#34;_blank&#34; rel=&#34; 的一部分进行管理noreferrer noopener&#34;&gt;Crane&lt;/a&gt; 基础设施堆栈。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;e69d694b-39e3-4650-824d-947f2ba180b7&#34;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-layer-1-orchestration&#34;&gt;第 1 层：编排&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3a32a183-2b47-42a7-902f-3dc9c2fde9dc&#34;,&#34;dropCap&#34;:false}&#34;&gt;计算资源是由 Kubernetes&lt;sup&gt;®&lt;/sup&gt; 和 Ray 管理。 Kubernetes 用于安排训练工作负载并管理硬件要求。 Ray 与 KubeRay 运算符一起用于将工作负载分配给工作人员。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;d742a5e0-215c-4584-a99d-2cd2f2ec42d9&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-layer-2-federation&#34;&gt;第 2 层：联合&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;353d646a-5615-4d50-b4bc-b0ffaffc27dd&#34;,&#34;dropCap&#34;:false}&#34;&gt;结束-资源管理的端到端流程如下图 1 所示。我们的多个 Kubernetes 集群由联合层管理，该联合层根据资源可用性来调度工作负载。训练作业被建模为具有多个任务的作业。 JobSpec 定义作业的目标状态，包括实例 SKU、集群、计算/存储资源以及用于设置令牌和环境变量的 Docker 启动后命令等信息。 &lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097951,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“dff8f22e-4f52-4cf6-ab64-b2c4eaecab2c”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“799”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/fig1k8s-17291800154604-1024x799.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097951&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024 ，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width= 300，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width =768，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/宽度=1471，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/fig1k8s-17291800154604.png 1471w“尺寸=”（最大宽度：1024px）100vw，1024px“referrerpolicy=” no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：LLM 工作流程的资源调度。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;75c9c747-bc39-426c-85aa-e0c39e60e5b8&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5dc9360d-b887-467d-9b4d-a21813c32596&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;97a27885-ee5a-402d-b7d8-36ad09297d0c&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-training-stack&#34;&gt;训练堆栈&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9600c43d-0531-437a-82b9-3968d02c9cf4&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们完全接受在构建我们的 LLM 培训堆栈时开源。具体来说，我们集成了 PyTorch、Ray、Hugging Face、DeepSpeed 和 NCLL，以便能够使用 Michelangelo 平台训练法学硕士。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;13622ae7-6133-4412-9f2b-11fef3eac11a&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;PyTorch 是我们选择的深度学习框架，因为大多数 SOTA 开源 LLM 和技术都是在 PyTorch 中实现的。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Ray Train 提供了一个精简 API，可在 Ray 集群上使用 PyTorch 执行分布式训练。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Hugging Face Transformers 提供 API 和工具来下载和训练基于 SOTA Transformer 的模型。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;DeepSpeed 是一款深度学习优化软件套件，可为深度学习训练和推理提供前所未有的规模和速度。&lt; /里&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;08d5f9d1-cc0e-4979-80ea-011ebf35983f&#34;,&#34;dropCap&#34;:false}&#34;&gt;如图下面的图 2 中，Ray 位于 LLM 培训堆栈的顶部，负责协调任务。 NCCL处于GPU通信的底层。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097891,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“1f4b6be8-b85d-4ea3-94c7-48ec2964ce74”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“535”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/fig2-17291323864935-1024x535.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097891&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024 ，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/fig2-17291323864935.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width= 300，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/fig2-17291323864935.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width =768，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/fig2-17291323864935.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024 /10/fig2-17291323864935.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=1680，quality=80，onerror=redirect，format=auto/wp-content/uploads/ 2024/10/fig2-17291323864935.png 1680w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：Uber LLM培训软件堆栈。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;292322d2-b608-44f1-93bb-8a794cb0ae6e&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9ce7e044-4e63-414e-91bb-787b66baa245&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1388b477-2ada-46d4-8926-b47d9e2cc6c9&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-distributed-training-pipeline&#34;&gt;分布式训练管道&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;93674e70-08af-454f-8eff-046a9cd96cdd&#34;,&#34;dropCap&#34;:false}&#34;&gt;支持我们在内部实施中，我们构建了LLM分布式训练管道，包括主机通信、数据准备、分布式模型训练和模型检查点管理。其工作原理如下：&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;hash&#34;:&#34;901cb5da-a158-4522-a928-e1b50df61ef7&#34;,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;多主机和多 GPU 通信&lt;/strong&gt;。首先，Ray Train 中的 TorchTrainer 以 Ray Actor 的形式创建多个工作线程，处理入站通信（由 Ray 对象存储使用），并在所有主机的 GPU 上初始化 PyTorch 分布式进程组（由 Deepspeed 使用）。 /里&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;数据准备&lt;/strong&gt;。 LLM 训练框架支持 Uber HDFS、Uber Terrablob 和 Hugging Face 公共数据集上的远程数据源。&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;模型训练&lt;/strong&gt;。标记化将输入文本转换为将输入模型的整数。对于分布式训练，每个 GPU 工作线程使用 DeepSpeed ZeRO stage 1/2/3 选项初始化 Hugging Face Transformers Trainer 对象。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;保存结果。&lt;/strong&gt;与训练实验相关的指标保存在 Uber Comet 上服务器。 Ray 头节点上的主要训练过程将训练模型权重和相关配置文件推送到 Terrablob 存储。 &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;aceba0d7-957c-43bf-beef-30c6b1b9db41&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdT3F2A2DQU9CZxNSsCKbIAIB7ZfHvNFKT2W7E2DRlpzCxmyD0NIwbwy0CfOCs2dnPJdQyHLuH5Ia7Dt5QSgICSuNmz9ig sWp_TabDWQ8XCJs1GWbMBRohsvSv9qg-J19oJyuLqixlDKAlRZrfZyhzu3l_3?key=F9WnaYLpB5WvGJfBHoMLXQ&#34; alt=&#34;&#34;referrerpolicy=&#34; no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：Uber LLM 分布式训练流程。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;63ddda68-46ce-42ab-a705-5330656936de&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;79024f68-5234-4376-958a-00799f61c598&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ddd7ea80-3f24-40ac-b5d0-c51ccdf19df5&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-training-results&#34;&gt;训练结果&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5e250810-041e-4b72-b1f2-503d255d34fa&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的探索涉及证明内部 Michelangelo 平台具有通过吞吐量优化训练任何开源 LLM 的能力和可扩展性。    &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;a3b35586-204b-4320-b82b-69c884b942be&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-training-on-state-of-the-art-llms&#34;&gt;最先进的法学硕士培训&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;770ae998-1513-4b07-9ddd-21064b7f0d0e&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们发现Michelangelo 平台可以支持最大的开源 LLM，同时在不同设置下进行训练，包括使用 LoRA 和 QLoRA 进行全参数微调和参数高效微调。  &lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097895,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“60b1c16e-2cee-4f9d-9961-44f6bb418189”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“505”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-4-17291324832411-1024x505.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097895&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-4-17291324832411.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-4-17291324832411.png 300w， https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-4-17291324832411。 PNG768w， https://blog.uber-cdn.com/cdn-cgi/image/width=1467，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-4-17291324832411。 png 1467w”尺寸=“（最大宽度：1024px）100vw，1024px” referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 4：使用和不使用 (Q)LoRA 的 Llama 2 模型的训练损失。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f8c07128-ce1d-418f-969b-2993735ab8ae&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;62e2ae55-2adb-47db-88d6-6aac1a579201&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 4 (上图）显示了 Llama 2 13B 和 Llama 2 70B 有和没有 LoRA 的训练损失曲线。我们发现，即使 LoRA 和 QLoRA 使用更少的 GPU 并且用更少的 GPU 训练得更快，损失的降低也远小于全参数训练。因此，提高吞吐量/模型触发器利用率（MFU）对于LLM的全参数微调非常重要。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;2794d532-813b-4ec7-8267-c36c5bfac293&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-throughput-mfu-optimization&#34;&gt;&lt;br&gt;吞吐量/MFU 优化&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;027c8334-2a64-4831-af4a-324f5abd02f0&#34;,&#34;dropCap&#34;:false}&#34;&gt;缩放变压器该架构严重受到模型自注意力机制的瓶颈，该机制具有二次方的时间和内存复杂度。为了实现更好的训练吞吐量，我们探索了几种业界推荐的优化 GPU 内存使用的方法：CPU 卸载和闪存注意力。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a34ef321-de14-4067-af33-e2eb15596493&#34;,&#34;dropCap&#34;:false}&#34;&gt;第一次训练我们探索的吞吐量优化是使用 DeepSpeed ZeRO-stage-3 CPU Optimizer Offload，在训练 Llama 时，在相同批量大小的情况下，GPU 内存减少至少 34% 2 70B。这使我们能够将批量大小增加 3-4 倍，但仍保持相同的前进和后退速度，因此训练吞吐量增加了 2-3 倍。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;758b796c-630f-443a-9953-7f554395bfe6&#34;,&#34;dropCap&#34;:false}&#34;&gt;第二次训练吞吐量优化的探索是遵循 Hugging Face 的建议，即使用 Flash Attention。 Flash 注意是一种注意算法，用于降低二次复杂度并更有效地扩展基于 Transformer 的模型，从而实现更快的训练。通过闪存注意力，我们可以在相同批量大小的情况下节省 50% 的 GPU 内存。如果我们最大化 GPU 内存的使用，那么我们可以将批量大小加倍，同时保持兼容的前进和后退速度。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;89be987d-e630-44c7-b748-e23a605041bc&#34;,&#34;dropCap&#34;:false}&#34;&gt;学习训练为了提高效率，我们使用了硬件模型触发器利用率 (&lt;a href=&#34;https://arxiv.org/pdf/2204.02311.pdf&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;MFU&lt;/a&gt;)。 MFU 是在基准硬件设置以峰值 FLOPS 运行且没有内存或通信开销的情况下观察到的吞吐量与理论最大吞吐量的比率。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;95c4ddbb-d746-4625-84fb-001e68a2d445&#34;,&#34;dropCap&#34;:false}&#34;&gt;在我们的基准测试中，我们使用 &lt;a href=&#34;https://deepspeed.readthedocs.io/en/latest/flops-profiler.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Deepspeed Flops Profiler&lt;/a&gt; 来获取预期的 FLOPS 数。每个 GPU 的 FLOPS 计算如下：每个 GPU 的前向和后向 FLOPS/迭代延迟。然后我们将其除以设备的峰值理论性能，得到最终的 MFU 指标。 ‌在我们所有的实验中，我们在不同的优化设置下最大化批量大小，以便充分利用 GPU 内存。我们使用训练参数来做到这一点，设置&lt;em&gt;gradient_accumulation_steps = 1&lt;/em&gt;，以便&lt;em&gt;macro_batch_size = micro_batch_size x num_gpus x 1&lt;/em&gt;。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3eb1c35d-1aa8-4459-9bcb-c207671f538f&#34;,&#34;dropCap&#34;:false}&#34;&gt;这是我们的发现：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0824a484-47fe-415d-990c-59086f7e64a6&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;吞吐量&lt;/strong&gt;：闪存注意力和 CPU 卸载都节省了 GPU 内存，使我们能够在 Llama 2 70B 训练期间，在 32 个 GPU（A100 上 8 个主机，H100 上 4 个主机）上使用最大 GPU 内存使用量 (70GB-80GB) 时，将批量大小增加 2 到 7 倍。这导致吞吐量显着增加。  &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;MFU&lt;/strong&gt;：H100 上的 MFU 低于 A100，GPU 利用率较低最大 GPU 内存使用量未满。这可能表明，对于 Llama 2 70B 训练，我们拥有内存限制的 GPU，而不是计算限制的 GPU。这也是为什么 CPU 卸载最有助于提高 MFU，如下图 5 所示。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;计算或内存限制&lt;/strong&gt;：Llama 2 7B 的情况略有不同4 A100/H100 在单个主机上，我们可能拥有计算密集型 GPU，而不是内存密集型 GPU。  我们看到 MFU训练 Llama 2 7B 的性能高于训练 Llama 2 70B，并且 CPU 卸载对提高 MFU 无帮助。 Flash 注意力的帮助最大，如下图 6 所示。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;网络：&lt;/strong&gt;在我们的实验中，网络使用量约为 10GB/秒用于 Llama 2 70B 模型训练的 H100 和 A100 上的 3GB/秒。与基础理论值相比，这个值很小，表明与 GPU 计算和内存相比，网络尚未成为瓶颈。   &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097898,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心&#34;,&#34;哈希&#34;:&#34;f6539680-e550-403c-8250-280ec77192ac&#34;,&#34;alt&#34;:&#34;&#34;}&#34;类=“aligncenter尺寸-大”&gt;&lt;img加载=“惰性”解码=“异步”宽度=“1024”高度=“634” src =“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-5 -17291325919540-1024x634.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097898&#34; title=&#34;图表&#34; srcset =“https://blog.uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-5 -17291325919540.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-5-17291325919540。 300w.png, https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-5-17291325919540。 PNG768w， https://blog.uber-cdn.com/cdn-cgi/image/width=1234，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-5-17291325919540。 png 1234w”尺寸=“（最大宽度：1024px）100vw，1024px” referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：训练 Llama 2 70B 的模型失败率利用。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a4b411e3-c488-4737-a15d-7fc23eeb3e67&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097899,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心&#34;,&#34;哈希&#34;:&#34;bca783a9-96e7-4c90-9dd0-6dd950e0cbb9&#34;,&#34;alt&#34;:&#34;&#34;}&#34;类=“aligncenter尺寸-大”&gt;&lt;img加载=“惰性”解码=“异步”宽度=“1024”高度=“635” src =“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-6 -17291326224707-1024x635.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097899&#34; title=&#34;图表&#34; srcset =“https://blog.uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-6 -17291326224707.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，质量=80，onerror=重定向，format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 300w，https://blog.uber-cdn.com/cdn-cgi /image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 768w，https://blog.uber-cdn.com/ cdn-cgi/image/width=1328，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-6-17291326224707.png 1328w“尺寸=”（最大宽度：1024px ) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 6：训练 Llama 2 7B 的模型失败率利用率。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f1e75079-9ed3-40d4-9930-c00265e9045c&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;5558af28-a0c8-493d-8ca2-1de822e467e0&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-llm-scorer&#34;&gt;LLM 评分者&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a73b63d3-6d45-465b-b421-b79fbf01737f&#34;,&#34;dropCap&#34;:false}&#34;&gt;评估除了原始或微调模型之外，我们还实现了离线 LLM 评分器来对大型数据集进行预测。我们使用 Ray 在 Kubernetes 上创建一个具有多个实例的集群，每个实例具有多个 GPU。这样，我们就可以并行分配数据和评分。在每个实例上，我们都使用了推理服务器，例如 &lt;a href=&#34;https://github.com/vllm-project/vllm&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;vLLM&lt;/a&gt;。&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4a617aea-dbba-4d40-95ba-8c8c612e6cac&#34;,&#34;dropCap&#34;:false}&#34;&gt;在我们的实现中，我们使用Ray jobs作为运营基础。每个 Ray 作业都会分配指定数量的 CPU 和 GPU 资源、下载模型并按等级对数据集进行分区。 Ray“ActorPool”聚合来自不同 Ray Actor 的输出。下面的图 7 显示了该 LLM 评分器的实现。 &lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;e9d41adb-1d33-48a2-988b-33d8c40de5fb&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcptqsUis4TPQFJP9-OfxrU60nUal734joeKAohIc3jWOMuOU30fC58yufglGf4nzT3KI8VggrcxoASoFb8aSmOQKMXOk5cc rXsIhpQAr_-Pomo-INJ-MUMOMIYkgqKv9u2Q7Dwg3laKTYJ750mU3w45i8?key=F9WnaYLpB5WvGJfBHoMLXQ&#34; 替代=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 7：使用 Ray 和 vLLM 的分布式 LLM 评分器。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;72b43d00-c050-41c9-867a-fc38576e1944&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;59341eaf-c14b-41c0-a3e4-35d84e603f04&#34;,&#34;dropCap&#34;:false}&#34;&gt;下面的图 8 总结了使用 2 个 A100 和 H100 GPU 的 Mixtral 8x7b 模型的批量预测性能，其中输入令牌大小为 4K，最大输出令牌为 700。我们观察到，每秒的输出令牌随着批量大小而线性增加两种 GPU 类型上的吞吐量均高达 64。值得注意的是，该基准测试可帮助团队制定生产决策并规划资源需求。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;5dc1b9ad-6441-4171-8b85-d233257a4bf8&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXfpULj9Ck6J4EpGtKKPx8e4f_q925QVj3CisQlmWVKLzr1NiTnTpsSSxOj_NfaZZ8eQWuxxBRM0Grb280IbiDTkdRqaK5RSg3moI346umhtDDnHFqVOhPflkhI0Bk0pIbI272 dXCbLHt0zw0iKOafuN-l4?key=F9WnaYLpB5WvGJfBHoMLXQ&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 8: Mixtral-8x7b 在 2 x A100/H100 上的吞吐量。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1dcee380-7696-48be-ad2b-c7ac66edcf82&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d8826856-01f0-4d2b-9b39-9b0ab9436a37&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;95cf00c9-778f-4b51-b272-fc8090e9c008&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6fff4811-1c1f-4a4b-b352-069d8588e134&#34;,&#34;dropCap&#34;:false}&#34;&gt;作为更多和随着更大的开源模型的发布，例如 Llama 3 450B，我们将改进我们的 LLM 培训基础设施以支持对其进行微调。使用这些经过微调的模型将帮助我们改进 Uber Eats 优食推荐和搜索等功能。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c1055457-0d60-4315-8a6a-9846867752e7&#34;,&#34;dropCap&#34;:false}&#34;&gt;思考在更广泛的行业中，我们探索内部法学硕士培训的旅程为我们带来了以下见解：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;ordered&#34;:true,&#34;hash&#34;:&#34;caf84a04-8f32-464e-a823-e06addcf93ee&#34;,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;拥抱开源是赶上生成式 AI 的关键&lt;/strong&gt;&lt;strong&gt; &lt;/strong&gt; 在很短的时间内，我们看到并受益于开源社区 Hugging Face 的快速发展以及 Deep 的快速采用速度。 Falcon、Llama 和 Mixtral 等开源模型结构每隔几个月就会陆续发布。借助开源解决方案，我们可以训练 SOTA LLM 并实现行业标准 MFU，以最大限度地提高 GPU 使用率。  &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;拥有经过长期测试且可扩展的集群管理对于快速捕捉最新趋势至关重要。 &lt;/strong&gt; 我们完善的 Ray 和 Kubernetes 堆栈可以轻松地将新的开源解决方案集成到我们的生产环境中。 &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;79492b52-80a3-484e-96db-eaea716fb532&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;34b325a2-53fb-47e7-9c70-956bb37ea040&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e1c7934a-3ba0-4400-8d03-91333882acb2&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-acknowledgements&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d61854a1-4a5c-4936-870c-08fc26b173a6&#34;,&#34;dropCap&#34;:false}&#34;&gt;这一步如果没有 Uber 的许多团队的贡献，Uber 的 GenAI 就不可能实现：米开朗基罗、应用人工智能、开发平台和平台核心服务。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;0cc3578a-4276-48eb-b5bb-dda18aac1570&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Apache&lt;sup&gt;®&lt;/sup&gt;、Apache Kafka、Kafka、Apache Spark、Spark 和星形徽标是以下公司的注册商标或商标：美国和/或其他国家的 Apache 软件基金会。使用这些标记并不暗示 Apache 软件基金会的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;1f17d0fc-b135-4a11-81f0-461744185c12&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Deepspeed&lt;sup&gt;®&lt;/sup&gt; 及其徽标，LoRA&lt;/em&gt;&lt;sup&gt;®&lt;/sup&gt;&lt;em&gt; 及其徽标徽标&lt;/em&gt; &lt;em&gt;是 Microsoft&lt;sup&gt;®&lt;/sup&gt; 在美国和其他国家/地区的注册商标。使用这些标记并不暗示 Microsoft 的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;7553dd58-1d4a-407e-bd4d-8d5ed7be3771&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Kubernetes&lt;sup&gt;®&lt;/sup&gt; 及其徽标是 Linux Foundation&lt;sup&gt;®&lt;/sup&gt; 在美国的注册商标和其他国家。使用这些标记并不暗示 Linux 基金会的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p 数据-wp-块-名称=“核心/段落”data-wp-block =“{”fontSize”：“小”，“散列”：“d91b4603-ef84-4b0e-bd0a-c31aedef4532”，“dropCap”：false}”class =“has-small” -font-size&#34;&gt;&lt;em&gt;Llama 2&lt;sup&gt;®&lt;/sup&gt;、Llama 3&lt;sup&gt;®&lt;/sup&gt;及其徽标是 Meta&lt;sup&gt;®&lt;/sup&gt; 在美国和其他国家/地区的注册商标。使用这些标记并不暗示 Meta 的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;b8b3f2bb-79ed-43e0-ae31-3f70e2215105&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;Mixtral&lt;sup&gt;®&lt;/sup&gt; 及其徽标已注册Mistral AI&lt;sup&gt;®&lt;/sup&gt; 在美国和其他国家/地区的商标。使用这些标记并不暗示 Mistral AI 的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;fc01d91d-1ad5-4ff6-b213-31414422427d&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;NVIDIA&lt;sup&gt;® &lt;/sup&gt; 和 NVIDIA 徽标是NVIDIA Corporation 在美国和其他国家/地区的商标和/或注册商标。使用这些标记并不暗示 NVIDIA 的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;c3799488-dfdf-4488-9a62-da6179757c3d&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;PyTorch、PyTorch 徽标和任何相关标记是 Linux 基金会的商标。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;53d78373-5c6a-4d62-9fd1-83994303c000&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;&lt;em&gt;变形金刚&lt;sup&gt;®&lt;/sup&gt;及其徽标是 Hugging Face&lt;sup&gt;®&lt;/sup&gt; 在美国和其他国家/地区的注册商标。使用这些标记并不暗示 Hugging Face 的认可。&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;33545b90-edf8-4266-a93c-c0c04c917f2e&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1b3dfcd7-24d6-409c-a60c-028e45f2e6be&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;308d94a8-c895-41fb-acd9-12964ced97c6&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;</description>
      <pubDate>Thu, 17 Oct 2024 07:30:00 +0000</pubDate>
    </item>
    <item>
      <title>【Enabling Infinite Retention for Upsert Tables in Apache Pinot】在 Apache Pinot 中启用 Upsert 表的无限保留</title>
      <link>https://www.uber.com/blog/enabling-infinite-retention-for-upsert-tables/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;6f464e0d-95aa-47d4-b91b-ff78b73e82ad&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3bf72380-da88-4457-b301-5a8b1f33f317&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;a href=&#34;https://github.com/apache/pinot&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Apache Pinot&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; was originally designed as an append-only OLAP (online analytical processing) database. After some redesign, it was modified to support upserts, which are UPdates plus inSERTs. This allows you to update a record for a given primary key or insert new primary keys. Deletion is a natural extension of upserts, addressing the need for efficient memory and disk usage in upsert use cases that require indefinite retention periods with deletions based on specific business needs.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;60776145-55b5-404a-a4ec-df832fd2fef4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This blog highlights recent feature developments in &lt;a href=&#34;https://github.com/apache/pinot&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Apache Pinot&lt;/a&gt; that now support deletions at both memory and disk levels. It also shows how these developments have enabled Uber to sustainably support infinite retention for Pinot upsert use cases.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5d7874d5-8553-4c9f-907f-66e93b70ae56&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;98ed0dc4-373d-46f6-a88e-92130099a954&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-upsert-overview&#34;&gt;Upsert Overview&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c28bed20-e3db-456b-b4a3-32f63b67707b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Upsert is a feature of Pinot used for things like point updates, backfills, and data correction.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7ae2a065-d825-4e86-9825-0d070419ff7a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 1 presents a high-level overview of upsert architecture, highlighting how upserts are highly memory-intensive.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098831,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;2ad046e2-dfe3-41b4-8633-e2a59301fa2a&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;428&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469-1024x428.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098831&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1053,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469.png 1053w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 1&lt;/em&gt;:&lt;em&gt; High-level architecture of upsert in Pinot.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9e441de2-02e6-4d81-ac1a-aaf46746c488&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c789f689-5369-4d82-a15b-3f0bb04df0f8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Upsert-Metadata is an in-memory hashmap that maintains a mapping of Record-Primary-keys to Record-locations. The Record-Primary-key, a unique identifier, is used for partitioning upstream Kafka and serves as a reference for updates if they already exist in the Upsert-Metadata map. The Record-location points to the &lt;a href=&#34;https://docs.pinot.apache.org/basics/concepts/components/table/segment&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;segment&lt;/a&gt; where the latest record for a given Record-Primary-key is stored. This entire Upsert-Metadata mapping is kept in memory for fast upsert operation, contributing to the high memory usage of upserts. To illustrate the memory-intensive nature of upserts, at Uber, our standard host with 376 GiB of memory and 1.1 TiB of disk storage experiences 80% memory utilization and approximately 10% disk utilization for upsert use cases. To draw a comparison with non-upsert append-only use-cases, these hosts experience higher disk utilization (~80%) with memory and cpu utilization at around ~30-40% (highly dependent on query shapes).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6ffd6fd5-44ff-4ab9-a63b-28c939d4d819&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This blog discusses strategies to improve both memory and disk footprints for upsert use cases that require very high (indefinite) retention periods.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098833,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;ddd7ab5c-b872-4e58-a955-92a7a84cd9c2&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;495&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159-1024x495.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098833&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 2&lt;/em&gt;:&lt;em&gt; Example explaining the low-level architecture of upsert.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e6650171-6279-4ab7-be14-b8215e2f7322&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5cc29ea0-9ad8-4e0e-b43a-3744fd3aa4d6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Consider Figure 2, which shows upsert behavior at the partition level within a specific server instance. Here, there’s a sealed segment S1 and a consuming segment S2. The Upsert-Metadata map stores a mapping of primary keys to record locations, represented as (segment-name, DocId). The DocId can be understood as the row number within a segment where the record is located. Figure 2 shows, via a dotted line, that when the same primary key appears in the consuming segment, the Upsert-Metadata map updates the record location to the new consuming segment, overwriting the reference to the old record.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;65e57f3d-f92a-4880-9f34-d79cb2e6885d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Additionally, there’s an in-memory segment bitmap that stores the queryable records for a given segment and is updated with each ingested record. During query processing for upsert tables, this bitmap is used as an implicit filter.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5e732668-f72a-431b-915f-d9fdaf8c745d&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;55a87a0f-15f6-4d4a-b20a-304128177f02&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-point-deletes&#34;&gt;Point Deletes&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;588352aa-4b80-4243-8443-231351742fc7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;When describing upserts, another important use case is deletes. Once you mark a Record-Primary-key as deleted, it shouldn’t be selected in subsequent queries anymore. They should also be subsequently deleted from in-memory and disk for cost savings.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;19afce3f-05e0-4edf-bc27-dea569945c24&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In Pinot, you can enable the point deletes feature by setting a table-level configuration.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098835,&amp;quot;width&amp;quot;:&amp;quot;568px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;dc5667b8-be55-461c-be1c-9001ea13e8ca&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;216&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002-1024x216.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098835&#34; style=&#34;width:568px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1252,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 1252w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 3&lt;/em&gt;:&lt;em&gt; Configuration to enable point-deletes.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;50bfa0e5-42c3-4558-ad92-a9630a88b86b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;348cb2da-3c55-48fa-826d-6cab7184eae8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Once the point deletes feature is enabled, Pinot starts tracking an additional bitmap called queryableDocIds. It operates similarly to validDocIds with one key difference: whenever the value in the deleteRecordColumn is true, the corresponding entries are removed from queryableDocIds but not from validDocIds. During query time, you then strictly use queryableDocIds acting as an implicit filter. Ideally, queryableDocIds and validDocIds are identical unless a delete record is present for a table.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098837,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;a9be6149-c76f-4fe4-972d-c344307edf24&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;410&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467-1024x410.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098837&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1862,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 1862w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 4&lt;/em&gt;:&lt;em&gt; Architecture of the point deletes feature.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6e6709ac-fbe8-4e64-b768-b73ce5db41ca&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;552aa8a6-7a03-4329-9e00-02412ab7c6fb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the example in Figure 4, the only action different from the normal ingestion flow whenever a delete-record comes up is to remove the entry from queryableDocIds. The rest of the flow remains the same. This feature is very similar to adding a filter where &lt;em&gt;deleteRecordColumn = false&lt;/em&gt; in all of your queries on this table.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0cb6e955-eec7-44da-85bc-9ff9126983f8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Pinot doesn’t immediately delete the key from the upsert-metadata map upon receiving a deletion message. This approach ensures consistency in deletion, particularly in cases where an out-of-order event arrives after the deletion event for that key.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3788335a-0090-4b38-980e-5a18a73d054a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;It’s clear that this function acts more as a soft-delete feature, as it doesn’t achieve any savings by removing metadata from the hashmap or from disk. We have a use case at Uber where the delete messages scale is around 5,000 per second, equivalent to 600 million keys being deleted daily. Based on the standard host configuration mentioned above, we can accommodate approximately 250-300 million keys per host. With a replication factor of 2, accommodating 600 million keys per day, that means adding 4 hosts daily. This becomes a critical issue if we want to support high or indefinite retention, as it results in the cost of adding 4 hosts every day just to manage the metadata of deleted records.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6162ad21-cef0-4213-980a-cf32cf952c5b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9eb6ec06-9c6b-4b95-bcd9-f0c476c9d878&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-metadata-retention-on-deleted-keys&#34;&gt;Metadata Retention on Deleted Keys&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b587ba8a-b675-4d04-a222-1620822b88fc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To address the problem mentioned above, we introduced &lt;a href=&#34;https://github.com/apache/pinot/issues/11736&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;a new feature in Pinot&lt;/a&gt; that removes metadata for deleted keys after a TTL window. This buffer TTL window ensures that any out-of-order events occurring within this period won’t reverse the deletion.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098839,&amp;quot;width&amp;quot;:&amp;quot;578px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;2cf8b259-d875-4e5d-9ae3-e4f6554e4199&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;254&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394-1024x254.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098839&#34; style=&#34;width:578px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1252,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394.png 1252w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 5&lt;/em&gt;:&lt;em&gt; Configuration to enable retention of metadata of deleted keys.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;04619d44-ef9f-4b7a-9ebe-ba50df77caee&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098841,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;4936f41b-6629-40cc-8ff4-c1dd68770750&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;360&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495-1024x360.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098841&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1902,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 1902w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 6&lt;/em&gt;:&lt;em&gt; Low-level architecture of metadata retention of deleted keys.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c30884a8-46cc-4a41-b0a8-648e37475ec2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bba4c59b-ef7d-45af-8262-5b409005c444&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The design is straightforward. After each segment commit cycle, Pinot iterates through the keys in a table’s partition in the upsert-metadata-manager. If a key points to a record that exists in validDocIds but not in queryableDocIds (indicating the record is deleted), and it’s exceeded the deletedKeysTTL threshold, Pinot removes the metadata for that key from the map and marks the validDocId as invalid. As shown in Figure 6, where red indicates removal, Pinot removes the 4th row from validDocId as well.&lt;br&gt;&lt;br&gt;The next section of this blog covers why Pinot marks the validDocId as invalid.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098843,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;c0576c7c-bd24-4ee0-aac0-31aaffcaa6c0&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;289&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158-1024x289.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098843&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1730,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 1730w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 7&lt;/em&gt;:&lt;em&gt; Pseudo-code for deleted keys TTL flow.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8204bef8-c3c1-49fd-8c10-481e4052ea65&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5f0cd937-4e99-470d-80af-e7deec686a33&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 8 illustrates the scale of deletion we achieved at Uber after enabling this feature on a table with a deletion rate of approximately 2,000 messages per second. The metric shows that up to 300 million keys were deleted from the metadata-manager map per day, considering a replication factor of 2.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098845,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;179cfea9-8182-42b3-9537-2dc589891402&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;404&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610-1024x404.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098845&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 8&lt;/em&gt;:&lt;em&gt; Deleted keys TTL feature impact in production.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;27480f2b-c480-4169-8aa2-9221c9eb52b2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;170a8587-a8bc-4bf9-8ab6-977dec3ca062&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2596619c-4815-4f28-8923-b98137a7e86b&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-upsert-compaction&#34;&gt;Upsert Compaction&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;44c5307e-38d8-49ca-a3ac-ae22532e8c2b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;During server restarts, Pinot loads all the keys persisted on disk back into the in-memory hashmap before triggering the deleted-keys-retention on them again. This has caused OOM issues as the stale keys weren’t removed from the disk and are in the scale of millions. This can be resolved by gradually removing the stale keys from the disk, thereby also regaining disk space savings and not loading them back into memory during restarts.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;493cb873-80ee-4b2a-8cae-125a566fd00f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;At Uber, we use the &lt;a href=&#34;https://github.com/apache/pinot/pull/10463&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;UpsertCompactionTask minion task&lt;/a&gt; to compact old segments and remove stale or deleted rows from the disk. For this, we use the validDocId bitmap snapshot flow. After every segment commit cycle, we snapshot these bitmaps for all segments and persist them to disk. During each task run, we loop through all these bitmaps to find the segments that’ll provide the maximum compaction efficiency, where the highest value of &lt;em&gt;invalidDocs = totalDocs − validDocs&lt;/em&gt;.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5c6ada86-b1b9-4d03-9d80-467cb9245304&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Referencing the previous examples, after an Upsert-compaction task runs on the segment, the segment on disk will be updated as shown in Figure 9. We see ‌records related to &lt;em&gt;primary key=3&lt;/em&gt; are removed from disk as well.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098847,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;3389947a-b60a-4997-9865-88a2216fe707&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;288&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383-1024x288.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098847&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1878,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 1878w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 9: Low-level architecture of upsert compaction.&amp;nbsp;&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;60b5ffc6-e7f6-492a-9139-255e21f10e5e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;aa036b3a-d22b-413e-b23c-74a369483933&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As mentioned earlier, during the metadata retention workflow for deleted keys, Pinot marked the validDocId as invalid for deleted primary keys. This allowed them to be snapshotted in the next cycle, enabling the removal of the deleted record entry from the disk via upsert compaction.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3297bbf8-670f-42db-a170-06fca407dd6f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 10 shows the impact of enabling upsert compaction for 1 of our production tables. The table grew to approximately 8 TiB in size, but after enabling compaction, the size was reduced to around 850 GiB, resulting in a space saving of about 90%. Additionally, the rate of data growth significantly decreased from approximately 85 GiB/day to about 3 GiB/day.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1098849,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;03b08f5a-2743-4eff-8c2a-888b3e21097f&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;309&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-production-scale.-17303498706695-1024x309.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098849&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-production-scale.-17303498706695.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-production-scale.-17303498706695.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-production-scale.-17303498706695.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-production-scale.-17303498706695.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-production-scale.-17303498706695.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;Figure 10: Impact of upsert compaction task at production scale.&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c2a7fe2a-7670-4ab9-a36f-52d424b2c6e6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;5c015e29-a878-4acc-8fab-9df3126a3230&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-ensuring-data-consistency-with-deletion-and-compaction&#34;&gt;&lt;br&gt;Ensuring Data Consistency with Deletion and Compaction&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2fb6d20d-9b99-4a6a-9b62-1484a31602c6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One challenge with enabling compaction along with deletion is we could end up in a situation where an older non-deleted record for a particular key isn’t compacted, but the deleted record is. During a server restart, when all segments are loaded, Pinot would incorrectly mark the record as non-deleted and start returning it as a valid primary key, leading to an inconsistent state in the table.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8b68305f-2087-43ae-982e-f48f19271e92&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For example, consider a primary key PK1 with records in segments S0 and S1. In S1, the record is marked as deleted. If S1 gets compacted but S0 doesn’t due to threshold reasons in the upsert compaction flow, during a server restart, the upsert-metadata-manager map would incorrectly point PK1 to S0, even though it should be considered deleted for the end user.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;86bb47ba-8878-4574-800c-0c722ad7fc09&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To resolve this situation, we proposed a &lt;a href=&#34;https://github.com/apache/pinot/pull/13347&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;design in Pinot to maintain a state of Primary Key&amp;nbsp; →&amp;nbsp; distinct-segment-count&lt;/a&gt;. This means tracking the number of segments where a record exists for a given primary key. If the count is &amp;lt;= 1, Pinot will allow deletion of metadata on the record, followed by marking the validDocId as invalid. Pinot can now compact the deleted record, ensuring that all other records in other segments are removed.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;238b50a4-0c7e-4faa-a6b9-4ad3a501a455&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1284d8a3-f06d-4fa8-826c-28ee992219e1&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-use-cases-at-uber&#34;&gt;Use Cases at Uber&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;78f3eacb-6acb-409b-91a4-20763d84c171&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As of writing, we’ve enabled infinite retention on upsert tables for over 20 tables, with the total primary key count across all tables being approximately 6 billion keys (without replication) and a deletion rate of around 600 million keys per day.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;57086e77-68d3-4503-9445-2979304f5655&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Infinite retention on upsert tables will benefit the following types of long-running use cases at Uber and many more:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;166919b3-4707-4aef-a4a9-842d37ad58a7&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Tracking Uber for Business ‌use cases where organizations are active for years and have regular updates regarding employee count, payment entities, etc.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Following Uber vouchers use cases where vouchers are active for years and receive updates on voucher redemption count, voucher expiry.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Cadence workflow analytics, as each workflow can run for hours, months, or years, with deletion enabled on closed workflows.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e8edb46e-3fd1-4226-a538-6141bfd46be2&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4c862e22-f807-4c74-8f15-83e0112383a1&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-next-steps-nbsp&#34;&gt;Next Steps&amp;nbsp;&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;235f6f61-db25-4acf-ac58-6c25fc91e4e0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One challenge we have is the creation of many small segments for a particular table over time. This can lead to longer loading times during server restarts and higher query latency, as more segments need to be processed by the same number of threads during query execution.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0ae209af-bd6e-40b5-8188-d7fc56b8f86d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One possible solution is to enable upsert compaction across multiple segments, merging them to create larger segments, controlling the overall segment count growth over time.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ffb7cee3-09ce-43e4-835b-be30f8bfc94a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;88951a08-8e0a-4188-bc28-d55268b08a69&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;514436bc-0ef2-4cd1-907d-e8239168f7b3&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This powerful feature in Apache Pinot meets a crucial need for many Pinot users at Uber and beyond, enabling higher retention for upsert tables and supporting deletions directly within Pinot. This unlocks numerous new use cases for Pinot upserts at Uber and brings Pinot’s functionality closer to that of a row-level database.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4fff3aad-3e6d-44ec-934e-01aa3d7ca10d&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e4c7c315-71fb-491b-bbe4-1c6ad36bb3e1&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;Acknowledgments&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;db131410-81a0-4b9f-b365-cd7d432d6fc8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Special thanks to the Apache Pinot&lt;sup&gt;™&lt;/sup&gt; community members who actively contributed to and reviewed the numerous changes required to enable this feature in Pinot.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;132c57fc-915d-4f35-ad45-844bb47ad56c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Special thanks to Navina Ramesh in designing point deletes, Robert Zych who designed upsert compaction, and Yupeng Fu for crafting the original upsert design document.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;744f7acb-2945-49f9-a5c4-677304116510&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Apache Pinot&lt;sup&gt;™,&lt;/sup&gt; Pinot, Apache, the Apache feather logo, and the Apache Pinot project logo are registered trademarks of The Apache Software Foundation. ‌No endorsement by The Apache Software Foundation is implied by the use of these marks.&lt;br&gt;Cover Photo attribution: “&lt;a href=&#34;https://openverse.org/image/bc95682f-5a02-46a3-98eb-86f364835de0&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Infinite Wine&lt;/a&gt;” by &lt;a href=&#34;https://www.flickr.com/photos/47105685@N00/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Adam Brill&lt;/a&gt; is licensed under &lt;a href=&#34;https://creativecommons.org/licenses/by-nc-sa/2.0/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;CC BY-NC-SA 2.0&lt;/a&gt;. No modifications.&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;6f464e0d-95aa-47d4-b91b-ff78b73e82ad&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3bf72380-da88-4457-b301-5a8b1f33f317&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;a href =&#34;https://github.com/apache/pinot&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Apache Pinot&lt;/a&gt;&lt;sup&gt;™&lt;/sup&gt; 最初设计为仅附加 OLAP（在线分析处理）数据库。经过一些重新设计后，它被修改为支持 upserts，即 UPdates 加上 inSERTs。这允许您更新给定主键的记录或插入新的主键。删除是 upsert 的自然扩展，解决了 upsert 用例中对高效内存和磁盘使用的需求，这些用例需要无限期的保留期，并根据特定业务需求进行删除。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;60776145-55b5-404a-a4ec-df832fd2fef4&#34;,&#34;dropCap&#34;:false}&#34;&gt;此博客亮点&lt;a href=&#34;https://github.com/apache/pinot&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Apache Pinot&lt;/a&gt; 中的最新功能开发现在支持内存和磁盘级别的删除。它还展示了这些发展如何使 Uber 能够持续支持 Pinot 更新插入用例的无限保留。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5d7874d5-8553-4c9f-907f-66e93b70ae56&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;98ed0dc4-373d-46f6-a88e-92130099a954&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-upsert-overview&#34;&gt;更新插入概述&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c28bed20-e3db-456b-b4a3-32f63b67707b&#34;,&#34;dropCap&#34;:false}&#34;&gt;更新插入是Pinot 的功能用于点更新、回填和数据校正等。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7ae2a065-d825-4e86-9825-0d070419ff7a&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 1 显示upsert 架构的高级概述，强调 upsert 如何高度占用内存。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098831,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“2ad046e2-dfe3-41b4-8633-e2a59301fa2a”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“428”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-1-upsert-高层架构re-17303485305469-1024x428.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098831&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80, onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469.png 1024w，https://blog.uber-cdn.com/cdn-cgi /image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level-architecture-17303485305469.png 300w，https:// blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-1-upsert-high-level- Architecture-17303485305469.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1053，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10 /figure-1-upsert-high-level-architecture-17303485305469.png 1053w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption &#34;&gt;&lt;em&gt;图 1&lt;/em&gt;：&lt;em&gt;Pinot 中 upsert 的高级架构。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9e441de2-02e6-4d81-ac1a-aaf46746c488&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c789f689-5369-4d82-a15b-3f0bb04df0f8&#34;,&#34;dropCap&#34;:false}&#34;&gt;更新插入元数据是一个内存中的哈希图，它维护记录主键到记录位置的映射。 Record-Primary-key 是一个唯一标识符，用于对上游 Kafka 进行分区，并作为更新的参考（如果更新已存在于 Upsert-Metadata 映射中）。 Record-location 指向 &lt;a href=&#34;https://docs.pinot.apache.org/basics/concepts/components/table/segment&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;segment&lt;/a &gt; 存储给定记录主键的最新记录的位置。整个更新插入元数据映射都保存在内存中，以实现快速更新插入操作，从而导致更新插入的内存使用率很高。为了说明 upsert 的内存密集型特性，在 Uber，我们拥有 376 GiB 内存和 1.1 TiB 磁盘存储的标准主机在 upsert 用例中内存利用率为 80%，磁盘利用率约为 10%。为了与非 upsert 仅附加用例进行比较，这些主机的磁盘利用率更高 (~80%)，内存和 CPU 利用率约为 30-40%（高度依赖于查询形状）。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6ffd6fd5-44ff-4ab9-a63b-28c939d4d819&#34;,&#34;dropCap&#34;:false}&#34;&gt;此博客讨论针对需要非常长（无限期）保留期的更新插入用例，改进内存和磁盘占用的策略。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098833,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心&#34;,&#34;哈希&#34;:&#34;ddd7ab5c-b872-4e58-a955-92a7a84cd9c2&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;imgloading=&#34;lazy&#34;decoding=&#34;async&#34;width=&#34;1024&#34;height=&#34;495&#34;src=&#34;https://blog .uber-cdn.com/cdn-cgi/image/width=2160，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture -17303490841159-1024x495.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098833&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror =重定向，format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图片/宽度=300，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 300w，https://blog .uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture -17303490841159.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/图2-upsert-low-level-architecture-17303490841159.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=2048，quality=80，onerror=redirect，format=auto /wp-content/uploads/2024/10/figure-2-upsert-low-level-architecture-17303490841159.png 2048w“尺寸=”（最大宽度：1024px）100vw，1024px“referrerpolicy=”no-referrer“&gt; &lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 2&lt;/em&gt;：&lt;em&gt;解释 upsert 底层架构的示例。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div &gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e6650171-6279-4ab7-be14-b8215e2f7322&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5cc29ea0-9ad8-4e0e-b43a-3744fd3aa4d6&#34;,&#34;dropCap&#34;:false}&#34;&gt;考虑图 2 ，它显示了特定服务器实例中分区级别的更新插入行为。这里有一个密封段 S1 和一个消耗段 S2。 Upsert-Metadata 映射存储主键到记录位置的映射，表示为（段名称，DocId）。 DocId可以理解为记录所在段内的行号。图 2 通过虚线显示，当相同的主键出现在消费段中时，Upsert-Metadata 映射会将记录位置更新到新的消费段，覆盖对旧记录的引用。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;65e57f3d-f92a-4880-9f34-d79cb2e6885d&#34;,&#34;dropCap&#34;:false}&#34;&gt;此外，还有内存中的段位图，用于存储给定段的可查询记录，并随每个摄取的记录进行更新。在更新插入表的查询处理过程中，该位图用作隐式过滤器。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5e732668-f72a-431b-915f-d9fdaf8c745d&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-块-sepa”rator 有-alpha-通道-不透明度&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;55a87a0f-15f6-4d4a-b20a-304128177f02&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-point-deletes&#34;&gt;点删除&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;588352aa-4b80-4243-8443-231351742fc7&#34;,&#34;dropCap&#34;:false}&#34;&gt;描述更新插入时，另一个重要的用例是删除。一旦将记录主键标记为已删除，就不应再在后续查询中选择它。随后还应将它们从内存和磁盘中删除，以节省成本。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;19afce3f-05e0-4edf-bc27-dea569945c24&#34;,&#34;dropCap&#34;:false}&#34;&gt;在黑皮诺中，您可以通过设置表级配置来启用点删除功能。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098835,&#34;width&#34;:&#34;568px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;sizeSlug&#34;:&#34;大&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;dc5667b8-be55-461c-be1c-9001ea13e8ca&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img 加载=“惰性”解码=“异步”宽度=“1024”高度=“216”src=“https://blog.uber-cdn.com/cdn-cgi/image/width= 2160，质量= 80，onerror =重定向，格式=自动/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002-1024x216.png&#34; alt=&#34;&#34; class=&#34;wp-image -1098835&#34; style=&#34;width:568px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto /wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality= 80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 300w，https://blog.uber-cdn.com/cdn-cgi /image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002.png 768w，https://blog. uber-cdn.com/cdn-cgi/image/width=1252，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-3-point-deletes-config-17303491308002。 png 1252w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 3&lt;/em&gt;：&lt;em&gt;启用点删除的配置。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;50bfa0e5-42c3-4558-ad92-a9630a88b86b&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;348cb2da-3c55-48fa-826d-6cab7184eae8&#34;,&#34;dropCap&#34;:false}&#34;&gt;一旦点启用删除功能后，Pinot 开始跟踪名为 queryableDocIds 的附加位图。它的操作方式与 va 类似lidDocIds 有一个关键区别：只要 deleteRecordColumn 中的值为 true，相应的条目就会从 queryableDocIds 中删除，但不会从 validDocIds 中删除。在查询期间，您可以严格使用 queryableDocIds 作为隐式过滤器。理想情况下，queryableDocIds 和 validDocIds 是相同的，除非表中存在删除记录。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098837,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“a9be6149-c76f-4fe4-972d-c344307edf24”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“410”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-4-point-deletes-architecture-17303491608467-1024x410.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098837&#34; srcset=&#34;https://blog.uber-cdn.com/cdn -cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 1024w，https:// blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-4-point-deletes-architecture- 17303491608467.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure -4-point-deletes-architecture-17303491608467.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp- content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=1862，quality=80，onerror =重定向，格式=自动/wp-content/uploads/2024/10/figure-4-point-deletes-architecture-17303491608467.png 1862w“尺寸=”（最大宽度：1024px）100vw，1024px“referrerpolicy=”否-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 4&lt;/em&gt;：&lt;em&gt;点删除功能的架构。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/分区&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6e6709ac-fbe8-4e64-b768-b73ce5db41ca&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;552aa8a6-7a03-4329-9e00-02412ab7c6fb&#34;,&#34;dropCap&#34;:false}&#34;&gt;在示例中在图 4 中，每当出现删除记录时，与正常摄取流程不同的唯一操作是从 queryableDocIds 中删除该条目。其余流程保持不变。此功能与在此表的所有查询中添加一个过滤器（其中 &lt;em&gt;deleteRecordColumn = false&lt;/em&gt;）非常相似。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0cb6e955-eec7-44da-85bc-9ff9126983f8&#34;,&#34;dropCap&#34;:false}&#34;&gt;Pinot 没有t 收到后立即从 upsert-metadata 映射中删除密钥删除消息。这种方法可确保删除的一致性，特别是在该键的删除事件之后发生无序事件的情况下。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3788335a-0090-4b38-980e-5a18a73d054a&#34;,&#34;dropCap&#34;:false}&#34;&gt;很明显，该函数更像是一种软删除功能，因为它不会通过从哈希映射或磁盘中删除元数据来实现任何节省。我们在 Uber 有一个用例，删除消息的规模约为每秒 5,000 条，相当于每天删除 6 亿个密钥。根据上述标准主机配置，每台主机大约可以容纳250-3亿个密钥。如果复制因子为 2，每天可容纳 6 亿个密钥，这意味着每天要添加 4 台主机。如果我们想要支持高保留或无限期保留，这将成为一个关键问题，因为这会导致每天添加 4 台主机来管理已删除记录的元数据的成本。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6162ad21-cef0-4213-980a-cf32cf952c5b&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9eb6ec06-9c6b-4b95-bcd9-f0c476c9d878&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-metadata-retention-on-deleted-keys&#34;&gt;已删除密钥的元数据保留&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b587ba8a-b675-4d04-a222-1620822b88fc&#34;,&#34;dropCap&#34;:false}&#34;&gt;解决针对上述问题，我们引入了&lt;a href=&#34;https://github.com/apache/pinot/issues/11736&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Pinot 中的一项新功能&lt;/a&gt;，该功能消除了TTL 窗口后已删除密钥的元数据。此缓冲区 TTL 窗口可确保在此期间发生的任何乱序事件都不会逆转删除。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098839,&#34;width&#34;:&#34;578px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;sizeSlug&#34;:&#34;大&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;align&#34;:&#34;中心&#34;,&#34;散列&#34;:&#34;2cf8b259-d875-4e5d-9ae3-e4f6554e4199&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img 加载=“惰性”解码=“异步”宽度=“1024”高度=“254”src=“https://blog.uber-cdn.com/cdn-cgi/image/width= 2160、质量=80、onerror=重定向、格式=自动/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394-1024x254.png&#34; alt=&#34;&#34; class=&#34;wp -image-1098839&#34; style=&#34;width:578px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format =auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394.png 1024w，https://blog.uber-cdn.com/cdn-cgi/im年龄/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config-17303492939394.png 300w，https://blog .uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-5-deleted-keys-ttl-config -17303492939394.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1252，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/图5-deleted-keys-ttl-config-17303492939394.png 1252w“尺寸=”（最大宽度：1024px）100vw，1024px”referrerpolicy=“no-referrer”&gt;&lt;figcaption class=“wp-element-caption” &gt;&lt;em&gt;图 5&lt;/em&gt;：&lt;em&gt;用于启用已删除密钥的元数据保留的配置。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;04619d44-ef9f-4b7a-9ebe-ba50df77caee&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098841,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“哈希”：“4936f41b-6629-40cc-8ff4-c1dd68770750”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“360”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495-1024x360.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098841&#34; srcset=&#34;https://blog .uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture-of -deleted-keys-ttl-17303494211495.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/ uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768 ，质量= 80，onerror =重定向，格式=自动/wp-content/uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 768w，https:// blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-6-low-level-architecture- of-deleted-keys-ttl-17303494211495.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=1902，quality=80，onerror=redirect，format=auto/wp-content /uploads/2024/10/figure-6-low-level-architecture-of-deleted-keys-ttl-17303494211495.png 1902w“尺寸=”（最大宽度：1024px）100vw，1024px“referrerpolicy=”no-referrer &#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 6&lt;/em&gt;：&lt;em&gt;已删除密钥的元数据保留的低级架构。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt; &lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c30884a8-46cc-4a41-b0a8-648e37475ec2&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bba4c59b-ef7d-45af-8262-5b409005c444&#34;,&#34;dropCap&#34;:false}&#34;&gt;设计很简单。在每个段提交周期之后，Pinot 都会迭代 upsert-metadata-manager 中表分区中的键。如果一个键指向存在于 validDocIds 中但不存在于 queryableDocIds 中的记录（表明该记录已被删除），并且超过了deletedKeysTTL阈值，Pinot将从映射中删除该键的元数据并将validDocId标记为无效。如图 6 所示，其中红色表示删除，Pinot 也会从 validDocId 中删除第 4 行。&lt;br&gt;&lt;br&gt;本博客的下一部分将介绍 Pinot 将 validDocId 标记为无效的原因。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098843,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“c0576c7c-bd24-4ee0-aac0-31aaffcaa6c0”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“289”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158-1024x289.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098843&#34; srcset=&#34;https://blog.uber-cdn .com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158 .png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure- 7-low-level-code-for-deletedkeysttl-17303494918158.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto /wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width= 1536，质量= 80，onerror =重定向，格式=自动/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl-17303494918158.png 1536w，https://blog.uber -cdn.com/cdn-cgi/image/width=1730，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-7-low-level-code-for-deletedkeysttl -17303494918158.png 1730w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 7&lt;/em&gt;： &lt;em&gt; 已删除键 TTL 流的伪代码。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8204bef8-c3c1-49fd-8c10-481e4052ea65&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5f0cd937-4e99-470d-80af-e7deec686a33&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 8 说明我们在 Uber 在表上启用此功能后实现的删除规模，删除率约为每秒 2,000 条消息。该指标显示，元数据中删除了多达 3 亿个键每天 a-manager 地图，考虑复制因子为 2。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098845,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“179cfea9-8182-42b3-9537-2dc589891402”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“404”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-8-deleted-keys-ttl-impact-17303496032610-1024x404.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098845&#34; srcset=&#34;https://blog.uber-cdn.com /cdn-cgi/image/width=1024，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 1024w， https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-8-deleted- keys-ttl-impact-17303496032610.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads /2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=重定向，format=auto/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image /宽度= 2048，质量= 80，onerror =重定向，格式=自动/wp-content/uploads/2024/10/figure-8-deleted-keys-ttl-impact-17303496032610.png 2048w“尺寸=”（最大- width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 8&lt;/em&gt;：&lt;em&gt;删除的密钥 TTL 功能对生产的影响。&lt; /em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;27480f2b-c480-4169-8aa2-9221c9eb52b2&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;170a8587-a8bc-4bf9-8ab6-977dec3ca062&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2596619c-4815-4f28-8923-b98137a7e86b&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-upsert-compaction&#34;&gt;更新插入压缩&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;44c5307e-38d8-49ca-a3ac-ae22532e8c2b&#34;,&#34;dropCap&#34;:false}&#34;&gt;服务器重新启动期间，Pinot 将磁盘上持久存在的所有键加载回内存中的哈希映射，然后再次触发它们的已删除键保留。这导致了 OOM 问题，因为过时的密钥没有从磁盘中删除，并且数量达到了数百万个。这可以通过逐渐从磁盘中删除过时的密钥来解决，从而重新获得节省的磁盘空间，并且在重新启动期间不会将它们加载回内存中。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;493cb873-80ee-4b2a-8cae-125a566fd00f&#34;,&#34;dropCap&#34;:false}&#34;&gt;在优步，我们使用 &lt;a href=&#34;https://github.com/apache/pinot/pull/10463&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;UpsertCompactionTask minion 任务&lt;/a&gt; 来压缩旧段并删除陈旧的段或从磁盘中删除行。为此，我们使用 validDocId 位图快照流程。在每个段提交周期之后，我们为所有段拍摄这些位图并将它们保存到磁盘。在每次任务运行期间，我们循环遍历所有这些位图，以找到提供最大压缩效率的段，其中 &lt;em&gt;invalidDocs =totalDocs - validDocs&lt;/em&gt; 的最高值。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5c6ada86-b1b9-4d03-9d80-467cb9245304&#34;,&#34;dropCap&#34;:false}&#34;&gt;引用上一个例如，在段上运行 Upsert-compaction 任务后，磁盘上的段将被更新，如图 9 所示。我们看到与 &lt;em&gt;primary key=3&lt;/em&gt; 相关的记录也从磁盘中删除。&lt; /p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098847,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“3389947a-b60a-4997-9865-88a2216fe707”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“288”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383-1024x288.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098847&#34; srcset=&#34;https://blog.uber -cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert -compaction-17303496455383.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/ 10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror =重定向，format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383.png 768w，https://blog.uber-cdn.com/ cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-9-low-level-architecture-of-upsert-compaction-17303496455383。 png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=1878，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-9 -low-level-architecture-of-upsert-compaction-17303496455383.png 1878w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption &#34;&gt;&lt;em&gt;图 9：upsert 压缩的低级架构。 &lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p达ta-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;60b5ffc6-e7f6-492a-9139-255e21f10e5e&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;aa036b3a-d22b-413e-b23c-74a369483933&#34;,&#34;dropCap&#34;:false}&#34;&gt;如前所述，在已删除键的元数据保留工作流程中，Pinot 将 validDocId 标记为对于已删除主键无效。这使得它们可以在下一个周期中进行快照，从而可以通过 upsert 压缩从磁盘中删除已删除的记录条目。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3297bbf8-670f-42db-a170-06fca407dd6f&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 10 显示对我们的 1 个生产表启用 upsert 压缩的影响。表的大小增长到约 8 TiB，但启用压缩后，大小减小到约 850 GiB，从而节省了约 90% 的空间。此外，数据增长率从约 85 GiB/天显着下降至约 3 GiB/天。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1098849,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“03b08f5a-2743-4eff-8c2a-888b3e21097f”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“309”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-10-impact-of-upsert-compaction-task-at-product-scale.-17303498706695-1024x309.png&#34; alt=&#34;&#34; class=&#34;wp-image-1098849&#34; srcset=&#34;https: //blog.uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-10-impact-of- upsert-compaction-task-at-product-scale.-17303498706695.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format= auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-product-scale.-17303498706695.png 300w，https://blog.uber-cdn.com/ cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-product-比例。-17303498706695.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/ 10/figure-10-impact-of-upsert-compaction-task-at-product-scale.-17303498706695.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=2048，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/figure-10-impact-of-upsert-compaction-task-at-product-scale.-17303498706695.png 2048w“尺寸= &#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;em&gt;图 10：upsert 压缩任务对生产规模的影响。&lt;/em&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c2a7fe2a-7670-4ab9-a36f-52d424b2c6e6&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;5c015e29-a878-4acc-8fab-9df3126a3230&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-ensuring-data-consistency-with-deletion-and-compaction&#34;&gt;&lt;br&gt;通过删除和压缩确保数据一致性&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2fb6d20d-9b99-4a6a-9b62-1484a31602c6&#34;,&#34;dropCap&#34;:false}&#34;&gt;一项挑战启用压缩和删除的情况是，我们最终可能会遇到这样的情况：特定键的较旧的未删除记录不会被压缩，但已删除的记录会被压缩。在服务器重新启动期间，当加载所有段时，Pinot 会错误地将记录标记为未删除，并开始将其作为有效主键返回，从而导致表中的状态不一致。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8b68305f-2087-43ae-982e-f48f19271e92&#34;,&#34;dropCap&#34;:false}&#34;&gt;例如，考虑主键 PK1，其记录位于段 S0 和 S1 中。在S1中，该记录被标记为已删除。如果由于 upsert 压缩流程中的阈值原因，S1 被压缩，但 S0 没有被压缩，则在服务器重新启动期间，upsert-metadata-manager 映射将错误地将 PK1 指向 S0，即使它应被视为对最终用户而言已删除。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;86bb47ba-8878-4574-800c-0c722ad7fc09&#34;,&#34;dropCap&#34;:false}&#34;&gt;解决此问题在这种情况下，我们在 Pinot 中提出了一种&lt;a href=&#34;https://github.com/apache/pinot/pull/13347&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;设计来维护主键→不同的状态-段数&lt;/a&gt;。这意味着跟踪给定主键存在记录的段数。如果计数 &lt;= 1，Pinot 将允许删除记录上的元数据，然后将 validDocId 标记为无效。 Pinot 现在可以压缩已删除的记录，确保删除其他段中的所有其他记录。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;238b50a4-0c7e-4faa-a6b9-4ad3a501a455&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1284d8a3-f06d-4fa8-826c-28ee992219e1&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-use-cases-at-uber&#34;&gt;Uber 用例&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;78f3eacb-6acb-409b-91a4-20763d84c171&#34;,&#34;dropCap&#34;:false}&#34;&gt;截至撰写时，我们为 20 多个表启用了 upsert 表的无限保留，以及所有表的主键总数大约有 60 亿个密钥（没有复制），每天的删除率约为 6 亿个密钥。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;57086e77-68d3-4503-9445-2979304f5655&#34;,&#34;dropCap&#34;:false}&#34;&gt;无限保留upsert 表将有利于 Uber 等以下类型的长期运行用例：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;166919b3-4707-4aef-a4a9-842d37ad58a7&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;跟踪 Uber for Business 用例，其中组织活跃多年并定期更新有关员工人数、支付实体的信息等等&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;以下 Uber 优惠券使用案例，其中优惠券有效多年，并接收有关优惠券兑换计数、优惠券到期的更新。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;Cadence 工作流程分析，因为每个工作流程可以运行数小时、数月或数年，并在关闭时启用删除工作流程。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e8edb46e-3fd1-4226-a538-6141bfd46be2&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4c862e22-f807-4c74-8f15-83e0112383a1&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-next-steps-nbsp&#34;&gt;后续步骤&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;235f6f61-db25-4acf-ac58-6c25fc91e4e0&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们面临的一项挑战have 是随着时间的推移为特定表创建许多小段。这可能会导致服务器重新启动期间的加载时间更长以及查询延迟更高，因为在查询执行期间需要由相同数量的线程处理更多的段。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0ae209af-bd6e-40b5-8188-d7fc56b8f86d&#34;,&#34;dropCap&#34;:false}&#34;&gt;一种可能的解决方案是为了跨多个段启用 upsert 压缩，将它们合并以创建更大的段，从而控制总体段计数随时间的增长。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ffb7cee3-09ce-43e4-835b-be30f8bfc94a&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;88951a08-8e0a-4188-bc28-d55268b08a69&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;514436bc-0ef2-4cd1-907d-e8239168f7b3&#34;,&#34;dropCap&#34;:false}&#34;&gt;Apache Pinot 中的这一强大功能满足了 Uber 及其他公司的许多 Pinot 用户的关键需求，可以提高更新插入表的保留率并支持直接在 Pinot 中进行删除。这为 Uber 的 Pinot 更新插入解锁了许多新用例，并使 Pinot 的功能更接近行级数据库的功能。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4fff3aad-3e6d-44ec-934e-01aa3d7ca10d&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e4c7c315-71fb-491b-bbe4-1c6ad36bb3e1&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;db131410-81a0-4b9f-b365-cd7d432d6fc8&#34;,&#34;dropCap&#34;:false}&#34;&gt;特别感谢Apache Pinot&lt;sup&gt;™&lt;/sup&gt; 社区成员积极贡献并审查了在 Pinot 中启用此功能所需的大量更改。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;132c57fc-915d-4f35-ad45-844bb47ad56c&#34;,&#34;dropCap&#34;:false}&#34;&gt;特别感谢Navina Ramesh 负责设计点删除，Robert Zych 负责设计 upsert 压缩，Yupeng Fu 负责制作原始的 upsert 设计文档。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;744f7acb-2945-49f9-a5c4-677304116510&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;Apache Pinot&lt;sup&gt;™、&lt;/sup&gt; Pinot、Apache、Apache 羽毛徽标和 Apache Pinot 项目徽标是 Apache 软件基金会的注册商标。 ‌使用这些标记并不暗示 Apache 软件基金会的认可。&lt;br&gt;封面照片归属：“&lt;a href=&#34;https://openverse.org/image/bc95682f-5a02-46a3-98eb-86f364835de0&#34; target =&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;无限美酒&lt;/a&gt;”作者：&lt;a href=&#34;https://www.flickr.com/photos/47105685@N00/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Adam Brill&lt;/a&gt; 已获得 &lt;a href=&#34;https://creativecommons.org/licenses/by-nc-sa/2.0/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;CC BY 许可-NC-SA 2.0&lt;/a&gt;。没有修改。&lt;/p&gt;</description>
      <pubDate>Thu, 31 Oct 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【Making Uber’s ExperimentEvaluation Engine 100x Faster】让 Uber 的实验评估引擎速度提高 100 倍</title>
      <link>https://www.uber.com/blog/making-ubers-experiment-evaluation-engine-100x-faster/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;d64b6745-f796-4cb8-872e-6ae0157f15d7&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f3c10d4f-01d7-4aec-9f1f-7b770ab21fc8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This blog post describes how we made efficiency improvements to Uber’s Experimentation platform to reduce the latencies of experiment evaluations by a factor of 100x (milliseconds to microseconds). We accomplished this by going from a remote evaluation architecture (client to server RPC requests) to a local evaluation architecture (client-side computation). Some of the terminology in this blog post (e.g., parameters, experiments, etc.) is referenced from our previous blog post on Uber Experimentation. To learn more, check out &lt;a href=&#34;https://www.uber.com/blog/supercharging-a-b-testing-at-uber/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Supercharging A/B Testing at Uber&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ac4c1504-882c-4649-933c-fa6b5b8b1afc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Experimentation is used heavily throughout Uber’s backend microservices, mobile apps, and web surfaces to measure improvements of product launches across all business units–Delivery, Mobility, Freight, Uber For Business (U4B), etc. We will cover the current and new architecture of the system as well as technical challenges, and learnings. This blog post specifically focuses on latency improvements to &lt;strong&gt;backend&lt;/strong&gt; Golang microservices rather than mobile or web-based experimentation. We are also focusing on A/B tests rather than other experimentation designs.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8db03731-b49f-4b16-b029-f3c0c476f829&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;50bc6c10-54b3-4842-8202-209b25f285cc&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-background&#34;&gt;Background&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a5e74f0b-28b2-41cf-bfc3-8d915ee23d65&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In 2020, Uber began a long journey to rewrite the A/B testing platform (internally referred to as Project Citrus). One of the key architectural decisions for this new system was to unify Uber’s existing backend configuration platform, &lt;a href=&#34;https://www.uber.com/blog/flipr/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Flipr&lt;/a&gt;, with the Experimentation platform. We built Experimentation to exist as a temporary override layer on top of Flipr configurations (also referred to as parameters)&lt;strong&gt; &lt;/strong&gt;in order to perform randomization, conduct causal inference, and help teams determine the best performing value to use for their parameters.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fc14f607-ac7b-4402-aaab-d17095a1697e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Below is an example to illustrate the difference between a parameter and an experiment. Here we have a &lt;strong&gt;parameter&lt;/strong&gt;, which controls the button color of a specific screen in the Rider app. The default value is red, but in some situations (e.g., if the user is in &lt;em&gt;city_id = 1&lt;/em&gt;) the value would be blue for &lt;em&gt;all users&lt;/em&gt; in that city.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b2b71d62-7a60-47d0-b089-cf5005aac389&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;7707510c-e913-4343-9940-4277b2619ab0&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcCn3OE-lw_syq4RP3ju2DpQ0D1xl16leZdP_eDI5i8anem_mVIFYBvXrlIXwFhe_3-0eUrXFomadWp52ObiNyxP9uzsxIDoFFz-z4Yn7xmlpVZ6YXqP5YQPCamrzUemoEyFfU13XDYaM3CFDtSgpCIsMab?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Parameter representation.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;96551fce-9bac-46a9-a7f6-1a31edb0ca3b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e083eb58-1309-410f-a1e2-66e77997f412&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;These parameter rules engines are evaluated using a Flipr client:&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;2c2f8923-a7ad-47b7-8f66-cb3d159a6e78&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcc7pse1Iyq0IKcOY4i8gl6_jnxlu6rD8oWL_i9wXvyYplJtZdR8whcpSTMiaOv-R5iGp_5cxF3olsqFcCKZ7YRaWqr0rMSef2R2WTq9NRWgl9fU-ukIR83Tl31VzwExH7x5SLe2NG2YkLXTa3ZYqWSrHQs?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: Flipr client parameter evaluation.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6ab1ea4c-fe8c-4749-8670-d82d3312f7c9&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b73e9c72-55bd-4de3-b9bd-1bc5f54e2187&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The calls to the &lt;strong&gt;get&lt;/strong&gt; method return different parameter values based on the runtime arguments passed in (e.g.,&lt;em&gt; city_id&lt;/em&gt;, &lt;em&gt;user_id&lt;/em&gt;, &lt;em&gt;app_version&lt;/em&gt;, etc.).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;940a53cb-bbe3-459f-be5b-41a1fa8635c7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;An &lt;strong&gt;experiment&lt;/strong&gt; allows us to randomize the behavior of the parameter for some unit of measurement (e.g., users, sessions, devices, or trips). While an experiment is active, the parameter has additional &lt;strong&gt;parameter metadata&lt;/strong&gt;, noting down the associated experiment that would override the behavior of the parameter. When the experiment is concluded, this metadata is removed.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b49aafcb-1c4c-40ea-8930-4f58126234f1&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;ecc0933e-c3ca-4036-b013-db0cc0c0adaa&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXexjiP3-po3l3ihs_fQd3guWL5DTCZIvUQ772FVqMyctGFS63DhRvCHKsa42Y4IRoRFVvjrFSi-sBaj4WT8AzkaGF-WHVkbGIvETqmFw-cRmWFNcTyONLV1AdAYj6qRoS1h_7_zWrui0c12CCfToHX514IZ?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: Parameter metadata representation.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f1193605-535c-4c70-9563-e1aaf3f89757&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e8ca6b41-3c1c-464b-a349-899fb7e7fcd8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the below example, 2 different users in &lt;em&gt;city_id = 1&lt;/em&gt; could get 2 different values of a button color based on which &lt;strong&gt;treatment group&lt;/strong&gt; they belong to in the experiment (the below A/B test is set up as 50% treatment and 50% control and is randomized by &lt;em&gt;user_id&lt;/em&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d15399a5-c8ee-4cac-8c9d-c99b9ab591b9&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;937986bc-64db-4d52-a6d7-32f9dd1d7f6a&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdHmTE23QiXnNEgxYPnx68cAEN8Hzl3NP88Fs8vJsUpajG6berW6mTMScplnEc7VPxfd0nAVIIoRHZxkW82a5vZTVbw1kVKlBtDRxy7P2meDrb1CfveKOv5rRbX8L7Ztq4HAoeXXCLkOoztJBNhDCC4ZxnL?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: Experiment and experiment metadata representations.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;36504ba8-03a6-4c23-9c55-183d16794848&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;42fede90-4b58-403d-933b-b753ebc5d5e2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The &lt;strong&gt;experiment&lt;/strong&gt; and &lt;strong&gt;experiment metadata&lt;/strong&gt; are read by the Flipr client and the return value of any parameters impacted by the experiment will vary based on the experiment randomization (e.g., &lt;em&gt;user_id = 123&lt;/em&gt; may get blue because they are part of the control group, while &lt;em&gt;user_id = 456&lt;/em&gt; would get the value green):&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;52345ac8-1e9b-4d86-8478-06ee41a7948e&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;ce15ddb4-a0f2-4f3f-93ac-ef97e39d89fe&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcpoEA_nfVd7LsWMyhG3bziMUdl4ITrlKuwOtg9-K5aTcXjrE-0wFCBDJe2Z6vFrZ3P-6mZsucF4Q8WrR41jm2TY0yWAJqs6U1oKeAoe53vx9ve95P9WITM_EgX77UIxLXKyhCUNj_ZwgS9hhFDCeH5o18?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: Flipr client parameter evaluation with experiment override.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;dcadd599-ede1-4988-9f5e-43b259d9738c&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f969ee60-3503-4da6-afd6-e8542ee55b8a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We log the exposure of users to experiments so that we can measure the impact that these changes have on key business outcomes, such as completed trips or gross bookings.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d65583f0-bd34-4a63-a299-3e1fb6807568&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c48b0622-aecd-423c-be13-474c76ae16b6&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-problem-statement&#34;&gt;Problem Statement&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6310153c-1cd3-47e0-9c90-7606539284fe&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Historically, all experiment evaluations happened through network calls to a centralized microservice, whereas evaluation of parameters with no active experiments happened locally (referred to as “local evaluation”). As part of project Citrus, we kept a pattern where all backend microservices made RPCs to a central service to evaluate active experiments. This approach allowed us to ship the new platform relatively quickly and it reduced migration cost for our customers to adopt the new platform. All of our clients (backend systems, mobile devices, and web services) adopted the new platform by making RPC calls to the new evaluation service (internally referred to as &lt;strong&gt;Parameter Service&lt;/strong&gt;).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0e39eb67-e7b6-4544-b5e6-cd0e09994579&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;040d5459-23bf-4773-9821-b0bedffb41ce&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfgi_tto5GyZSqw-RsesbyPBH2Z9YCFlvmsRI7ZSyHqC9NiZ8W_qgxgcktI7Hp4DxV2jk2pd6gREQLrlHYj-2XM13BoqE2i-eMYe-OoxJUgM3yQg5xz7cfZZehnyr2cu3NKQFZidRPn735nN9xvj0K0doo?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 6: Parameter Service Architecture (RPC evaluation).&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;eb7ea424-ecc9-42fb-a03b-087856d826d8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;aabc8519-d3b2-450e-a7b7-ed893eff3615&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;br&gt;However, this pattern also left several problems unaddressed for backend callers of experimentation, that we wanted to solve as part of our experimentation platform rewrite.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f6745bde-0355-48de-848c-1f9869dc7691&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Latency&lt;/strong&gt;: RPC based evaluations are relatively slow (p99 latency of ~10 ms). Given the real-time nature of the Uber marketplace, there are many applications that needed their experiments to be evaluated faster in order to onboard to the new platform.&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Reliability&lt;/strong&gt;: The parameter service became a single point of failure. To mitigate this concern, we invested heavily in the reliability of parameter service, eventually maintaining an availability SLA of 99.95% for each of its endpoints. We also encouraged teams to rely on a fallback value in case of RPC failure. However, given the scale of the system and the fact that hundreds of teams and microservices call parameter service to evaluate thousands of parameters and experiments at any given time, the behavior of every fallback could not be guaranteed. Occasionally, the fallback value would become unsafe, resulting in outages that would then need to be promptly fixed.&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Developer Productivity&lt;/strong&gt;: In order to reduce the number of requests to parameter service, we introduced a prefetch mechanism. As part of this mechanism, a backend service would send a batch RPC request to parameter service to evaluate and return &lt;strong&gt;all&lt;/strong&gt; of the parameters under active experimentation needed to process business logic for that specific request. The experiment values and exposure logs returned from the parameter service would be stored in the local in-memory cache of the backend service.&amp;nbsp;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;The backend app would then &lt;strong&gt;get &lt;/strong&gt;the value of each individual parameter needed in that request (which was impacted by an experiment) exactly when it was needed, and this is the point at which we would emit an exposure log for the user entering the experiment.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a4427471-3ff1-4905-96a9-91dc1d65829d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;While this batching helped reduce the total number of RPC calls, it also meant that backend developers needed to be cognizant of the prefetch mechanism while coding their application. They would need to plan for which parameters to prefetch upfront so that these parameter values would be available later. A failure to do so would result in unexpected bugs that would then need to be debugged and fixed, resulting in inefficiency.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;015fdac7-4719-46b9-a1a3-2ea244c3b0a0&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;d887cb33-7e66-4dd0-a4b3-ac2d087b1233&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfDVtfii-J4qcPg2YJtWSkXfvWDWv-KTwuM72AULRUI3zxzma2dj2vPfvaMSzugIOKLQsoKsg5TQLmva-uAEPUDcTuwJ2bDjZRCviyCOlFY58-llmflatbDIxCJ0heqp3C5C3UqF7X7zttrx8fl-G0q1HA?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 7: Initial Architecture: Prefetch parameters mechanism.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7b0ea81f-c7eb-45ff-9531-316815e29e09&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5033feb0-daf7-44d6-a24f-5e4fb50e46ce&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We believed that all of these concerns could be addressed by a new architecture involving client-side evaluation of experiments (and parameters) without any RPC requests to the parameter service.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;934b57ef-115b-4707-be3e-e2665432395b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;445e90ae-10ba-4ffa-9353-5dba81b4f6a6&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architecture&#34;&gt;Architecture&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;55e76b60-4589-41d2-becd-ed057a9a1bb1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Uber’s existing architecture involved a distribution mechanism where Flipr parameters were sent to all host agents at Uber (&lt;a href=&#34;https://www.uber.com/blog/how-we-unified-configuration-distribution-across-systems-at-uber/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;see previous eng blog for more details&lt;/a&gt;). Each microservice running on such host machines would rely on the Flipr client to periodically bootstrap these parameter rules engines by reading from file caches which results in a much higher availability than online RPC architecture.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2f5c86e6-e578-4ab8-a75e-dae062dcdb43&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;b088ac78-b735-4c9d-88d2-e3ff47ecc8fd&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd3OYBBowDH_C3r1DhN2tu-fEtjHEzLZv_vRtEsIBtk6G0NUszEUquFnpCt5gtTVc4dK1JB_qVY4cKJ7F8LzP-wRac-Hsq-EsKBANHoSrqECWjOuwotA77-5jTT0R7GJo46YKflS3j-dFkmh2mHQ6AZgG4z?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 8: Parameter host agent distribution.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d1f41a6a-5b70-44d2-b665-a0ca62124f06&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4a048935-c4fa-4b94-96b6-eac2134b2e36&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One of the major changes in the new architecture was to distribute &lt;em&gt;experiments&lt;/em&gt; to all host agents by using the same distribution layer as regular Flipr parameters. This change in the distribution layer would unlock the ability for each microservice to locally read experiment data without any RPC to Parameter Service at all.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;63099f92-3738-4998-9b54-fcbe2db2f94e&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;7ee272d4-aa04-46ff-9b6c-45e6ecf33fff&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcKDN5DxoAaBdHAZTOrJUzsoefqhlUErYvD0g7UAyln6llauKDecQnwhH7ul3yoseZyAFP4Ds7CdbQsh-b8ja6QbUmzbMjRvcdEWJoqh3wtL-AK389xl8ey4M6CeYmShCFTQkLWx-zt0s62OHHxoSpBBbc?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 9: Experiment host agent distribution.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6b0ffc43-1496-4c55-b262-d5f1f46ac85d&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;adfabe5c-dde3-4abd-82c3-c2dd8a677fee&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The next step for us was to port all experimentation specific business logic of the Parameter Service into an &lt;strong&gt;ExperimentPlugin&lt;/strong&gt;,&lt;strong&gt; &lt;/strong&gt;which would be embedded directly within the Flipr client. We intended to pilot this new capability directly within the Parameter Service before exposing this new capability of Local Experiment Evaluation to external microservices. The benefit of being the first users of Local Experiment Evaluation was to allow for &lt;strong&gt;rigorous shadow testing&lt;/strong&gt; to ensure correctness and performance parity.&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f04d2aa4-af87-446b-9270-ee28e8debd82&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;9f4bd2fa-4ae3-406c-98e3-8de044fe66cf&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfX4ur07iZOXrXm_yBZqMT96lUUkK6UtKEDPoysWcVop9gUKKnTb9wNvXHHgEq4TzyoanjOlN-C2qw89l36IkzOIaTRyPlWOqivL6bVigFeR7pCyZ6sXRm8a7zvoIRM9pxVEVCEo_oqtcf3uXBIgxwklble?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 10: Intermediate Architecture: Shadow evaluations in Parameter Service.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f6c86324-e4e6-4da9-bf01-fa62d9a5907b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9aa41247-e80c-4554-8e8d-8aedda0f1439&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;After a thorough shadow testing process through which we uncovered and addressed 13 separate bugs, the final step in this journey was to allow teams to directly opt in to use the Local Experiment Evaluation capabilities and remove their usage of the PrefetchParameters API entirely.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3c32247a-108e-4d0f-ad93-71e4adcb0330&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;6437ed43-38f5-4090-be47-ed6975e71eb7&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdOxStMOvaEm58g-JwGuIeMTKJ7qgzjAgDFm3BXhDz8eA0-aaV59TajP0JzHWu4-tuvrwuWukh76OXkZ-VBCI4-pIr6-p5wN1YkHWrG3M1owopRG0jgiGVhaIC_XFJovE5g-Zn0Y1-B1_bQs60EmLImumzT?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 11: Final Architecture:&amp;nbsp;Direct usage of Local Experiment Evaluation in backend microservices.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b92ed6f5-7e4d-442e-bc53-a1087605e9d3&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ac67e08a-3e62-4ee2-a97c-72c18708e894&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-challenges-amp-learnings&#34;&gt;Challenges &amp;amp; Learnings&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;1b107d54-09cb-488a-b808-2871f6e8a911&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-1-verification-at-scale&#34;&gt;1) Verification at scale&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;dad739ab-b35a-4899-b3fc-3fe873f1e031&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One of the major challenges of building this new local evaluation functionality was to ensure that it was performing correctly at scale. In order to do this, we implemented a shadow testing capability to ensure that a sampling of requests that went to the V1 legacy evaluation code path would also trigger a separate async goroutine to evaluate and compare results with the V2 local experiment evaluation code path.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0abdd297-983f-4ac0-99e6-9dd68729bfcd&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The scale of such evaluations was enormous (roughly 20 million evaluations per second) and required heavy sampling to prevent any degradation to Parameter Service to perform these comparisons. Additionally,&amp;nbsp; the types of evaluations varied greatly from backend, mobile, and web surfaces. For this reason, we found it necessary to prove that every mismatch we encountered was explainable. And eventually we achieved a match rate &amp;gt;99.999% (1 explainable discrepancy out of 100,000 evaluations on average).&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;506c3496-912b-4c65-99e2-1a791658c7bc&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;f0932322-4158-4a84-a4b5-79d79a887fbc&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfkDB3JeA0i5JY19L-Cw7R0uM4WGps4Kd8N6MUC1FkhCWPDOcYZyILjrFgviTGd8a8h6ZakoGVNup_x6zXt98AM7NWLBcHakzuxk2DbvUhmi-kZm_sNiYS9sTi6qNuQBbkz-ZtEDKCP_07nxp5gfnfTtiY?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 12: Shadow evaluation match rate.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;34acc681-281b-4bff-a037-e658f65264c7&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;63e623d2-a89a-4d65-9813-028a25e7444d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Some of the key learnings from this process included:&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b9a6d2df-c22c-4063-9fc5-2f86b4606e00&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Known discrepancies during parameter or experiment updates&lt;/strong&gt; – Whenever users updated the values or rules engine for parameters or experiments, this would predictably result in a race condition. The V1 evaluation methodology might use version X of the parameter or experiment whereas the shadow comparison using V2 methodology could use version X+1 based on the timing of Flipr distribution. This became the &lt;em&gt;only&lt;/em&gt; source of acceptable discrepancies in the system.&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Bugs in the old methodology&lt;/strong&gt; – Although 100% parity with the old system was the goal, at times we decided to “fix forward” and address minor bugs and edge cases in the legacy system instead of the new system. This proved to be a major benefit of this migration: in addition to providing new functionality, we were able to fix difficult-to-detect edge cases in the legacy system too.&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Race conditions and timeouts&lt;/strong&gt; – Similar to the issue of “known discrepancies” during parameter or experiment updates, we realized that some subtle race conditions could affect our shadow evaluation match rate. One example was to set an adequate timeout for the shadow evaluation–it should mimic the same context deadline provided to the original evaluation to do an apples-to-apples comparison not just for logical correctness, but also performance.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f33fe512-c94d-4246-9029-230911eb591b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;c9ffdcb3-3f47-43ee-afe0-1f9ef83790c5&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-2-logging-volume-concerns&#34;&gt;2) Logging volume concerns&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b478fb6d-949a-4af6-a4c7-1a7b6e5ddff7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The dramatic improvement in evaluation speed introduced a risk to experiment log production and processing. Evaluating a parameter that is being experimented on may produce an exposure log to Apache Kafka®. If parameters can be evaluated 100 times faster, this means logs can potentially be produced 100 times faster too, and there is a risk of potentially overwhelming the infrastructure that produces, distributes, and processes the logs. In particular, we were concerned about dropping experiment logs due to hitting rate limits on our Kafka topic (either byte rate or message rate throughput limits).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7870c783-6532-4bc4-a380-2d60402a7fc6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;One common experimentation use-case where a large cohort of users can be processed in bulk is producing marketing copy for an email campaign involving hundreds of millions of users.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;da4724f7-a7ab-4235-ab53-2152cb58de80&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To mitigate this risk we did the following:&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;373275bf-50a4-4d3c-9445-e57403f31b6d&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Telemetry &amp;amp; alerting on log volume production&lt;/strong&gt; – First of all, we added telemetry to understand how many experiment logs were produced per second by each client, and alerting our on-call team if any one of them was producing greater than 5% of the total quota for our Kafka topic. This allowed us to identify hotspots and build solutions to address them.&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;In-memory LRU cache&lt;/strong&gt; – Because our experiment log processing pipeline only cares about the first time each user enters the experiment, we were able to deduplicate an enormous volume of logs. We decided to use a highly performant in-memory LRU cache (&lt;a href=&#34;https://github.com/hashicorp/golang-lru&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;golang-lru&lt;/a&gt;) to reduce redundant logs, and ultimately were able to deduplicate roughly 80% of logs.&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Parameters within the Flipr client library&lt;/strong&gt; – Having the ability to add “internal” parameters used within the Flipr client library and ExperimentPlugin became crucial to developing features safely. In order to avoid circular dependencies, we had a separate mechanism to load these “internal parameters” at file cache bootstrap time vs. providing runtime context to evaluate them. In case of emergency, we were able to entirely disable local evaluation using these internal Flipr client parameters without having to re-deploy services.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e084632c-ca52-43ea-914c-66c1a2493fc6&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;02c9d2f9-6517-4642-a059-f05afd2b2181&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-3-decentralized-evaluation&#34;&gt;3) Decentralized evaluation&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b1178d8b-d999-41c2-a54d-7de90f53aafe&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Lastly, a new challenge that we had to face was the fact that experiment evaluations were now decentralized as part of a client library versus a single centralized microservice. One of the major benefits of RPC-based evaluation, especially in the initial development phases of project Citrus, was that any issues with the core evaluation logic could be easily reverted by redeploying a single microservice. We would encourage others to only move towards client side evaluation once the platform is in a mature state, because reverting multiple separate microservices involving separate versions of client libraries is a much more costly and time consuming exercise.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;361e81b7-1e5d-4889-ac06-591bc50b23e0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Some of the tools which helped us with this paradigm change include:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;77b1cb48-f40a-4734-b173-5aeb8dc4ad6e&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Client library version tracking&lt;/strong&gt; – Even though our backend microservices are deployed at a regular cadence, it isn’t always the case that every single microservice at Uber is up-to-date with the latest client code changes. Client version tracking telemetry allowed us to more easily identify services which were using outdated or buggy versions of the SDK.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5667ba11-eee9-4e70-b2ec-45290073c058&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;b99a72dd-8035-4e21-9267-2fcafd0bd339&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfVlJBJwZVPpoGcaCKELgO40jDpe5EWiteqtyxeHsQsmGWqtpA7bloW2FS15rf9RxXqzKIodyysvMEJywcO0p0G3QfN3am2fE5Sf0ZNGKRMn_pQotJHekJ-hdAFHfdNzsHHyDxRmBRL0kk-6UZPqkyoBZyT?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 13: Client library version adoption curve&lt;br&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;948edbc4-172e-4787-93d8-95510b8b870c&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;000f094a-7e5c-4109-8ca2-9a2e1499f495&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Bulk deployment infrastructure&lt;/strong&gt; – &lt;a href=&#34;https://www.uber.com/blog/up-portable-microservices-ready-for-the-cloud/?uclick_id=b017bf4f-abd9-415e-aee6-3540742d49ad&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Up&lt;/a&gt; is the platform at Uber which manages orchestration and code deployment of thousands of microservices across millions of host instances. We were able to add capabilities to bulk deploy services in a worst-case scenario (e.g., broken client version released).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fb45ec4e-a63c-4002-8b8e-b561b81e73eb&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;517dda9d-6a81-432e-92d6-47c286375bef&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-impact&#34;&gt;Impact&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ebe4e725-1949-4d2e-94b3-0423cf766e8d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Ultimately, the new architecture proved to be a success for many use cases at Uber. The p99 latencies of experiment evaluations dropped by a factor of 100x (from 10 ms to 100 µs).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2e81cbce-46ea-4370-9a75-0f094a8274ed&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;413b8262-4b07-49d8-a66b-42309ff8ba66&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXffLKFTT_m6BdKUfilQq3txDxRV1j5GdeC8BVg6xgwvGvKu8UYjjksYNr2aeW2zZNdKtaDC-ZPt_FHMre0VApVA-oVGIaX29mTmtOyeeIOa07pRjcOouC9ufQP8qxPJigzeBJHvySR3RLjB1rhVOKL6cA4?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 14: Experiment Evaluation p99 latency.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;419c8a90-862b-4320-915b-bc744db38550&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fc19a4a6-e449-4348-8684-45c1f05ae69e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;After the initial release of this feature in H2 of 2023, we strategically targeted the rollout to the Go microservices contributing the most to experiment evaluations, resulting in over 100 services and nearly 70% of experiment traffic so far.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;53d578f9-0a25-4f26-98dd-dd857144bcfe&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;d816a793-d275-4ced-bb88-91480f12ef04&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcsRkV5JjP_DY03MxPQzoMgPiyfiQsl9eH5lIXsCiQi4GOsHBNlWIEgMH-4LpzKfna6910eoXhmpMFaxQ8W5gqB7adZxOsJGBHt8Ln3Pa2M9Kifn8Ro22mP_TfWBWGeEVoQaHER9b26AXSRR2o3Ob0zkWo?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 15: Local Experiment Evaluation adoption KPIs.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2894e647-1d06-42b4-8577-05756c90f12c&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4bc26680-a0f4-46a8-8b1f-1ebcac155072&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Additionally, we have been able to observe some noticeable improvements in user-facing functionality in Uber’s applications. For example, the end-to-end backend latency of the UberEats search suggestion indexing reduced by 20% (p99 latency went from 250 ms to 200 ms), which translated to an appreciable improvement in the mobile app experience.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9f89216c-cfb1-40b7-9a1e-fa7f471f3470&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;99d7f75a-094a-49ad-9267-f604b51f3640&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXer56jkW2Kdvch_24Hp6K4dmLJ73CxFiZJ2XI2VfjL6XB527vo57pVxm40r0i4sMEMNesH5jKscf-nxZy3XDMawB-bTM4dbHyvXTTOMMj_RlFOcjs2XHhuNt7qTXzhQwlO9GK-Tpg-LUglZ6KgpsEUTBGPj?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 16: Impact of Local Experiment Evaluation for UberEats store index service.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;dc9e1900-7d44-417b-abbc-451d9175de7c&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5373b880-fe5b-4cbd-bcab-b37016f5eb60&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-next-steps&#34;&gt;Next Steps&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c02969d9-5961-4721-b5a2-81d0053bb65d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This first iteration of Local Experiment Evaluation was for services using Golang, which serves the majority of our backend experimentation. The immediate next step is to also include Java, which is the other main backend service language that is supported at Uber.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0d0efe9b-3e73-412e-a887-909d71f478b5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Beyond this, there are plans and ongoing work to move the complexity from the clients to the server side. Complex clients are harder to rollout than server-side changes, and having complex clients in two or more languages adds duplication of effort and risks of divergence.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d4ab51b2-7942-42b9-8f4e-7a03f8ebe585&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;A more expressive language would allow us to move some of this complexity to the server. Instead of the clients parsing the experiment rules engines on the client using an ExperimentPlugin pattern for both Golang &amp;amp; Java, the system could parse this logic on the server, and output simpler programs in the more expressive client language to be executed by both Golang and Java clients. This would lead to thinner clients, and more server side control. The details of this will be the subject of future blog posts.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;40e3d864-d6f9-439b-9674-e426a5957e05&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;b27d423e-1886-4b9b-8f67-c6f16111d984&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1d2f57e6-05d6-4aaa-8aa0-5ba9bb87fde7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In summary, we replaced the RPC-based experimentation system with a new feature that evaluates the experiment rules engines locally by reading from file caches that are distributed to all host agents. Adding local evaluation for the experimentation stack helped improve the following:&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5f8d1b57-583d-42fd-9182-e7343956b8d4&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Latency:&lt;/strong&gt; Evaluation latency dropped by a factor of 100x (p99 10 ms to p99 100 µs), unlocking new integration opportunities&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Reliability:&lt;/strong&gt; We removed a single point of failure on a single high-traffic microservice, replacing it with a more reliable distributed configuration pipeline&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Developer Productivity: &lt;/strong&gt;Developers no longer need to worry about prefetching parameters in a batch request and caching them to avoid the RPC overhead, making code less complex&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;308d3a47-41fc-4d1c-a863-3b4567650527&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We learned many lessons from this initiative, which may be useful for others attempting to build an in-house Experimentation platform or make large scale updates to their existing platform:&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e9facbf2-f63d-4c3c-9712-ad717b80a989&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Start with Centralized&lt;/strong&gt; – Creating a new experimentation platform which returns evaluation results through RPC calls to a centralized microservice is advisable, especially during the initial period of rapid new feature development&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Decentralized when mature – &lt;/strong&gt;When the platform is mature, switching to a decentralized library architecture unlocks many benefits (as listed above)&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Safe development of libraries&lt;/strong&gt; – To make (decentralized) library development safer, utilizing concepts like lightweight feature flagging within the client library, having strong telemetry and alerting, and tracking library version usage across microservices is important&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Faster evaluations can mean faster log emission&lt;/strong&gt; – Making sure that the experimentation logging infrastructure can handle increased volume is critical when moving towards a client side, low latency evaluation architecture&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;62f1a658-4de0-451a-9c4c-50a74ed1ffb4&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7914a2a8-41f9-4444-a1f7-a7a8d10f02bf&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;Acknowledgments&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;07b5e14d-8520-40d7-a7ff-a10331d953c9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;This project would not have been possible without the contributions of numerous people on the Experimentation team, Flipr team, and pilot customer teams (Rider Experience, Ads Delivery Platform, and Earner Incentives) who helped us release Local Experiment Evaluation for Go services!&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;26f7463a-272c-45ad-9add-cbdaf679c43b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Apache®, Apache Kafka, Kafka, and the corresponding logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries. No endorsement by The Apache Software Foundation is implied by the use of these marks.&lt;br&gt;Cover image by Iffany via &lt;a href=&#34;https://pixabay.com/illustrations/alchemical-alchemy-magician-witch-8848871/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Pixabay&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a24c4410-ca5c-4518-acaa-63d94cad84c6&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;d64b6745-f796-4cb8-872e-6ae0157f15d7&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f3c10d4f-01d7-4aec-9f1f-7b770ab21fc8&#34;,&#34;dropCap&#34;:false}&#34;&gt;这篇博文描述了我们如何提高 Uber 实验平台的效率，将实验评估的延迟减少 100 倍（毫秒到微秒）。我们通过从远程评估架构（客户端到服务器 RPC 请求）转向本地评估架构（客户端计算）来实现这一目标。本博文中的一些术语（例如参数、实验等）引用自我们之前关于 Uber Experimentation 的博文。要了解更多信息，请查看&lt;a href=&#34;https://www.uber.com/blog/supercharging-a-b-testing-at-uber/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;增压 A/B在 Uber 进行测试&lt;/a&gt;。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ac4c1504-882c-4649-933c-fa6b5b8b1afc&#34;,&#34;dropCap&#34;:false}&#34;&gt;使用实验重点贯穿 Uber 的后端微服务、移动应用程序和 Web 界面，以衡量所有业务部门（交付、移动、货运、Uber For Business (U4B) 等）产品发布的改进。我们将介绍系统的当前和新架构：以及技术挑战和学习。这篇博文特别关注&lt;strong&gt;后端&lt;/strong&gt; Golang 微服务的延迟改进，而不是移动或基于网络的实验。我们还专注于 A/B 测试，而不是其他实验设计。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8db03731-b49f-4b16-b029-f3c0c476f829&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;50bc6c10-54b3-4842-8202-209b25f285cc&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-background&#34;&gt;​​背景&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a5e74f0b-28b2-41cf-bfc3-8d915ee23d65&#34;,&#34;dropCap&#34;:false}&#34;&gt;2020 年， Uber开始了重写A/B测试平台的漫长旅程（内部称为Project Citrus）。这个新系统的关键架构决策之一是统一 Uber 现有的后端配置平台，&lt;a href=&#34;https://www.uber.com/blog/flipr/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34; &gt;Flipr&lt;/a&gt;，带有实验平台。我们构建了实验作为 Flipr 配置（也称为参数）之上的临时覆盖层&lt;strong&gt; &lt;/strong&gt;，以便执行随机化、进行因果推理并帮助团队确定使用 fo 的最佳性能值r 他们的参数。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fc14f607-ac7b-4402-aaab-d17095a1697e&#34;,&#34;dropCap&#34;:false}&#34;&gt;下面是示例来说明参数和实验之间的差异。这里我们有一个&lt;strong&gt;参数&lt;/strong&gt;，它控制 Rider 应用程序中特定屏幕的按钮颜色。默认值为红色，但在某些情况下（例如，如果用户位于&lt;em&gt;city_id = 1&lt;/em&gt;），该城市的&lt;em&gt;所有用户&lt;/em&gt;的值将为蓝色。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b2b71d62-7a60-47d0-b089-cf5005aac389&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;7707510c-e913-4343-9940-4277b2619ab0&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcCn3OE-lw_syq4RP3ju2DpQ0D1xl16leZdP_eDI5i8anem_mVIFYBvXrlIXwFhe_3-0eUrXFomadWp52ObiNyxP9uzsx IDoFFz-z4Yn7xmlpVZ6YXqP5YQPCamrzUemoEyFfU13XDYaM3CFDtSgpCIsMab?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：参数表示。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;96551fce-9bac-46a9-a7f6-1a31edb0ca3b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e083eb58-1309-410f-a1e2-66e77997f412&#34;,&#34;dropCap&#34;:false}&#34;&gt;这些参数规则使用 Flipr 客户端评估引擎：&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;2c2f8923-a7ad-47b7-8f66-cb3d159a6e78&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcc7pse1Iyq0IKcOY4i8gl6_jnxlu6rD8oWL_i9wXvyYplJtZdR8whcpSTMiaOv-R5iGp_5cxF3olsqFcCKZ7YRaW qr0rMSef2R2WTq9NRWgl9fU-ukIR83Tl31VzwExH7x5SLe2NG2YkLXTa3ZYqWSrHQs?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy =&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：Flipr 客户端参数评估。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6ab1ea4c-fe8c-4749-8670-d82d3312f7c9&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b73e9c7​​2-55bd-4de3-b9bd-1bc5f54e2187&#34;,&#34;dropCap&#34;:false}&#34;&gt;调用&lt;strong&gt;get&lt;/strong&gt; 方法根据运行时参数传递返回不同的参数值d（例如，&lt;em&gt; city_id&lt;/em&gt;、&lt;em&gt;user_id&lt;/em&gt;、&lt;em&gt;app_version&lt;/em&gt; 等）。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;940a53cb-bbe3-459f-be5b-41a1fa8635c7&#34;,&#34;dropCap&#34;:false}&#34;&gt;一个 &lt;strong &gt;实验&lt;/strong&gt;允许我们随机化某些测量单位（例如用户、会话、设备或行程）的参数行为。当实验处于活动状态时，参数具有附加&lt;strong&gt;参数元数据&lt;/strong&gt;，记录将覆盖参数行为的关联实验。实验结束后，此元数据将被删除。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b49aafcb-1c4c-40ea-8930-4f58126234f1&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;ecc0933e-c3ca-4036-b013-db0cc0c0adaa&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXexjiP3-po3l3ihs_fQd3guWL5DTCZIvUQ772FVqMyctGFS63DhRvCHKsa42Y4IRoRFVvjrFSi-sBaj4WT8AzkaGF-WHVkbGI vETqmFw-cRmWFNcTyONLV1AdAYj6qRoS1h_7_zWrui0c12CCfToHX514IZ?key=MWSPikVkL_FOThWVVOyYBw&#34; 替代=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：参数元数据表示。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f1193605-535c-4c70-9563-e1aaf3f89757&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e8ca6b41-3c1c-464b-a349-899fb7e7fcd8&#34;,&#34;dropCap&#34;:false}&#34;&gt;在下面例如，&lt;em&gt;city_id = 1&lt;/em&gt; 中的 2 个不同用户可以根据他们在实验中所属的&lt;strong&gt;治疗组&lt;/strong&gt;获得按钮颜色的 2 个不同值（下面的 A/B 测试设置为 50% 治疗和 50% 对照，并按&lt;em&gt;user_id&lt;/em&gt;随机化）。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d15399a5-c8ee-4cac-8c9d-c99b9ab591b9&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;937986bc-64db-4d52-a6d7-32f9dd1d7f6a&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdHmTE23QiXnNEgxYPnx68cAEN8Hzl3NP88Fs8vJsUpajG6berW6mTMScplnEc7VPxfd0nAVIIoRHZxkW82a5vZTVbw1kVKlB tDRxy7P2meDrb1CfveKOv5rRbX8L7Ztq4HAoeXXCLkOoztJBNhDCC4ZxnL?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy=&#34;no- referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 4：实验和实验元数据表示。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;36504ba8-03a6-4c23-9c55-183d16794848&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;42fede90-4b58-403d-933b-b753ebc5d5e2&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong &gt;实验&lt;/strong&gt;和&lt;strong&gt;实验元数据&lt;/strong&gt;由 Flipr 客户端读取，受实验影响的任何参数的返回值将根据实验随机化而变化（例如，&lt;em&gt;user_id = 123&lt; /em&gt; 可能会变成蓝色，因为它们是控制组的一部分，而 &lt;em&gt;user_id = 456&lt;/em&gt; 会得到绿色值）：&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;52345ac8-1e9b-4d86-8478-06ee41a7948e&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;ce15ddb4-a0f2-4f3f-93ac-ef97e39d89fe&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcpoEA_nfVd7LsWMyhG3bziMUdl4ITrlKuwOtg9-K5aTcXjrE-0wFCBDJe2Z6vFrZ3P-6mZsucF4Q8WrR41jm2TY0y WAJqs6U1oKeAoe53vx9ve95P9WITM_EgX77UIxLXKyhCUNj_ZwgS9hhFDCeH5o18?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：使用实验覆盖进行 Flipr 客户端参数评估。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;dcadd599-ede1-4988-9f5e-43b259d9738c&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f969ee60-3503-4da6-afd6-e8542ee55b8a&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们记录让用户参与实验，以便我们能够衡量这些变化对关键业务成果（例如已完成的行程或总预订量）的影响。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d65583f0-bd34-4a63-a299-3e1fb6807568&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c48b0622-aecd-423c-be13-474c76ae16b6&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-problem-statement&#34;&gt;问题陈述&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6310153c-1cd3-47e0-9c90-7606539284fe&#34;,&#34;dropCap&#34;:false}&#34;&gt;从历史上看，所有实验评估是通过网络调用集中式微服务进行的，而 eval在本地没有进行主动实验的情况下对参数进行评估（称为“本地评估”）。作为 Citrus 项目的一部分，我们保留了一种模式，即所有后端微服务都向中央服务发出 RPC，以评估活动实验。这种方法使我们能够相对快速地发布新平台，并降低了客户采用新平台的迁移成本。我们的所有客户（后端系统、移动设备和 Web 服务）都通过对新评估服务（内部称为&lt;strong&gt;参数服务&lt;/strong&gt;）进行 RPC 调用来采用新平台。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0e39eb67-e7b6-4544-b5e6-cd0e09994579&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;040d5459-23bf-4773-9821-b0bedffb41ce&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfgi_tto5GyZSqw-RsesbyPBH2Z9YCFlvmsRI7ZSyHqC9NiZ8W_qgxgcktI7Hp4DxV2jk2pd6gREQLrlHYj-2XM13BoqE2i -eMYe-OoxJUgM3yQg5xz7cfZZehnyr2cu3NKQFZidRPn735nN9xvj0K0doo?key=MWSPikVkL_FOThWVVOyYBw&#34; alt =&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 6：参数服务架构（RPC 评估）。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;eb7ea424-ecc9-42fb-a03b-087856d826d8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;aabc8519-d3b2-450e-a7b7-ed893eff3615&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;br&gt;然而，这种模式也给实验的后端调用者留下了一些未解决的问题，我们希望作为实验平台重写的一部分来解决这些问题。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f6745bde-0355-48de-848c-1f9869dc7691&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;延迟&lt;/strong&gt;：基于 RPC 的评估相对较慢（p99 延迟约为 10 毫秒） ）。鉴于 Uber 市场的实时性，许多应用程序需要更快地评估其实验，以便加入新平台。&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;可靠性&lt;/strong&gt;：参数服务成为单点故障。为了减轻这种担忧，我们在参数服务的可靠性方面投入了大量资金，最终将每个端点的可用性 SLA 维持在 99.95%。我们还鼓励团队在 RPC 失败时依赖后备值。豪维r，考虑到系统的规模以及数百个团队和微服务在任何给定时间调用参数服务来评估数千个参数和实验的事实，无法保证每个回退的行为。有时，回退值会变得不安全，从而导致需要及时修复的中断。&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;开发人员生产力&lt;/strong&gt;：为了减少参数服务的请求数量，我们引入了预取机制。作为此机制的一部分，后端服务将向参数服务发送批量 RPC 请求，以评估并返回处理该特定请求的业务逻辑所需的&lt;strong&gt;所有&lt;/strong&gt;主动实验参数。从参数服务返回的实验值和暴露日志将存储在后端服务的本地内存缓存中。 &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;后端应用程序将&lt;strong&gt;获取&lt;/strong&gt;所需的每个单独参数的值准确地在需要时发出请求（受到实验的影响），此时我们将为进入实验的用户发出暴露日志。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a4427471-3ff1-4905-96a9-91dc1d65829d&#34;,&#34;dropCap&#34;:false}&#34;&gt;在此批处理时有助于减少 RPC 调用的总数，这也意味着后端开发人员在编写应用程序时需要了解预取机制。他们需要预先计划预取哪些参数，以便这些参数值稍后可用。如果不这样做，就会导致意外的错误，然后需要进行调试和修复，从而导致效率低下。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;015fdac7-4719-46b9-a1a3-2ea244c3b0a0&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;d887cb33-7e66-4dd0-a4b3-ac2d087b1233&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfDVtfii-J4qcPg2YJtWSkXfvWDWv-KTwuM72AULRUI3zxzma2dj2vPfvaMSzugIOKLQsoKsg5TQLmva-uAEPUDcTuwJ2bDjZ RCviyCOlFY58-llmflatbDIxCJ0heqp3C5C3UqF7X7zttrx8fl-G0q1HA?key=MWSPikVkL_FOThWVVOyYBw &#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 7：初始架构：预取参数机制。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7b0ea81f-c7eb-45ff-9531-316815e29e09&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha 通道不透明度&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5033feb0-daf7-44d6-a24f-5e4fb50e46ce&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们相信所有这些问题都可以通过一种新的架构来解决，该架构涉及客户端对实验（和参数）进行评估，而无需向参数服务发出任何 RPC 请求。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;934b57ef-115b-4707-be3e-e2665432395b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;445e90ae-10ba-4ffa-9353-5dba81b4f6a6&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architecture&#34;&gt;架构&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;55e76b60-4589-41d2-becd-ed057a9a1bb1&#34;,&#34;dropCap&#34;:false}&#34;&gt;Uber 的现有架构涉及一种分配机制，其中 Flipr 参数被发送到 Uber 的所有主机代理 (&lt;a href=&#34;https://www.uber.com/blog/how-we-unified-configuration-distribution-across-systems-at-uber /&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;有关更多详细信息，请参阅之前的英语博客&lt;/a&gt;）。在此类主机上运行的每个微服务都将依赖 Flipr 客户端通过读取文件缓存来定期引导这些参数规则引擎，从而获得比在线 RPC 架构更高的可用性。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2f5c86e6-e578-4ab8-a75e-dae062dcdb43&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;b088ac78-b735-4c9d-88d2-e3ff47ecc8fd&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd3OYBBowDH_C3r1DhN2tu-fEtjHEzLZv_vRtEsIBtk6G0NUszEUquFnpCt5gtTVc4dK1JB_qVY4cKJ7F8LzP-wR ac-Hsq-EsKBANHoSrqECWjOuwotA77-5jTT0R7GJo46YKflS3j-dFkmh2mHQ6AZgG4z?key =MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 8：参数主机代理分布。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d1f41a6a-5b70-44d2-b665-a0ca62124f06&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4a048935-c4fa-4b94-96b6-eac2134b2e36&#34;,&#34;dropCap&#34;:false}&#34;&gt;其中之一新架构的主要变化是使用与常规 Flipr 参数相同的分发层将实验分发到所有主机代理。分布层的这一变化将解锁每个微服务能够在本地读取实验数据，而无需任何 RPC 到参数服务。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;63099f92-3738-4998-9b54-fcbe2db2f94e&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;7ee272d4-aa04-46ff-9b6c-45e6ecf33fff&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcKDN5DxoAaBdHAZTOrJUzsoefqhlUErYvD0g7UAyln6llauKDecQnwhH7ul3yoseZyAFP4Ds7CdbQsh-b8ja6QbUmzbMjRvcd EWJoqh3wtL-AK389xl8ey4M6CeYmShCFTQkLWx-zt0s62OHHxoSpBBbc?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 9：实验主机代理分布。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6b0ffc43-1496-4c55-b262-d5f1f46ac85d&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;adfabe5c-dde3-4abd-82c3-c2dd8a677fee&#34;,&#34;dropCap&#34;:false}&#34;&gt;下一步对我们来说，是将参数服务的所有实验特定业务逻辑移植到 &lt;strong&gt;ExperimentPlugin&lt;/strong&gt; 中，&lt;strong&gt; &lt;/strong&gt;它将直接嵌入 Flipr 客户端中。我们打算在向外部微服务公开本地实验评估这一新功能之前，直接在参数服务中试用这一新功能。成为本地实验评估的首批用户的好处是可以进行&lt;strong&gt;严格的影子测试&lt;/strong&gt;，以确保正确性和性能平等。&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f04d2aa4-af87-446b-9270-ee28e8debd82&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;9f4bd2fa-4ae3-406c-98e3-8de044fe66cf&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfX4ur07iZOXrXm_yBZqMT96lUUkK6UtKEDPoysWcVop9gUKKnTb9wNvXHHgEq4TzyoanjOlN-C2qw89l36IkzO IaTRyPlWOqivL6bVigFeR7pCyZ6sXRm8a7zvoIRM9pxVEVCEo_oqtcf3uXBIgxwklble?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy=&#34; no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 10：中间架构：参数服务中的影子评估。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f6c86324-e4e6-4da9-bf01-fa62d9a5907b&#34;,&#34;opacity&#34;:&#34;alphaa-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9aa41247-e80c-4554-8e8d-8aedda0f1439&#34;,&#34;dropCap&#34;:false}&#34;&gt;彻底之后通过影子测试过程，我们发现并解决了 13 个单独的错误，此旅程的最后一步是允许团队直接选择使用本地实验评估功能，并完全删除对 PrefetchParameters API 的使用。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3c32247a-108e-4d0f-ad93-71e4adcb0330&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;6437ed43-38f5-4090-be47-ed6975e71eb7&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdOxStMOvaEm58g-JwGuIeMTKJ7qgzjAgDFm3BXhDz8eA0-aaV59TajP0JzHWu4-tuvrwuWukh76OXkZ-VBCI4-pIr6 -p5wN1YkhWrG3M1owopRG0jgiGVhaIC_XFJovE5g-Zn0Y1 -B1_bQs60EmLImumzT?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 11：最终架构：在后端微服务中直接使用本地实验评估。&lt;/figcaption &gt;&lt;/图&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b92ed6f5-7e4d-442e-bc53-a1087605e9d3&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ac67e08a-3e62-4ee2-a97c-72c18708e894&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-challenges-amp-learnings&#34;&gt;挑战与学习&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;1b107d54-09cb-488a-b808-2871f6e8a911&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-1-verification-at-scale&#34;&gt;1) 大规模验证&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;dad739ab-b35a-4899-b3fc-3fe873f1e031&#34;,&#34;dropCap&#34;:false}&#34;&gt;其中之一构建这一新的本地评估功能的主要挑战是确保其在规模上正确运行。为了做到这一点，我们实现了影子测试功能，以确保进入 V1 遗留评估代码路径的请求采样也会触发一个单独的异步 goroutine 来评估结果并将其与 V2 本地实验评估代码路径进行比较。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0abdd297-983f-4ac0-99e6-9dd68729bfcd&#34;,&#34;dropCap&#34;:false}&#34;&gt;规模此类评估数量巨大（每秒大约 2000 万次评估）并且需要大量采样以防止执行这些比较时参数服务的任何降级。此外，后端、移动设备和网络界面的评估类型差异很大。出于这个原因，我们发现有必要证明我们遇到的每一个不匹配都是可以解释的。最终我们实现了 &gt;99.999% 的匹配率（平均 100,000 次评估中有 1 个可解释的差异）。&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;506c3496-912b-4c65-99e2-1a791658c7bc&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;f0932322-4158-4a84-a4b5-79d79a887fbc&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfkDB3JeA0i5JY19L-Cw7R0uM4WGps4Kd8N6MUC1FkhCWPDOcYZyILjrFgviTGd8a8h6ZakoGVNup_x6zXt98AM7NWLB cHakzuxk2DbvUhmi-kZm_sNiYS9sTi6qNuQBbkz-ZtEDKCP_07nxp5gfnfTtiY?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34; &#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 12：影子评估匹配率。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;34acc681-281b-4bff-a037-e658f65264c7&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;63e623d2-a89a-4d65-9813-028a25e7444d&#34;,&#34;dropCap&#34;:false}&#34;&gt;一些此过程的主要经验包括：&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b9a6d2df-c22c-4063-9fc5-2f86b4606e00&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;参数或实验更新期间的已知差异&lt;/strong&gt; – 每当用户更新值或规则时对于参数或实验的引擎，这可以预见地会导致竞争条件。 V1 评估方法可能使用参数或实验的版本 X，而使用 V2 方法的影子比较可以根据 Flipr 分布的时间使用版本 X+1。这成为系统中可接受的差异的&lt;em&gt;唯一&lt;/em&gt;来源。&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;旧方法中的错误&lt;/strong&gt; – 尽管与旧系统 100% 相同为了实现目标，有时我们决定“向前修复”并解决遗留系统而不是新系统中的小错误和边缘情况。事实证明，这是这次迁移的一个主要好处：除了提供新功能之外，我们还能够修复旧系统中难以检测的边缘情况。&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;竞争条件和超时&lt;/strong&gt; – 与参数或实验更新期间的“已知差异”问题类似，我们意识到一些微妙的竞争条件可能会影响我们的影子评估匹配率。一个例子是设置影子评估有足够的超时时间——它应该模仿为原始评估提供的相同上下文截止日期，以便进行同类比较，不仅是为了逻辑正确性，而且是为了性能。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f33fe512-c94d-4246-9029-230911eb591b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;c9ffdcb3-3f47-43ee-afe0-1f9ef83790c5&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-2-logging-volume-concerns&#34;&gt;2) 日志量问题&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b478fb6d-949a-4af6-a4c7-1a7b6e5ddff7&#34;,&#34;dropCap&#34;:false}&#34;&gt;显着改进评估速度给实验日志生产和处理带来了风险。评估正在试验的参数可能会生成 Apache Kafka® 的暴露日志。如果参数的评估速度可以加快 100 倍，这意味着日志的生成速度也可能加快 100 倍，并且存在可能压垮生成、分发和处理日志的基础设施的风险。特别是，我们担心由于达到 Kafka 主题的速率限制（字节率或消息速率吞吐量限制）而导致实验日志丢失。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7870c783-6532-4bc4-a380-2d60402a7fc6&#34;,&#34;dropCap&#34;:false}&#34;&gt;一种常见实验可以批量处理大量用户的用例是为涉及数亿用户的电子邮件活动制作营销文案。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;da4724f7-a7ab-4235-ab53-2152cb58de80&#34;,&#34;dropCap&#34;:false}&#34;&gt;缓解这种情况风险我们做了以下操作：&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;373275bf-50a4-4d3c-9445-e57403f31b6d&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;日志量生产的遥测和警报&lt;/strong&gt; – 首先，我们添加了遥测了解每个客户端每秒生成多少实验日志，如果其中任何一个客户端生成的日志数量超过 Kafka 主题总配额的 5%，则会向我们的待命团队发出警报。这使我们能够识别热点并构建解决方案来解决这些问题。&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;内存中 LRU 缓存&lt;/strong&gt; – 因为我们的实验日志处理管道只关心每个用户第一次进入实验的时间，所以我们能够对大量日志进行重复数据删除。我们决定使用高性能内存中 LRU 缓存 (&lt;a href=&#34;https://github.com/hashicorp/golang-lru&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;golang-lru&lt;/a &gt;) 减少冗余日志，最终能够删除大约 80% 的日志。&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Flipr 客户端库中的参数&lt;/strong&gt; – 能够添加“内部” Flipr 客户端库和 ExperimentPlugin 中使用的参数对于安全开发功能至关重要。为了避免循环依赖，我们有一个单独的机制来在文件缓存引导时加载这些“内部参数”，而不是提供运行时上下文来评估它们。在紧急情况下，我们能够使用这些内部 Flipr 客户端参数完全禁用本地评估，而无需重新部署服务。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e084632c-ca52-43ea-914c-66c1a2493fc6&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;02c9d2f9-6517-4642-a059-f05afd2b2181&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-3-decentralized-evaluation&#34;&gt;3) 去中心化评估&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b1178d8b-d999-41c2-a54d-7de90f53aafe&#34;,&#34;dropCap&#34;:false}&#34;&gt;最后，我们必须面对的新挑战是，实验评估现在作为客户端库的一部分进行分散，而不是单个集中式微服务。基于 RPC 的评估的主要好处之一（尤其是在 Citrus 项目的初始开发阶段）是，核心评估逻辑的任何问题都可以通过重新部署单个微服务轻松恢复。我们鼓励其他人仅在平台处于成熟状态时才进行客户端评估，因为恢复涉及不同版本的客户端库的多个单独的微服务是一项成本更高且耗时的工作。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;361e81b7-1e5d-4889-ac06-591bc50b23e0&#34;,&#34;dropCap&#34;:false}&#34;&gt;一些帮助我们实现这一范式转变的工具包括：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;77b1cb48-f40a-4734-b173-5aeb8dc4ad6e&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;客户端库版本跟踪&lt;/strong&gt; – 即使我们的后端微服务定期部署节奏，情况并非总是如此Uber 的每一个微服务都与最新的客户端代码更改保持同步。客户端版本跟踪遥测使我们能够更轻松地识别使用过时或有错误的 SDK 版本的服务。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5667ba11-eee9-4e70-b2ec-45290073c058&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;b99a72dd-8035-4e21-9267-2fcafd0bd339&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXfVlJBJwZVPpoGcaCKELgO40jDpe5EWiteqtyxeHsQsmGWqtpA7bloW2FS15rf9RxXqzKIodyysvMEJywcO0p0G3QfN3am2f E5Sf0ZNGKRMn_pQotJHekJ-hdAFHfdNzsHHyDxRmBRL0kk-6UZPqkyoBZyT?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy =&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 13：客户端库版本采用曲线&lt;br&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;948edbc4-172e-4787-93d8-95510b8b870c&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;000f094a-7e5c-4109-8ca2-9a2e1499f495&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;批量部署基础架构&lt;/strong&gt; – &lt;a href=&#34;https://www. uber.com/blog/up-portable-microservices-ready-for-the-cloud/?uclick_id=b017bf4f-abd9-415e-aee6-3540742d49ad&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;向上&lt;/a&gt;是 Uber 的平台，用于管理数百万个主机实例上数千个微服务的编排和代码部署。我们能够在最坏的情况下（例如，发布了损坏的客户端版本）添加批量部署服务的功能。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fb45ec4e-a63c-4002-8b8e-b561b81e73eb&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;517dda9d-6a81-432e-92d6-47c286375bef&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-impact&#34;&gt;影响&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ebe4e725-1949-4d2e-94b3-0423cf766e8d&#34;,&#34;dropCap&#34;:false}&#34;&gt;最终，事实证明，新架构在 Uber 的许多用例中取得了成功。实验评估的 p99 延迟下降了 100 倍（从 10 ms 降至 100 µs）。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2e81cbce-46ea-4370-9a75-0f094a8274ed&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;413b8262-4b07-49d8-a66b-42309ff8ba66&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXffLKFTT_m6BdKUfilQq3txDxRV1j5GdeC8BVg6xgwvGvKu8UYjjksYNr2aeW2zZNdKtaDC-ZPt_FHMre0VApVA-oVGIaX 29mTmtOyeeIOa07pRjcOouC9ufQP8qxPJigzeBJHvySR3RLjB1rhVOKL6cA4?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy =&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 14：实验评估 p99 延迟。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;419c8a90-862b-4320-915b-bc744db38550&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fc19a4a6-e449-4348-8684-45c1f05ae69e&#34;,&#34;dropCap&#34;:false}&#34;&gt;初始之后在 2023 年下半年发布此功能后，我们战略性地将部署目标锁定在对实验评估贡献最大的 Go 微服务上，迄今为止已实现了 100 多个服务和近 70% 的实验流量。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;53d578f9-0a25-4f26-98dd-dd857144bcfe&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;d816a793-d275-4ced-bb88-91480f12ef04&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcsRkV5JjP_DY03MxPQzoMgPiyfiQsl9eH5lIXsCiQi4GOsHBNlWIEgMH-4LpzKfna6910eoXhmpMFaxQ8W5gqB7adZxOsJ GBHt8Ln3Pa2M9Kifn8Ro22mP_TfWBWGeEVoQaHER9b26AXSRR2o3Ob0zkWo?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy=&#34; no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 15：本地实验评估采用 KPI。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2894e647-1d06-42b4-8577-05756c90f12c&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4bc26680-a0f4-46a8-8b1f-1ebcac155072&#34;,&#34;dropCap&#34;:false}&#34;&gt;此外，我们我们已经能够观察到 Uber 应用程序中面向用户的功能有一些显着的改进。例如，UberEats 搜索建议索引的端到端后端延迟减少了 20%（p99 延迟从 250 毫秒减少到 200 毫秒），这转化为移动应用程序体验的显着改善。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;小时数据-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9f89216c-cfb1-40b7-9a1e-fa7f471f3470&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp -块分隔符具有 alpha 通道不透明度&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;99d7f75a-094a-49ad-9267-f604b51f3640&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src =“https://lh7-rt.googleusercontent.com/docsz/AD_4nXer56jkW2Kdvch_24Hp6K4dmLJ73CxFiZJ2XI2VfjL6XB527vo57pVxm40r0i4sME MNesH5jKscf-nxZy3XDMawB-bTM4dbHyvXTTOMMj_RlFOcjs2XHhuNt7qTXzhQwlO9GK-Tpg-LUglZ6KgpsEUTBGPj?key=MWSPikVkL_FOThWVVOyYBw&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 16：UberEats 商店索引服务本地实验评估的影响。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;dc9e1900-7d44-417b-abbc-451d9175de7c&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5373b880-fe5b-4cbd-bcab-b37016f5eb60&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-next-steps&#34;&gt;后续步骤&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c02969d9-5961-4721-b5a2-81d0053bb65d&#34;,&#34;dropCap&#34;:false}&#34;&gt;这第一次迭代本地实验评估是针对使用 Golang 的服务，它服务于我们的大部分后端实验。下一步计划还包括 Java，这是 Uber 支持的另一种主要后端服务语言。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0d0efe9b-3e73-412e-a887-909d71f478b5&#34;,&#34;dropCap&#34;:false}&#34;&gt;除此之外，有计划和正在进行的工作将复杂性从客户端转移到服务器端。复杂的客户端比服务器端的更改更难部署，并且使用两种或多种语言的复杂客户端会增加重复工作和出现分歧的风险。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d4ab51b2-7942-42b9-8f4e-7a03f8ebe585&#34;,&#34;dropCap&#34;:false}&#34;&gt;更具表现力语言将使我们能够将部分复杂性转移到服务器上。系统可以在服务器上解析此逻辑，并以更具表现力的客户端语言输出更简单的程序，以供 Golang 和 Java 执行，而不是客户端使用 Golang 和 Java 的 ExperimentPlugin 模式来解析客户端上的实验规则引擎。客户。这将导致更精简的客户端和更多的服务器端控制。详细信息将成为未来博客文章的主题。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;40e3d864-d6f9-439b-9674-e426a5957e05&#34;,&#34;不透明度&#34;:&#34;alpha-channel&#34;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;b27d423e-1886-4b9b-8f67-c6f16111d984&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1d2f57e6-05d6-4aaa-8aa0-5ba9bb87fde7&#34;,&#34;dropCap&#34;:false}&#34;&gt;总而言之，我们用一项新功能替换了基于 RPC 的实验系统，该功能通过读取分发到所有主机代理的文件缓存来在本地评估实验规则引擎。为实验堆栈添加本地评估有助于改进以下方面：&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5f8d1b57-583d-42fd-9182-e7343956b8d4&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;延迟：&lt;/strong&gt;评估延迟下降了 100 倍（p99 10 毫秒到p99 100 µs)，释放新的集成机会&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;可靠性&lt;/strong&gt;：我们消除了单个高流量上的单点故障微服务，用更可靠的分布式配置管道取代它&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;开发人员生产力&lt;/strong&gt;开发人员不再需要担心批量预取参数的问题请求并缓存它们以避免 RPC 开销，从而降低代码的复杂性&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;308d3a47-41fc-4d1c-a863-3b4567650527&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们学到了很多该计划的经验教训，对于其他尝试构建内部实验平台或对其现有平台进行大规模更新的人来说可能有用：&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e9facbf2-f63d-4c3c-9712-ad717b80a989&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;从集中化开始&lt;/strong&gt; – 创建一个新的实验平台，通过 RPC 返回评估结果建议调用集中式微服务，尤其是在快速新功能开发的初期&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;成熟时去中心化 - &lt;/strong&gt;当平台成熟时，切换到去中心化库架构带来了许多好处（如上所述）&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;库的安全开发&lt;/strong&gt; – 为了使（去中心化）库开发更安全，利用cli 中的轻量级功能标记等概念ent 库，具有强大的遥测和警报功能，并跟踪跨微服务的库版本使用情况非常重要&lt;br&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;更快的评估意味着更快的日志发送&lt;/strong&gt; – 确保实验日志基础设施在转向客户端、低延迟评估架构时，能够处理增加的容量至关重要&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;62f1a658-4de0-451a-9c4c-50a74ed1ffb4&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7914a2a8-41f9-4444-a1f7-a7a8d10f02bf&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-acknowledgments&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;07b5e14d-8520-40d7-a7ff-a10331d953c9&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;如果没有实验团队、Flipr 团队和试点客户团队（乘客体验、广告投放平台和Earner Incentives）帮助我们发布了 Go 服务的本地实验评估！&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;26f7463a-272c-45ad-9add-cbdaf679c43b&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;Apache®、Apache Kafka、Kafka 和相应的徽标是 Apache Software Foundation 在美国和/或其他国家/地区的注册商标或商标。使用这些标记并不暗示 Apache 软件基金会的认可。&lt;br&gt;封面图片由 Iffany 通过 &lt;a href=&#34;https://pixabay.com/illustrations/alchemical-alchemy-magician-witch-8848871/&#34; 提供target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Pixabay&lt;/a&gt;。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a24c4410-ca5c-4518-acaa-63d94cad84c6&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;</description>
      <pubDate>Thu, 03 Oct 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【Genie: Uber’s Gen AI On-Call Copilot】Genie：Uber 的 Gen AI On-Call 副驾驶</title>
      <link>https://www.uber.com/blog/genie-ubers-gen-ai-on-call-copilot/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;e7b16816-7feb-4864-8765-c97c5e712233&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;83ceaad1-2639-48b3-a7fe-b65336676e02&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In today’s fast-paced tech environment, maintaining robust on-call operations is crucial for ensuring seamless service functioning. Modern platform engineering teams face the challenge of efficiently managing on-call schedules, incident response, communication during critical moments, and strong customer support on Slack&lt;sup&gt;®&lt;/sup&gt; channels.&lt;br&gt;&lt;br&gt;This post describes Genie, an on-call copilot we built that uses generative AI to optimize communication and question-answering with on-call engineers.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;44f18be0-34d4-4eea-b7dc-a66f7c356686&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4d9ace85-d435-4f79-bc16-ca7545517062&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-a-closer-look-problem-and-motivation&#34;&gt;A Closer Look: Problem and Motivation&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e42ca7aa-2298-49d4-bb40-466989b1deb0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;At Uber, different teams like the Michelangelo team have Slack support channels where their internal users can ask for help. People ask around 45,000 questions on these channels each month, as shown in Figure 1. High question volumes and long response wait times reduce productivity for users and on-call engineers.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097494,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;139eb3c9-7dca-4316-842f-78d479d072dc&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-full&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;636&#34; height=&#34;233&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure1-17285117876372.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097494&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=636,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure1-17285117876372.png 636w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure1-17285117876372.png 300w&#34; sizes=&#34;(max-width: 636px) 100vw, 636px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: The high number of questions asked across Slack channels at Uber over 5 months.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6f3202a6-b275-41b8-afd6-a034baa192bd&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;392586df-9bd9-4f14-9628-730f13b3e53f&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-cumbersome-process&#34;&gt;&lt;br&gt;Cumbersome Process&lt;/h3&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097496,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;6e32b91d-85cf-49bf-8b23-04b1a787fca6&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-full&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;864&#34; height=&#34;281&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097496&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=864,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png 864w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png 768w&#34; sizes=&#34;(max-width: 864px) 100vw, 864px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: The slow process of waiting for an on-call engineer to answer a question.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;52bc6081-d1db-42d1-bb04-bcb7387358df&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;br&gt;Typically, when users ask a question in a Slack channel, they have to wait for the on-call engineer to respond. The on-call engineer either answers the user’s initial question or asks for more details. Users might then ask follow-up questions, seek more clarification, or provide extra information. This leads to another wait for a response from the on-call engineer. After several rounds of back-and-forth communication, the user’s question eventually gets resolved.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;53b2c110-525b-4ae2-bffd-f2b6d5be6e8a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e2b1d2ee-bf35-4150-b995-3e291c9948a7&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-hard-to-find-information&#34;&gt;Hard to Find Information&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;555a7e9d-308d-498a-9d0c-d3d06c52b16a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Many questions could‌ get answered by referring to existing documentation, but the information is fragmented across Uber’s internal wiki called Engwiki, internal Stack Overflow, and other locations, making it challenging to find specific answers. As a result, users often ask the same questions repeatedly, leading to a high demand for on-call support across hundreds of Slack channels.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;523bac00-5e5d-419b-a101-3509db9a4c45&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c65afede-93c3-465d-8b31-e8add6c3edb8&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architectural-challenges&#34;&gt;Architectural Challenges&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fdeaec3c-30d5-4218-af3b-8ca8990f0898&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For building an on-call copilot, we chose between fine-tuning an LLM model or leveraging &lt;a href=&#34;https://www.anyscale.com/blog/a-comprehensive-guide-for-building-rag-based-llm-applications-part-1&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Retrieval-Augmented Generation (RAG)&lt;/a&gt;. Fine-tuning requires curated data with high-quality, diverse examples for the LLM to learn from. It also requires compute resources to keep the model updated with new examples.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;744ef140-d7d0-4aea-8221-b3b3ea0f9688&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In contrast, RAG doesn’t require any diverse examples to begin with. This reduced the time to market for the copilot launch, so we chose this approach for our copilot.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;99175e3c-e91c-45cc-aa82-2be9b7386c35&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Building an on-call copilot presented several challenges, including addressing hallucination, protecting data sources, and improving the user experience. Here’s an overview of how we solved each challenge.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e9110a7c-4bf5-454c-bb29-41de6910fdff&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For hallucination, we focused on:&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;eedf199c-34fc-47a2-8b5c-1af71d316e77&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Accuracy of responses&lt;/strong&gt;: We ensure that the copilot retrieves relevant knowledge for the question, which prevents the LLM engine from generating incorrect or misleading information&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Verification mechanisms&lt;/strong&gt;: We implement methods to verify the copilot’s responses against authoritative sources to reduce the likelihood of hallucination&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Continuous learning&lt;/strong&gt;: We ensure that the copilot has access to the most updated data to enhance its accuracy&lt;br&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;079a03e0-3175-42d9-a799-f2db1cbd69f4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For data security, we chose the data sources to ingest carefully, as many data sources can’t be exposed in Slack channels.&lt;br&gt;&lt;br&gt;To improve the user experience, we designed:&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9b32f175-7af2-4cb8-a3fd-e478d6c979b6&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Intuitive interface&lt;/strong&gt;: We designed an easy-to-use interface that allows users to interact with the copilot efficiently&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Feedback loop&lt;/strong&gt;: We created a system for users to provide feedback on responses to continually refine the copilot’s performance&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;544fa9a3-d103-49f1-bd3f-0ea3e60a5fe7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We addressed these challenges when developing our on-call copilot to ensure that it’s reliable, user-friendly, and secure.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8595d9fd-d250-4111-a0ae-c65a880b660f&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;775af645-d734-43db-8617-596ded3f17e1&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-deep-dive-architecture&#34;&gt;Deep Dive: Architecture&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e3acd865-7c12-403d-a1dd-c12e0cfd66a5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Let’s explore the architecture of our on-call copilot, called Genie.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097498,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;b1baea01-32a1-4ee9-ac99-52df5911b2a8&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;443&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072-1024x443.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097498&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2000,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 2000w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: Architecture of the on-call copilot.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;18321915-dd26-4e3e-9ea7-3905b8a51726&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;418a7ac1-114d-4079-bebe-6277461f0ad5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;At a high level, we scrape internal data sources like Uber’s internal wiki, Uber’s internal Stack Overflow, engineering requirement documents, and create vectors from these data sources using an Open AI embedding model. Those embeddings get stored in a vector database. Then, when a user posts a question in a Slack channel, the question gets translated to embeddings. The service searches for relevant embeddings related to the question in a vector database. The results indexed by embeddings get used as prompts to the LLM to get back a response.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bbbba4d6-3bfb-47db-8917-95748eba02b5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The following steps for data prep, embeddings, and pushing the artifacts for serving can be generalized as a RAG application using Apache Spark&lt;sup&gt;™&lt;/sup&gt;. These general steps form the basis of a RAG application.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;94026da2-9931-4e3e-852b-dcd6665156ea&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7ccaf504-43aa-4a72-a0d6-96471408651e&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-etl&#34;&gt;ETL&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097500,&amp;quot;width&amp;quot;:&amp;quot;521px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;aspectRatio&amp;quot;:&amp;quot;4\/3&amp;quot;,&amp;quot;scale&amp;quot;:&amp;quot;cover&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;c2dadb8f-040e-4a17-afd8-3cf88890e063&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;816&#34; height=&#34;1024&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035-816x1024.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097500&#34; style=&#34;aspect-ratio:4/3;object-fit:cover;width:521px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=816,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 816w, https://blog.uber-cdn.com/cdn-cgi/image/width=239,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 239w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=940,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 940w&#34; sizes=&#34;(max-width: 816px) 100vw, 816px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: Spark application for data ingest.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a3677069-38fe-4d57-9b36-6ee85aeb3ea8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;78d8d942-525e-4c13-ab8d-79d3d980353d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 4 shows a custom Spark application that contains the steps for ingesting data to a vector database. A Spark application runs those steps using Spark executors.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;2e768fa5-c1b6-4c6a-ba46-d642732c1be9&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-data-prep&#34;&gt;&lt;br&gt;Data Prep&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a5923920-e1e5-4281-8a97-4821b2ae661f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;A Spark app fetches content from the respective data source using Uber’s internal wiki, called Engwiki, or Uber Stack Overflow APIs. A Spark dataframe gets outputted from this data prep stage. The schema has the Engwiki link in a column and the content of the Engwiki in a separate column, both in string format.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097502,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;abbd21e9-5275-4ac1-8273-11af89807749&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;220&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure5-17285119354055-1024x220.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097502&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure5-17285119354055.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure5-17285119354055.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure5-17285119354055.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1284,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure5-17285119354055.png 1284w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: Columns of the Spark dataframe from the Engwiki datasource.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d307d345-ce2b-4274-af28-d2713e6f8005&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a0213e51-4c9b-4bea-9c22-fde19d3849ff&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 5 shows the columns of the Spark dataframe with Uber’s internal wiki as the original data source. It has the source URL, content, and other columns storing metadata.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;900833c0-b219-4f9b-bf03-a6c037e70413&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-embedding-generation&#34;&gt;&lt;br&gt;Embedding Generation&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fa364112-7193-470a-ae5d-1120d6bd5e94&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Once the data is scraped, embeddings get created using the OpenAI embedding model and pushed to Terrablob, Uber’s blob storage. The embeddings created are only accessible through a particular Slack channel related to the Engwiki space. The output format is a dataframe with a schema of chunked content mapped to the corresponding vector of that chunk. Uber’s internal wiki content is chunked using langchain and embeddings are generated through OpenAI with PySpark UDFs.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;95723f82-760a-4697-ac97-71700d164769&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXf4DX2PBW9iHR6npUbfBZlpuNq7pEZ9stydlXT94UlJNgeLsPs3n6gwe1rcsSDFCWKDKYiQ9JS1NNt6wPCkjbmB3K4NrFXd5Ql16Y8Fmdf3OkPwPcl7yppTkl7DznlJnWAbxu6bswf3dhwIukjV--SLHag?key=Cul8rOkHqArI5wi0MdurWQ&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 6: Columns of the Spark dataframe with vector embeddings.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;df3248a1-b648-4a1e-8d38-14ddc846a9a5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d26434ed-fb67-4781-969b-18478fa7b608&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 6 shows the columns of the Spark dataframe with Uber’s internal wiki as the original data source. It has the source URL, content, chunked content, and embeddings for that particular chunk.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a42e77cd-a2e6-490f-b6f1-500a195f2d66&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8422f718-6035-4458-b9d6-d150217f2714&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-pusher&#34;&gt;Pusher&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097505,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;15bc5c0c-6300-4e90-9ff1-4000afc37ea7&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;456&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure7-17285121216461-1024x456.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097505&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1399,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 1399w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 7: Flow of vectors getting pushed to Terrablob.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;925589cc-cfb6-42c4-85ae-50b997c1f75b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;96764c30-7e39-416f-8a35-8b6bfd29b4a9&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 7 shows how vectors are pushed to Terrablob. A bootstrap job is triggered to ingest data from a data source to Sia, Uber’s in-house vector database solution. Then, two Spark jobs are triggered for the index build and merge and ingest data to Terrablob. Every leaf syncs and downloads a base index and snapshot stored in Terrablob. During retrieval, a query is directly sent to each leaf.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c83baa9b-0da1-4226-8912-f3918309b9e0&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e55d7c63-e2d6-4f4d-90d8-4db67d0d800e&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-knowledge-service&#34;&gt;Knowledge Service&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097508,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;d1952dd4-d236-42e5-a1f1-49eda9714865&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;533&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure8-17285122683730-1024x533.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097508&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1819,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 1819w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 8: Flow of the back-end Knowledge Service.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d51d2f61-620b-497b-90b3-33159c9b573f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1aa84d55-9c15-4da0-9464-3f72e7a637a2&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Genie has a back-end service called Knowledge Service, which serves incoming requests for all incoming queries by first converting the incoming query into an embedding and then fetching the most relevant chunks from the vector database.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;00b12d8a-403b-41d0-ad77-0eb9d5db4039&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bfd1c1c7-ff26-495a-aab2-a536972d1288&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-cost-tracking&#34;&gt;Cost Tracking&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097510,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;f3d3a3dd-1430-4e46-9139-6906e12b17b6&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;466&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595-1024x466.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097510&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1538,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 1538w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 9: Flow of Genie cost tracking.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ff527243-716c-489e-b627-22d696350692&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1fc50b8e-0cdf-4138-a8e2-314b72818355&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For cost tracking, when the Slack client or other platforms call Knowledge Service, a UUID gets passed to Knowledge Service, which in turn passes the UUID through the context header to Michelangelo Gateway. Michelangelo Gateway is a pass-through service to the LLM so that it can be added to an audit log used to track costs by that UUID.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;43875a90-77f2-4acc-ac34-df25281d3e51&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8fa72504-db7a-4ece-80ef-7e3714b0189a&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-genie-performance-evaluation&#34;&gt;Genie Performance Evaluation&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;a453e184-134d-423e-987f-5c2c51383195&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-metrics-framework&#34;&gt;Metrics Framework&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1515629e-7d00-4f78-936c-9553ed1f6cbe&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Users can provide feedback right away in Slack by clicking the relevant button in the Genie’s reply. We give users the option to choose from:&amp;nbsp;&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;32dde48a-387a-4bae-a2b3-9d0525d3826c&amp;quot;,&amp;quot;ordered&amp;quot;:false,&amp;quot;values&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Resolved&lt;/strong&gt;: the answer completely resolved the issue&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Helpfu&lt;/strong&gt;l: the answer partially helped, but the user needs more help&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Not Helpful&lt;/strong&gt;: the response is wrong or not relevant&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;Not Relevant&lt;/strong&gt;: the user needs help from someone on call and Genie can’t assist (like for a code review)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097512,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;03c44d96-15a9-4c38-b363-e4a2706e8fbc&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;116&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660-1024x116.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097512&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 2048w, https://blog.uber-cdn.com/cdn-cgi/image/width=2139,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 2139w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 10: Flow of user feedback for Genie.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1a39fc28-3c28-4116-9f55-6d19ae315c90&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;857e39a6-853d-4547-9869-e92e41699b5c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;br&gt;When the user leaves their feedback, a Slack plugin picks it up and uses a specific Kafka topic to stream metrics into a Hive table with the feedback and all the relevant metadata. We later visualize these metrics in a dashboard.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;979e8cb5-13b2-4bfa-bdeb-9fee00e198ee&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-performance-evaluation&#34;&gt;&lt;br&gt;Performance Evaluation&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5a818e05-9a10-4b1b-af8b-d87178bcd50a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We provide Genie users with the option to run custom evaluations. They can evaluate hallucinations, answer relevancy, or any other metric that they deem important for their use case. This evaluation can be used for better tuning of all the relevant RAG components—retrieval and generation.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097514,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;3f2db8f8-1c88-400c-bc43-cafba48a1524&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;474&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740-1024x474.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097514&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 11: Performance evaluation process.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8c2a3927-19b6-4db3-9707-b4e7387f4bb8&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bb9431c5-4a78-4afc-a264-ede6c44f7ac0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 11 shows the evaluation process, which is a separate ETL pipeline that uses already-built Michelangelo components. Genie’s context and responses are retrieved from Hive and joined on any other relevant date, like Slack metadata and user feedback. It gets processed and passed to the Evaluator. Evaluator fetches specified prompt and runs LLM as a Judge. The specified metrics are extracted and included in the evaluation report, which is available to users in the UI.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;e2225358-ed38-49c8-9016-00b050230665&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-document-evaluation&#34;&gt;&lt;br&gt;Document Evaluation&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;476397f2-a2f6-40aa-a21b-56cd9fdf3670&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Accurate information retrieval depends on the clarity and accuracy of the source documents. If the quality of the documentation is poor itself, no matter how good the LLM performs, there’s no way to have a good performance. Therefore, the ability to evaluate documents and make actionable suggestions to improve document quality is essential for an efficient and effective RAG system.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;86fb2e66-3a6d-44b4-a503-4df31f230238&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097516,&amp;quot;sizeSlug&amp;quot;:&amp;quot;full&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;df6c991d-50fe-4b9f-a1d5-8d1ffa31c15a&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-full&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;800&#34; height=&#34;600&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-12-17285129625698.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097516&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=800,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-12-17285129625698.png 800w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-12-17285129625698.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-12-17285129625698.png 768w&#34; sizes=&#34;(max-width: 800px) 100vw, 800px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 12: Workflow of the document evaluation app.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7fd0361d-27f8-4ec0-9c68-2afdcd6caf0b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;749bc0f6-cb3e-43dc-821d-4646be34267c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Figure 12 shows the workflow of the document evaluation app. After the data is scraped, documents in the knowledge base are transformed into a Spark dataframe. Each row in the dataframe represents one document in the knowledge base. Then the evaluation is processed by calling LLM as the judge. Here, we feed LLM with a custom evaluation prompt. The LLM returns an evaluation score, together with explanations of the score and actionable suggestions on how to improve the quality of each document. All these metrics get published as an evaluation report, which users can access in the Michelangelo UI.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;06cc4f29-732c-4eab-9eb4-0e8fd386b55b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6ad29c63-bdbd-40fd-852c-20b68861cf10&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-solutions-to-challenges&#34;&gt;Solutions to Challenges&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1d2a3a6f-deb7-490c-be46-055790382f2d&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To reduce hallucinations&lt;strong&gt;, &lt;/strong&gt;we changed the way we sent prompts to the LLM that we got from the vector database. We explicitly added for all the results obtained from the vector database a section called sub-context along with the source URL for that sub-context. We asked the LLM to only give answers from the various sub-contexts provided and return the source url to cite the answer. This seeks to provide a source URL for every answer it returns.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0427a52a-b8be-4769-87d4-dbe168c385df&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To ensure we don’t leak the data sources for which we create embeddings to Open AI or on Slack to folks who might not be able to access to sensitive data sources, we pre-curated data sources which are widely available to most Uber engineers and only allowed using those data sources for generating embeddings.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3614a771-313c-4df7-ae34-d854bd369dad&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To maximize Genie’s potential in answering questions, we developed a new interaction mode. This mode allows users to ask follow-up questions more conveniently and encourages them to read Genie’s answers more attentively. If Genie can’t answer their questions, users can easily escalate the issue to on-call support.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;22c66eba-4b1d-4f55-8a61-8bfb697e9f4e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1097518,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;44f606b1-fecc-453b-95d9-59fb126fb25d&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;391&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-13-17285130008667-1024x391.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097518&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-13-17285130008667.png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-13-17285130008667.png 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-13-17285130008667.png 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-13-17285130008667.png 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-13-17285130008667.png 2048w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 13: Flow of how Genie responds to user questions.&amp;nbsp;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;22c66eba-4b1d-4f55-8a61-8bfb697e9f4e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;bc41c3aa-eac1-46b6-936d-7a1e67af4ea1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In the new interaction mode, when a user asks a question, Genie will answer with next step action buttons provided. Using those buttons, users can easily ask followup questions, mark questions as resolved, or contact human support.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;79f5346a-c345-4c2c-88c8-6f935ed481b8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d70fa89b-a6e4-4e10-95d3-38e538b6c409&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-results&#34;&gt;Results&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ca43db45-05d5-415d-ad84-a7e0796db4f1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Since its launch in September of 2023, Genie has expanded its presence to &lt;em&gt;154 Slack channels&lt;/em&gt; and has answered over &lt;em&gt;70,000 questions&lt;/em&gt;. Genie boasts a &lt;em&gt;48.9% helpfulness rate&lt;/em&gt;, showcasing its growing effectiveness. We estimate it’s saved us &lt;em&gt;13,000 engineering hours&lt;/em&gt; so far since its launch.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e73c09e1-274a-42a5-92e9-adb69b58474a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b132ac5a-370a-4354-852c-bf77d294ef71&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-future&#34;&gt;Future&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8d1b8f31-767c-4c6d-8966-374e09f1fe7f&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Genie is a cutting-edge Slack bot designed to streamline on-call management, optimize incident response, and improve team collaboration. Developed with a focus on simplicity and effectiveness, Genie serves as a comprehensive assistant, empowering engineering teams to handle on-call responsibilities seamlessly.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;01426ba8-3693-43a5-83f5-446a0e1d3e48&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This on-call assistant copilot has the scope to change the entire experience of how users and on-call engineers of any platform interact and engage within the respective platform’s Slack channel. It can also change the experience within each product, like Michelangelo or IDEs, where users can find product-specific help within the product or a product-specific Slack channel without having to wait for on-call assistance.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9a0acdb7-601d-4d57-ac93-00495e498efb&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;4890f555-add4-4b02-9966-a448c71b2d81&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;157fe169-dc52-4ed0-b048-bb834225462a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Genie, the on-call assistant copilot, revolutionizes the way engineering teams manage on-call duties. By facilitating auto-resolution and providing insightful analytics, Genie empowers teams to handle on-call responsibilities efficiently and effectively.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a7436f34-ba56-435b-a0d6-089c152bc929&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7063b9e6-3aba-4ab9-a7e6-6978598c2c6e&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgements&#34;&gt;Acknowledgements&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;59559f57-4e2e-4e69-af78-260327769ca4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The roll-out of this on-call copilot couldn’t have happened without the many team members who contributed to it. A huge thank you to the folks within Uber’s Michelangelo team. We also thank our partners on other Uber teams for making this idea a reality.&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;2c90521c-3176-44ec-ad7d-d89cc4be2729&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Slack&lt;sup&gt;®&lt;/sup&gt; is a registered trademark and service mark of Slack Technologies, Inc.Apache&lt;sup&gt;®&lt;/sup&gt;, Apache Spark&lt;sup&gt;™&lt;/sup&gt;, and Spark&lt;sup&gt;™&lt;/sup&gt; are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries. No endorsement by The Apache Software Foundation is implied by the use of these marks.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;2c90521c-3176-44ec-ad7d-d89cc4be2729&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;Header Image Attribution: The image was generated by a generative AI tool.&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;e7b16816-7feb-4864-8765-c97c5e712233&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;83ceaad1-2639-48b3-a7fe-b65336676e02&#34;,&#34;dropCap&#34;:false}&#34;&gt;在今天的禁食中在快速发展的技术环境中，保持强大的随叫随到操作对于确保无缝服务功能至关重要。现代平台工程团队面临着有效管理待命时间表、事件响应、关键时刻的沟通以及 Slack&lt;sup&gt;®&lt;/sup&gt; 渠道上强大客户支持的挑战。&lt;br&gt;&lt;br&gt;这篇文章介绍了 Genie、我们构建的待命副驾驶使用生成式人工智能来优化与待命工程师的沟通和问答。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;44f18be0-34d4-4eea-b7dc-a66f7c356686&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4d9ace85-d435-4f79-bc16-ca7545517062&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-a-closer-look-problem-and-motivation&#34;&gt;仔细观察：问题和动机&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e42ca7aa-2298-49d4-bb40-466989b1deb0&#34;,&#34;dropCap&#34;:false}&#34;&gt;在 Uber，像 Michelangelo 团队这样的不同团队都有 Slack 支持渠道，内部用户可以在其中寻求帮助。人们每月会在这些渠道上提出大约 45,000 个问题，如图 1 所示。问题量大和响应等待时间长会降低用户和值班工程师的工作效率。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097494,&#34;sizeSlug&#34;:&#34;full&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“139eb3c9-7dca-4316-842f-78d479d072dc”，“alt”：“”}“类=“aligncenter size-full”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “636”高度=“233”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure1-17285117876372.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097494&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=636,quality =80，onerror=重定向，format=auto/wp-content/uploads/2024/10/figure1-17285117876372.png 636w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，质量= 80，onerror =重定向，格式=自动/ wp-content/uploads/2024/10/figure1-17285117876372.png 300w“尺寸=”（最大宽度：636px）100vw，636px“referrerpolicy=”无引用“ &gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：过去 5 个月内，Uber 通过 Slack 渠道提出的问题数量较多。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;核心/段落&#34;data-wp-block=&#34;{&#34;hash&#34;:&#34;6f3202a6-b275-41b8-afd6-a034baa192bd&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;392586df-9bd9-4f14-9628-730f13b3e53f&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-cumbersome-process&#34;&gt;&lt;br&gt;繁琐的过程&lt;/h3&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097496,&#34;sizeSlug&#34;:&#34;full&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“6e32b91d-85cf-49bf-8b23-04b1a787fca6”，“alt”：“”}“类=“aligncenter size-full”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “864”高度=“281”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure2-17285118129665.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097496&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=864,quality =80，onerror=重定向，format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png 864w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，质量=80，onerror=重定向，format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768 ,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure2-17285118129665.png 768w&#34; 尺寸=&#34;(最大宽度: 864px) 100vw, 864px&#34;referrerpolicy=&#34;no-referrer &#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：等待待命工程师回答问题的缓慢过程。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;52bc6081-d1db-42d1-bb04-bcb7387358df&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;br&gt;通常，当用户在 Slack 频道中提问时，他们必须等待待命工程师做出回应。值班工程师要么回答用户的初始问题，要么询问更多详细信息。然后，用户可能会提出后续问题、寻求更多说明或提供额外信息。这导致再次等待待命工程师的响应。经过多轮来回沟通，用户的问题最终得到解决。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;53b2c110-525b-4ae2-bffd-f2b6d5be6e8a&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e2b1d2ee-bf35-4150-b995-3e291c9948a7&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-hard-to-find-information&#34;&gt;难以查找的信息&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;555a7e9d-308d-498a-9d0c-d3d06c52b16a&#34;,&#34;dropCap&#34;:false}&#34;&gt;许多问题可以‌‌通过参考现有文档得到答案，但信息分散在 Uber 的内部无线网络中ki 调用了 Engwiki、内部 Stack Overflow 和其他位置，因此很难找到具体答案。因此，用户经常反复询问相同的问题，从而导致对数百个 Slack 渠道的随叫随到支持的需求很高。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;523bac00-5e5d-419b-a101-3509db9a4c45&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c65afede-93c3-465d-8b31-e8add6c3edb8&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architectural-challenges&#34;&gt;架构挑战&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fdeaec3c-30d5-4218-af3b-8ca8990f0898&#34;,&#34;dropCap&#34;:false}&#34;&gt;用于构建当值班副驾驶时，我们选择微调 LLM 模型或利用 &lt;a href=&#34;https://www.anyscale.com/blog/a-compressive-guide-for-building-rag-based-llm-applications -part-1&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;检索增强生成 (RAG)&lt;/a&gt;。微调需要包含高质量、多样化示例的精选数据，供法学硕士学习。它还需要计算资源来使用新示例来更新模型。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;744ef140-d7d0-4aea-8221-b3b3ea0f9688&#34;,&#34;dropCap&#34;:false}&#34;&gt;相反， RAG 不需要任何不同的示例来开始。这缩短了 copilot 的上市时间，因此我们为 copilot 选择了这种方法。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;99175e3c-e91c-45cc-aa82-2be9b7386c35&#34;,&#34;dropCap&#34;:false}&#34;&gt;构建-call copilot 提出了多项挑战，包括解决幻觉、保护数据源和改善用户体验。以下概述了我们如何解决每个挑战。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e9110a7c-4bf5-454c-bb29-41de6910fdff&#34;,&#34;dropCap&#34;:false}&#34;&gt;对于幻觉，我们重点关注：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;eedf199c-34fc-47a2-8b5c-1af71d316e77&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;回答的准确性&lt;/strong&gt;：我们确保副驾驶能够检索到问题的相关知识，这可以防止LLM引擎生成不正确或误导性的信息&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;验证机制&lt;/strong&gt;：我们实施方法来根据权威来源验证副驾驶的响应减少产生幻觉的可能性&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;继续良好的学习&lt;/strong&gt;：我们确保副驾驶能够访问最新的数据以提高其准确性&lt;br&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;079a03e0-3175-42d9-a799-f2db1cbd69f4&#34;,&#34;dropCap&#34;:false}&#34;&gt;为了数据安全，我们仔细选择了要摄取的数据源，因为许多数据源无法在 Slack 通道中公开。&lt;br&gt;&lt;br&gt;为了改善用户体验，我们设计了：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9b32f175-7af2-4cb8-a3fd-e478d6c979b6&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”类=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;直观的界面&lt;/strong&gt;：我们设计了一个易于使用的界面，允许用户与副驾驶高效互动&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;反馈循环&lt;/strong&gt;：我们创建了一个系统，供用户提供有关响应的反馈不断完善副驾驶的表现&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;544fa9a3-d103-49f1-bd3f-0ea3e60a5fe7&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们解决了这些问题开发我们的待命副驾驶时面临的挑战，以确保其可靠、用户友好且安全。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8595d9fd-d250-4111-a0ae-c65a880b660f&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;775af645-d734-43db-8617-596ded3f17e1&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-deep-dive-architecture&#34;&gt;深入探讨：架构&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e3acd865-7c12-403d-a1dd-c12e0cfd66a5&#34;,&#34;dropCap&#34;:false}&#34;&gt;让我们探索一下我们的待命副驾驶（称为 Genie）的架构。 &lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097498,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“b1baea01-32a1-4ee9-ac99-52df5911b2a8”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“443”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure3-3-17285118456072-1024x443.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097498&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图像/宽度=300，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/figure3-3-17285118456072.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072.png 768w，https:// /blog.uber-cdn.com/cdn-cgi/image/width=1536，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/figure3-3-17285118456072.png 1536w， https://blog.uber-cdn.com/cdn-cgi/image/width=2000，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure3-3-17285118456072。 png 2000w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：待命副驾驶的架构。&lt;/图标题&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;18321915-dd26-4e3e-9ea7-3905b8a51726&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;418a7ac1-114d-4079-bebe-6277461f0ad5&#34;,&#34;dropCap&#34;:false}&#34;&gt;处于高位在级别上，我们抓取内部数据源，例如 Uber 的内部 wiki、Uber 的内部 Stack Overflow、工程需求文档，并使用开放 AI 嵌入模型从这些数据源创建向量。这些嵌入被存储在矢量数据库中。然后，当用户在 Slack 频道中发布问题时，问题会被转换为嵌入。该服务在向量数据库中搜索与问题相关的相关嵌入。由嵌入索引的结果被用作 LLM 获取响应的提示。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bbbba4d6-3bfb-47db-8917-95748eba02b5&#34;​​,&#34;dropCap&#34;:false}&#34;&gt;以下步骤用于数据准备、嵌入和推送服务的工件可以概括为使用 Apache Spark&lt;sup&gt;™&lt;/sup&gt; 的 RAG 应用程序。这些一般步骤构成了 RAG 应用程序的基础。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;94026da2-9931-4e3e-852b-dcd6665156ea&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7ccaf504-43aa-4a72-a0d6-964714​​08651e&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-etl&#34;&gt;ETL&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097500,&#34;width&#34;:&#34;521px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;aspectRatio&#34;:&#34; 4\/3&#34;,&#34;scale&#34;:&#34;cover&#34;,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;c2dadb8f-040e-4a17-afd8 -3cf88890e063&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;imgloading=&#34;lazy&#34;decoding=&#34;async&#34;width=&#34;816&#34;height=&#34;1024&#34;src=&#34;https ://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035-816x1024.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097500&#34; style=&#34;aspect-ratio:4/3;object-fit:cover;width:521px;height:auto&#34; srcset=&#34;https ://blog.uber-cdn.com/cdn-cgi/image/width=816,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 816w, https://blog.uber-cdn.com/cdn-cgi/image/width=239，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 239w ，https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure4-17285118719035.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=940，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure4-17285118719035。 png 940w&#34;sizes=&#34;(max-width: 816px) 100vw, 816px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 4：用于数据提取的 Spark 应用程序。&lt;/figcaption&gt; &lt;/图&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a3677069-38fe-4d57-9b36-6ee85aeb3ea8&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;78d8d942-525e-4c13-ab8d-79d3d980353d&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 4 显示自定义 Spark 应用程序，其中包含将数据提取到矢量数据库的步骤。 Spark 应用程序使用 Spark 执行器运行这些步骤。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;2e768fa5-c1b6-4c6a-ba46-d642732c1be9&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-data-prep&#34;&gt;&lt;br&gt;数据准备&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a5923920-e1e5-4281-8a97-4821b2ae661f&#34;,&#34;dropCap&#34;:false}&#34;&gt;Spark 应用使用 Uber 的内部 wiki（称为 Engwiki 或 Uber Stack Overflow API）从相应的数据源获取内容。 Spark 数据帧从此数据准备阶段输出。该架构的一列中包含 Engwiki 链接，另一列中包含 Engwiki 内容，两者均采用字符串格式。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097502,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“abbd21e9-5275-4ac1-8273-11af89807749”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“220”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure5-17285119354055-1024x220.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097502&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024 ，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/figure5-17285119354055.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width= 300，质量= 80，onerror =重定向，格式=自动/wp-content/uploads/2024/10/figure5-17285119354055.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure5-17285119354055。 png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1284，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure5-17285119354055 .png 1284w&#34;sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：来自 Engwiki 数据源的 Spark 数据框的列.  &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d307d345-ce2b-4274-af28-d2713e6f8005&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a0213e51-4c9b-4bea-9c22-fde19d3849ff&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 5 显示Spark 数据框的列，以 Uber 的内部 wiki 作为原始数据源。它具有源 URL、内容和存储元数据的其他列。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;900833c0-b219-4f9b-bf03-a6c037e70413&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-embedding- Generation&#34;&gt;&lt;br&gt;嵌入生成&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fa364112-7193-470a-ae5d-1120d6bd5e94&#34;,&#34;dropCap&#34;:false}&#34;&gt;一旦数据被抓取后，使用 OpenAI 嵌入模型创建嵌入，并将其推送到 Uber 的 blob 存储 Terrablob。创建的嵌入只能通过与 Engwiki 空间相关的特定 Slack 通道访问。输出格式是一个数据帧，其中分块内容的模式映射到该块的相应向量。 Uber 的内部 wiki 内容使用 langchain 进行分块，并通过 OpenAI 和 PySpark UDF 生成嵌入。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;95723f82-760a-4697-ac97-71700d164769&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXf4DX2PBW9iHR6npUbfBZlpuNq7pEZ9stydlXT94UlJNgeLsPs3n6gwe1rcsSDFCWKDKYiQ9JS1NNt6wPCkjbmB3K4NrFX d5Ql16Y8Fmdf3OkPwPcl7yppTkl7DznlJnWAbxu6bswf3dhwIukjV--SLHag?key=Cul8rOkHqArI5wi0MdurWQ&#34; alt=&#34;&#34;referrerpolicy= &#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 6：具有向量嵌入的 Spark 数据帧的列。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;df3248a1-b648-4a1e-8d38-14ddc846a9a5&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d26434ed-fb67-4781-969b-18478fa7b608&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 6 显示Spark 数据框的列，以 Uber 的内部 wiki 作为原始数据源。它具有源 URL、内容、分块内容和该特定块的嵌入。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a42e77cd-a2e6-490f-b6f1-500a195f2d66&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8422f718-6035-4458-b9d6-d150217f2714&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-pusher&#34;&gt;推动者&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097505,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心&#34;,&#34;哈希&#34;:&#34;15bc5c0c-6300-4e90-9ff1-4000afc37ea7&#34;,&#34;alt&#34;:&#34;&#34;}&#34;类=“aligncenter尺寸-大”&gt;&lt;img加载=“惰性”解码=“异步”宽度=“1024”高度=“456” src =“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure7-17285121216461 -1024x456.png&#34; alt=&#34;&#34; 类=&#34;wp-image-1097505&#34; srcset =“https://blog.uber-cdn.com/cdn-cgi/image/width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure7-17285121216461 .png 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 300w , https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 768w , https://blog.uber-cdn.com/cdn-cgi/image/width=1399，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure7-17285121216461.png 1399w “尺寸=”（最大宽度：1024px）100vw，1024px“ referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 7：被推送到 Terrablob 的向量流。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;925589cc-cfb6-42c4-85ae-50b997c1f75b&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;96764c30-7e39-416f-8a35-8b6bfd29b4a9&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 7 显示如何将向量推送到 Terrablob。触发引导作业将数据从数据源提取到 Uber 的内部矢量数据库解决方案 Sia。然后，触发两个 Spark 作业来构建索引、合并数据并将数据摄取到 Terrablob。每个叶子同步并下载存储在 Terrablob 中的基本索引和快照。在检索过程中，查询会直接发送到每个叶子。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c83baa9b-0da1-4226-8912-f3918309b9e0&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e55d7c63-e2d6-4f4d-90d8-4db67d0d800e&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -块标题”id=&#34;h-knowledge-service&#34;&gt;知识服务&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097508,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“d1952dd4-d236-42e5-a1f1-49eda9714865”，“alt”：“”}“class =“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“533”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure8-17285122683730-1024x533.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097508&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024 ，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/figure8-17285122683730.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width= 300，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/figure8-17285122683730.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width =768，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/宽度=1536，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure8-17285122683730.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image /宽度= 1819，质量= 80，onerror =重定向，格式=自动/可湿性粉剂内容/上传/2024/10/figure8-17285122683730.png 1819w“尺寸=”（最大宽度：1024像素）100vw，1024像素“referrerpolicy= &#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 8：后端知识服务的流程。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d51d2f61-620b-497b-90b3-33159c9b573f&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1aa84d55-9c15-4da0-9464-3f72e7a637a2&#34;,&#34;dropCap&#34;:false}&#34;&gt;精灵有一个称为知识服务的后端服务，它通过首先将传入查询转换为嵌入，然后从向量数据库中获取最相关的块来为所有传入查询提供传入请求。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;00b12d8a-403b-41d0-ad77-0eb9d5db4039&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bfd1c1c7-ff26-495a-aab2-a536972d1288&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-cost-tracking&#34;&gt;成本跟踪&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097510,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“f3d3a3dd-1430-4e46-9139-6906e12b17b6”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“as”同步”宽度=“1024”高度=“466”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp -content/uploads/2024/10/figure9-17285128268595-1024x466.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097510&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image /width=1024，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图像/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 300w，https://blog.uber-cdn.com/cdn-cgi /image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 768w，https://blog.uber-cdn.com/cdn- cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 1536w，https://blog.uber-cdn.com/cdn -cgi/image/width=1538,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure9-17285128268595.png 1538w&#34; 尺寸=&#34;(最大宽度: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 9：Genie 成本跟踪流程。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ff527243-716c-489e-b627-22d696350692&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1fc50b8e-0cdf-4138-a8e2-314b72818355&#34;,&#34;dropCap&#34;:false}&#34;&gt;用于费用跟踪，当 Slack 客户端或其他平台调用 Knowledge Service 时，UUID 会传递给 Knowledge Service，Knowledge Service 又将 UUID 通过上下文标头传递给 Michelangelo Gateway。 Michelangelo Gateway 是 LLM 的直通服务，因此可以将其添加到用于通过该 UUID 跟踪成本的审核日志中。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;43875a90-77f2-4acc-ac34-df25281d3e51&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8fa72504-db7a-4ece-80ef-7e3714b0189a&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-genie-performance-evaluation&#34;&gt;精灵性能评估&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;a453e184-134d-423e-987f-5c2c51383195&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-metrics-framework&#34;&gt;指标框架&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1515629e-7d00-4f78-936c-9553ed1f6cbe&#34;,&#34;dropCap&#34;:false}&#34;&gt;用户可以提供单击 Genie 回复中的相关按钮即可立即在 Slack 中反馈。我们为用户提供了以下选项：  &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul data-wp-block-name=&#34;core/list&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;32dde48a-387a-4bae-a2b3-9d0525d3826c&#34;,&#34;ordered&#34;:false,&#34;values&#34;:&#34; “}”cl屁股=“wp-block-list”&gt;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;已解决&lt;/strong&gt;：答案完全解决了问题&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;帮助&lt;/strong&gt;l：答案部分有帮助，但用户需要更多帮助&lt; /里&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;没有帮助&lt;/strong&gt;：响应错误或不相关&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li data-wp-block-name=&#34;core/list-item&#34; data-wp-block=&#34;[]&#34;&gt;&lt;strong&gt;不相关&lt;/strong&gt;：用户需要值班人员的帮助，而 Genie 不能不提供协助（例如代码审查）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097512,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“03c44d96-15a9-4c38-b363-e4a2706e8fbc”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“116”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-10-17285128486660-1024x116.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097512&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图片/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 300w，https://blog.uber-cdn.com/cdn -cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 768w，https://blog.uber-cdn。 com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 1536w，https://blog.uber -cdn.com/cdn-cgi/image/width=2048，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 2048w，https:// blog.uber-cdn.com/cdn-cgi/image/width=2139，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-10-17285128486660.png 2139w“尺寸=&#34;(max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 10：Genie 的用户反馈流程。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1a39fc28-3c28-4116-9f55-6d19ae315c90&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;857e39a6-853d-4547-9869-e92e41699b5c&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;br&gt;当用户留下反馈时，Slack 插件会接收反馈并使用特定的 Kafka 主题将指标以及反馈和所有相关元数据流式传输到 Hive 表中。我们稍后会在仪表板中可视化这些指标。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;核心/标题&#34; data-wp-block=&#34;{&#34;level&#34;:3,&amp;quot;hash&#34;:&#34;979e8cb5-13b2-4bfa-bdeb-9fee00e198ee&#34;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-performance-evaluation&#34;&gt;&lt;br&gt;性能评估&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5a818e05-9a10-4b1b-af8b-d87178bcd50a&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们提供精灵用户可以选择运行自定义评估。他们可以评估幻觉、回答相关性或他们认为对其用例重要的任何其他指标。此评估可用于更好地调整所有相关 RAG 组件（检索和生成）。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097514,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“3f2db8f8-1c88-400c-bc43-cafba48a1524”，“alt”：“”}“类=“aligncenter size-large”&gt; &lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“474”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-11-17285128734740-1024x474.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097514&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 1024w，https://blog.uber-cdn.com/cdn-cgi/图片/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 300w，https://blog.uber-cdn.com/cdn -cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 768w，https://blog.uber-cdn。 com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 1536w，https://blog.uber -cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-11-17285128734740.png 2048w&#34; 尺寸=&#34;( max-width: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 11：性能评估流程。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8c2a3927-19b6-4db3-9707-b4e7387f4bb8&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bb9431c5-4a78-4afc-a264-ede6c44f7ac0&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 11 显示评估过程，这是一个单独的 ETL 管道，使用已构建的 Michelangelo 组件。 Genie 的上下文和响应是从 Hive 检索的，并在任何其他相关日期加入，例如 Slack 元数据和用户反馈。它被处理并传递给评估器。评估者获取指定的提示并作为法官运行 LLM。指定的指标将被提取并包含在评估报告中，用户可以在 UI 中使用该报告。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;核心/头ing&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;e2225358-ed38-49c8-9016-00b050230665&#34;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-document-evaluation &#34;&gt;&lt;br&gt;文件评估&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;476397f2-a2f6-40aa-a21b-56cd9fdf3670&#34;,&#34;dropCap&#34;:false}&#34;&gt;精准信息检索取决于源文件的清晰度和准确性。如果文档本身的质量很差，那么无论LLM表现得多么好，也不可能有好的表现。因此，评估文档并提出可行建议以提高文档质量的能力对于高效且有效的 RAG 系统至关重要。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;86fb2e66-3a6d-44b4-a503-4df31f230238&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097516,&#34;sizeSlug&#34;:&#34;full&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“df6c991d-50fe-4b9f-a1d5-8d1ffa31c15a”，“alt”：“”}“class =“aligncenter size-full”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “800”height =“600”src =“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror =重定向，format = auto/wp-content/uploads /2024/10/figure-12-17285129625698.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097516&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=800 ，质量= 80，onerror =重定向，格式= auto/wp-content/uploads/2024/10/figure-12-17285129625698.png 800w，https://blog.uber-cdn.com/cdn-cgi/image/宽度=300，质量=80，onerror=重定向，格式=auto/wp-content/uploads/2024/10/figure-12-17285129625698.png 300w，https://blog.uber-cdn.com/cdn-cgi /image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/10/figure-12-17285129625698.png 768w&#34; 尺寸=&#34;(最大宽度: 800px) 100vw, 800px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 12：文档评估应用程序的工作流程。 &lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7fd0361d-27f8-4ec0-9c68-2afdcd6caf0b&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;749bc0f6-cb3e-43dc-821d-4646be34267c&#34;,&#34;dropCap&#34;:false}&#34;&gt;图 12 显示文档评估应用程序的工作流程。抓取数据后，知识库中的文档将转换为 Spark 数据帧。数据框中的每一行代表知识库中的一个文档。然后调用LLM作为评委进行评估。在这里，我们向 LLM 提供自定义评估提示。法学硕士返回评估分数，以及分数的解释和有关如何提高每个文档质量的可行建议。所有这些指标都作为n 评估报告，用户可以在 Michelangelo UI 中访问该报告。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;06cc4f29-732c-4eab-9eb4-0e8fd386b55b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6ad29c63-bdbd-40fd-852c-20b68861cf10&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-solutions-to-challenges&#34;&gt;挑战的解决方案&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1d2a3a6f-deb7-490c-be46-055790382f2d&#34;,&#34;dropCap&#34;:false}&#34;&gt;减少幻觉&lt;strong&gt;，&lt;/strong&gt;我们更改了向 LLM 发送从矢量数据库获得的提示的方式。我们为从矢量数据库获得的所有结果明确添加了一个称为子上下文的部分以及该子上下文的源 URL。我们要求法学硕士仅从所提供的各种子上下文中给出答案，并返回源网址以引用答案。这旨在为其返回的每个答案提供源 URL。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0427a52a-b8be-4769-87d4-dbe168c385df&#34;,&#34;dropCap&#34;:false}&#34;&gt;为了确保我们不要将我们在 Open AI 或 Slack 上创建嵌入的数据源泄露给可能无法访问敏感数据源的人员，我们预先整理了大多数 Uber 工程师都可以广泛使用的数据源，并且只允许使用用于生成嵌入的数据源。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3614a771-313c-4df7-ae34-d854bd369dad&#34;,&#34;dropCap&#34;:false}&#34;&gt;最大化 Genie为了提高回答问题的潜力，我们开发了一种新的交互模式。这种模式可以让用户更方便地提出后续问题，并鼓励他们更仔细地阅读Genie的答案。如果 Genie 无法回答他们的问题，用户可以轻松地将问题升级为待命支持。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;22c66eba-4b1d-4f55-8a61-8bfb697e9f4e&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1097518,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;align&#34;:&#34;中心”，“散列”：“44f606b1-fecc-453b-95d9-59fb126fb25d”，“alt”：“”}“类=“aligncenter size-large”&gt;&lt;img加载=“惰性”解码=“异步”宽度= “1024”高度=“391”src=“https://blog.uber-cdn.com/cdn-cgi/image/width=2160，质量= 80，onerror=重定向，format=auto/wp-content/uploads /2024/10/figure-13-17285130008667-1024x391.png&#34; alt=&#34;&#34; class=&#34;wp-image-1097518&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width =1024，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/10/figure-13-17285130008667.png 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=redirect，format=auto/wp-content/uploads/ 2024/10/figure-13-17285130008667.png 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768，quality=80，onerror=redirect，format=auto/wp-content /uploads/2024/10/figure-13-17285130008667.png 768w，https://blog.uber-cdn.com/cdn-cgi/image/width=1536，quality=80，onerror=redirect，format=auto/ wp-content/uploads/2024/10/figure-13-17285130008667.png 1536w，https://blog.uber-cdn.com/cdn-cgi/image/width=2048，quality=80，onerror=redirect，格式=auto/wp-content/uploads/2024/10/figure-13-17285130008667.png 2048w&#34; 尺寸=&#34;(最大宽度: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp -element-caption&#34;&gt;图 13：Genie 如何响应用户问题的流程。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;22c66eba-4b1d-4f55-8a61-8bfb697e9f4e&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;/p &gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;bc41c3aa-eac1-46b6-936d-7a1e67af4ea1&#34;,&#34;dropCap&#34;:false}&#34;&gt;在新的交互模式，当用户提出问题时，Genie 将回答并提供下一步操作按钮。使用这些按钮，用户可以轻松提出后续问题、将问题标记为已解决或联系人工支持。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;79f5346a-c345-4c2c-88c8-6f935ed481b8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d70fa89b-a6e4-4e10-95d3-38e538b6c409&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-results&#34;&gt;结果&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ca43db45-05d5-415d-ad84-a7e0796db4f1&#34;,&#34;dropCap&#34;:false}&#34;&gt;自发布以来到 2023 年 9 月，Genie 已将其业务扩展到 &lt;em&gt;154 个 Slack 频道&lt;/em&gt;，并回答了 &lt;em&gt;70,000 多个问题&lt;/em&gt;。 Genie 拥有 &lt;em&gt;48.9% 的帮助率&lt;/em&gt;，显示出其不断增长的有效性。我们估计，自推出以来，它已为我们节省了&lt;em&gt;13,000 个工程时间&lt;/em&gt;。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e73c09e1-274a-42a5-92e9-adb69b58474a&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b132ac5a-370a-4354-852c-bf77d294ef71&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-future&#34;&gt;未来&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8d1b8f31-767c-4c6d-8966-374e09f1fe7f&#34;,&#34;dropCap&#34;:false}&#34;&gt;精灵是一个尖端的 Slack 机器人，旨在简化待命管理、优化事件响应并提高团队协作流产。 Genie 的开发重点是简单性和有效性，它作为一个全面的助手，使工程团队能够无缝地处理随叫随到的职责。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;01426ba8-3693-43a5-83f5-446a0e1d3e48&#34;,&#34;dropCap&#34;:false}&#34;&gt;此-呼叫助理副驾驶可以改变任何平台的用户和值班工程师在各自平台的 Slack 通道中交互和参与的整体体验。它还可以改变每个产品内的体验，例如 Michelangelo 或 IDE，用户可以在产品或特定于产品的 Slack 渠道中找到特定于产品的帮助，而无需等待随叫随到的帮助。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9a0acdb7-601d-4d57-ac93-00495e498efb&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;4890f555-add4-4b02-9966-a448c71b2d81&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;157fe169-dc52-4ed0-b048-bb834225462a&#34;,&#34;dropCap&#34;:false}&#34;&gt;精灵，待命助理副驾驶彻底改变了工程团队管理待命职责的方式。通过促进自动解决并提供富有洞察力的分析，Genie 使团队能够高效且有效地处理随叫随到的职责。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a7436f34-ba56-435b-a0d6-089c152bc929&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7063b9e6-3aba-4ab9-a7e6-6978598c2c6e&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-acknowledgements&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;59559f57-4e2e-4e69-af78-260327769ca4&#34;,&#34;dropCap&#34;:false}&#34;&gt;滚动-如果没有许多团队成员的贡献，这位值班副驾驶的成功是不可能发生的。非常感谢 Uber 米开朗基罗团队的工作人员。我们还感谢其他 Uber 团队的合作伙伴使这一想法成为现实。&lt;br&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;2c90521c-3176-44ec-ad7d-d89cc4be2729&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;Slack&lt;sup&gt;®&lt;/sup&gt; 是 Slack Technologies, Inc. 的注册商标和服务商标。Apache&lt;sup&gt;®&lt;/sup&gt;、Apache Spark &lt;sup&gt;™&lt;/sup&gt; 和 Spark&lt;sup&gt;™&lt;/sup&gt; 是 Apache Software Foundation 在美国和/或其他国家/地区的注册商标或商标。没有认可使用这些标记暗示 Apache 软件基金会。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;2c90521c-3176-44ec-ad7d-d89cc4be2729&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;标题图像属性：该图像由生成式 AI 工具生成。&lt;/p&gt;</description>
      <pubDate>Thu, 10 Oct 2024 05:00:00 +0000</pubDate>
    </item>
    <item>
      <title>【QueryGPT – Natural Language to SQL Using Generative AI】QueryGPT – 使用生成式 AI 将自然语言转换为 SQL</title>
      <link>https://www.uber.com/blog/query-gpt/</link>
      <description>【&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;e735bd6b-558b-4301-a92b-9fba35e6bc65&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-introduction&#34;&gt;Introduction&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;eb484efe-378c-40e0-af57-14bd8a10b396&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;SQL is a vital tool used daily by engineers, operations managers, and data scientists at Uber to access and manipulate terabytes of data. Crafting these queries not only requires a solid understanding of SQL syntax, but also deep knowledge of how our internal data models represent business concepts. QueryGPT aims to bridge this gap, enabling users to generate SQL queries through natural language prompts, thereby significantly enhancing productivity.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f224d2da-b02d-4ff2-b219-0fdc1f5cab39&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;QueryGPT uses large language models (LLM), vector databases, and similarity search to generate complex queries from English questions that are provided by the user as input.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2a651aaf-0a58-4385-b7da-05a4eeb8d4e4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This article chronicles our development journey over the past year and where we are today with this vision.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b60d0020-1daa-4a5e-97a6-98f869f533b4&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-motivation&#34;&gt;Motivation&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;53bb688c-ff1f-4bb8-a317-e04e6185daa5&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcC2OH7JIyWjT68dWjQgaxz8SbmhQVz-ARB4M6bOYRV0bIxLS7ellpYioGaYm7PewbHzme4l2r1rqwellO74eax1CyGrRPtbAY17X1aUQDx9Lp00mLsgWIOW9q6fJzH8U54NpxlTFEdbEA_QITC755FAAsH?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 1: Query Authoring Process.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;baefce90-b4db-4613-95b6-d55bbe7b3f4c&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f5a98fa3-88bc-494c-833c-892a333b2748&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;At Uber, our data platform handles approximately 1.2 million interactive queries each month. The Operations organization, one of the largest user cohorts, contributes to about 36% of these queries. Authoring these queries generally requires a fair amount of time between searching for relevant datasets in our data dictionary and then authoring the query inside our editor. Given that each query can take around 10 minutes to author, the introduction of QueryGPT, which can automate this process and generate reliable queries in just about 3 minutes, represents a major productivity gain.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;025f314b-d91a-4eab-9e39-223a072900a7&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;If we make a conservative estimate that each query takes about 10 minutes to author, QueryGPT can automate this process and provide sufficiently reliable queries in about 3 minutes. This would result in a major productivity gain for Uber.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a9b8789e-02b4-4aa6-9888-946c91bfd0df&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096044,&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;b1b68651-445c-4842-a62b-a8df8ab6c7cb&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;429&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445-1024x429.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1096044&#34; style=&#34;width:700px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1276,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 1276w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 2: Querybuilder Usage.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ca26529d-ff05-4a61-adf8-800507582c78&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;id&amp;quot;:1096046,&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;sizeSlug&amp;quot;:&amp;quot;large&amp;quot;,&amp;quot;linkDestination&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;48d4a1db-0ee0-4040-810f-2b4111ffbf0b&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;387&#34; src=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592-1024x387.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1096046&#34; style=&#34;width:700px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1272,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 1272w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 3: QueryGPT Impact.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;97932bcf-6d95-412f-8ea8-1d286dbb0f78&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6581dfd0-5bfd-48c1-b8e7-a00a9a44c0aa&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-architecture&#34;&gt;Architecture&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;aa0702df-39bb-4e7c-8eb9-d5435da45c75&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;QueryGPT originated as a proposal during Uber’s Generative AI Hackdays in May 2023. Since then, we have iteratively refined the core algorithm behind QueryGPT, transitioning it from concept to a production-ready service. Below, we detail the evolution of QueryGPT and its current architecture, highlighting key enhancements..&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cf501d3d-beaf-4ad6-930f-219adc58ff82&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We’ve described below our current version of QueryGPT. Please bear in mind that there were about 20+ iterations of the algorithm between the 2 detailed below and if we were to list and describe each, the length of this blog article would put Ayn Rand’s &lt;em&gt;Atlas Shrugged&lt;/em&gt; to shame.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a980128d-4d7f-4361-9cdc-4f0a5d55f728&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;a306c97a-e64b-4f92-8b70-79aaca67cf84&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-hackdayz-version-1&#34;&gt;Hackdayz (version 1)&lt;/h3&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;e07c37f7-b2ca-45c9-af49-d2e559f91221&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdBuoSw4-YUqiwCVg-oD6Ov6Cx9PCnOCQKikBooaMttGGhDJAbsmJU19_bhlIZGE-lTX2YVZXaejXc3nuJoKVnuP8Fhq6bySTfmgn2-Srxhsa0fPxWTyPMshWKtrfoSilJnXGXQ5WL137-t0rf3-EdYUdyA?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 4: QueryGPT Hackdayz version&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;16e124f2-00b4-4145-98e2-3c17b14d6873&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;69c8f8d1-8176-43c8-8d53-ea406e49c0df&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The first version of QueryGPT relied on a fairly simple RAG to fetch the relevant samples we needed to include in our query generation call to the LLM (Few Shot Prompting). We would take the user’s natural language prompt, vectorize it and do a similarity search (using k-nearest neighbor search) on the SQL samples and schemas to fetch 3 relevant tables and 7 relevant SQL samples.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e68f2468-74cc-4c2b-82a0-93e73ad70643&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The first version used 7 tier 1 tables and 20 SQL queries as our sample data set. The SQL queries were supposed to provide the LLM guidance on how to use the table schemas provided and the table schemas provided the LLM information about the columns that existed on those tables.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1c42885a-f676-434b-a7de-3587222251a5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For example, for a tier 1 table, &lt;em&gt;uber.trips_data&lt;/em&gt; (not a real table), this is what the schema would look like:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e2e04fd9-2c4f-456c-b979-6b074618d4d8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;685394a5-0bce-4fda-bcb7-3c9f526e9ff8&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcv35PJRLqPvFrcSQUwvxQqutjd0mT_vauGDqqY5CESrguVm845_6Ife4azUiuhodUKRND7WNwdOIcnraAGEfco5b4puw1uC3a-hQzYGBGYIZul3KD0MB7zcrbgJG2pCE8uItfdre19hVCd6WxbjFNNX1-i?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 5: uber.trips_data table.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1707de5e-8545-4535-8831-14ff942e11ce&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;11f17948-81df-4982-badd-dbca4261bdac&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To help the LLM understand internal Uber lingo and work with Uber datasets, we also included some custom instructions in the LLM call. Shown below is a snippet of how we wanted the LLM to work with dates:&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;a42b8d62-db59-4ac9-a921-30e012a8b378&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeZMYZI9LdwW_GU31hqaswX7jMwtaQZL0Vuyo2ExTpUo-MKpeN3Qj_q14-aEgueHMqT9JRHryH6fWssismaF2N768dmaD9KE6xZQhO4Fyb-srNa1YoGNfiyTAh-GTEYWcpKTsVfp_8US8jpKkiAsRejPsR1?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 6: Custom Instructions for handling dates in Uber datasets.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ab0aed50-802e-4e17-95f2-ae6aedb3e5c2&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a09c0daf-d5f1-4fea-be38-02ec7656f366&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We would wrap all the relevant schema samples, SQL samples, user’s natural language prompt, and Uber Business instructions around a system prompt and send the request to the LLM.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;11e599d5-2a2c-42b1-b0ad-310cb1de7b35&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The response would include an “SQL Query” and an “Explanation” of how the LLM generated the query:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1c3f9567-ad6f-40f9-b8bc-80a94f3eb950&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;7b817659-3a61-49a3-b0fb-9b7c5c1505c3&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXega7yHLmgA8wlGBdnBqbco16GQV7SeKdOCtUbGD1E1ZhuglOZ0P47UDHXvj99RDm-ndeh1GgWWMxKQx8kDKZZYZLEryCFFSEi3pGrUF1vMD9RSzrbMNHta6SZ38hXddp8tHy-iSHccFYFgmrInQKlAfc8?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 7: Generated SQL with Explanation.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c42500bc-5a08-440b-983b-843e36e3269b&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;84b98147-4a93-4ddd-9098-9b6f3e2371e1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;While this version of the algorithm worked well for a small set of schemas and SQL samples, as we started to onboard more tables and their associated SQL samples into the service, we started seeing declining accuracy in the generated queries.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0df8653a-d050-48c7-96db-3f304a03369d&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;feeb6cb0-3a63-4949-8813-c1d57306a63f&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-better-rag&#34;&gt;Better RAG&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8c219406-9327-41b9-80fd-671f5c74f2eb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Doing a simple similarity search for a user’s natural language prompt (“Find the number of trips completed yesterday in Seattle”) on schema samples (&lt;em&gt;CREATE TABLE&lt;/em&gt;…) and SQL queries (&lt;em&gt;SELECT a, b, c FROM uber.foo &lt;/em&gt;…) doesn’t return relevant results.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;ed25814d-9f75-4fba-8bd1-dc78df2dd7b2&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-understanding-user-s-intent&#34;&gt;Understanding User’s Intent&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1e71a70f-8c29-4964-80ec-99d74b347ba0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Another issue we found was that it’s incredibly challenging to go from a user’s natural language prompt to finding the relevant schemas. What we needed was an intermediate step, which classifies the user’s prompt into an “intent” that maps to relevant schemas and SQL samples.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;02705018-fca5-4181-a29e-474bdc114c29&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-handling-large-schemas&#34;&gt;Handling Large Schemas&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;82be2c49-fc74-4aff-81b5-96f5c48123c1&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We have some really large schemas on some Tier 1 tables at Uber, with some spanning over 200 columns. These large tables could use up as much as 40-60K tokens in the request object. Having 3 or more of these tables would break the LLM call since the largest available model (at the time) only supported 32K tokens.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a461a6ed-9e9e-43d6-88ca-8677920dc47d&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;651e011c-62e0-434d-bf63-5aea7e878acd&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-current-design&#34;&gt;Current Design&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;77cb3666-0e69-4200-89b2-02b7c85c5b3a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The diagram below shows the current design of QueryGPT that we’re running in production. The current version includes many iterative changes from the first version.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;f0c52e7a-e247-4213-bb8b-8a6d1613ce65&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXctJlWIn-wn89ptfWpK2OrhH9sVIkP5OqSthEr21ZoybaECaxE5GATRUNJX8ElX1ODGz1N2JHcg0sYjN1QXIi9T-_Ex6VjVUunGJ8s5SW2D5gaEUme4Skh3NrVqjmIazQZPJ17XhJ2JJwo3FfqpLh8JD9j4?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 8: QueryGPT (current).&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c6320027-f65a-476a-903e-367a1a1300ac&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;2e3c3d0c-e4e8-42c9-91a4-6a44c74d54f2&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-workspaces&#34;&gt;Workspaces&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1ed49b96-6676-4e81-bf7d-0c556fb024bc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In our current design, we introduced “workspaces,” which are curated collections of SQL samples and tables tailored to specific business domains such as Ads, Mobility, and Core Services. These workspaces help narrow the focus for the LLM, improving the relevance and accuracy of generated queries.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;621f9d8c-b8f7-459b-8a34-cf2c979fbcd4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We’ve identified some of the more common business domains inside Uber and created those in the backend as “System Workspaces.”&amp;nbsp; Mobility is one of these system workspaces that we identified as foundational domains that could be used for query generation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;40ccaf2a-b154-4919-a164-6b5bb7267f30&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;&lt;em&gt;Mobility&lt;/em&gt;&lt;/strong&gt; : Queries that include trips, driver, document details, etc.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/table&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fc77e064-4516-45a8-bac0-a244ae55e605&amp;quot;,&amp;quot;hasFixedLayout&amp;quot;:true,&amp;quot;head&amp;quot;:[],&amp;quot;body&amp;quot;:[],&amp;quot;foot&amp;quot;:[]}&#34; class=&#34;wp-block-table&#34;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;Write &lt;strong&gt;a&lt;/strong&gt; query to find &lt;strong&gt;the&lt;/strong&gt; number &lt;strong&gt;of&lt;/strong&gt; trips that were completed &lt;strong&gt;by&lt;/strong&gt; Teslas &lt;strong&gt;in&lt;/strong&gt; Seattle yesterday&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;96a999fa-1a1d-483a-a2b3-2289e2eaf41c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Along with these, we also shipped 11 other system workspaces, including “Core Services,” “Platform Engineering,” “IT,” “Ads,” etc.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;03ab4f6d-f230-419f-b99d-e9064462e72e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We also included a feature that allows users to create “Custom Workspaces” if none of the existing system workspaces fit their requirement and use those for query generation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ec194bba-bc61-46c2-91de-f269f31851d3&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;ad296232-7118-4e6d-8353-d16b35e40f2b&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-intent-agent&#34;&gt;Intent Agent&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9c9515c9-371b-46a4-a087-c9df6f41e7cb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Every incoming prompt from the user now first runs through an “intent” agent. The purpose of this intent agent is to map the user’s question to one or more business domains/workspaces (and by extension a set of SQL samples and tables mapped to the domain). We use an LLM call to infer the intent from the user question and map these to “system” workspaces or “custom” workspaces.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a97a543b-072c-4538-b64f-f4217acf4c22&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Picking a business domain allowed us to drastically narrow the search radius for RAG.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;f8a6a800-3138-4111-9cc8-d2f736961781&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;996e7798-8d39-4add-adec-dc7a6ee4cdb2&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-table-agent&#34;&gt;Table Agent&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8ab1add6-aa91-419e-9287-0d5549a95170&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Allowing users to select the tables used in the query generation came up as feedback from some users who saw that the tables that were eventually picked by QueryGPT were not correct.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6d2a216b-7995-463c-af9f-ffe50188b17e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To address this feedback, we added another LLM agent (Table Agent) that would pick the right tables and send those out to the user to either “ACK” or edit the given list and set the right tables. A screenshot of what the user would see is shown below:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;303e6130-d5f0-44fa-8489-012c7f4cca45&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;160a0a6b-69db-4f16-ad46-7c88fd4e8c10&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXe5HZ4tiL_nVjtwxiqbzBEliN6R1jI6h5GoGhK0_DGBWp4d46ohXoYpgj0Pcud6Jjz-W3EiwsvH23i-XoyCpTbizCa8xtNEDclrJ8HqMvXiZGgl1OlF_94PdLqons1RdiTBbJxbMYERhVaq-wvxIon-YJRA?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 9: Table Agent.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;09fefa62-872a-420b-bb86-705b08a571b2&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;68044f0d-6fc4-4925-8384-178a1785da01&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The user would either select the “Looks Good” button or edit the existing list and modify the list of tables to be used by the LLM for query generation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;28f6a556-b474-4c60-81a1-ea13dee2dbe0&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;35299468-83bd-4b44-8960-b02078d580fc&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-column-prune-agent&#34;&gt;Column Prune Agent&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5c36fd6d-2fe8-4fc7-bac0-7cf5076b3e11&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Another interesting issue we ran into after rolling QueryGPT out to a larger set of users was the “intermittent” token size issue during query generation for some requests. We were using the OpenAI GPT-4 Turbo model with 128K token limit (1106), but were still seeing token limit issues because some requests included one or more tables that each consumed a large amount of tokens.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7d0c0540-504f-48bb-872e-02c34cf9caff&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To address this issue, we implemented a “Column Prune” agent, wherein we use an LLM call to prune the irrelevant columns from the schemas we provided to the LLM.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;6c14bed0-9cce-43fb-b02b-5cbcff2dae18&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Here’s what the output from the agent looks like:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b7c5982b-fadc-439a-a1cd-cee31f8fdcf8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;6087e6ad-9d13-455e-bb79-74c74e6c9a96&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXeKKZe_ie-slfFAA0v-BO7q8FPx370zQT1sKhHDur281yeKZMA6yvQ4QNWFWEftBzY8Zaq1nguEbE3fLbSOMoNrSN424rVb_L4pdZpB4iAjifXAHTNk5Q1UsZtlGFJxWJec5BAGCXMH71ZwbTrPQ0HEzTEQ?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 10: Column Prune Agent&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;2d80f47b-f517-4405-bc87-1a542c1db11e&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;22d287a2-8140-478c-a43b-25505258b600&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The output would include a skinnier version of each schema that we needed for query generation. This change massively improved not just the token size and by extension the cost of each LLM call, but also reduced the latency since the input size was much smaller.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;ad62c2da-2025-4f62-b4ed-a5c1cfa0d924&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;a3320a6c-fcf8-4627-802b-e5aeb17afa16&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-output&#34;&gt;Output&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fefd8ccf-6833-4250-a03c-110d8ba7db27&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;No changes were made to the output structure with the current design. The response would include a SQL Query and an explanation from the LLM about how the query was generated similar to what’s shown in Figure 7.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5a000f5e-295b-43cd-87d3-7c834c30bc80&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;49809270-e565-48fc-8734-352be50398ad&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-evaluation&#34;&gt;Evaluation&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c67b1093-265c-48ee-a005-0813be377523&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;To track incremental improvements in QueryGPT’s performance, we needed a standardized evaluation procedure. This enabled us to differentiate between repeated vs. anomalous shortcomings of the service and ensure algorithm changes were incrementally improving performance in aggregate.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;5901fe4e-9d5c-4646-a301-c8c02428f739&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-evaluation-set&#34;&gt;Evaluation Set&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e6b633b4-8f3d-4ffe-9290-ab4545fdaaf4&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Curating a set of golden question-to-SQL answer mappings for evaluation required manual upfront investment. We identified a set of real questions from the QueryGPT logs, and manually verified the correct intent, schemas required to answer the question, and the golden SQL. The question set covers a variety of datasets and business domains.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;6d60db9c-2fcd-4627-a2b2-d8a43562b6fa&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-evaluation-procedure&#34;&gt;Evaluation Procedure&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b0fca7e2-0aae-46cd-86df-60110f462749&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We developed a flexible procedure that can capture signals throughout the query generation process in production and staging environments using different product flows:&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;73fe5693-aa64-428d-a14d-598bc1dfa0b8&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/table&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9c2693aa-c1fc-4b4a-aed6-5174495a9f44&amp;quot;,&amp;quot;hasFixedLayout&amp;quot;:true,&amp;quot;head&amp;quot;:[],&amp;quot;body&amp;quot;:[],&amp;quot;foot&amp;quot;:[]}&#34; class=&#34;wp-block-table&#34;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;Product Flow&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;Purpose&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;Procedure&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Vanilla&lt;/td&gt;&lt;td&gt;Measures QueryGPT’s baseline performance.&amp;nbsp;&lt;/td&gt;&lt;td&gt;Input a question.QueryGPT infers the intent and datasets needed to answer the question.Generate the SQL using inferred datasets and intent.Evaluate intent, datasets, and SQL.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Decoupled&lt;/td&gt;&lt;td&gt;Measures QueryGPT performance with the human-in-the-loop experience. Enables component-level evaluation by removing dependencies on performance on earlier outcomes.&lt;/td&gt;&lt;td&gt;Input a question, intent, and datasets needed to answer the question.QueryGPT infers the intent and datasets.Generate the SQL using the actual (not inferred) intent and datasets.&amp;nbsp;Evaluate intent, datasets, and SQL.&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;844d8d03-39be-48ba-810d-ed59b92f9ce4&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;37b06925-8cea-40b2-bf69-c315b21c995e&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For each question in the evaluation, we capture the following signals:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;1c6015b5-b225-4d87-a67c-5d2310ddac62&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Intent:&lt;/strong&gt; Is the intent assigned to the question as accurate?&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7be425df-7a17-4112-8e11-3e2a36e3bba0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Table Overlap:&lt;/strong&gt; Are the tables identified via Search + Table Agent correct? This is represented as a score between 0 and 1. For example, if the query needed to answer the questions “How many trips were canceled by drivers last week in Los Angeles?” required the use of [&lt;em&gt;fact_trip_state&lt;/em&gt; , &lt;em&gt;dim_city&lt;/em&gt;], and QueryGPT identified [&lt;em&gt;dim_city, fact_eats_trip&lt;/em&gt;], the Search Overlap Score for this output would be 0.5, because one of the two tables required to answer the question was selected.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;66f0f059-dfc4-407c-b614-bf81837c9af5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Successful Run:&lt;/strong&gt; Does the generated query run successfully?&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;9f3cef08-b804-42f2-bc5c-cf7d26d5113b&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Run Has Output:&lt;/strong&gt; Does the query execution return &amp;gt; 0 records. (Sometimes, QueryGPT hallucinates filters like WHERE status = “Finished” when, the filter should have been WHERE status = “Completed” resulting in a successful run with no output).&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;52e39c00-7d1e-4771-9541-c57154014240&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;&lt;strong&gt;Qualitative Query Similarity:&lt;/strong&gt; How similar is the generated query relative to the golden SQL? We use an LLM to assign a similarity score between 0 and 1. This allows us to quickly see if a generated query that is failing for a syntactic reason is on the right track in terms of columns used, joins, functions applied, etc.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b48fa8e3-54ba-4fc2-bae2-6b22055eb2eb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We visualize progress over time to identify regressions and patterns revealing areas for improvement.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c2fb41ee-fbb6-42ec-800f-3317ae9302dd&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The figure below is an example of question-level run results enabling us to see repeated shortcomings at individual question level.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cbdd3499-3477-4b41-ac0c-33ec54373213&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;348px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;de1a4f25-f7cc-48d2-a77e-c6950d392f97&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXccdOmsynkpZ4KcgAN-f4lTMXzKGtojslRD5cszq2UdwOBCtdpERozd51i1FnmN00SHT4tdvAT6ZivKymWIIrhfTne8fUXkS_tZIHgliaohNDBATY8jOSap-pNBj4yQIT_0GHEOSn8S6g3YeIr2vNffZ8-I?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:348px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 11A: SQL Query Evaluation.&lt;br&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;46c7c91e-f8e1-4576-be48-edea51d4aad4&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;18fee675-385f-4742-9938-d3f57ad7330b&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXc1vtFiN4pyNtoVJc8y2T_o8bbHQX7-UG0ioS7rkAGVih7uWAbBytShk37OKfjVmu0UsVC9ThlEdIetEPKgj8c0x4MCssyApV--ulZVzmG3ZiQWE3GpHWjRXOhxAk0rMryNyufAhySPzi35dcqwZcQKl86A?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 11B: SQL Query Evaluation across environments.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;33cd3465-0d7b-4d11-91a5-0b697305044f&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;c7b817aa-4d4e-49e5-a71d-6dc74fa7b72a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;For each question, we can view the generated SQL, reason for the error, and related performance metrics. Below is a question whose generated query is regularly failing because it is not applying a partition filter in the where clause. However, according to the qualitative LLM-based evaluation, the generated SQL is otherwise similar to the golden SQL.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;45360b20-3f94-4b57-99d0-60b021998a1a&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;176a0706-d32f-44fe-b70f-14117127e67b&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd-05KYpUrcOPqKxNRoo6TT4P-q4nPo1AR7Bt4oceFEm9dJy2tz9g5GJbEqT0qpf_hbJaGZLBpqUBVLH_dqQ1GGW8xXLfzVvdIIIHoC2mGc8C23nuC2kWK6bqldi-mgZoxNvlO6JbO_wV0R2QnklbW-Dif2?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 12: SQL Evaluation Stats.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;04b0f0e6-274e-48a9-9f1d-d8938364a401&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;67682112-acbf-408d-b753-5ca6e49f32f5&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We also aggregate accuracy and latency metrics for each evaluation run to track performance over time.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;36078627-a789-48a7-bf5f-b6e7d032bb45&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&amp;quot;width&amp;quot;:&amp;quot;700px&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;auto&amp;quot;,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;0ca65ba1-9648-4c31-ae98-5ced8fe98681&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXdYG0RGLFMXqT8AHrOcUZsTFnWlA02vxOPEAIasdfbzJhFisn2-fGO3ahW9UZbWpL7L4u1qjsdzEr60UgY8ZQPYirtm71M-bwA_WX3sxw-3V5CoQh1KTo7j7dXMdO7Vkbyp9JztGWuP99uj43ArIDMawyk?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Figure 13: SQL Evaluation criterions.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;e52fb602-16a2-41e3-9cf4-cdbe5ecf0cb1&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;fadd0c17-a50c-4e2e-ad6b-a745d9df8378&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-limitations&#34;&gt;Limitations&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;49a7ec20-24a0-47b4-9c0a-26342195b744&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Due to the non-deterministic nature of LLMs, running the same evaluation with no changes to the underlying QueryGPT service can result in different outcomes. In general, we do not over-index decisions based on ~5% run-to-run changes in most metrics. Instead, we identify error patterns over longer time periods that can be addressed by specific feature improvements.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;fe896d92-3cc7-48fd-82e5-c8c35b597330&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Uber has hundreds of thousands of datasets with varying levels of documentation. Thus, it is impossible for the set of evaluation questions to fully cover the universe of business questions that a user may ask. Instead, we curated a set of questions that represent the current usage of the product. As we improve accuracy and new bugs arise, the evaluation set will evolve to capture the direction of the product.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;eb9e9b7a-b950-4310-9a65-ca866145d51a&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;There is not always one correct answer. Often, the same question could be answered by querying different tables or writing queries in different styles. By visualizing the golden vs. returned SQL and using the LLM-based evaluation score, we can understand if the generated query is written in a different style, but has a similar intent related to the golden SQL.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;d654b0fa-3911-4d5a-b063-a08a256da9de&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;a48db9ec-daee-4411-89f9-f1a08e7d023f&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-learnings&#34;&gt;Learnings&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;3cab4b48-6ad3-4a4a-9f31-0f236019b5ba&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Working with nascent technologies like GPTs and LLMs over the past year allowed us to experiment and learn a lot of different nuances of how agents and LLMs use data to generate responses to user questions. We’ve briefly described below some of the learnings from our journey:&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;cac6df94-1908-4171-ae84-1f933148d1c4&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-llms-are-excellent-classifiers&#34;&gt;LLMs are excellent classifiers&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7ad4a5d4-d72f-4c36-952a-0bed88699fac&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Our intermediate agents that we used in QueryGPT to decompose the user’s natural language prompt into better signals for our RAG improved our accuracy a lot from the first version and a lot of it was due to the fact that the LLMs worked really well when given a small unit of specialized work to do.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;00b9e128-c899-4b26-ab48-77ac14026e96&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The intent agent, table agent, and column prune agent each did an excellent job because they were asked to work on a single unit of work rather than a broad generalized task.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;2c2c5240-a771-4f89-abf5-28321ce28330&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-hallucinations&#34;&gt;Hallucinations&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;18098f4a-1ca8-4a96-a6e2-988fc58813cc&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;This remains an area that we are constantly working on, but in a nutshell, we do see instances where the LLM would generate a query with tables that don’t exist or with columns that don’t exist on those tables.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;7920ad06-2623-4706-a0d0-c9ee71cf5012&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;We’ve been experimenting with prompts to reduce hallucinations, introduced a chat style mode where users can iterate on the generated query and are also looking to include a “Validation” agent that recursively tries to fix hallucinations, but this remains an area that we haven’t completely solved yet.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;0a5fcc9b-322f-4a6d-a79a-6dadf80fccf7&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-user-prompts-are-not-always-context-rich&#34;&gt;User prompts are not always “context”-rich&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;546499a4-c289-478b-adfc-31edd877bdbe&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Questions entered by the users in QueryGPT ranged from very detailed with the right keywords to narrow the search radius to a 5 word question (with typos) to answer a broad question that would require joins across multiple tables.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;33186177-6cb8-42ae-a1cd-5a959a95203c&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;Solely relying on user questions as “good” input to the LLM caused issues with accuracy and reliability. A “prompt enhancer” or “prompt expander” was needed to “massage” the user question into a more context-rich question before we sent those to the LLM.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:3,&amp;quot;hash&amp;quot;:&amp;quot;9f670540-0564-4c3a-a1dc-c263263f0220&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-high-bar-for-sql-output-generated-by-the-llm&#34;&gt;High bar for SQL output generated by the LLM&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5348bcb2-8b9b-4332-b614-2e87542629bb&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;While this version of QueryGPT is helpful for a broad set of personas, there is definitely an expectation from many that the queries produced will be highly accurate and “just work.” The bar is high!&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;4f6a07df-d622-4adb-949d-b931e4746811&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;In our experience, we found that it was best to target and test with the right persona(s) as your initial user base when building a product like this.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;0991e158-aca7-4941-bf2a-5c611ca9d4c9&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;level&amp;quot;:1,&amp;quot;hash&amp;quot;:&amp;quot;02630760-d3f5-4166-bf76-7442565ad923&amp;quot;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;b189a3fd-91b7-4801-a5fb-c3f9d5b22614&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;The development of QueryGPT at Uber has been a transformative journey, significantly enhancing productivity and efficiency in generating SQL queries from natural language prompts. Leveraging advanced generative AI models, QueryGPT seamlessly integrates with Uber’s extensive data ecosystem, reducing query authoring time and improving accuracy, addressing both the scale and complexity of our data needs.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;19347b08-51ca-4d8c-ad2a-915513abeff0&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;While challenges such as handling large schemas and reducing hallucinations persist, our iterative approach and constant learning have enabled continuous improvements. QueryGPT not only simplifies data access but also democratizes it, making powerful data insights more accessible across various teams within Uber.&amp;nbsp;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;cb86e603-2f0c-41fe-9d46-cc278cddf8cf&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;With our limited release to some teams in Operations and Support, we are averaging about 300 daily active users, with about 78% saying that the generated queries have reduced the amount of time they would’ve spent writing it from scratch.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;431ca7ef-0bb3-4a23-87df-b903178e79da&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34;&gt;As we look forward, the integration of more sophisticated AI techniques and user feedback will drive further enhancements, ensuring that QueryGPT remains a vital tool in our data platform.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;8201e8b8-465b-4565-97bd-3d4b4cf67c21&amp;quot;,&amp;quot;opacity&amp;quot;:&amp;quot;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&amp;quot;hash&amp;quot;:&amp;quot;5d465de2-dafa-46f0-82aa-073654ce1bd1&amp;quot;,&amp;quot;level&amp;quot;:2}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-acknowledgements-nbsp&#34;&gt;Acknowledgements&amp;nbsp;&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&amp;quot;fontSize&amp;quot;:&amp;quot;small&amp;quot;,&amp;quot;hash&amp;quot;:&amp;quot;02707c3a-ea37-40cf-b242-32dfb606de76&amp;quot;,&amp;quot;dropCap&amp;quot;:false}&#34; class=&#34;has-small-font-size&#34;&gt;QueryGPT was a cross-discipline effort across Uber, requiring expertise and domain knowledge from folks working in Engineering, Product Management and Operations. The product wouldn’t exist today without the great contributions by Abhi Khune, Callie Busch, Jeffrey Johnson, Pradeep Chakka, Saketh Chintapalli, Adarsh Nagesh, Gaurav Paul and Ben Carroll.&lt;/p&gt;】&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;e735bd6b-558b-4301-a92b-9fba35e6bc65&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-introduction&#34;&gt;简介&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;eb484efe-378c-40e0-af57-14bd8a10b396&#34;,&#34;dropCap&#34;:false}&#34;&gt;SQL 是Uber 的工程师、运营经理和数据科学家每天使用它来访问和操作 TB 数据的重要工具。制作这些查询不仅需要对 SQL 语法有深入的了解，还需要深入了解我们的内部数据模型如何表示业务概念。 QueryGPT旨在弥合这一差距，使用户能够通过自然语言提示生成SQL查询，从而显着提高生产力。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f224d2da-b02d-4ff2-b219-0fdc1f5cab39&#34;,&#34;dropCap&#34;:false}&#34;&gt;QueryGPT 使用大语言模型 (LLM)、向量数据库和相似性搜索，用于根据用户提供的英语问题作为输入生成复杂的查询。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2a651aaf-0a58-4385-b7da-05a4eeb8d4e4&#34;,&#34;dropCap&#34;:false}&#34;&gt;本文记录我们过去一年的发展历程以及我们今天的愿景。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b60d0020-1daa-4a5e-97a6-98f869f533b4&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-motivation&#34;&gt;动机&lt;/h2&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;53bb688c-ff1f-4bb8-a317-e04e6185daa5&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXcC2OH7JIyWjT68dWjQgaxz8SbmhQVz-ARB4M6bOYRV0bIxLS7ellpYioGaYm7PewbHzme4l2r1rqwellO74eax1CyGrRPtbAY17X1aUQDx9Lp00mLsgWIOW9q6fJzH8U54Npxl TFEdbEA_QITC755FAAsH?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 1：查询创作过程。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;baefce90-b4db-4613-95b6-d55bbe7b3f4c&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f5a98fa3-88bc-494c-833c-892a333b2748&#34;,&#34;dropCap&#34;:false}&#34;&gt;在 Uber，我们的数据平台每月处理大约 120 万次交互式查询。运营组织是最大的用户群体之一，贡献了约 36% 的查询。编写这些查询通常需要公平的时间在数据字典中搜索相关数据集和在编辑器中编写查询之间的时间量。鉴于编写每个查询大约需要 10 分钟，引入 QueryGPT 可以自动执行此过程并在大约 3 分钟内生成可靠的查询，这代表了生产力的重大提升。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;025f314b-d91a-4eab-9e39-223a072900a7&#34;,&#34;dropCap&#34;:false}&#34;&gt;如果我们保守估计，每个查询大约需要 10 分钟来编写，QueryGPT 可以自动化此过程，并在大约 3 分钟内提供足够可靠的查询。这将为 Uber 带来显着的生产力提升。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a9b8789e-02b4-4aa6-9888-946c91bfd0df&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096044,&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;sizeSlug&#34;:&#34;大&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;align&#34;:&#34;中心&#34;,&#34;散列&#34;:&#34;b1b68651-445c-4842-a62b-a8df8ab6c7cb&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img 加载=“惰性”解码=“异步”宽度=“1024”高度=“429”src=“https://blog.uber-cdn.com/cdn-cgi/image/width= 2160、质量=80、onerror=重定向、格式=自动/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445-1024x429.jpeg&#34; alt=&#34;&#34; class=&#34;wp-image-1096044 “ style=”width:700px;height:auto” srcset=”https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp -content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300，quality=80，onerror=重定向，format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 300w，https://blog.uber-cdn.com/cdn-cgi/image/width=768 ，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 768w，https://blog.uber-cdn.com/cdn- cgi/image/width=1276,quality=80,onerror=redirect,format=auto/wp-content/uploads/2024/09/figure-1-querybuilder-usage-17265653056445.jpeg 1276w&#34; 尺寸=&#34;(最大宽度: 1024px) 100vw, 1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 2：Querybuilder 用法。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ca26529d-ff05-4a61-adf8-800507582c78&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;id&#34;:1096046,&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;sizeSlug&#34;:&#34;大&#34;,&#34;linkDestination&#34;:&#34;无&#34;,&#34;对齐&#34;:&#34;中心&#34;,&#34;哈希&#34;:&#34;48d4a1db-0ee0-4040-810f-2b4111ffbf0b&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34; aligncenter size-large is-resized&#34;&gt;&lt;imgloading=“lazy”解码=“async”宽度=“1024”高度=“387”src=“https://blog.uber-cdn.com/cdn-cgi/图像/宽度=2160，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592-1024x387.jpeg&#34; alt=&#34;&#34; class=&#34;wp -image-1096046&#34; style=&#34;width:700px;height:auto&#34; srcset=&#34;https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format =auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 1024w，https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality= 80，onerror=重定向，format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 300w，https://blog.uber-cdn.com/cdn-cgi/image /width=768，quality=80，onerror=redirect，format=auto/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 768w，https://blog.uber-cdn。 com/cdn-cgi/image/width=1272，质量=80，onerror=重定向，格式=自动/wp-content/uploads/2024/09/figure-2-querygpt-impact-17265653352592.jpeg 1272w“尺寸=” （最大宽度：1024px）100vw，1024px&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 3：QueryGPT 影响。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;97932bcf-6d95-412f-8ea8-1d286dbb0f78&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6581dfd0-5bfd-48c1-b8e7-a00a9a44c0aa&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-architecture&#34;&gt;架构&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;aa0702df-39bb-4e7c-8eb9-d5435da45c75&#34;,&#34;dropCap&#34;:false}&#34;&gt;QueryGPT 源自这是 2023 年 5 月 Uber Generative AI Hackdays 期间的一项提案。从那时起，我们迭代地完善了 QueryGPT 背后的核心算法，将其从概念转变为生产就绪的服务。下面，我们详细介绍 QueryGPT 的演变及其当前架构，重点介绍关键增强功能。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cf501d3d-beaf-4ad6-930f-219adc58ff82&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们已经下面描述了我们当前版本的 QueryGPT。请记住，下面详细介绍的 2 次算法之间大约有 20 多次迭代，如果我们要列出并描述每个迭代，这篇博客文章的长度将使 Ayn Rand 的 &lt;em&gt;Atlas Shrugged&lt;/em&gt; 相形见绌.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a980128d-4d7f-4361-9cdc-4f0a5d55f728&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;a306c97a-e64b-4f92-8b70-79aaca67cf84&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-hackdayz-version-1&#34;&gt;Hackdayz（版本 1）&lt;/h3&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;e07c37f7-b2ca-45c9-af49-d2e559f91221&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXdBuoSw4-YUqiwCVg-oD6Ov6Cx9PCnOCQKikBooaMttGGhDJAbsmJU19_bhlIZGE-lTX2YVZXaejXc3nuJoKVnuP8Fhq6bySTfmgn2-Srxhsa0fPxWTyPMshWKtrfoSilJnXGXQ5WL137- t0rf3-EdYUdyA?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34; wp-element-caption&#34;&gt;图 4：QueryGPT Hackdayz 版本&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;16e124f2-00b4-4145-98e2-3c17b14d6873&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;69c8f8d1-8176-43c8-8d53-ea406e49c0df&#34;,&#34;dropCap&#34;:false}&#34;&gt;第一个版本QueryGPT 依赖于一个相当简单的 RAG 来获取我们需要包含在对 LLM（Few Shot Prompting）的查询生成调用中的相关样本。我们将获取用户的自然语言提示，对其进行向量化，并对 SQL 示例和模式进行相似性搜索（使用 k 最近邻搜索），以获取 3 个相关表和 7 个相关 SQL 示例。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e68f2468-74cc-4c2b-82a0-93e73ad70643&#34;,&#34;dropCap&#34;:false}&#34;&gt;第一个版本使用 7 个 1 层表和 20 个 SQL 查询作为我们的示例数据集。 SQL 查询应该提供关于如何使用所提供的表模式的 LLM 指导，并且表模式提供有关这些表上存在的列的 LLM 信息。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1c42885a-f676-434b-a7de-3587222251a5&#34;,&#34;dropCap&#34;:false}&#34;&gt;例如，对于第 1 层表 &lt;em&gt;uber.trips_data&lt;/em&gt;（不是真实的表），架构如下所示：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e2e04fd9-2c4f-456c-b979-6b074618d4d8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;685394a5-0bce-4fda-bcb7-3c9f526e9ff8&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXcv35PJRLqPvFrcSQUwvxQqutjd0mT_vauGDqqY5CESrguVm845_6Ife4azUiuhodUKRND7WNwdOIcnraAGEfco5b4puw1uC3a-hQzYGBGYI Zul3KD0MB7zcrbgJG2pCE8uItfdre19hVCd6WxbjFNNX1-i?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height: auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 5：uber.trips_data 表。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1707de5e-8545-4535-8831-14ff942e11ce&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;11f17948-81df-4982-badd-dbca4261bdac&#34;,&#34;dropCap&#34;:false}&#34;&gt;帮助LLM 了解内部 Uber 术语并使用 Uber 数据集，我们还在 LLM 调用中包含了一些自定义指令。下面显示的是我们希望法学硕士如何处理日期的片段：&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;a42b8d62-db59-4ac9-a921-30e012a8b378&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXeZMYZI9LdwW_GU31hqaswX7jMwtaQZL0Vuyo2ExTpUo-MKpeN3Qj_q14-aEgueHMqT9JRHryH6fWssismaF2N768dmaD9KE6xZQhO4Fyb-srNa1YoGNfiyTAh-GTEYWcpKTsVfp_ 8US8jpKkiAsRejPsR1?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element- title&#34;&gt;图 6：处理 Uber 数据集中日期的自定义指令。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ab0aed50-802e-4e17-95f2-ae6aedb3e5c2&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a09c0daf-d5f1-4fea-be38-02ec7656f366&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们会换行所有相关的模式示例、SQL 示例、用户的自然语言提示以及围绕系统提示的 Uber 业务说明，并将请求发送给 LLM。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;11e599d5-2a2c-42b1-b0ad-310cb1de7b35&#34;,&#34;dropCap&#34;:false}&#34;&gt;响应将包括“SQL 查询”和 LLM 如何生成查询的“说明”：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1c3f9567-ad6f-40f9-b8bc-80a94f3eb950&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&amp;quot;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;7b817659-3a61-49a3-b0fb-9b7c5c1505c3&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img解码=“异步”src=“https://lh7-rt.googleusercontent.com/docsz/AD_4nXega7yHLmgA8wlGBdnBqbco16GQV7SeKdOCtUbGD1E1ZhuglOZ0P47UDHXvj99RDm-ndeh1GgWWMxKQx8kDKZZYZLEryCFFSEi3pGrUF1vMD9RSzrbMNH ta6SZ38hXddp8tHy-iSHccFYFgmrInQKlAfc8?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34; no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 7：生成的带有解释的 SQL。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c42500bc-5a08-440b-983b-843e36e3269b&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;84b98147-4a93-4ddd-9098-9b6f3e2371e1&#34;,&#34;dropCap&#34;:false}&#34;&gt;虽然此版本该算法的算法对于一小组模式和 SQL 示例运行良好，当我们开始将更多表及其关联的 SQL 示例添加到服务中时，我们开始看到生成的查询的准确性下降。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0df8653a-d050-48c7-96db-3f304a03369d&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;feeb6cb0-3a63-4949-8813-c1d57306a63f&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-better-rag&#34;&gt;更好的 RAG&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8c219406-9327-41b9-80fd-671f5c74f2eb&#34;,&#34;dropCap&#34;:false}&#34;&gt;做一个简单的对模式示例（&lt;em&gt;CREATE TABLE&lt;/em&gt;...）和 SQL 查询（&lt;em&gt;SELECT a, b, c FROM uber.foo &lt;/em&gt;...) 不返回相关结果。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;ed25814d-9f75-4fba-8bd1-dc78df2dd7b2&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-understanding-user-s-intent&#34;&gt;了解用户意图&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1e71a70f-8c29-4964-80ec-99d74b347ba0&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的另一个问题我们发现从用户的自然语言提示到找到相关模式是非常具有挑战性的。我们需要的是一个中间步骤，它将用户的提示分类为映射到相关架构和 SQL 示例的“意图”。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;02705018-fca5-4181-a29e-474bdc114c29&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-handling-large-schemas&#34;&gt;哈ndling 大型模式&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;82be2c49-fc74-4aff-81b5-96f5c48123c1&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们有一些Uber 的一些第 1 层表上的架构非常大，其中一些跨越 200 列。这些大型表可能会在请求对象中使用多达 40-60K 的令牌。拥有 3 个或更多这样的表将破坏 LLM 调用，因为最大的可用模型（当时）仅支持 32K 令牌。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a461a6ed-9e9e-43d6-88ca-8677920dc47d&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;651e011c-62e0-434d-bf63-5aea7e878acd&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-current-design&#34;&gt;当前设计&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;77cb3666-0e69-4200-89b2-02b7c85c5b3a&#34;,&#34;dropCap&#34;:false}&#34;&gt;下图显示了我们在生产中运行的 QueryGPT 的当前设计。当前版本包含与第一个版本相比的许多迭代更改。&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;f0c52e7a-e247-4213-bb8b-8a6d1613ce65&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXctJlWIn-wn89ptfWpK2OrhH9sVIkP5OqSthEr21ZoybaECaxE5GATRUNJX8ElX1O DGz1N2JHcg0sYjN1QXIi9T-_Ex6VjVUunGJ8s5SW2D5gaEUme4Skh3NrVqjmIazQZPJ17XhJ2JJwo3FfqpLh8JD9j4?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 8：QueryGPT（当前）。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c6320027-f65a-476a-903e-367​​a1a1300ac&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;2e3c3d0c-e4e8-42c9-91a4-6a44c74d54f2&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-workspaces&#34;&gt;工作区&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1ed49b96-6676-4e81-bf7d-0c556fb024bc&#34;,&#34;dropCap&#34;:false}&#34;&gt;在我们当前的在设计中，我们引入了“工作区”，它是针对特定业务领域（例如广告、移动性和核心服务）量身定制的 SQL 示例和表格的精选集合。这些工作区有助于缩小法学硕士的关注范围，提高生成查询的相关性和准确性。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;621f9d8c-b8f7-459b-8a34-cf2c979fbcd4&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们已经确定了 U 内部一些更常见的业务领域ber 并在后端将其创建为“系统工作区”。  移动性是我们确定为可用于查询生成的基础域的系统工作区之一。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;40ccaf2a-b154-4919-a164-6b5bb7267f30&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt; &lt;em&gt;移动性&lt;/em&gt;&lt;/strong&gt;：包括行程、司机、文档详细信息等的查询。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/table&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fc77e064-4516-45a8-bac0-a244ae55e605&#34;,&#34;hasFixedLayout&#34;:true,&#34;head&#34;:[ ],&#34;body&#34;:[],&#34;foot&#34;:[]}&#34; class=&#34;wp-block-table&#34;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;将&lt;strong&gt;a&lt;/strong&gt;查询写入查找昨天&lt;strong&gt;&lt;/strong&gt;特斯拉在&lt;/strong&gt;西雅图&lt;strong&gt;完成的&lt;strong&gt;出行次数&lt;/td&gt;&lt;/tr&gt;&lt; /tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;96a999fa-1a1d-483a-a2b3-2289e2eaf41c&#34;,&#34;dropCap&#34;:false}&#34;&gt;还有这些，我们还推出了其他 11 个系统工作区，包括“核心服务”、“平台工程”、“IT”、“广告”等。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;03ab4f6d-f230-419f-b99d-e9064462e72e&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们还包括如果现有系统工作区都不符合用户的要求，则允许用户创建“自定义工作区”并使用这些工作区来生成查询。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ec194bba-bc61-46c2-91de-f269f31851d3&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;ad296232-7118-4e6d-8353-d16b35e40f2b&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-intent-agent&#34;&gt;意向代理&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9c9515c9-371b-46a4-a087-c9df6f41e7cb&#34;,&#34;dropCap&#34;:false}&#34;&gt;每个传入提示现在，用户首先通过“意图”代理运行。此意图代理的目的是将用户的问题映射到一个或多个业务域/工作区（并通过扩展映射到该域的一组 SQL 示例和表）。我们使用 LLM 调用从用户问题中推断意图，并将其映射到“系统”工作区或“自定义”工作区。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a97a543b-072c-4538-b64f-f4217acf4c22&#34;,&#34;dropCap&#34;:false}&#34;&gt;选择商家域使我们能够大大缩小 RAG 的搜索半径。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;f8a6a800-3138-4111-9cc8-d2f736961781&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp块分隔符”具有 alpha 通道不透明度&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;996e7798-8d39-4add-adec-dc7a6ee4cdb2&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-table-agent&#34;&gt;表代理&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8ab1add6-aa91-419e-9287-0d5549a95170&#34;,&#34;dropCap&#34;:false}&#34;&gt;允许用户选择查询生成中使用的表是一些用户的反馈，他们发现 QueryGPT 最终选择的表不正确。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6d2a216b-7995-463c-af9f-ffe50188b17e&#34;,&#34;dropCap&#34;:false}&#34;&gt;解决此问题反馈，我们添加了另一个 LLM 代理（表代理），它将选择正确的表并将其发送给用户以“ACK”或编辑给定的列表并设置正确的表表。用户将看到的屏幕截图如下所示：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;303e6130-d5f0-44fa-8489-012c7f4cca45&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;160a0a6b-69db-4f16-ad46-7c88fd4e8c10&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src =“https://lh7-rt.googleusercontent.com/docsz/AD_4nXe5HZ4tiL_nVjtwxiqbzBEliN6R1jI6h5GoGhK0_DGBWp4d46ohXoYpgj0Pcud6Jj z-W3EiwsvH23i-XoyCpTbizCa8xtNEDclrJ8HqMvXiZGgl1OlF_94PdLqons1RdiTBbJxbMYERhVaq-wvxIon-YJRA?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 9：表代理。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;09fefa62-872a-420b-bb86-705b08a571b2&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;68044f0d-6fc4-4925-8384-178a1785da01&#34;,&#34;dropCap&#34;:false}&#34;&gt;用户会选择“看起来不错”按钮，或者编辑现有列表并修改 LLM 用于查询生成的表列表。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;28f6a556-b474-4c60-81a1-ea13dee2dbe0&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;35299468-83bd-4b44-8960-b02078d580fc&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-column-prune-agent&#34;&gt;列修剪代理&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5c36fd6d-2fe8-4fc7-bac0-7cf5076b3e11&#34;,&#34;dropCap&#34;:false}&#34;&gt;另一个有趣的在将 QueryGPT 推广到更多用户后，我们遇到的一个问题是在某些请求的查询生成期间出现“间歇性”令牌大小问题。我们使用具有 128K 令牌限制 (1106) 的 OpenAI GPT-4 Turbo 模型，但仍然遇到令牌限制问题，因为某些请求包含一个或多个表，每个表消耗大量令牌。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7d0c0540-504f-48bb-872e-02c34cf9caff&#34;,&#34;dropCap&#34;:false}&#34;&gt;解决此问题问题中，我们实现了一个“Column Prune”代理，其中我们使用 LLM 调用来从我们提供给 LLM 的模式中删除不相关的列。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;6c14bed0-9cce-43fb-b02b-5cbcff2dae18&#34;,&#34;dropCap&#34;:false}&#34;&gt;这是代理的输出如下所示：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b7c5982b-fadc-439a-a1cd-cee31f8fdcf8&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;6087e6ad-9d13-455e-bb79-74c74e6c9a96&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXeKKZe_ie-slfFAA0v-BO7q8FPx370zQT1sKhHDur281yeKZMA6yvQ4QNWFWEftBzY8Zaq1nguEbE3fLbSOMoNrSN424rVb_L4pdZpB4iAjifXAHTNk5Q1UsZtlGFJxWJec5BAGC XMH71ZwbTrPQ0HEzTEQ?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图10：列修剪剂&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;2d80f47b-f517-4405-bc87-1a542c1db11e&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;22d287a2-8140-478c-a43b-25505258b600&#34;,&#34;dropCap&#34;:false}&#34;&gt;输出将包括我们生成查询所需的每个模式的精简版本。这一变化不仅极大地改善了令牌大小并扩展了每个 LLM 调用的成本，而且还减少了延迟，因为输入大小要小得多。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;ad62c2da-2025-4f62-b4ed-a5c1cfa0d924&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;a3320a6c-fcf8-4627-802b-e5aeb17afa16&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-output&#34;&gt;输出&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;核心/段落&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fefd8ccf-6833-4250-a03c-110d8ba7db27&#34;,&#34;dropCap&#34;:false}&#34;&gt;当前设计未对输出结构进行任何更改。响应将包括一个 SQL 查询以及来自 LLM 的关于如何生成查询的解释，类似于图 7 所示。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5a000f5e-295b-43cd-87d3-7c834c30bc80&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;49809270-e565-48fc-8734-352be50398ad&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-evaluation&#34;&gt;评估&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c67b1093-265c-48ee-a005-0813be377523&#34;,&#34;dropCap&#34;:false}&#34;&gt;跟踪增量为了提高 QueryGPT 的性能，我们需要一个标准化的评估程序。这使我们能够区分服务的重复缺陷和异常缺陷，并确保算法更改能够逐步提高总体性能。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;5901fe4e-9d5c-4646-a301-c8c02428f739&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-evaluation-set&#34;&gt;评估集&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e6b633b4-8f3d-4ffe-9290-ab4545fdaaf4&#34;,&#34;dropCap&#34;:false}&#34;&gt;策划一组用于评估的黄金问题到 SQL 答案的映射需要手动前期投资。我们从 QueryGPT 日志中识别出一组真实问题，并手动验证正确的意图、回答问题所需的模式以及黄金 SQL。问题集涵盖了各种数据集和业务领域。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;6d60db9c-2fcd-4627-a2b2-d8a43562b6fa&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-evaluation-procedure&#34;&gt;评估程序&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b0fca7e2-0aae-46cd-86df-60110f462749&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们开发了一个灵活的过程，可以使用不同的产品流在生产和登台环境中的整个查询生成过程中捕获信号：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;73fe5693-aa64-428d-a14d-598bc1dfa0b8&#34;,&#34;opacity&#34;:&#34;alpha 通道&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure data-wp-block-name=&#34;core/table&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9c2693aa-c1fc-4b4a-aed6-5174495a9f44&#34;,&#34;hasFixedLayout&#34;:true,&#34;head&#34;:[ ],&#34;body&#34;:[],&#34;foot&#34;:[]}&#34; class=&#34;wp-block-table&#34;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;产品流程&lt;/strong&gt;&lt;/ td&gt;&lt;td&gt;&lt;强g&gt;目的&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;过程&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;普通&lt;/td&gt;&lt;td&gt;测量 QueryGPT 的基准性能。 &lt;/td&gt;&lt;td&gt;输入问题。QueryGPT 推断回答问题所需的意图和数据集。使用推断的数据集和意图生成 SQL。评估意图、数据集和 SQL。&lt;/td&gt;&lt;/tr&gt;&lt;tr &gt;&lt;td&gt;解耦&lt;/td&gt;&lt;td&gt;通过人机交互体验来衡量 QueryGPT 性能。通过消除对早期结果的性能依赖性来实现组件级评估。&lt;/td&gt;&lt;td&gt;输入回答问题所需的问题、意图和数据集。QueryGPT 推断意图和数据集。使用实际（而不是推断）意图和数据集。 评估意图、数据集和 SQL。&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;844d8d03-39be-48ba-810d-ed59b92f9ce4&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;37b06925-8cea-40b2-bf69-c315b21c995e&#34;,&#34;dropCap&#34;:false}&#34;&gt;对于每个问题在评估中，我们捕捉到以下信号：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;1c6015b5-b225-4d87-a67c-5d2310ddac62&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;意图：分配给问题的意图是否准确？ &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7be425df-7a17-4112-8e11-3e2a36e3bba0&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;表重叠：通过搜索+表代理识别的表是否正确？这表示为 0 到 1 之间的分数。例如，如果查询需要回答“上周洛杉矶有多少趟行程被司机取消”的问题。需要使用 [&lt;em&gt;fact_trip_state&lt;/em&gt;、&lt;em&gt;dim_city&lt;/em&gt;] 和 QueryGPT 识别的 [&lt;em&gt;dim_city、fact_eats_trip&lt;/em&gt;]，此输出的搜索重叠得分将为 0.5 ，因为选择了回答问题所需的两个表之一。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;66f0f059-dfc4-407c-b614-bf81837c9af5&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;成功运行：生成的查询是否成功运行？ &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;9f3cef08-b804-42f2-bc5c-cf7d26d5113b&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;运行有输出：&lt;/strong&gt;查询执行是否返回 &gt; 0 条记录。 （有时，QueryGPT 会产生像 WHERE status =“Finished”这样的过滤器，而过滤器本应是 WHERE status =“Completed”，从而导致成功运行但没有输出）。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;52e39c00-7d1e-4771-9541-c57154014240&#34;,&#34;dropCap&#34;:false}&#34;&gt;&lt;strong&gt;夸查询相似度：生成的查询相对于黄金 SQL 有多相似？我们使用 LLM 分配 0 到 1 之间的相似度分数。这使我们能够快速查看因语法原因而失败的生成查询在使用的列、连接、应用的函数等方面是否处于正确的轨道上。&lt; /p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b48fa8e3-54ba-4fc2-bae2-6b22055eb2eb&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们可视化进度随着时间的推移，识别回归和模式，揭示需要改进的领域。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c2fb41ee-fbb6-42ec-800f-3317ae9302dd&#34;,&#34;dropCap&#34;:false}&#34;&gt;下图是问题级运行结果的示例，使我们能够看到单个问题级重复出现的缺陷。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cbdd3499-3477-4b41-ac0c-33ec54373213&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;348px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;de1a4f25-f7cc-48d2-a77e-c6950d392f97&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXccdOmsynkpZ4KcgAN-f4lTMXzKGtojslRD5cszq2UdwOBCtdpERozd51i1FnmN00 SHT4tdvAT6ZivKymWIIrhfTne8fUXkS_tZIHgliaohNDBATY8jOSap-pNBj4yQIT_0GHEOSn8S6g3YeI r2vNffZ8-I?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:348px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34; &gt;图 11A：SQL 查询评估。&lt;br&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;46c7c91e-f8e1-4576-be48-edea51d4aad4&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;18fee675-385f-4742-9938-d3f57ad7330b&#34;,&#34;alt&#34; ：&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXc1vtFiN4pyNtoVJc8y2T_o8bbHQX7-UG0ioS7rkAGVih7uWAbBytShk37OKfjVmu0UsVC9ThlEdIetEPKgj8c0x4MCssyApV --ulZVzmG3ZiQWE3GpHWjRXOhxAk0rMryNyufAhySPzi35dcqwZcQKl86A?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 11B：跨环境的 SQL 查询评估。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;33cd3465-0d7b-4d11-91a5-0b697305044f&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p 数据可湿性粉剂块k-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;c7b817aa-4d4e-49e5-a71d-6dc74fa7b72a&#34;,&#34;dropCap&#34;:false}&#34;&gt;对于每个问题，我们可以查看生成的SQL、错误原因以及相关性能指标。下面是一个问题，其生成的查询经常失败，因为它没有在 where 子句中应用分区过滤器。然而，根据基于 LLM 的定性评估，生成的 SQL 在其他方面与黄金 SQL 类似。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;45360b20-3f94-4b57-99d0-60b021998a1a&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;align&#34;:&#34;center&#34;,&#34;hash&#34;:&#34;176a0706-d32f-44fe-b70f-14117127e67b&#34;,&#34;alt&#34; :&#34;&#34;}&#34; class=&#34;aligncenter&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent.com/docsz/AD_4nXd-05KYpUrcOPqKxNRoo6TT4P-q4nPo1AR7Bt4oceFEm9dJy2tz9g5GJbEqT0qpf_hbJaGZLBpqUBVLH_dqQ1GGW8xXLfzV vdIIIHoC2mGc8C23nuC2kWK6bqldi-mgZoxNvlO6JbO_wV0R2QnklbW-Dif2?key=FDiTashaNIm84IIOQgmW9w&#34; 替代=&#34;&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;图 12：SQL 评估统计信息。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;04b0f0e6-274e-48a9-9f1d-d8938364a401&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;67682112-acbf-408d-b753-5ca6e49f32f5&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们还汇总了每次评估运行的准确性和延迟指标，以跟踪一段时间内的性能。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;36078627-a789-48a7-bf5f-b6e7d032bb45&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure data-wp-block-name=&#34;core/image&#34; data-wp-block=&#34;{&#34;width&#34;:&#34;700px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;align&#34;:&#34;center&#34;,&#34;hash&#34; :&#34;0ca65ba1-9648-4c31-ae98-5ced8fe98681&#34;,&#34;alt&#34;:&#34;&#34;}&#34; class=&#34;aligncenter is-resized&#34;&gt;&lt;img 解码=&#34;async&#34; src=&#34;https://lh7-rt.googleusercontent. com/docsz/AD_4nXdYG0RGLFMXqT8AHrOcUZsTFnWlA02vxOPEAIasdfbzJhFisn2-fGO3ahW9UZbWpL7L4u1qjsdzEr60UgY8ZQPYirtm71M-bwA_WX3sxw-3V5CoQh1KTo7j7dXMdO7V kbyp9JztGWuP99uj43ArIDMawyk?key=FDiTashaNIm84IIOQgmW9w&#34; alt=&#34;&#34; style=&#34;width:700px;height:auto&#34;referrerpolicy=&#34;no-referrer&#34;&gt;&lt;figcaption class=&#34;wp-element-caption&#34; &gt;图13：SQL评估标准。&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;e52fb602-16a2-41e3-9cf4-cdbe5ecf0cb1&#34;,&#34;opacity&#34;:&#34;alpha-channel&amp;quot;}&#34; class=&#34;wp-block-separator has-alpha-channel-opacity&#34;&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;fadd0c17-a50c-4e2e-ad6b-a745d9df8378&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-limitations&#34;&gt;限制&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;49a7ec20-24a0-47b4-9c0a-26342195b744&#34;,&#34;dropCap&#34;:false}&#34;&gt;由于由于 LLM 的不确定性，在不对底层 QueryGPT 服务进行任何更改的情况下运行相同的评估可能会导致不同的结果。一般来说，我们不会根据大多数指标中大约 5% 的运行变化来过度索引决策。相反，我们会识别较长时间内的错误模式，这些模式可以通过特定的功能改进来解决。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;fe896d92-3cc7-48fd-82e5-c8c35b597330&#34;,&#34;dropCap&#34;:false}&#34;&gt;Uber 有数百个具有不同级别文档的数千个数据集。因此，评估问题集不可能完全涵盖用户可能提出的所有业务问题。相反，我们策划了一组代表产品当前使用情况的问题。随着我们提高准确性和新错误的出现，评估集将不断发展以捕获产品的方向。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;eb9e9b7a-b950-4310-9a65-ca866145d51a&#34;,&#34;dropCap&#34;:false}&#34;&gt;没有总是有一个正确答案。通常，可以通过查询不同的表或以不同的样式编写查询来回答同一问题。通过可视化黄金 SQL 与返回的 SQL 并使用基于 LLM 的评估分数，我们可以了解生成的查询是否以不同的风格编写，但与黄金 SQL 具有相似的意图。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;d654b0fa-3911-4d5a-b063-a08a256da9de&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;a48db9ec-daee-4411-89f9-f1a08e7d023f&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-learnings&#34;&gt;学习内容&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;3cab4b48-6ad3-4a4a-9f31-0f236019b5ba&#34;,&#34;dropCap&#34;:false}&#34;&gt;使用新生过去一年中，GPT 和 LLM 等技术使我们能够尝试并了解代理和 LLM 如何使用数据来生成对用户问题的响应的许多不同细微差别。我们在下面简要描述了我们的旅程中的一些经验教训：&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;cac6df94-1908-4171-ae84-1f933148d1c4&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-llms-are-excellent-classifiers&#34;&gt;法学硕士是优秀的分类器&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p数​​据a-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7ad4a5d4-d72f-4c36-952a-0bed88699fac&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们的中间代理在 QueryGPT 中用于将用户的自然语言提示分解为 RAG 的更好信号，与第一个版本相比，我们的准确性得到了很大提高，这在很大程度上是由于法学硕士在给予一小部分专门工作时工作得非常好。做。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;00b9e128-c899-4b26-ab48-77ac14026e96&#34;,&#34;dropCap&#34;:false}&#34;&gt;意图代理、表代理和列修剪代理都做得非常出色，因为他们被要求处理单个工作单元而不是广泛的通用任务。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;2c2c5240-a771-4f89-abf5-28321ce28330&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-hallucinations&#34;&gt;幻觉&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;18098f4a-1ca8-4a96-a6e2-988fc58813cc&#34;,&#34;dropCap&#34;:false}&#34;&gt;这仍然是这是我们一直在研究的领域，但简而言之，我们确实看到了 LLM 会生成包含不存在的表或这些表中不存在的列的查询的实例。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;7920ad06-2623-4706-a0d0-c9ee71cf5012&#34;,&#34;dropCap&#34;:false}&#34;&gt;我们已经一直在尝试减少幻觉的提示，引入了一种聊天风格模式，用户可以在其中迭代生成的查询，并且还希望包含一个“验证”代理，该代理会递归地尝试修复幻觉，但这仍然是我们尚未完全解决的领域还没解决。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;hash&#34;:&#34;0a5fcc9b-322f-4a6d-a79a-6dadf80fccf7&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-user-prompts-are-not-always-context-rich&#34;&gt;用户提示并不总是“上下文”丰富&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;546499a4-c289-478b-adfc-31edd877bdbe&#34;,&#34;dropCap&#34;:false}&#34;&gt;输入的问题QueryGPT 中的用户范围从非常详细的正确关键字以缩小搜索半径到 5 个单词的问题（有拼写错误）以回答需要跨多个表联接的广泛问题。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;33186177-6cb8-42ae-a1cd-5a959a95203c&#34;,&#34;dropCap&#34;:false}&#34;&gt;完全依赖用户提出的“良好”输入给法学硕士的问题导致了准确性和可靠性问题。在我们将用户问题发送给法学硕士之前，需要使用“提示增强器”或“提示扩展器”将用户问题“按摩”为上下文更丰富的问题​​。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:3,&#34;有h&#34;:&#34;9f670540-0564-4c3a-a1dc-c263263f0220&#34;}&#34; class=&#34;wp-block-heading&#34; id=&#34;h-high-bar-for-sql-output- generated-by-the-llm&#34;&gt;高LLM 生成的 SQL 输出栏&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5348bcb2-8b9b-4332-b614-2e87542629bb&#34;,&#34;dropCap&#34;:false}&#34;&gt;虽然此版本QueryGPT 对广泛的角色有帮助，许多人肯定期望生成的查询将非常准确并且“正常工作”。门槛很高！ &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;4f6a07df-d622-4adb-949d-b931e4746811&#34;,&#34;dropCap&#34;:false}&#34;&gt;根据我们的经验，我们发现，在构建此类产品时，最好以正确的角色作为初始用户群进行定位和测试。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;0991e158-aca7-4941-bf2a-5c611ca9d4c9&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;level&#34;:1,&#34;hash&#34;:&#34;02630760-d3f5-4166-bf76-7442565ad923&#34;}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-conclusion&#34;&gt;结论&lt;/h1&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;b189a3fd-91b7-4801-a5fb-c3f9d5b22614&#34;,&#34;dropCap&#34;:false}&#34;&gt;开发Uber 的 QueryGPT 是一次变革之旅，显着提高了根据自然语言提示生成 SQL 查询的生产力和效率。 QueryGPT 利用先进的生成式人工智能模型，与 Uber 广泛的数据生态系统无缝集成，减少查询编写时间并提高准确性，满足我们数据需求的规模和复杂性。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;19347b08-51ca-4d8c-ad2a-915513abeff0&#34;,&#34;dropCap&#34;:false}&#34;&gt;虽然面临这样的挑战随着处理大型模式和减少幻觉的持续存在，我们的迭代方法和不断学习实现了持续改进。 QueryGPT 不仅简化了数据访问，还使其民主化，使 Uber 内的各个团队能够更轻松地获取强大的数据洞察。 &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;cb86e603-2f0c-41fe-9d46-cc278cddf8cf&#34;,&#34;dropCap&#34;:false}&#34;&gt;以我们有限的向运营和支持部门的一些团队发布后，我们平均约有 300 名每日活跃用户，其中约 78% 的用户表示生成的查询减少了他们从头开始编写的时间。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;431ca7ef-0bb3-4a23-87df-b903178e79da&#34;,&#34;dropCap&#34;:false}&#34;&gt;正如我们所见未来，更复杂的人工智能技术和用户反馈的集成将推动进一步的增强，确保 QueryGPT 仍然是我们数据平台中的重要工具。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr data-wp-block-name=&#34;core/separator&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;8201e8b8-465b-4565-97bd-3d4b4cf67c21&#34;,&#34;opacity&#34;:&#34;alpha-channel&#34;}&#34;类=“wp-block-separator有-alpha-channel-opacity”&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 data-wp-block-name=&#34;core/heading&#34; data-wp-block=&#34;{&#34;hash&#34;:&#34;5d465de2-dafa-46f0-82aa-073654ce1bd1&#34;,&#34;level&#34;:2}&#34; class=&#34;wp -block-heading&#34; id=&#34;h-acknowledgements-nbsp&#34;&gt;致谢&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p data-wp-block-name=&#34;core/paragraph&#34; data-wp-block=&#34;{&#34;fontSize&#34;:&#34;小&#34;,&#34;hash&#34;:&#34;02707c3a-ea37-40cf-b242-32dfb606de76&#34;,&#34;dropCap&#34; :false}&#34; class=&#34;has-small-font-size&#34;&gt;QueryGPT 是 Uber 的一项跨学科工作，需要工程、产品管理和运营人员的专业知识和领域知识。如果没有 Abhi Khune、Callie Busch、Jeffrey Johnson、Pradeep Chakka、Saketh Chintapalli、Adarsh Nagesh、Gaurav Paul 和 Ben Carroll 的巨大贡献，该产品就不会存在于今天。&lt;/p&gt;</description>
      <pubDate>Thu, 19 Sep 2024 05:00:00 +0000</pubDate>
    </item>
  </channel>
</rss>